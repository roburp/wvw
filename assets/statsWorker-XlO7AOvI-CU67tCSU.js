(function(){"use strict";const Yt=["selfBuffs","groupBuffs","squadBuffs"],Jt=o=>o!=null&&o.classification?o.classification==="Boon":!0,Qt=o=>`b${o}`,On=(o,c)=>{const m=Array.isArray(o==null?void 0:o.activeTimes)?o.activeTimes:[],P=typeof m[0]=="number"?m[0]:0;return P>0?P:c},Xt=(o,c,m,P,j,W,he)=>{const oe=o==="selfBuffs"?1:Math.max(o==="groupBuffs"?W-1:he-1,0);return!oe||!j?{generationMs:0,wastedMs:0}:c?{generationMs:m*j*oe,wastedMs:P*j*oe}:{generationMs:m/100*j*oe,wastedMs:P/100*j*oe}},_n=o=>{const c=new Map,m=new Map;return o.forEach(W=>{const he=W.details;if(!he)return;const oe=he.durationMS||0,be=he.buffMap||{};Object.entries(be).forEach(([_,V])=>{if(!c.has(_)){c.set(_,V);return}const ke=c.get(_)||{},x={name:ke.name||V.name,stacking:ke.stacking??V.stacking,icon:ke.icon||V.icon,classification:ke.classification||V.classification};c.set(_,x)});const We=(he.players||[]).filter(_=>!_.notInSquad),De=We.length,Ce=new Map;We.forEach(_=>{const V=_.group??0;Ce.set(V,(Ce.get(V)||0)+1)}),We.forEach(_=>{const V=_.account||_.name||_.character_name||"Unknown",ke=_.profession||"Unknown",x=_.group??0,le=Ce.get(x)||1,ue=On(_,oe);m.has(V)||m.set(V,{account:V,profession:ke,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const me=m.get(V);me.profession=ke,ke!=="Unknown"&&(me.professions.add(ke),me.professionTimeMs[ke]=(me.professionTimeMs[ke]||0)+ue),me.activeTimeMs+=ue,me.numFights+=1,me.groupSupported+=le,me.squadSupported+=De,Yt.forEach(Ne=>{(_[Ne]||[]).forEach(ge=>{var Ie,$e,Fe,tt;if(typeof(ge==null?void 0:ge.id)!="number")return;const Ue=Qt(ge.id),Be=be[Ue];if(!Jt(Be))return;const Ae=(Be==null?void 0:Be.stacking)??!1,qe=(($e=(Ie=ge.buffData)==null?void 0:Ie[0])==null?void 0:$e.generation)??0,Te=((tt=(Fe=ge.buffData)==null?void 0:Fe[0])==null?void 0:tt.wasted)??0,{generationMs:Me,wastedMs:je}=Xt(Ne,Ae,qe,Te,oe,le,De);!Me&&!je||(c.has(Ue)||c.set(Ue,Be||{}),me.boons[Ue]||(me.boons[Ue]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),me.boons[Ue][Ne].generationMs+=Me,me.boons[Ue][Ne].wastedMs+=je)})})})}),{boonTables:Array.from(c.keys()).filter(W=>Jt(c.get(W))).map(W=>{const he=c.get(W)||{},oe=[];return m.forEach(be=>{var _;const Le=be.boons[W];if(!Le||!Yt.some(V=>Le[V].generationMs>0||Le[V].wastedMs>0))return;const De=Array.from(be.professions||[]).filter(V=>V&&V!=="Unknown");let Ce=be.profession;if(De.length>0){Ce=De[0];let V=((_=be.professionTimeMs)==null?void 0:_[Ce])||0;De.forEach(ke=>{var le;const x=((le=be.professionTimeMs)==null?void 0:le[ke])||0;x>V&&(V=x,Ce=ke)})}oe.push({account:be.account,profession:Ce||"Unknown",professionList:De,activeTimeMs:be.activeTimeMs||1,numFights:be.numFights||1,groupSupported:be.groupSupported||1,squadSupported:be.squadSupported||1,categories:{selfBuffs:{...Le.selfBuffs},groupBuffs:{...Le.groupBuffs},squadBuffs:{...Le.squadBuffs}}})}),{id:W,name:he.name||W,icon:he.icon,stacking:he.stacking??!1,rows:oe}}).filter(W=>W.rows.length>0)}},Zt=(o,c,m,P,j,W,he={})=>{var _,V,ke,x;const be=((o==null?void 0:o[c])||[]).find(le=>le.id===m);if(!be)return{generationMs:0,wastedMs:0};const Le=he[Qt(m)],We=(Le==null?void 0:Le.stacking)??!1,De=((V=(_=be.buffData)==null?void 0:_[0])==null?void 0:V.generation)??0,Ce=((x=(ke=be.buffData)==null?void 0:ke[0])==null?void 0:x.wasted)??0;return Xt(c,We,De,Ce,P,j,W)};var qn={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const jn=qn,$t="count",Wn=o=>(o||0)/1e3,Vn=(o,c)=>{var j;if(!o)return 0;const m=(j=jn.methods.tiered)==null?void 0:j.tiers;if(!m)return o;const P=c/Math.max(o,1);return P<=m.shortMs?o*m.weights.short:P<=m.mediumMs?o*m.weights.medium:o*m.weights.long},en=(o,c,m)=>m==="duration"?Wn(c):m==="tiered"?Vn(o,c):o;function zn(o,c=$t){var W;const m=(W=o.statsAll)==null?void 0:W[0],P=Number((m==null?void 0:m.appliedCrowdControl)??0),j=Number((m==null?void 0:m.appliedCrowdControlDuration)??0);return en(P,j,c)}function Kn(o,c){const m=(c==null?void 0:c.durationMS)||0,P=(c==null?void 0:c.buffMap)||{},j=o.filter(oe=>!oe.notInSquad),W=j.length,he=new Map;j.forEach(oe=>{const be=oe.group??0;he.set(be,(he.get(be)||0)+1)}),j.forEach(oe=>{const be=he.get(oe.group??0)||1,Le=Zt(oe,"selfBuffs",1122,m,be,W,P),We=Zt(oe,"squadBuffs",1122,m,be,W,P);oe.stabGeneration=(Le.generationMs+We.generationMs)/1e3})}function yn(o){if(!o.statsTargets)return 0;let c=0;for(const m of o.statsTargets)m&&m.length>0&&(c+=m[0].downContribution||0);return c}function Gn(o){if(!o.extBarrierStats||!o.extBarrierStats.outgoingBarrierAllies)return 0;let c=0;for(const m of o.extBarrierStats.outgoingBarrierAllies)if(m)for(const P of m)P&&(c+=P.barrier||0);return c}function Yn(o){if(!o.extHealingStats||!o.extHealingStats.outgoingHealingAllies)return 0;let c=0;for(const m of o.extHealingStats.outgoingHealingAllies)if(m)for(const P of m)P&&(c+=P.healing||0);return c}const Jn=o=>{var c,m,P,j;return(((m=(c=o.support)==null?void 0:c[0])==null?void 0:m.condiCleanse)||0)+(((j=(P=o.support)==null?void 0:P[0])==null?void 0:j.condiCleanseSelf)||0)},Qn=(o,c=$t)=>{var W;const m=(W=o.support)==null?void 0:W[0],P=Number((m==null?void 0:m.boonStrips)??0),j=Number((m==null?void 0:m.boonStripsTime)??0);return en(P,j,c)},Xn=o=>yn(o),Zn=o=>Yn(o),ei=o=>Gn(o),ti=(o,c=$t)=>zn(o,c),ni=(o,c)=>Kn(o,c),ii="count",oi={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},si={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},tn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),ai={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},ft=o=>{if(!o)return null;const c=o.trim().toLowerCase(),m=tn.get(c);if(m)return m;const P=c.split(/[^a-z]+/).filter(Boolean);for(const j of P){const W=tn.get(j);if(W)return W}return null},ri=o=>ft(o),nn=o=>{const c=new Map;return o&&(Object.values(o).forEach(m=>{if(!(m!=null&&m.icon)||!(m!=null&&m.name))return;const P=ft(m.name);P&&(c.has(P)||c.set(P,m.icon))}),Object.entries(ai).forEach(([m,P])=>{c.has(m)||c.set(m,P)})),c},Nt=(o,c,m)=>{var P;if(c&&m){const j=(P=m[`b${c}`])==null?void 0:P.name,W=ft(j);if(W)return W}return o?ft(o):null},ci=o=>{const c=(o==null?void 0:o.account)||"Unknown";return c&&c!=="Unknown"?c:(o==null?void 0:o.name)||"Unknown"||null},li=o=>{if(!o||o.length===0)return 0;let c=0,m=null;return o.forEach(P=>{const j=Number(P[1]??0);if(Number.isFinite(j)){if(m===null){m=j;return}j>m&&(c+=j-m),m=j}}),c},ui=o=>{if(!o||o.length===0)return 0;let c=0;return o.forEach(m=>{const P=Number(m[0]??0),j=Number(m[1]??0);Number.isFinite(j)&&P!==0&&j>0&&(c+=1)}),c},mi=o=>{const{players:c,targets:m,skillMap:P,buffMap:j}=o,W=o.getPlayerKey||ci,he=nn(j),oe={},be={};c.forEach(_=>{if(_!=null&&_.notInSquad)return;const V=W(_);V&&(oe[V]||(oe[V]={}),_!=null&&_.totalDamageDist&&_.totalDamageDist.forEach(ke=>{ke&&ke.forEach(x=>{if(!x.id)return;let le=`Skill ${x.id}`,ue;P&&(P[`s${x.id}`]?(le=P[`s${x.id}`].name||le,ue=P[`s${x.id}`].icon||ue):P[`${x.id}`]&&(le=P[`${x.id}`].name||le,ue=P[`${x.id}`].icon||ue));const me=Nt(le,x.id,j);if(!me)return;const Ne=j==null?void 0:j[`b${x.id}`],_e=Ne==null?void 0:Ne.name,ge=he.get(me)||(Ne==null?void 0:Ne.icon),Ue=le.startsWith("Skill ")?_e||me:le,Be=ue||(Ne==null?void 0:Ne.icon),Ae=Number(x.connectedHits??0),qe=Number(x.hits??0),Te=Ae>0?Ae:qe,Me=Number(x.totalDamage??0);if(!Number.isFinite(Te)&&!Number.isFinite(Me))return;const je=be[me]||{name:me,icon:ge,applications:0,damage:0};je.applications+=Number.isFinite(Te)?Te:0,je.damage+=Number.isFinite(Me)?Me:0,!je.icon&&ge&&(je.icon=ge),be[me]=je;const Ie=oe[V][me]||{icon:ge,applications:0,damage:0,skills:{}};Ie.applications+=Number.isFinite(Te)?Te:0,Ie.damage+=Number.isFinite(Me)?Me:0;const $e=Ie.skills[Ue]||{name:Ue,hits:0,damage:0,icon:Be};$e.hits+=Number.isFinite(Te)?Te:0,$e.damage+=Number.isFinite(Me)?Me:0,!$e.icon&&Be&&($e.icon=Be),Ie.skills[Ue]=$e,!Ie.icon&&ge&&(Ie.icon=ge),oe[V][me]=Ie})}))});const Le=new Map;c.forEach(_=>{if(_!=null&&_.notInSquad)return;const V=W(_);V&&_!=null&&_.name&&Le.set(_.name,V)});let We=0,De=0,Ce=0;return m.forEach(_=>{_!=null&&_.buffs&&_.buffs.forEach(V=>{const ke=Number(V==null?void 0:V.id);if(!Number.isFinite(ke))return;const x=j==null?void 0:j[`b${ke}`],le=ft(x==null?void 0:x.name);if(!le||x!=null&&x.classification&&x.classification!=="Condition")return;const ue=le;if(!ue)return;const me=V.statesPerSource||{};Ce+=1,Object.entries(me).forEach(([Ne,_e])=>{var Te;const ge=Le.get(Ne);if(!ge)return;De+=1;const Ue=li(_e),Be=ui(_e);We+=Ue;const Ae=((Te=oe[ge])==null?void 0:Te[ue])||{applications:0,damage:0,skills:{}};Ae.applicationsFromBuffs=(Ae.applicationsFromBuffs||0)+Ue,Ae.applicationsFromBuffsActive=(Ae.applicationsFromBuffsActive||0)+Be,oe[ge]=oe[ge]||{},oe[ge][ue]=Ae;const qe=be[ue]||{name:ue,applications:0,damage:0};qe.applicationsFromBuffs=(qe.applicationsFromBuffs||0)+Ue,qe.applicationsFromBuffsActive=(qe.applicationsFromBuffsActive||0)+Be,be[ue]=qe})})}),Object.values(oe).forEach(_=>{Object.values(_).forEach(V=>{typeof V.applicationsFromBuffs=="number"&&(V.applications=V.applicationsFromBuffs)})}),Object.values(be).forEach(_=>{typeof _.applicationsFromBuffs=="number"&&(_.applications=_.applicationsFromBuffs)}),{playerConditions:oe,summary:be,meta:{buffStateApplicationsTotal:We,targetBuffEntriesSeen:Ce,buffStateSourcesSeen:De}}},di=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),fi=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],gi=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],pi=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],hi=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],bi=new Set([10244]),ki=(o,c)=>{var j;if(bi.has(o))return!0;const m=(c==null?void 0:c[`s${o}`])||(c==null?void 0:c[`${o}`]),P=((j=m==null?void 0:m.name)==null?void 0:j.toLowerCase())||"";return hi.some(W=>P.includes(W))},Si=o=>{if(!o||!Number.isFinite(o))return"--:--";const c=Math.max(0,Math.round(o/1e3)),m=Math.floor(c/3600),P=Math.floor(c%3600/60),j=c%60;return m>0?`${m}:${String(P).padStart(2,"0")}:${String(j).padStart(2,"0")}`:`${P}:${String(j).padStart(2,"0")}`},At={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function on(o){return At[o]||At.Unknown}const Ci=o=>{if(o==null||o==="")return 0;if(typeof o=="number")return!Number.isFinite(o)||o<=0?0:o>1e12?o:o*1e3;if(o instanceof Date){const he=o.getTime();return Number.isFinite(he)&&he>0?he:0}const c=String(o).trim();if(!c)return 0;const m=Number(c);if(Number.isFinite(m)&&m>0)return m>1e12?m:m*1e3;const P=Date.parse(c);if(Number.isFinite(P)&&P>0)return P;const j=c.replace(/([+-]\d{2})$/,"$1:00"),W=Date.parse(j);return Number.isFinite(W)&&W>0?W:0},Qe=(o,c)=>Ci((o==null?void 0:o.uploadTime)??(c==null?void 0:c.uploadTime)??(o==null?void 0:o.timeStartStd)??(o==null?void 0:o.timeStart)??(o==null?void 0:o.timeEndStd)??(o==null?void 0:o.timeEnd)??(o==null?void 0:o.timeStartText)??(o==null?void 0:o.timeEndText)),Di=({logs:o,precomputedStats:c,mvpWeights:m,statsViewSettings:P,disruptionMethod:j})=>{const W=(()=>{const De=o.filter(Ce=>Ce.details&&Ce.details.players&&Ce.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:o.length,passed:De.length,statuses:o.map(Ce=>Ce.status),hasDetails:o.map(Ce=>!!Ce.details)}),De})(),he=P||si,oe=m||oi,be=De=>{if(!De||typeof De!="object")return De;const Ce=Array.isArray(De.fightBreakdown)?De.fightBreakdown:null;if(!Ce||Ce.length===0)return De;const _=new Map,V=new Map;o.forEach(x=>{var me;const le=(x==null?void 0:x.filePath)||(x==null?void 0:x.id);le&&_.set(String(le),x);const ue=(x==null?void 0:x.permalink)||((me=x==null?void 0:x.details)==null?void 0:me.permalink);typeof ue=="string"&&ue.trim()&&V.set(ue.trim(),x)});const ke=Ce.map(x=>{if(!x||typeof x!="object"||Number(x.timestamp)>0)return x;const ue=x.id?String(x.id):"",me=typeof x.permalink=="string"?x.permalink.trim():"",Ne=(ue?_.get(ue):void 0)||(me?V.get(me):void 0);if(!Ne)return x;const _e=Qe(Ne==null?void 0:Ne.details,Ne);return _e?{...x,timestamp:_e}:x});return{...De,fightBreakdown:ke}},Le=(()=>{if(c)return be(c);const De=j||ii,Ce=he.topSkillDamageSource||"target",_=he.topSkillsMetric||"damage",V=W.length;let ke=0,x=0,le=0,ue=0,me=0,Ne=0,_e=0,ge=0;const Ue=e=>{const n=((e==null?void 0:e.players)||[]).filter(y=>!y.notInSquad);let d=0,r=0,C=0,w=0;return n.forEach(y=>{var de;const U=(de=y.defenses)==null?void 0:de[0];if(!U)return;const J=Number(U.downCount||0),Se=Number(U.deadCount||0);d+=J+Se,C+=Se}),n.forEach(y=>{!y.statsTargets||y.statsTargets.length===0||y.statsTargets.forEach(U=>{const J=U==null?void 0:U[0];if(!J)return;const Se=Number(J.downed||0),de=Number(J.killed||0);r+=Se+de,w+=de})}),{squadDownsDeaths:d,enemyDownsDeaths:r,squadDeaths:C,enemyDeaths:w}},Be=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:n}=Ue(e);return t>0||n>0?n>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},Ae=new Map,qe=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),Te={},Me={},je=new Map,Ie={},$e={},Fe={},tt=new Map,Xe=new Map,Tt=new Set(Object.keys(At)),Mt=Object.keys(At).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),wt=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],at=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Tt.has(t))return t;const n=t.toLowerCase();for(const r of Mt)if(n.includes(r.toLowerCase()))return r;return wt.find(r=>n.includes(r.toLowerCase()))||t||"Unknown"},Ai=e=>e!=null&&e.classification?e.classification==="Boon":!0,vt=new Map,Et=new Map,gt=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),re=e=>{const t=Number(e);return Number.isFinite(t)?t:0},un=e=>{const t=String(e).split("|"),n=t[0]||"Unknown",d=at(t[1]||"Unknown"),r=t[2]||n||"Unknown";return{name:n,profession:d,account:r}},mn=(e,t,n)=>{let d=e.get(t);return d?n.profession&&!d.professionList.includes(n.profession)&&d.professionList.push(n.profession):(d={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt()},e.set(t,d)),d},dn=(e,t,n)=>{let d=e.get(t);return d?n.profession&&!d.professionList.includes(n.profession)&&d.professionList.push(n.profession):(d={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt(),minion:n.minion},e.set(t,d)),d},fn=(e,t)=>{e.totalHits+=re((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=re(t==null?void 0:t.blocked),e.evaded+=re(t==null?void 0:t.evaded),e.glanced+=re(t==null?void 0:t.glanced),e.missed+=re(t==null?void 0:t.missed),e.invulned+=re(t==null?void 0:t.invulned),e.interrupted+=re(t==null?void 0:t.interrupted),e.totalMitigation+=re((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=re((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},Ti=e=>Object.values(e).some(t=>t>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:W.length});const Ft=(e,t,n)=>{var C,w,y,U;const d=`s${e}`;if((C=t==null?void 0:t[d])!=null&&C.name)return t[d].name;if((w=t==null?void 0:t[String(e)])!=null&&w.name)return t[String(e)].name;const r=`b${e}`;return(y=n==null?void 0:n[r])!=null&&y.name?n[r].name:(U=n==null?void 0:n[String(e)])!=null&&U.name?n[String(e)].name:`Unknown Skill ${e}`},pt=new Map,rt=e=>{const t=pt.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const n=t.connectedHits||0,d=n>0?t.totalDamage/n:0,r=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:d,min:r,hits:n}},Bt="Ashtonlightstone.9145",gn="Illusionary Warden",Rt=[],ct=[],Ot=[],_t=[],pn=new Map,hn=new Map,bn=(e,t,n)=>{const d=e.get(t)||gt();return d.totalHits+=n.totalHits,d.blocked+=n.blocked,d.evaded+=n.evaded,d.glanced+=n.glanced,d.missed+=n.missed,d.invulned+=n.invulned,d.interrupted+=n.interrupted,e.set(t,d),d};W.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(d=>{const r=(d==null?void 0:d.totalDamageDist)||[],C=Array.isArray(r)?r[0]:null;C==null||C.forEach(w=>{if(!(w!=null&&w.id))return;const y=Number(w.id),U=pt.get(y)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};U.totalDamage+=Number(w.totalDamage||0),U.connectedHits+=Number(w.connectedHits||0);const J=Number.isFinite(Number(w.min))?Number(w.min):0;U.minTotal+=J,U.minCount+=1,pt.set(y,U)})})}),W.forEach((e,t)=>{var ce,He;const n=e.details;if(!n)return;const d=n.players;console.log(`[useStatsAggregation] Processing log ${t}:`,{playerCount:d==null?void 0:d.length,hasTargets:!!n.targets,firstPlayer:d!=null&&d[0]?{account:d[0].account,notInSquad:d[0].notInSquad}:"none"});const r=n.targets||[],C=n.skillMap||{},w=n.buffMap||{},y=new Map,U=new Map;r.forEach(s=>{const g=(s==null?void 0:s.totalDamageDist)||[],$=Array.isArray(g)?g[0]:null;$==null||$.forEach(X=>{var Z;if(!(X!=null&&X.id))return;const K=Number(X.id),a=((Z=C==null?void 0:C[K])==null?void 0:Z.name)||X.name||X.skillName||String(K),N=y.get(K)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};N.totalDamage+=Number(X.totalDamage||0),N.connectedHits+=Number(X.connectedHits||0);const T=Number.isFinite(Number(X.min))?Number(X.min):0;N.minTotal+=T,N.minCount+=1,y.set(K,N);const L=U.get(a)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};L.totalDamage+=Number(X.totalDamage||0),L.connectedHits+=Number(X.connectedHits||0);const se=Number.isFinite(Number(X.min))?Number(X.min):0;L.minTotal+=se,L.minCount+=1,U.set(a,L)})});const J=s=>{const g=y.get(s);if(!g||g.connectedHits<=0)return{avg:1,min:1};const $=g.connectedHits>0?g.totalDamage/g.connectedHits:0,X=g.minCount>0?g.minTotal/g.minCount:$;return{avg:$||1,min:X||1}},Se=s=>{const g=U.get(s);if(!g||g.connectedHits<=0)return{avg:1,min:1};const $=g.connectedHits>0?g.totalDamage/g.connectedHits:0,X=g.minCount>0?g.minTotal/g.minCount:$;return{avg:$||1,min:X||1}},de=n.combatReplayMetaData||{},Re=(de==null?void 0:de.inchToPixel)>0?de.inchToPixel:1,F=(de==null?void 0:de.pollingRate)>0?de.pollingRate:1,v=5e3,I=s=>Array.isArray(s)?s.map(g=>Array.isArray(g)?[Number(g[0]),Number(g[1])]:null).filter(g=>!!g&&Number.isFinite(g[0])):[];let Q=[],ae=n.durationMS||0,l=!1;const u=d.find(s=>(s==null?void 0:s.hasCommanderTag)&&!(s!=null&&s.notInSquad));(ce=u==null?void 0:u.combatReplayData)!=null&&ce.positions&&(Q=u.combatReplayData.positions,I(u.combatReplayData.dead).forEach(([g])=>{g>0&&(l=!0,ae=Math.min(ae,g))}));const k=s=>{var L;const g=(L=s.statsAll)==null?void 0:L[0];if((g==null?void 0:g.distToCom)!==void 0&&(g==null?void 0:g.distToCom)!=="Infinity")return Math.round(Number(g.distToCom));if((g==null?void 0:g.stackDist)!==void 0)return Math.round(Number(g.stackDist))||0;if(s.hasCommanderTag)return 0;const $=s.combatReplayData;if(!($!=null&&$.positions)||!Q.length)return 0;const X=$.positions,K=I($.dead),a=I($.down),N=Math.floor(($.start||0)/F);let T=0;if(K.length&&a.length)for(const[se]of K){if(se<0)continue;const Z=Math.max(0,Math.floor(se/F))-N;for(const[O,G]of a){if(se!==G)continue;const ee=l&&O>ae?Math.max(1,Math.floor(ae/F)):Z,te=Math.max(0,Math.min(ee,X.length,Q.length));if(te<=0)continue;let R=0;for(let H=0;H<te;H++){const[M,Y]=X[H],[ne,ie]=Q[H];R+=Math.hypot(M-ne,Y-ie)}T=Math.round(R/te/Re)}}return T},h=d.filter(s=>!s.notInSquad);le+=h.length,ue+=r.filter(s=>!s.isFake).length,ni(d,{durationMS:n.durationMS,buffMap:n.buffMap});const{squadDeaths:E,enemyDeaths:i}=Ue(n);me+=E,Ne+=i,ge+=E,_e+=i,Be(n)?ke++:x++;const B=n.skillMap?Number((He=Object.keys(n.skillMap).find(s=>{var g,$;return(($=(g=n.skillMap)==null?void 0:g[s])==null?void 0:$.name)==="Battle Standard"}))==null?void 0:He.replace(/^s/,"")):null;d.forEach((s,g)=>{var nt,it,lt,ut,Ht,ht,bt,Tn,Mn,wn,vn,En,Fn;if(s.notInSquad)return;const $=s.account||"Unknown",X=$!=="Unknown"?$:s.name||"Unknown",K=s.name||"Unknown";Ae.has(X)||Ae.set(X,{name:K,account:X,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:s.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const a=Ae.get(X);if(s.hasCommanderTag&&(a.isCommander=!0),s.profession&&s.profession!=="Unknown"){a.profession=s.profession,a.professions.add(s.profession);const f=Array.isArray(s.activeTimes)&&typeof s.activeTimes[0]=="number"?s.activeTimes[0]:n.durationMS||0;a.professionTimeMs[s.profession]=(a.professionTimeMs[s.profession]||0)+f}a.logsJoined++,a.downContrib+=Xn(s),a.cleanses+=Jn(s),a.strips+=Qn(s,De),a.healing+=Zn(s),a.barrier+=ei(s),a.cc+=ti(s,De),a.stab+=s.stabGeneration||0;const N=k(s);N<=v&&(a.totalDist+=N,a.distCount++),(nt=s.defenses)!=null&&nt[0]&&(a.dodges+=s.defenses[0].dodgeCount||0,a.downs+=s.defenses[0].downCount||0,a.deaths+=s.defenses[0].deadCount||0),n.durationMS&&(a.totalFightMs+=n.durationMS);const T=Array.isArray(s.activeTimes)&&typeof s.activeTimes[0]=="number"?s.activeTimes[0]:n.durationMS||0;a.defenseActiveMs+=T,a.supportActiveMs+=T,a.healingActiveMs+=T,Array.isArray(s.buffUptimes)&&s.buffUptimes.length>0&&s.buffUptimes.forEach(f=>{var Hn,Un,$n,Ln,xn,Rn;if(typeof(f==null?void 0:f.id)!="number")return;const b=`b${f.id}`,A=((Hn=n.buffMap)==null?void 0:Hn[b])||((Un=n.buffMap)==null?void 0:Un[String(f.id)]);if(!A||Ai(A))return;const z=Number(((Ln=($n=f.buffData)==null?void 0:$n[0])==null?void 0:Ln.uptime)??0),Ee=Number(((Rn=(xn=f.buffData)==null?void 0:xn[0])==null?void 0:Rn.presence)??0);if((!Number.isFinite(z)||z<=0)&&(!Number.isFinite(Ee)||Ee<=0))return;const ze=(A==null?void 0:A.stacking)??!1,Ke=(ze?Number.isFinite(z)?z:0:Number.isFinite(z)?z/100:0)*T,st=ze?Ee:z,yt=Math.min(Math.max(Number.isFinite(st)?st:0,0),100)/100*T,Bn=Number.isFinite(Ke)&&Ke>0,In=Number.isFinite(yt)&&yt>0;if(!Bn&&!In)return;const ye=ri(A==null?void 0:A.name);if(ye&&di.has(ye)&&(!(A!=null&&A.classification)||A.classification==="Condition")){const Ut=Ke/1e3,Ge=A==null?void 0:A.icon,kt=Ie[ye]||{name:ye,icon:Ge,applications:0,damage:0};kt.applicationsFromUptime=(kt.applicationsFromUptime||0)+Ut,!kt.icon&&Ge&&(kt.icon=Ge),Ie[ye]=kt;const St=a.outgoingConditions[ye]||{applications:0,damage:0,skills:{},icon:Ge};St.applicationsFromUptime=(St.applicationsFromUptime||0)+Ut,!St.icon&&Ge&&(St.icon=Ge),a.outgoingConditions[ye]=St;const Ct=$e[ye]||{name:ye,icon:Ge,applications:0,damage:0};Ct.applicationsFromUptime=(Ct.applicationsFromUptime||0)+Ut,!Ct.icon&&Ge&&(Ct.icon=Ge),$e[ye]=Ct;const Dt=a.incomingConditions[ye]||{applications:0,damage:0,skills:{},icon:Ge};Dt.applicationsFromUptime=(Dt.applicationsFromUptime||0)+Ut,!Dt.icon&&Ge&&(Dt.icon=Ge),a.incomingConditions[ye]=Dt}tt.has(b)||tt.set(b,{name:A==null?void 0:A.name,stacking:ze,icon:A==null?void 0:A.icon}),Xe.has(b)||Xe.set(b,new Map);const Pn=Xe.get(b),Gt=a.account||s.account||s.name||"Unknown";let et=Pn.get(Gt);et||(et={account:Gt,profession:a.profession||s.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,uptimeMs:0,durationMs:0},Pn.set(Gt,et));const dt=s.profession||a.profession;dt&&dt!=="Unknown"&&(et.professions.add(dt),et.professionTimeMs[dt]=(et.professionTimeMs[dt]||0)+T,et.profession=dt),et.totalMs+=Bn?Ke:0,et.uptimeMs+=In?yt:0,et.durationMs+=T}),(it=s.defenses)!=null&&it[0]&&gi.forEach(f=>{const b=Number(s.defenses[0][f.field]??0);Number.isFinite(b)&&(a.defenseTotals[f.id]=(a.defenseTotals[f.id]||0)+b)}),(lt=s.support)!=null&&lt[0]&&pi.forEach(f=>{let b=Number(s.support[0][f.field]??0);Number.isFinite(b)&&(qe.has(f.field)&&b>999999&&(b=0),a.supportTotals[f.id]=(a.supportTotals[f.id]||0)+b)});const L=(f,b)=>{Number.isFinite(b)&&(a.healingTotals[f]=(a.healingTotals[f]||0)+b)},se=(f,b)=>Array.isArray(f)?f.reduce((A,z)=>A+Number((z==null?void 0:z[b])??0),0):0,Z=(f,b,A)=>{if(!Number.isFinite(A)||A<=0)return;const z=d[b],Ee=b===g,ze=z==null?void 0:z.notInSquad,ot=!ze,Ke=ot&&(z==null?void 0:z.group)!=null&&z.group===s.group;L(f,A),ot&&L(`squad${f[0].toUpperCase()}${f.slice(1)}`,A),Ke&&L(`group${f[0].toUpperCase()}${f.slice(1)}`,A),Ee&&L(`self${f[0].toUpperCase()}${f.slice(1)}`,A),ze&&L(`offSquad${f[0].toUpperCase()}${f.slice(1)}`,A)};if(Array.isArray(s.rotation)){let f=0;s.rotation.forEach(b=>{var z;if(!(b!=null&&b.id)||!ki(b.id,n.skillMap))return;const A=((z=b.skills)==null?void 0:z.length)||0;A>0&&(f+=A,L(`resUtility_s${b.id}`,A))}),f>0&&L("resUtility",f)}const O=(ut=s.extHealingStats)==null?void 0:ut.outgoingHealingAllies;Array.isArray(O)&&O.forEach((f,b)=>{const A=se(f,"healing"),z=se(f,"downedHealing");Z("healing",b,A),Z("downedHealing",b,z)});const G=(Ht=s.extBarrierStats)==null?void 0:Ht.outgoingBarrierAllies;Array.isArray(G)&&G.forEach((f,b)=>{const A=se(f,"barrier");Z("barrier",b,A)});const ee=(ht=s.statsAll)==null?void 0:ht[0],te=(bt=s.dpsAll)==null?void 0:bt[0],R=(Tn=s.support)==null?void 0:Tn[0];if(fi.forEach(f=>{if(f.id==="downContributionPercent"||!f.field)return;let b=0,A=0;f.source==="dpsAll"&&te?b=Number(te[f.field]??0):f.source==="statsAll"&&ee?(b=Number(ee[f.field]??0),A=Number(ee[f.denomField||f.weightField||"connectedDamageCount"]??0)):f.source==="support"&&R?b=Number(R[f.field]??0):s.statsTargets&&s.statsTargets.forEach(z=>{z!=null&&z[0]&&(b+=Number(z[0][f.field]??0),A+=Number(z[0][f.denomField||f.weightField||"connectedDamageCount"]??0))}),Number.isFinite(b)&&(a.offenseTotals[f.id]=(a.offenseTotals[f.id]||0)+b,f.isRate&&A>0&&(a.offenseRateWeights[f.id]=(a.offenseRateWeights[f.id]||0)+A))}),s.targetDamageDist&&Number.isFinite(B)){const f=s.targetDamageDist.flatMap(b=>b||[]).flatMap(b=>b||[]).reduce((b,A)=>A!=null&&A.id&&A.id===B?b+((A==null?void 0:A.connectedHits)||0):b,0);a.offenseTotals.battleStandardHits=(a.offenseTotals.battleStandardHits||0)+f}a.revives+=((wn=(Mn=s.support)==null?void 0:Mn[0])==null?void 0:wn.resurrects)||0,te&&(a.damage+=te.damage||0,a.dps+=te.dps||0);const H=f=>{var Ee,ze,ot,Ke;let b=`Skill ${f.id}`;const A=((Ee=n.skillMap)==null?void 0:Ee[`s${f.id}`])||((ze=n.skillMap)==null?void 0:ze[`${f.id}`]);let z=A==null?void 0:A.icon;if(A!=null&&A.name&&(b=A.name),b.startsWith("Skill ")){const st=Nt(b,f.id,n.buffMap);st&&(b=st,z=((Ke=(ot=n.buffMap)==null?void 0:ot[`b${f.id}`])==null?void 0:Ke.icon)||z)}return{name:b,icon:z}},M=f=>{if(!(f!=null&&f.id))return;const{name:b,icon:A}=H(f);Te[f.id]||(Te[f.id]={name:b,icon:A,damage:0,hits:0,downContribution:0}),Te[f.id].name.startsWith("Skill ")&&!b.startsWith("Skill ")&&(Te[f.id].name=b),!Te[f.id].icon&&A&&(Te[f.id].icon=A),Te[f.id].damage+=f.totalDamage,Te[f.id].hits+=f.connectedHits,Te[f.id].downContribution+=Number(f.downContribution||0)},Y=s.account||s.name||"Unknown",ne=s.profession||"Unknown",ie=`${Y}|${ne}`;let fe=je.get(ie);fe||(fe={key:ie,account:Y,displayName:Y,profession:ne,professionList:[ne],totalFightMs:0,skills:new Map},je.set(ie,fe)),fe.professionList.includes(ne)||fe.professionList.push(ne),fe.totalFightMs+=n.durationMS||0;const Oe=f=>{if(!(f!=null&&f.id))return;const{name:b,icon:A}=H(f),z=`s${f.id}`;let Ee=fe.skills.get(z);Ee||(Ee={id:z,name:b,icon:A,damage:0,downContribution:0},fe.skills.set(z,Ee)),Ee.name.startsWith("Skill ")&&!b.startsWith("Skill ")&&(Ee.name=b),!Ee.icon&&A&&(Ee.icon=A),Ee.damage+=Number(f.totalDamage||0),Ee.downContribution+=Number(f.downContribution||0)};if(Ce==="total")(vn=s.totalDamageDist)==null||vn.forEach(f=>{f==null||f.forEach(b=>{M(b),Oe(b)})});else{const f=new Set;(En=s.targetDamageDist)==null||En.forEach(b=>{b==null||b.forEach(A=>{A==null||A.forEach(z=>{const Ee=Number(z==null?void 0:z.id);Number.isFinite(Ee)&&f.add(Ee),M(z),Oe(z)})})}),(Fn=s.totalDamageDist)==null||Fn.forEach(b=>{b==null||b.forEach(A=>{const z=Number(A==null?void 0:A.id);!Number.isFinite(z)||f.has(z)||(M(A),Oe(A))})})}s.totalDamageTaken&&s.totalDamageTaken.forEach(f=>{f==null||f.forEach(b=>{var ze,ot,Ke,st;if(!(b!=null&&b.id))return;let A=`Skill ${b.id}`;const z=((ze=n.skillMap)==null?void 0:ze[`s${b.id}`])||((ot=n.skillMap)==null?void 0:ot[`${b.id}`]);let Ee=z==null?void 0:z.icon;if(z!=null&&z.name&&(A=z.name),A.startsWith("Skill ")){const Kt=Nt(A,b.id,n.buffMap);Kt&&(A=Kt,Ee=((st=(Ke=n.buffMap)==null?void 0:Ke[`b${b.id}`])==null?void 0:st.icon)||Ee)}Me[b.id]||(Me[b.id]={name:A,icon:Ee,damage:0,hits:0}),(!Me[b.id].name.startsWith("Skill ")||A.startsWith("Skill "))&&(Me[b.id].name=A),!Me[b.id].icon&&Ee&&(Me[b.id].icon=Ee),Me[b.id].damage+=b.totalDamage,Me[b.id].hits+=b.hits})})}),r.forEach(s=>{if(s!=null&&s.isFake)return;const g=at((s==null?void 0:s.profession)||(s==null?void 0:s.name)||(s==null?void 0:s.id));g&&(Fe[g]=(Fe[g]||0)+1)});const p=mi({players:d,targets:r,skillMap:n.skillMap,buffMap:n.buffMap,getPlayerKey:s=>s.account&&s.account!=="Unknown"?s.account:s.name||null}),S=nn(n.buffMap);Object.entries(p.playerConditions).forEach(([s,g])=>{const $=Ae.get(s);$&&Object.entries(g).forEach(([X,K])=>{const a=$.outgoingConditions[X]||{applications:0,damage:0,skills:{},icon:K.icon};a.applications+=Number(K.applications||0),a.damage+=Number(K.damage||0),K.applicationsFromBuffs&&(a.applicationsFromBuffs=(a.applicationsFromBuffs||0)+K.applicationsFromBuffs),K.applicationsFromBuffsActive&&(a.applicationsFromBuffsActive=(a.applicationsFromBuffsActive||0)+K.applicationsFromBuffsActive),Object.entries(K.skills||{}).forEach(([N,T])=>{const L=a.skills[N]||{name:T.name,hits:0,damage:0,icon:T.icon};L.hits+=Number(T.hits||0),L.damage+=Number(T.damage||0),!L.icon&&T.icon&&(L.icon=T.icon),a.skills[N]=L}),!a.icon&&K.icon&&(a.icon=K.icon),$.outgoingConditions[X]=a})}),Object.entries(p.summary).forEach(([s,g])=>{const $=Ie[s]||{name:g.name||s,icon:g.icon,applications:0,damage:0};$.applications+=Number(g.applications||0),$.damage+=Number(g.damage||0),g.applicationsFromBuffs&&($.applicationsFromBuffs=($.applicationsFromBuffs||0)+g.applicationsFromBuffs),g.applicationsFromBuffsActive&&($.applicationsFromBuffsActive=($.applicationsFromBuffsActive||0)+g.applicationsFromBuffsActive),!$.icon&&g.icon&&($.icon=g.icon),Ie[s]=$}),h.forEach(s=>{const g=s.account&&s.account!=="Unknown"?s.account:s.name||"Unknown",$=Ae.get(g);!$||!s.totalDamageTaken||s.totalDamageTaken.forEach(X=>X==null?void 0:X.forEach(K=>{var H,M,Y,ne,ie,fe;if(!(K!=null&&K.id))return;let a=`Skill ${K.id}`;const N=((H=n.skillMap)==null?void 0:H[`s${K.id}`])||((M=n.skillMap)==null?void 0:M[`${K.id}`]);N!=null&&N.name&&(a=N.name);const T=Nt(a,K.id,n.buffMap);if(!T)return;const L=(ne=(Y=n.buffMap)==null?void 0:Y[`b${K.id}`])==null?void 0:ne.name,se=S.get(T)||((fe=(ie=n.buffMap)==null?void 0:ie[`b${K.id}`])==null?void 0:fe.icon),Z=(N==null?void 0:N.icon)||se;a.startsWith("Skill ")&&(L||T)&&(a=L||T);const O=Number(K.hits??0),G=Number(K.totalDamage??0),ee=$e[T]||{name:T,icon:se,applications:0,damage:0};ee.applications+=Number.isFinite(O)?O:0,ee.damage+=Number.isFinite(G)?G:0,!ee.icon&&se&&(ee.icon=se),$e[T]=ee;const te=$.incomingConditions[T]||{applications:0,damage:0,skills:{},icon:se};te.applications+=Number.isFinite(O)?O:0,te.damage+=Number.isFinite(G)?G:0;const R=te.skills[a]||{name:a,hits:0,damage:0,icon:Z};R.hits+=Number.isFinite(O)?O:0,R.damage+=Number.isFinite(G)?G:0,!R.icon&&Z&&(R.icon=Z),te.skills[a]=R,!te.icon&&se&&(te.icon=se),$.incomingConditions[T]=te}))});const q=n.player_damage_mitigation||n.playerDamageMitigation,we=q&&typeof q=="object"&&Object.keys(q).length>0;we&&Object.entries(q).forEach(([s,g])=>{if(!g||typeof g!="object")return;const $=un(s),X=mn(vt,$.account,$);Object.values(g).forEach(K=>{re((K==null?void 0:K.avoided_damage)??(K==null?void 0:K.avoidedDamage))<=0||fn(X.mitigationTotals,K)})});const pe=n.player_minion_damage_mitigation||n.playerMinionDamageMitigation,xe=pe&&typeof pe=="object"&&Object.keys(pe).length>0;xe&&Object.entries(pe).forEach(([s,g])=>{if(!g||typeof g!="object")return;const $=un(s);Object.entries(g).forEach(([X,K])=>{if(!K||typeof K!="object")return;const a=`${$.account}::${X}`,N=dn(Et,a,{...$,minion:String(X||"Unknown")});Object.values(K).forEach(T=>{fn(N.mitigationTotals,T)})})}),(!we||!xe)&&(we||h.forEach(s=>{const g=(s==null?void 0:s.totalDamageTaken)||[];if(!Array.isArray(g)||g.length===0)return;const $=s.account||s.name||"Unknown",X={account:$,name:s.name||$,profession:at(s.profession||"Unknown")};mn(vt,$,X);const K=n.skillMap||{},a=n.buffMap||{},N=Array.isArray(g)?g[0]:null;if(N==null||N.forEach(T=>{if(!(T!=null&&T.id))return;const L=re(T.blocked),se=re(T.evaded),Z=re(T.glance??T.glanced),O=re(T.missed),G=re(T.invulned),ee=re(T.interrupted),te=re(T.hits??T.connectedHits),R=Number(T.id),H=Ft(R,K,a);if(bn(pn,`${$}::${R}`,{totalHits:te,blocked:L,evaded:se,glanced:Z,missed:O,invulned:G,interrupted:ee}),$===Bt){const M=pt.get(R),Y=rt(R),ne=Y.hasSkill?Y.hits>0?Y.avg:0:1,ie=Y.hasSkill?Y.min||0:1,fe=Y.hits>0?Z*ne/2+(L+se+O+G+ee)*ne:0,Oe=Y.hits>0?Z*ie/2+(L+se+O+G+ee)*ie:0;Ot.push({logId:e.filePath||e.id||t,skillId:T.id,skillName:H,blocked:L,evaded:se,glanced:Z,missed:O,invulned:G,interrupted:ee,totalAvoids:L+se+Z+O+G+ee,avg:ne,min:ie,enemyHits:(M==null?void 0:M.connectedHits)??0,enemyTotalDmg:(M==null?void 0:M.totalDamage)??0,avoidDmg:fe,avoidMinDmg:Oe})}}),$===Bt){const T=(L,se)=>{let Z=0,O=0,G=0;if(!Array.isArray(L))return{total:Z,minTotal:O,hits:G};for(const ee of L){if(!(ee!=null&&ee.id))continue;const te=re(ee.blocked),R=re(ee.evaded),H=re(ee.glance??ee.glanced),M=re(ee.missed),Y=re(ee.invulned),ne=re(ee.interrupted),ie=Ft(Number(ee.id),C,w),fe=se(Number(ee.id),ie);(fe.hits??0)>0&&(Z+=H*fe.avg/2+(te+R+M+Y+ne)*fe.avg,O+=H*fe.min/2+(te+R+M+Y+ne)*fe.min),G+=re(ee.hits??ee.connectedHits)}return{total:Z,minTotal:O,hits:G}};_t.push({logId:e.filePath||e.id||t,variant:"current_global_name_taken0",...T(N,(L,se)=>{const Z=rt(L),O=Z.hasSkill?Z.hits>0?Z.avg:0:1,G=Z.hasSkill?Z.min||0:1;return{avg:O,min:G,hits:Z.hits}})})}}),xe||h.forEach(s=>{const g=(s==null?void 0:s.minions)||[];if(!Array.isArray(g)||g.length===0)return;const $=s.account||s.name||"Unknown",X={account:$,name:s.name||$,profession:at(s.profession||"Unknown")},K=n.skillMap||{},a=n.buffMap||{};g.forEach(N=>{const T=(N==null?void 0:N.totalDamageTakenDist)||[];if(!Array.isArray(T)||T.length===0)return;let L=String((N==null?void 0:N.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";L.toUpperCase().includes("UNKNOWN")&&(L="Unknown");const se=`${$}::${L}`;dn(Et,se,{...X,minion:L});const Z=Array.isArray(T)?T[0]:null;if(Z==null||Z.forEach(O=>{if(!(O!=null&&O.id))return;const G=re(O.blocked),ee=re(O.evaded),te=re(O.glance??O.glanced),R=re(O.missed),H=re(O.invulned),M=re(O.interrupted),Y=re(O.hits??O.connectedHits),ne=Number(O.id),ie=Ft(ne,K,a);if(bn(hn,`${se}::${ne}`,{totalHits:Y,blocked:G,evaded:ee,glanced:te,missed:R,invulned:H,interrupted:M}),$===Bt&&L===gn){const fe=pt.get(ne),Oe=rt(ne),nt=Oe.hasSkill?Oe.hits>0?Oe.avg:0:1,it=Oe.hasSkill?Oe.min||0:1,lt=Oe.hits>0?te*nt/2+(G+ee+R+H+M)*nt:0,ut=Oe.hits>0?te*it/2+(G+ee+R+H+M)*it:0;Rt.push({logId:e.filePath||e.id||t,skillId:O.id,skillName:ie,blocked:G,evaded:ee,glanced:te,missed:R,invulned:H,interrupted:M,totalAvoids:G+ee+te+R+H+M,avg:nt,min:it,enemyHits:(fe==null?void 0:fe.connectedHits)??0,enemyTotalDmg:(fe==null?void 0:fe.totalDamage)??0,avoidDmg:lt,avoidMinDmg:ut})}}),$===Bt&&L===gn){const O=(R,H)=>{let M=0,Y=0,ne=0;if(!Array.isArray(R))return{total:M,minTotal:Y,hits:ne};for(const ie of R){if(!(ie!=null&&ie.id))continue;const fe=re(ie.blocked),Oe=re(ie.evaded),nt=re(ie.glance??ie.glanced),it=re(ie.missed),lt=re(ie.invulned),ut=re(ie.interrupted),Ht=Ft(Number(ie.id),C,w),{avg:ht,min:bt}=H(Number(ie.id),Ht);re(ie.hits??ie.connectedHits)>0&&(M+=nt*ht/2+(fe+Oe+it+lt+ut)*ht,Y+=nt*bt/2+(fe+Oe+it+lt+ut)*bt),ne+=re(ie.hits??ie.connectedHits)}return{total:M,minTotal:Y,hits:ne}},G=Array.isArray(T)?T[0]||[]:[],ee=Array.isArray(T)?T.flat():[],te=Array.isArray(N==null?void 0:N.totalDamageTaken)?N.totalDamageTaken[0]||[]:[];ct.push({logId:e.filePath||e.id||t,variant:"current_global_name_dist0",...O(G,(R,H)=>{const M=rt(R),Y=M.hasSkill?M.hits>0?M.avg:0:1,ne=M.hasSkill&&M.min||0;return{avg:Y,min:ne}})}),ct.push({logId:e.filePath||e.id||t,variant:"local_name_dist0",...O(G,(R,H)=>Se(H))}),ct.push({logId:e.filePath||e.id||t,variant:"local_id_dist0",...O(G,R=>J(R))}),ct.push({logId:e.filePath||e.id||t,variant:"global_name_alllists",...O(ee,(R,H)=>{const M=rt(R),Y=M.hasSkill?M.hits>0?M.avg:0:1,ne=M.hasSkill&&M.min||0;return{avg:Y,min:ne}})}),ct.push({logId:e.filePath||e.id||t,variant:"global_name_taken0",...O(te,(R,H)=>{const M=rt(R),Y=M.hasSkill?M.hits>0?M.avg:0:1,ne=M.hasSkill&&M.min||0;return{avg:Y,min:ne}})})}})}))}),Rt.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table(Rt),ct.length>0&&console.table(ct),console.groupEnd()),Ot.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(Ot),_t.length>0&&console.table(_t),console.groupEnd());const kn=(e,t)=>{const n=new Map,d=r=>{let C=n.get(r);return C||(C=gt(),n.set(r,C)),C};t.forEach((r,C)=>{const w=C.lastIndexOf("::"),y=w>-1?C.slice(0,w):C,U=w>-1?Number(C.slice(w+2)):Number.NaN,J=Number.isFinite(U)?rt(U):{hasSkill:!1,avg:0,min:0,hits:0};if(!J.hasSkill||J.hits<=0)return;const Se=J.avg,de=J.min,Re=r.glanced*Se/2+(r.blocked+r.evaded+r.missed+r.invulned+r.interrupted)*Se,F=r.glanced*de/2+(r.blocked+r.evaded+r.missed+r.invulned+r.interrupted)*de;if(Re<=0)return;const v=d(y);v.totalHits+=r.totalHits,v.blocked+=r.blocked,v.evaded+=r.evaded,v.glanced+=r.glanced,v.missed+=r.missed,v.invulned+=r.invulned,v.interrupted+=r.interrupted,v.totalMitigation+=Re,v.minMitigation+=F}),e.forEach((r,C)=>{const w=n.get(C)||gt();r.mitigationTotals.totalHits=w.totalHits,r.mitigationTotals.blocked=w.blocked,r.mitigationTotals.evaded=w.evaded,r.mitigationTotals.glanced=w.glanced,r.mitigationTotals.missed=w.missed,r.mitigationTotals.invulned=w.invulned,r.mitigationTotals.interrupted=w.interrupted,r.mitigationTotals.totalMitigation=w.totalMitigation,r.mitigationTotals.minMitigation=w.minMitigation})};kn(vt,pn),kn(Et,hn);const Mi=V>0?Math.round(le/V):0,wi=V>0?Math.round(ue/V):0,vi=me>0?(Ne/me).toFixed(2):Ne>0?"∞":"0.00",Ei=_e>0?(ge/_e).toFixed(2):ge>0?"∞":"0.00",Sn=(e,t)=>{const d=e.filter(w=>Number.isFinite(w.value)&&(t?w.value>0:w.value>=0)).sort((w,y)=>{const U=t?y.value-w.value:w.value-y.value;return U!==0?U:w.account.localeCompare(y.account)});let r=null,C=0;return d.map((w,y)=>((r===null||w.value!==r)&&(C=y+1,r=w.value),{rank:C,...w}))},qt=Array.from(Ae.values()).map(e=>{const t=Array.from(e.professions).filter(n=>n!=="Unknown");if(e.professionList=t,t.length>0){let n=t[0],d=e.professionTimeMs[n]||0;t.forEach(r=>{const C=e.professionTimeMs[r]||0;C>d&&(d=C,n=r)}),e.profession=n}return{key:e.account,stat:e}}),Cn=e=>{const t=Ae.get(e.account);if(!t){const r=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:r}}const n=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(r=>r&&r!=="Unknown"),d=t.profession||e.profession;return{...e,profession:d,professionList:n.length>0?n:d?[d]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},Fi=Array.from(vt.values()).map(Cn).filter(e=>Ti(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),Bi=Array.from(Et.values()).map(Cn).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const n=e.account.localeCompare(t.account);return n!==0?n:String(e.minion||"").localeCompare(String(t.minion||""))}),It=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},Ve=(e,t)=>Sn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:It(n,e),count:n.logsJoined})),t),Pe={downContrib:Ve("downContrib",!0),barrier:Ve("barrier",!0),healing:Ve("healing",!0),dodges:Ve("dodges",!0),strips:Ve("strips",!0),cleanses:Ve("cleanses",!0),cc:Ve("cc",!0),stability:Ve("stability",!0),revives:Ve("revives",!0),participation:Ve("participation",!0),dps:Ve("dps",!0),damage:Ve("damage",!0),closestToTag:Ve("closestToTag",!1).filter(e=>Number.isFinite(e.value))},Ii={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},ve=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},Ze={maxDownContrib:ve([]),maxBarrier:ve([]),maxHealing:ve([]),maxDodges:ve([]),maxStrips:ve([]),maxCleanses:ve([]),maxCC:ve([]),maxStab:ve([]),closestToTag:ve([])},Je={},Pi=(e,t)=>{if(t==="closestToTag")return It(e,t);const n=Math.max(1,(e.totalFightMs||0)/1e3);return It(e,t)/n};Object.values(Ii).forEach(e=>{const t=e!=="closestToTag";Je[e]=Sn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:Pi(n,e),count:n.logsJoined})),t)}),Ze.maxDownContrib=ve(Je.downContrib),Ze.maxBarrier=ve(Je.barrier),Ze.maxHealing=ve(Je.healing),Ze.maxDodges=ve(Je.dodges),Ze.maxStrips=ve(Je.strips),Ze.maxCleanses=ve(Je.cleanses),Ze.maxCC=ve(Je.cc),Ze.maxStab=ve(Je.stability),Ze.closestToTag=ve(Je.closestToTag);const Hi={maxDownContrib:ve(Pe.downContrib),maxBarrier:ve(Pe.barrier),maxHealing:ve(Pe.healing),maxDodges:ve(Pe.dodges),maxStrips:ve(Pe.strips),maxCleanses:ve(Pe.cleanses),maxCC:ve(Pe.cc),maxStab:ve(Pe.stability),closestToTag:ve(Pe.closestToTag)};let jt={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},Dn,Nn,An=0;if(he!=null&&he.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=C=>{const w=e[C];return w?Number(oe[w]||0)>0:!1},n=[],d=C=>[...C||[]].filter(w=>t(w==null?void 0:w.name)).sort((w,y)=>y.ratio-w.ratio||w.rank-y.rank||w.name.localeCompare(y.name)).slice(0,3),r=C=>{var y;if(!C)return;const w=d(C.contribs);return{...C,player:C.name,reason:((y=w[0])==null?void 0:y.name)||"Top Performance",topStats:w}};qt.forEach(({stat:C})=>{let w=0;const y=[],U=(J,Se,de,Re,F=!0)=>{var I,Q;if(de<=0)return;const v=((I=Se[0])==null?void 0:I.value)||0;if(v&&Number.isFinite(J)&&(F?J>0:J<Number.POSITIVE_INFINITY)){const ae=F?J/v:v/J;w+=ae*de;const l=((Q=Se.find(u=>u.account===C.account))==null?void 0:Q.rank)||0;y.push({name:Re,ratio:ae,val:J.toLocaleString(),rank:l})}};U(C.downContrib,Pe.downContrib,oe.downContribution,"Down Contribution"),U(C.healing,Pe.healing,oe.healing,"Healing"),U(C.cleanses,Pe.cleanses,oe.cleanses,"Cleanses"),U(C.strips,Pe.strips,oe.strips,"Strips"),U(C.stab,Pe.stability,oe.stability,"Stability"),U(C.cc,Pe.cc,oe.cc,"CC"),U(C.revives,Pe.revives,oe.revives,"Revives"),U(It(C,"closestToTag"),Pe.closestToTag,oe.distanceToTag,"Distance to Tag",!1),U(C.logsJoined,Pe.participation,oe.participation,"Participation"),U(C.dodges,Pe.dodges,oe.dodging,"Dodging"),U(C.dps,Pe.dps,oe.dps,"DPS"),U(C.damage,Pe.damage,oe.damage,"Damage"),n.push({...C,score:w,contribs:y.filter(J=>t(J.name))})}),n.sort((C,w)=>w.score-C.score),n[0]&&n[0].score>0&&(jt=r(n[0])||jt),Dn=r(n[1]),Nn=r(n[2]),An=n.length>0?n.reduce((C,w)=>C+w.score,0)/n.length:0}const Ui=Object.values(Te).sort((e,t)=>{const n=_==="downContribution"?e.downContribution:e.damage;return(_==="downContribution"?t.downContribution:t.damage)-n}).slice(0,25),$i=Object.values(Me).sort((e,t)=>t.damage-e.damage).slice(0,25),Li=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),n=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return n?`${n[1]} Borderlands`:t||"Unknown"},Pt=(e,t)=>Li((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),xi=(e,t)=>{const n=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof n=="string"&&n.trim().length>0)return n.trim();const d=e==null?void 0:e.uploadLinks;if(!Array.isArray(d))return"";for(const r of d){if(typeof r=="string"&&r.trim().length>0)return r.trim();if(r&&typeof r=="object"){const C=r.permalink||r.link||r.url||r.reportLink;if(typeof C=="string"&&C.trim().length>0)return C.trim()}}return""},Wt={};W.forEach(e=>{const t=Pt(e==null?void 0:e.details,e);Wt[t]=(Wt[t]||0)+1});const Ri=Object.entries(Wt).map(([e,t])=>{const n=String(e).trim(),d=/eternal battlegrounds|^ebg$/i.test(n);let r="#64748b";return d?r="#ffffff":/red/i.test(n)?r="#ef4444":/blue/i.test(n)?r="#3b82f6":/green/i.test(n)&&(r="#22c55e"),{name:e,value:t,color:r}}).sort((e,t)=>t.value-e.value),{boonTables:Oi}=_n(W),_i=W.map((e,t)=>{var d,r;const n=((d=e.details)==null?void 0:d.players)||[];return{index:t+1,label:`Log ${t+1}`,timestamp:Qe(e.details,e),squadCount:n.filter(C=>!C.notInSquad).length,friendlyCount:n.length,enemies:((r=e.details)==null?void 0:r.targets).filter(C=>!C.isFake).length}}).sort((e,t)=>e.timestamp-t.timestamp),Vt={};Array.from(Ae.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(Vt[e.profession]=(Vt[e.profession]||0)+1)});const qi=Object.entries(Vt).map(([e,t])=>({name:e,value:t,color:on(e)})).sort((e,t)=>t.value-e.value),zt={};Object.keys(Fe).length===0&&W.forEach(e=>{var t,n;(n=(t=e.details)==null?void 0:t.targets)==null||n.forEach(d=>{if(d.isFake)return;const r=d.profession&&d.profession!=="Unknown"?d.profession:d.name||d.id||"Unknown",C=at(r);zt[C]=(zt[C]||0)+1})});const ji=Object.keys(Fe).length>0?Fe:zt,Wi=Object.entries(ji).map(([e,t])=>({name:e,value:t,color:on(e)})).sort((e,t)=>t.value-e.value),Vi=W.map((e,t)=>({log:e,originalIndex:t})).sort((e,t)=>Qe(e.log.details,e.log)-Qe(t.log.details,t.log)).map(({log:e},t)=>{const n=e.details;if(!n)return null;const d=n.players||[],r=d.filter(i=>!i.notInSquad),C=d.filter(i=>i.notInSquad),w=n.targets||[],y=w.filter(i=>!i.isFake),U=r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.dpsAll)==null?void 0:B[0])==null?void 0:p.damage)||0)},0),J=r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.defenses)==null?void 0:B[0])==null?void 0:p.damageTaken)||0)},0),{enemyDeaths:Se,enemyDownsDeaths:de}=Ue(n),Re=Be(n),F=Qe(n,e),v=Pt(n,e),I={red:0,green:0,blue:0},Q=i=>{const D=Number(i);return Number.isFinite(D)?D:0},ae=i=>{if(!i||typeof i!="object")return;const D=i.teamID??i.teamId??i.team??i.teamColor??i.team_color;if(D!=null)return D;const B=Object.keys(i).find(p=>/^team/i.test(p));return B?i[B]:void 0},l=(i,D)=>{if(i==null)return null;if(typeof i=="string"){const B=i.toLowerCase();return B.includes("red")?"red":B.includes("green")?"green":B.includes("blue")?"blue":B==="r"?"red":B==="g"?"green":B==="b"?"blue":null}if(typeof i=="number")if(D==="zeroBased"){if(i===0)return"red";if(i===1)return"green";if(i===2)return"blue"}else{if(i===1)return"red";if(i===2)return"green";if(i===3)return"blue"}return null},u=(i,D)=>{const B={};return i.forEach(p=>{const S=D(p),q=at(S);q&&(B[q]=(B[q]||0)+1)}),B},k=u(r,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)),h=u(C,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)),E=u(y,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)||(i==null?void 0:i.id));if(n.teamCounts&&typeof n.teamCounts=="object"){const i=n.teamCounts;I.red=Q(i.red??i.r??i[0]??i[1]),I.green=Q(i.green??i.g??i[1]??i[2]),I.blue=Q(i.blue??i.b??i[2]??i[3])}else{const i=[];w.forEach(S=>{if(S!=null&&S.isFake)return;const q=ae(S);q!=null&&i.push(q)}),d.forEach(S=>{if(!(S!=null&&S.notInSquad))return;const q=ae(S);q!=null&&i.push(q)}),i.length===0&&d.forEach(S=>{const q=ae(S);q!=null&&i.push(q)});const D=new Set;i.forEach(S=>{typeof S=="number"&&D.add(S)});const B=D.has(0)?"zeroBased":D.has(3)?"oneBased":"zeroBased";if(i.forEach(S=>{const q=l(S,B);q&&(I[q]+=1)}),I.red+I.green+I.blue===0&&i.length>0){const S=new Map;i.forEach(we=>{const pe=String(we);S.set(pe,(S.get(pe)||0)+1)});const q=Array.from(S.values()).sort((we,pe)=>pe-we);I.red=q[0]||0,I.green=q[1]||0,I.blue=q[2]||0}I.red+I.green+I.blue===0&&(I.red=Math.max(y.length,d.filter(S=>S==null?void 0:S.notInSquad).length))}return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:xi(n,e),timestamp:F,mapName:v,duration:Si(n.durationMS),isWin:Re,squadCount:r.length,allyCount:C.length,enemyCount:y.length,teamCounts:I,alliesDown:r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.defenses)==null?void 0:B[0])==null?void 0:p.downCount)||0)},0),alliesDead:r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.defenses)==null?void 0:B[0])==null?void 0:p.deadCount)||0)},0),alliesRevived:r.reduce((i,D)=>{var B,p;return Number(((p=(B=D.statsAll)==null?void 0:B[0])==null?void 0:p.saved)||0)>0?i+1:i},0),rallies:0,enemyDeaths:Se,enemyDowns:Math.max(0,de-Se),totalOutgoingDamage:U,totalIncomingDamage:J,incomingBarrierAbsorbed:r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.defenses)==null?void 0:B[0])==null?void 0:p.damageBarrier)||0)},0),outgoingBarrierAbsorbed:r.reduce((i,D)=>{var S;const B=(S=D.extBarrierStats)==null?void 0:S.outgoingBarrier;if(!Array.isArray(B))return i;let p=0;return B.forEach(q=>{if(Array.isArray(q)){q.forEach(we=>{p+=Number((we==null?void 0:we.barrier)||0)});return}p+=Number((q==null?void 0:q.barrier)||0)}),i+p},0),squadClassCountsFight:k,allyClassCountsFight:h,enemyClassCounts:E}}).filter(Boolean),zi=(e,t)=>{const n=(t==null?void 0:t.skillMap)||{},d=(t==null?void 0:t.buffMap)||{};let r=0,C="";const w=U=>{const J=Number(U);if(!Number.isFinite(J))return String(U||"Unknown Skill");const Se=(n==null?void 0:n[`s${J}`])||(n==null?void 0:n[`${J}`]);if(Se!=null&&Se.name)return String(Se.name);const de=(d==null?void 0:d[`b${J}`])||(d==null?void 0:d[`${J}`]);return de!=null&&de.name?String(de.name):`Skill ${J}`},y=U=>{if(!U||typeof U!="object")return;const J=[Number(U.max),Number(U.maxDamage),Number(U.maxHit),Number(U.totalDamage)>0&&Number(U.connectedHits)>0?Number(U.totalDamage)/Number(U.connectedHits):0].filter(de=>Number.isFinite(de)),Se=J.length>0?Math.max(...J):0;Se>r&&(r=Se,C=w(U.id))};return Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(U=>{Array.isArray(U)&&U.forEach(J=>y(J))}),Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(U=>{Array.isArray(U)&&U.forEach(J=>{Array.isArray(J)&&J.forEach(Se=>y(Se))})}),{peak:r,skillName:C||"Unknown Skill"}},Ki=(()=>{const e=F=>String(F||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=F=>e(F).toLowerCase().split(/[^a-z0-9]+/i).map(v=>v.trim()).filter(Boolean).map(v=>v.length>3&&v.endsWith("s")?v.slice(0,-1):v),n=(F,v)=>{const I=e(F),Q=e(v);if(!Q)return I;if(!I)return Q;const ae=t(I),l=t(Q),u=new Set(ae),k=new Set(l),h=l.length>0&&l.every(i=>u.has(i)),E=ae.length>0&&ae.every(i=>k.has(i));return h||E?I:`${I} - ${Q}`},d=[],r=new Map,C=F=>{const v=h=>{if(!Array.isArray(h)||h.length===0)return[];const E=[];for(let i=0;i<h.length;i+=1){const D=Number(h[i]||0),B=i>0?Number(h[i-1]||0):0;E.push(Math.max(0,D-B))}return E},I=h=>{if(!Array.isArray(h))return[];const E=h.reduce((D,B)=>Math.max(D,Array.isArray(B)?B.length:0),0);if(E<=0)return[];const i=new Array(E).fill(0);return h.forEach(D=>{if(Array.isArray(D))for(let B=0;B<E;B+=1)i[B]+=Number(D[B]||0)}),i},Q=h=>Array.isArray(h)?h.map(E=>Number(E||0)):null,l=(h=>{if(!Array.isArray(h)||h.length===0)return null;const E=h[0];if(!Array.isArray(E))return null;if(Array.isArray(E[0])&&Array.isArray(E[0][0]))return I(E);if(Array.isArray(E[0])&&!Array.isArray(E[0][0])){const i=h.map(D=>Q(Array.isArray(D)?D[0]:null)).filter(D=>Array.isArray(D)&&D.length>0);if(i.length>0)return I(i)}return null})(F==null?void 0:F.targetDamage1S),u=Array.isArray(F==null?void 0:F.damage1S)&&Array.isArray(F.damage1S[0])?F.damage1S[0]:null,k=l||(Array.isArray(u)?u.map(h=>Number(h||0)):[]);return v(k)},w=(F,v)=>{if(!Array.isArray(F)||F.length===0||v<=0)return 0;let I=0,Q=0;for(let ae=0;ae<F.length;ae+=1)I+=Number(F[ae]||0),ae>=v&&(I-=Number(F[ae-v]||0)),ae>=v-1&&I>Q&&(Q=I);return Math.max(0,Q)},y=(F,v)=>{if(!Array.isArray(F)||F.length===0||v<=0)return[];const I=[];for(let Q=0;Q<F.length;Q+=v){const ae=Math.min(Q+v,F.length),l=F.slice(Q,ae).reduce((u,k)=>u+Number(k||0),0);I.push(l)}return I},U=(F,v)=>{const I=Number(F);if(!Number.isFinite(I))return{name:String(F||"Unknown Skill"),icon:void 0};const Q=(v==null?void 0:v.skillMap)||{},ae=(v==null?void 0:v.buffMap)||{},l=(Q==null?void 0:Q[`s${I}`])||(Q==null?void 0:Q[`${I}`]);if(l!=null&&l.name)return{name:String(l.name),icon:l==null?void 0:l.icon};const u=(ae==null?void 0:ae[`b${I}`])||(ae==null?void 0:ae[`${I}`]);return u!=null&&u.name?{name:String(u.name),icon:u==null?void 0:u.icon}:{name:`Skill ${I}`,icon:void 0}},J=F=>Array.isArray(F)?F.map(v=>Array.isArray(v)?[Number(v[0]),Number(v[1])]:v&&typeof v=="object"?[Number(v.time),Number(v.value)]:null).filter(v=>!!v&&Number.isFinite(v[0])&&v[0]>=0):[],Se=(F,v,I,Q,ae)=>{if(!F.length||Q<=0)return[];const l=Math.max(Q*5e3,ae||0),u=S=>S.reduce((q,we)=>we>=0&&we<=l+2e3?q+1:q,0),k=F.map(S=>Number(S||0)).filter(S=>Number.isFinite(S)&&S>=0);if(!k.length)return[];const h=[k],E=k.reduce((S,q)=>Math.max(S,q),0),i=k.reduce((S,q)=>Math.min(S,q),Number.POSITIVE_INFINITY);E>l*20&&h.push(k.map(S=>S/1e3)),E<=l*2&&i>=0&&E>0&&E<Math.max(120,Q*5+10)&&h.push(k.map(S=>S*1e3));let D=k,B=0,p=-1;return h.forEach(S=>{const q=S.reduce((pe,xe)=>Math.min(pe,xe),Number.POSITIVE_INFINITY),we=new Set([0,...v,...I]);if(Number.isFinite(q)&&l>0&&q>l){const pe=Math.floor(q/l)*l;we.add(pe),we.add(Math.max(0,pe-l))}we.forEach(pe=>{const xe=S.map(He=>He-pe),ce=u(xe);ce>p&&(p=ce,B=pe,D=S)})}),D.map(S=>S-B).filter(S=>Number.isFinite(S)&&S>=0)},de=(F,v,I,Q,ae)=>{const l=Se(F,v,I,Q,ae);return Array.from(new Set(l.map(u=>Math.floor(u/5e3)).filter(u=>Number.isFinite(u)&&u>=0&&u<Q)))};W.map(F=>({log:F,ts:Qe(F==null?void 0:F.details,F)})).sort((F,v)=>F.ts-v.ts).forEach(({log:F},v)=>{const I=F==null?void 0:F.details;if(!I)return;const Q=e(I.fightName||F.fightName||`Fight ${v+1}`),ae=Pt(I,F),l=n(Q,String(ae||"")),u={},k=Array.isArray(I.players)?I.players:[],h=k.flatMap(p=>{const S=p==null?void 0:p.combatReplayData;return Array.isArray(S)?S.map(q=>Number(q==null?void 0:q.start)):[Number(S==null?void 0:S.start)]}).filter(p=>Number.isFinite(p)&&p>=0);k.forEach(p=>{if(p!=null&&p.notInSquad)return;const S=String((p==null?void 0:p.account)||(p==null?void 0:p.name)||"Unknown"),q=String((p==null?void 0:p.character_name)||(p==null?void 0:p.display_name)||(p==null?void 0:p.name)||""),we=String((p==null?void 0:p.profession)||"Unknown"),pe=`${S}|${we}`,xe=zi(p,I),ce=Number(xe.peak||0),He=C(p),s=Number(w(He,1)||0),g=Number(w(He,5)||0),$=Number(w(He,30)||0),X=Math.max(0,Math.ceil(Number((I==null?void 0:I.durationMS)||0)/5e3)),K=Math.max(0,Math.ceil(He.length/5)),a=Math.max(X,K),N=y(He,5),T=Array.from({length:a},(H,M)=>Number(N[M]||0)),L=new Map,se=H=>{if(!H||typeof H!="object"||H.indirectDamage)return;const M=Number(H.totalDamage||0);if(!Number.isFinite(M)||M<=0)return;const Y=Number(H.connectedHits||H.hits||0),ne=U(H.id,I),ie=ne.name,fe=L.get(ie)||{skillName:ie,damage:0,hits:0,icon:ne.icon};fe.damage+=M,fe.hits+=Number.isFinite(Y)?Y:0,!fe.icon&&ne.icon&&(fe.icon=ne.icon),L.set(ie,fe)},Z=new Set;Array.isArray(p==null?void 0:p.targetDamageDist)&&p.targetDamageDist.forEach(H=>{Array.isArray(H)&&H.forEach(M=>{Array.isArray(M)&&M.forEach(Y=>{const ne=Number(Y==null?void 0:Y.id);Number.isFinite(ne)&&Z.add(ne),se(Y)})})}),Array.isArray(p==null?void 0:p.totalDamageDist)&&p.totalDamageDist.forEach(H=>{Array.isArray(H)&&H.forEach(M=>{const Y=Number(M==null?void 0:M.id);Number.isFinite(Y)&&Z.has(Y)||se(M)})});const O=(()=>{const H=p==null?void 0:p.combatReplayData;return Array.isArray(H)?H.filter(M=>M&&typeof M=="object"):H&&typeof H=="object"?[H]:[]})(),G=O.map(H=>Number(H==null?void 0:H.start)).filter(H=>Number.isFinite(H)&&H>=0),ee=O.flatMap(H=>J(H==null?void 0:H.down).map(([M])=>Number(M||0))),te=O.flatMap(H=>J(H==null?void 0:H.dead).map(([M])=>Number(M||0)));u[pe]={hit:ce,burst1s:s,burst5s:g,burst30s:$,skillName:xe.skillName,buckets5s:T,downIndices5s:de(ee,G,h,a,Number((I==null?void 0:I.durationMS)||0)),deathIndices5s:de(te,G,h,a,Number((I==null?void 0:I.durationMS)||0)),skillRows:Array.from(L.values()).sort((H,M)=>M.damage-H.damage).slice(0,50)};const R=r.get(pe)||{key:pe,account:S,displayName:S,characterName:q,profession:we,professionList:[we],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};R.logs+=1,R.professionList.includes(we)||R.professionList.push(we),!R.characterName&&q&&(R.characterName=q),ce>R.peakHit&&(R.peakHit=ce,R.peakFightLabel=l,R.peakSkillName=xe.skillName),s>R.peak1s&&(R.peak1s=s),g>R.peak5s&&(R.peak5s=g),$>R.peak30s&&(R.peak30s=$),r.set(pe,R)});const E=Object.values(u).reduce((p,S)=>Math.max(p,Number((S==null?void 0:S.hit)||0)),0),i=Object.values(u).reduce((p,S)=>Math.max(p,Number((S==null?void 0:S.burst1s)||0)),0),D=Object.values(u).reduce((p,S)=>Math.max(p,Number((S==null?void 0:S.burst5s)||0)),0),B=Object.values(u).reduce((p,S)=>Math.max(p,Number((S==null?void 0:S.burst30s)||0)),0);d.push({id:F.filePath||F.id||`fight-${v+1}`,shortLabel:`F${v+1}`,fullLabel:l,timestamp:Qe(I,F),values:u,maxHit:E,max1s:i,max5s:D,max30s:B})});const Re=Array.from(r.values()).sort((F,v)=>v.peakHit!==F.peakHit?v.peakHit-F.peakHit:F.displayName.localeCompare(v.displayName));return{fights:d,players:Re}})(),yi=(()=>{const e=l=>String(l||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=l=>e(l).toLowerCase().split(/[^a-z0-9]+/i).map(u=>u.trim()).filter(Boolean).map(u=>u.length>3&&u.endsWith("s")?u.slice(0,-1):u),n=(l,u)=>{const k=e(l),h=e(u);if(!h)return k;if(!k)return h;const E=t(k),i=t(h),D=new Set(E),B=new Set(i),p=i.length>0&&i.every(q=>D.has(q)),S=E.length>0&&E.every(q=>B.has(q));return p||S?k:`${k} - ${h}`},d=[],r=new Map,C=(l,u)=>{const k=Number(l);if(!Number.isFinite(k))return{name:String(l||"Unknown Skill"),icon:void 0};const h=(u==null?void 0:u.skillMap)||{},E=(u==null?void 0:u.buffMap)||{},i=(h==null?void 0:h[`s${k}`])||(h==null?void 0:h[`${k}`]);if(i!=null&&i.name)return{name:String(i.name),icon:i==null?void 0:i.icon};const D=(E==null?void 0:E[`b${k}`])||(E==null?void 0:E[`${k}`]);return D!=null&&D.name?{name:String(D.name),icon:D==null?void 0:D.icon}:{name:`Skill ${k}`,icon:void 0}},w=(l,u)=>{let k=0,h="";const E=i=>{if(!i||typeof i!="object"||i.indirectDamage)return;const D=[Number(i.max),Number(i.maxDamage),Number(i.maxHit),Number(i.totalDamage)>0&&Number(i.connectedHits)>0?Number(i.totalDamage)/Number(i.connectedHits):0].filter(p=>Number.isFinite(p)),B=D.length>0?Math.max(...D):0;B>k&&(k=B,h=C(i.id,u).name)};return Array.isArray(l==null?void 0:l.totalDamageDist)&&l.totalDamageDist.forEach(i=>{Array.isArray(i)&&i.forEach(D=>E(D))}),Array.isArray(l==null?void 0:l.targetDamageDist)&&l.targetDamageDist.forEach(i=>{Array.isArray(i)&&i.forEach(D=>{Array.isArray(D)&&D.forEach(B=>E(B))})}),{peak:k,skillName:h||"Unknown Skill"}},y=l=>{if(!Array.isArray(l)||l.length===0)return[];const u=[];for(let k=0;k<l.length;k+=1){const h=Number(l[k]||0),E=k>0?Number(l[k-1]||0):0;u.push(Math.max(0,h-E))}return u},U=l=>{if(!Array.isArray(l)||l.length===0)return[];const u=l.reduce((h,E)=>Math.max(h,Array.isArray(E)?E.length:0),0);if(u<=0)return[];const k=new Array(u).fill(0);return l.forEach(h=>{if(Array.isArray(h))for(let E=0;E<u;E+=1)k[E]+=Number(h[E]||0)}),k},J=l=>{if(!Array.isArray(l)||l.length===0)return[];const u=l[0];if(typeof u=="number")return l.map(k=>Number(k||0));if(Array.isArray(u)&&u.length>0){if(typeof u[0]=="number")return u.map(k=>Number(k||0));if(Array.isArray(u[0])){const k=u.map(h=>Array.isArray(h)?h.map(E=>Number(E||0)):null).filter(h=>Array.isArray(h)&&h.length>0);if(k.length>0)return U(k)}}return[]},Se=l=>{const u=J(l==null?void 0:l.powerDamage1S),k=J(l==null?void 0:l.damage1S),h=u.length>0?u:k;return y(h)},de=(l,u)=>{const k=l==null?void 0:l.targetPowerDamage1S;if(!Array.isArray(k)||!Array.isArray(k[u]))return[];const h=k[u];if(!Array.isArray(h)||h.length===0)return[];if(typeof h[0]=="number")return h.map(E=>Number(E||0));if(Array.isArray(h[0])&&!Array.isArray(h[0][0]))return h[0].map(E=>Number(E||0));if(Array.isArray(h[0])&&Array.isArray(h[0][0])){const i=h[0].map(D=>Array.isArray(D)?D.map(B=>Number(B||0)):null).filter(D=>Array.isArray(D)&&D.length>0);return U(i)}return[]},Re=(l,u)=>{if(!Array.isArray(l)||l.length===0||u<=0)return 0;let k=0,h=0;for(let E=0;E<l.length;E+=1)k+=Number(l[E]||0),E>=u&&(k-=Number(l[E-u]||0)),E>=u-1&&k>h&&(h=k);return Math.max(0,h)},F=(l,u)=>{if(!Array.isArray(l)||l.length===0||u<=0)return[];const k=[];for(let h=0;h<l.length;h+=u){const E=Math.min(h+u,l.length),i=l.slice(h,E).reduce((D,B)=>D+Number(B||0),0);k.push(i)}return k},v=l=>Array.isArray(l)?l.map(u=>Array.isArray(u)?[Number(u[0]),Number(u[1])]:u&&typeof u=="object"?[Number(u.time),Number(u.value)]:null).filter(u=>!!u&&Number.isFinite(u[0])&&u[0]>=0):[],I=(l,u,k,h,E)=>{if(!l.length||h<=0)return[];const i=Math.max(h*5e3,E||0),D=ce=>ce.reduce((He,s)=>s>=0&&s<=i+2e3?He+1:He,0),B=l.map(ce=>Number(ce||0)).filter(ce=>Number.isFinite(ce)&&ce>=0);if(!B.length)return[];const p=[B],S=B.reduce((ce,He)=>Math.max(ce,He),0),q=B.reduce((ce,He)=>Math.min(ce,He),Number.POSITIVE_INFINITY);S>i*20&&p.push(B.map(ce=>ce/1e3)),S<=i*2&&q>=0&&S>0&&S<Math.max(120,h*5+10)&&p.push(B.map(ce=>ce*1e3));let we=B,pe=0,xe=-1;return p.forEach(ce=>{const He=ce.reduce((g,$)=>Math.min(g,$),Number.POSITIVE_INFINITY),s=new Set([0,...u,...k]);if(Number.isFinite(He)&&i>0&&He>i){const g=Math.floor(He/i)*i;s.add(g),s.add(Math.max(0,g-i))}s.forEach(g=>{const $=ce.map(K=>K-g),X=D($);X>xe&&(xe=X,pe=g,we=ce)})}),we.map(ce=>ce-pe).filter(ce=>Number.isFinite(ce)&&ce>=0)},Q=(l,u,k,h,E)=>{const i=I(l,u,k,h,E);return Array.from(new Set(i.map(D=>Math.floor(D/5e3)).filter(D=>Number.isFinite(D)&&D>=0&&D<h)))};W.map(l=>({log:l,ts:Qe(l==null?void 0:l.details,l)})).sort((l,u)=>l.ts-u.ts).forEach(({log:l},u)=>{const k=l==null?void 0:l.details;if(!k)return;const h=e(k.fightName||l.fightName||`Fight ${u+1}`),E=Pt(k,l),i=n(h,String(E||"")),D={},p=(Array.isArray(k.players)?k.players:[]).filter(a=>!(a!=null&&a.notInSquad)),S=p.flatMap(a=>{const N=a==null?void 0:a.combatReplayData;return Array.isArray(N)?N.map(T=>Number(T==null?void 0:T.start)):[Number(N==null?void 0:N.start)]}).filter(a=>Number.isFinite(a)&&a>=0),q=p.flatMap(a=>{const N=a==null?void 0:a.combatReplayData;return(Array.isArray(N)?N:N?[N]:[]).flatMap(L=>v(L==null?void 0:L.down).map(([se])=>Number(se||0)))}),we=p.flatMap(a=>{const N=a==null?void 0:a.combatReplayData;return(Array.isArray(N)?N:N?[N]:[]).flatMap(L=>v(L==null?void 0:L.dead).map(([se])=>Number(se||0)))}),pe=new Map,xe=new Map,ce=new Map;(Array.isArray(k.targets)?k.targets:[]).forEach((a,N)=>{if(!a||a.isFake||!a.enemyPlayer)return;const T=at((a==null?void 0:a.profession)||(a==null?void 0:a.name)||(a==null?void 0:a.id))||"Unknown";ce.set(T,(ce.get(T)||0)+1);const L=xe.get(T)||new Map;Array.isArray(a==null?void 0:a.totalDamageDist)&&a.totalDamageDist.forEach(te=>{Array.isArray(te)&&te.forEach(R=>{if(!R||typeof R!="object"||R.indirectDamage)return;const H=Number(R.totalDamage||0);if(!Number.isFinite(H)||H<=0)return;const M=Number(R.connectedHits||R.hits||0),Y=C(R.id,k),ne=Y.name,ie=L.get(ne)||{skillName:ne,damage:0,hits:0,icon:Y.icon};ie.damage+=H,ie.hits+=Number.isFinite(M)?M:0,!ie.icon&&Y.icon&&(ie.icon=Y.icon),L.set(ne,ie)})}),xe.set(T,L);const se=U(p.map(te=>de(te,N))),Z=se.length>0?y(se):Se(a),O=w(a,k);let G=pe.get(T);G||(G={perSecond:[],hit:0,skillName:""},pe.set(T,G)),Z.length>G.perSecond.length&&(G.perSecond.length=Z.length);for(let te=0;te<Z.length;te+=1)G.perSecond[te]=Number(G.perSecond[te]||0)+Number(Z[te]||0);const ee=Number(O.peak||0);ee>G.hit&&(G.hit=ee,G.skillName=O.skillName||"Unknown Skill")});const s=Array.from(pe.values()).some(a=>Array.isArray(a.perSecond)&&a.perSecond.some(N=>Number(N||0)>0));if(pe.size===0||!s){const a=U(p.map(T=>{const L=J(T==null?void 0:T.powerDamageTaken1S);return y(L)})),N=Array.from(ce.values()).reduce((T,L)=>T+Number(L||0),0);a.length>0&&N>0&&ce.forEach((T,L)=>{const se=Number(T||0)/N,Z=a.map(G=>Number(G||0)*se),O=pe.get(L);pe.set(L,{perSecond:Z,hit:Number((O==null?void 0:O.hit)||0),skillName:String((O==null?void 0:O.skillName)||"")})})}pe.forEach((a,N)=>{var Y;const T=N,L=Number(a.hit||0),se=Number(Re(a.perSecond,1)||0),Z=Number(Re(a.perSecond,5)||0),O=Number(Re(a.perSecond,30)||0),G=Math.max(0,Math.ceil(Number((k==null?void 0:k.durationMS)||0)/5e3)),ee=Math.max(0,Math.ceil(a.perSecond.length/5)),te=Math.max(G,ee),R=F(a.perSecond,5),H=Array.from({length:te},(ne,ie)=>Number(R[ie]||0));D[T]={hit:L,burst1s:se,burst5s:Z,burst30s:O,skillName:a.skillName||"Unknown Skill",buckets5s:H,downIndices5s:Q(q,[],S,te,Number((k==null?void 0:k.durationMS)||0)),deathIndices5s:Q(we,[],S,te,Number((k==null?void 0:k.durationMS)||0)),skillRows:Array.from(((Y=xe.get(N))==null?void 0:Y.values())||[]).sort((ne,ie)=>ie.damage-ne.damage).slice(0,50)};const M=r.get(T)||{key:T,account:N,displayName:N,characterName:"",profession:N,professionList:[N],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};M.logs+=1,L>M.peakHit&&(M.peakHit=L,M.peakFightLabel=i,M.peakSkillName=a.skillName||"Unknown Skill"),se>M.peak1s&&(M.peak1s=se),Z>M.peak5s&&(M.peak5s=Z),O>M.peak30s&&(M.peak30s=O),r.set(T,M)});const g=Object.values(D).reduce((a,N)=>Math.max(a,Number((N==null?void 0:N.hit)||0)),0),$=Object.values(D).reduce((a,N)=>Math.max(a,Number((N==null?void 0:N.burst1s)||0)),0),X=Object.values(D).reduce((a,N)=>Math.max(a,Number((N==null?void 0:N.burst5s)||0)),0),K=Object.values(D).reduce((a,N)=>Math.max(a,Number((N==null?void 0:N.burst30s)||0)),0);d.push({id:l.filePath||l.id||`fight-${u+1}`,shortLabel:`F${u+1}`,fullLabel:i,timestamp:Qe(k,l),values:D,maxHit:g,max1s:$,max5s:X,max30s:K})});const ae=Array.from(r.values()).sort((l,u)=>u.peakHit!==l.peakHit?u.peakHit-l.peakHit:l.displayName.localeCompare(u.displayName));return{fights:d,players:ae}})(),Gi=Array.from(Xe.entries()).map(([e,t])=>{const n=tt.get(e)||{},d=Array.from(t.values()).map(r=>{var Re,F;const C=Array.from(r.professions||[]).filter(v=>v&&v!=="Unknown");let w=r.profession||"Unknown";if(C.length>0){w=C[0];let v=((Re=r.professionTimeMs)==null?void 0:Re[w])||0;C.forEach(I=>{var ae;const Q=((ae=r.professionTimeMs)==null?void 0:ae[I])||0;Q>v&&(v=Q,w=I)})}const y=r.durationMs||0,U=r.totalMs/1e3,J=y>0?r.totalMs/y:0,Se=((F=Ae.get(r.account))==null?void 0:F.supportActiveMs)||y,de=Se>0?r.uptimeMs/Se:0;return{account:r.account,profession:w,professionList:C,total:U,perSecond:J,uptimePerSecond:de,duration:y/1e3}}).filter(r=>r.total>0||r.perSecond>0);return{id:e,name:n.name||e,icon:n.icon,rows:d}}).filter(e=>e.rows.length>0),Yi=Array.from(je.values()).map(e=>{const t=Array.from(e.skills.values()).sort((d,r)=>r.damage-d.damage),n=t.reduce((d,r)=>(d[r.id]=r,d),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t,skillMap:n}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:V,wins:ke,losses:x,avgSquadSize:Mi,avgEnemies:wi,squadKDR:vi,enemyKDR:Ei,totalSquadKills:Ne,totalSquadDeaths:me,totalEnemyKills:ge,totalEnemyDeaths:_e,leaderboards:Pe,...Hi,outgoingConditionSummary:Object.values(Ie).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values($e).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:Ui,topIncomingSkills:$i,playerSkillBreakdowns:Yi,topSkillsMetric:_,mapData:Ri,timelineData:_i,boonTables:Oi,offensePlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:Fi,damageMitigationMinions:Bi,supportPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:jt,silver:Dn,bronze:Nn,squadClassData:qi,enemyClassData:Wi,fightBreakdown:Vi,spikeDamage:Ki,incomingStrikeDamage:yi,specialTables:Gi,topStatsPerSecond:Ze,topStatsLeaderboardsPerSecond:Je,avgMvpScore:An}})(),We=(()=>{const De=new Map,Ce=new Map,_=[],V=new Map,ke=new Map;W.forEach(le=>{const ue=le.details;if(!ue)return;const me=ue.skillMap||{},Ne=ue.fightName||"Log",_e=Qe(ue,le)||Date.now(),ge={id:le.filePath||le.id||Ne,label:Ne,timestamp:_e,skillEntries:{},playerActiveSeconds:{},durationSeconds:ue.durationMS?ue.durationMS/1e3:0};(ue.players||[]).forEach(Be=>{if(Be.notInSquad)return;const Ae=Be.account||Be.name||"Unknown",qe=Be.profession||"Unknown",Te=`${Ae}|${qe}`;let Me=Ce.get(Te);Me||(Me={key:Te,account:Ae,displayName:Ae,profession:qe,professionList:[qe],logs:0,totalActiveSeconds:0,skillTotals:{}},Ce.set(Te,Me)),Me.logs++;const je=(Array.isArray(Be.activeTimes)?Be.activeTimes[0]:0)/1e3;Me.totalActiveSeconds=(Me.totalActiveSeconds||0)+je,ge.playerActiveSeconds[Te]=je,(Be.rotation||[]).forEach(Ie=>{var Tt,Mt,wt;if(!(Ie!=null&&Ie.id))return;const $e=((Tt=Ie.skills)==null?void 0:Tt.length)||0;if($e<=0)return;const Fe=`s${Ie.id}`,tt=((Mt=me[Fe])==null?void 0:Mt.name)||`Skill ${Ie.id}`,Xe=(wt=me[Fe])==null?void 0:wt.icon;Me.skillTotals[Fe]=(Me.skillTotals[Fe]||0)+$e,De.set(Fe,(De.get(Fe)||0)+$e),V.set(Fe,tt),Xe&&!ke.has(Fe)&&ke.set(Fe,Xe),ge.skillEntries[Fe]||(ge.skillEntries[Fe]={name:tt,icon:Xe,players:{}}),!ge.skillEntries[Fe].icon&&Xe&&(ge.skillEntries[Fe].icon=Xe),ge.skillEntries[Fe].players[Te]=(ge.skillEntries[Fe].players[Te]||0)+$e})}),_.push(ge)});const x=Array.from(De.entries()).map(([le,ue])=>({id:le,name:V.get(le)||le,total:ue,icon:ke.get(le)})).sort((le,ue)=>ue.total-le.total);return{logRecords:_,players:Array.from(Ce.values()),skillOptions:x,resUtilitySkills:[]}})();return{validLogs:W,stats:Le,skillUsageData:We}};let Ye=null,mt=!1,sn=null,an=0,rn=0,Lt=null;const cn=o=>{if(!o||typeof o!="object")return o;const c=(P,j)=>{const W={};return j.forEach(he=>{P&&Object.prototype.hasOwnProperty.call(P,he)&&(W[he]=P[he])}),W},m=c(o,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(m.players)&&(m.players=m.players.map(P=>c(P,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","powerDamageTaken1S","targetPowerDamage1S","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(m.targets)&&(m.targets=m.targets.map(P=>c(P,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist","powerDamage1S","damage1S"]))),m},Ni=o=>{if(!o||typeof o!="object")return o;const c={...o};return o.details?c.details=cn(o.details):c.details=cn(o),c},ln=()=>{if(!mt||!Ye)return;mt=!1,an+=1;const o=Lt;Lt=null;const c=Di(Ye);self.postMessage({type:"result",result:c,computeId:an,logCount:Ye.logs.length,token:rn,completedAt:Date.now(),flushId:o})},xt=()=>{sn===null&&(sn=setInterval(()=>{ln()},5e3))};self.onmessage=o=>{var m,P,j,W;const c=o.data;if((c==null?void 0:c.type)==="reset"){Ye={logs:[]},typeof c.token=="number"&&(rn=c.token),mt=!0,xt();return}if((c==null?void 0:c.type)==="settings"){Ye={logs:(Ye==null?void 0:Ye.logs)||[],precomputedStats:(m=c.payload)==null?void 0:m.precomputedStats,mvpWeights:(P=c.payload)==null?void 0:P.mvpWeights,statsViewSettings:(j=c.payload)==null?void 0:j.statsViewSettings,disruptionMethod:(W=c.payload)==null?void 0:W.disruptionMethod},mt=!0,xt();return}if((c==null?void 0:c.type)==="log"){Ye||(Ye={logs:[]}),Ye.logs.push(Ni(c.payload)),mt=!0,xt();return}(c==null?void 0:c.type)==="flush"&&(typeof c.flushId=="number"&&(Lt=c.flushId),mt=!0,ln())}})();
