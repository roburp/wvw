(function(){"use strict";const Yt=["selfBuffs","groupBuffs","squadBuffs"],Jt=o=>o!=null&&o.classification?o.classification==="Boon":!0,Qt=o=>`b${o}`,Rn=(o,c)=>{const m=Array.isArray(o==null?void 0:o.activeTimes)?o.activeTimes:[],P=typeof m[0]=="number"?m[0]:0;return P>0?P:c},Xt=(o,c,m,P,j,W,pe)=>{const te=o==="selfBuffs"?1:Math.max(o==="groupBuffs"?W-1:pe-1,0);return!te||!j?{generationMs:0,wastedMs:0}:c?{generationMs:m*j*te,wastedMs:P*j*te}:{generationMs:m/100*j*te,wastedMs:P/100*j*te}},On=o=>{const c=new Map,m=new Map;return o.forEach(W=>{const pe=W.details;if(!pe)return;const te=pe.durationMS||0,he=pe.buffMap||{};Object.entries(he).forEach(([O,y])=>{if(!c.has(O)){c.set(O,y);return}const be=c.get(O)||{},x={name:be.name||y.name,stacking:be.stacking??y.stacking,icon:be.icon||y.icon,classification:be.classification||y.classification};c.set(O,x)});const We=(pe.players||[]).filter(O=>!O.notInSquad),Ce=We.length,Se=new Map;We.forEach(O=>{const y=O.group??0;Se.set(y,(Se.get(y)||0)+1)}),We.forEach(O=>{const y=O.account||O.name||O.character_name||"Unknown",be=O.profession||"Unknown",x=O.group??0,le=Se.get(x)||1,ue=Rn(O,te);m.has(y)||m.set(y,{account:y,profession:be,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const me=m.get(y);me.profession=be,be!=="Unknown"&&(me.professions.add(be),me.professionTimeMs[be]=(me.professionTimeMs[be]||0)+ue),me.activeTimeMs+=ue,me.numFights+=1,me.groupSupported+=le,me.squadSupported+=Ce,Yt.forEach(De=>{(O[De]||[]).forEach(fe=>{var Ie,$e,Ee,tt;if(typeof(fe==null?void 0:fe.id)!="number")return;const Ue=Qt(fe.id),Be=he[Ue];if(!Jt(Be))return;const Ne=(Be==null?void 0:Be.stacking)??!1,_e=(($e=(Ie=fe.buffData)==null?void 0:Ie[0])==null?void 0:$e.generation)??0,Ae=((tt=(Ee=fe.buffData)==null?void 0:Ee[0])==null?void 0:tt.wasted)??0,{generationMs:Te,wastedMs:qe}=Xt(De,Ne,_e,Ae,te,le,Ce);!Te&&!qe||(c.has(Ue)||c.set(Ue,Be||{}),me.boons[Ue]||(me.boons[Ue]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),me.boons[Ue][De].generationMs+=Te,me.boons[Ue][De].wastedMs+=qe)})})})}),{boonTables:Array.from(c.keys()).filter(W=>Jt(c.get(W))).map(W=>{const pe=c.get(W)||{},te=[];return m.forEach(he=>{var O;const Le=he.boons[W];if(!Le||!Yt.some(y=>Le[y].generationMs>0||Le[y].wastedMs>0))return;const Ce=Array.from(he.professions||[]).filter(y=>y&&y!=="Unknown");let Se=he.profession;if(Ce.length>0){Se=Ce[0];let y=((O=he.professionTimeMs)==null?void 0:O[Se])||0;Ce.forEach(be=>{var le;const x=((le=he.professionTimeMs)==null?void 0:le[be])||0;x>y&&(y=x,Se=be)})}te.push({account:he.account,profession:Se||"Unknown",professionList:Ce,activeTimeMs:he.activeTimeMs||1,numFights:he.numFights||1,groupSupported:he.groupSupported||1,squadSupported:he.squadSupported||1,categories:{selfBuffs:{...Le.selfBuffs},groupBuffs:{...Le.groupBuffs},squadBuffs:{...Le.squadBuffs}}})}),{id:W,name:pe.name||W,icon:pe.icon,stacking:pe.stacking??!1,rows:te}}).filter(W=>W.rows.length>0)}},Zt=(o,c,m,P,j,W,pe={})=>{var O,y,be,x;const he=((o==null?void 0:o[c])||[]).find(le=>le.id===m);if(!he)return{generationMs:0,wastedMs:0};const Le=pe[Qt(m)],We=(Le==null?void 0:Le.stacking)??!1,Ce=((y=(O=he.buffData)==null?void 0:O[0])==null?void 0:y.generation)??0,Se=((x=(be=he.buffData)==null?void 0:be[0])==null?void 0:x.wasted)??0;return Xt(c,We,Ce,Se,P,j,W)};var _n={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const qn=_n,$t="count",jn=o=>(o||0)/1e3,Wn=(o,c)=>{var j;if(!o)return 0;const m=(j=qn.methods.tiered)==null?void 0:j.tiers;if(!m)return o;const P=c/Math.max(o,1);return P<=m.shortMs?o*m.weights.short:P<=m.mediumMs?o*m.weights.medium:o*m.weights.long},en=(o,c,m)=>m==="duration"?jn(c):m==="tiered"?Wn(o,c):o;function yn(o,c=$t){var W;const m=(W=o.statsAll)==null?void 0:W[0],P=Number((m==null?void 0:m.appliedCrowdControl)??0),j=Number((m==null?void 0:m.appliedCrowdControlDuration)??0);return en(P,j,c)}function Vn(o,c){const m=(c==null?void 0:c.durationMS)||0,P=(c==null?void 0:c.buffMap)||{},j=o.filter(te=>!te.notInSquad),W=j.length,pe=new Map;j.forEach(te=>{const he=te.group??0;pe.set(he,(pe.get(he)||0)+1)}),j.forEach(te=>{const he=pe.get(te.group??0)||1,Le=Zt(te,"selfBuffs",1122,m,he,W,P),We=Zt(te,"squadBuffs",1122,m,he,W,P);te.stabGeneration=(Le.generationMs+We.generationMs)/1e3})}function zn(o){if(!o.statsTargets)return 0;let c=0;for(const m of o.statsTargets)m&&m.length>0&&(c+=m[0].downContribution||0);return c}function Kn(o){if(!o.extBarrierStats||!o.extBarrierStats.outgoingBarrierAllies)return 0;let c=0;for(const m of o.extBarrierStats.outgoingBarrierAllies)if(m)for(const P of m)P&&(c+=P.barrier||0);return c}function Gn(o){if(!o.extHealingStats||!o.extHealingStats.outgoingHealingAllies)return 0;let c=0;for(const m of o.extHealingStats.outgoingHealingAllies)if(m)for(const P of m)P&&(c+=P.healing||0);return c}const Yn=o=>{var c,m,P,j;return(((m=(c=o.support)==null?void 0:c[0])==null?void 0:m.condiCleanse)||0)+(((j=(P=o.support)==null?void 0:P[0])==null?void 0:j.condiCleanseSelf)||0)},Jn=(o,c=$t)=>{var W;const m=(W=o.support)==null?void 0:W[0],P=Number((m==null?void 0:m.boonStrips)??0),j=Number((m==null?void 0:m.boonStripsTime)??0);return en(P,j,c)},Qn=o=>zn(o),Xn=o=>Gn(o),Zn=o=>Kn(o),ei=(o,c=$t)=>yn(o,c),ti=(o,c)=>Vn(o,c),ni="count",ii={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},oi={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},tn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),si={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},ft=o=>{if(!o)return null;const c=o.trim().toLowerCase(),m=tn.get(c);if(m)return m;const P=c.split(/[^a-z]+/).filter(Boolean);for(const j of P){const W=tn.get(j);if(W)return W}return null},ai=o=>ft(o),nn=o=>{const c=new Map;return o&&(Object.values(o).forEach(m=>{if(!(m!=null&&m.icon)||!(m!=null&&m.name))return;const P=ft(m.name);P&&(c.has(P)||c.set(P,m.icon))}),Object.entries(si).forEach(([m,P])=>{c.has(m)||c.set(m,P)})),c},Nt=(o,c,m)=>{var P;if(c&&m){const j=(P=m[`b${c}`])==null?void 0:P.name,W=ft(j);if(W)return W}return o?ft(o):null},ri=o=>{const c=(o==null?void 0:o.account)||"Unknown";return c&&c!=="Unknown"?c:(o==null?void 0:o.name)||"Unknown"||null},ci=o=>{if(!o||o.length===0)return 0;let c=0,m=null;return o.forEach(P=>{const j=Number(P[1]??0);if(Number.isFinite(j)){if(m===null){m=j;return}j>m&&(c+=j-m),m=j}}),c},li=o=>{if(!o||o.length===0)return 0;let c=0;return o.forEach(m=>{const P=Number(m[0]??0),j=Number(m[1]??0);Number.isFinite(j)&&P!==0&&j>0&&(c+=1)}),c},ui=o=>{const{players:c,targets:m,skillMap:P,buffMap:j}=o,W=o.getPlayerKey||ri,pe=nn(j),te={},he={};c.forEach(O=>{if(O!=null&&O.notInSquad)return;const y=W(O);y&&(te[y]||(te[y]={}),O!=null&&O.totalDamageDist&&O.totalDamageDist.forEach(be=>{be&&be.forEach(x=>{if(!x.id)return;let le=`Skill ${x.id}`,ue;P&&(P[`s${x.id}`]?(le=P[`s${x.id}`].name||le,ue=P[`s${x.id}`].icon||ue):P[`${x.id}`]&&(le=P[`${x.id}`].name||le,ue=P[`${x.id}`].icon||ue));const me=Nt(le,x.id,j);if(!me)return;const De=j==null?void 0:j[`b${x.id}`],Oe=De==null?void 0:De.name,fe=pe.get(me)||(De==null?void 0:De.icon),Ue=le.startsWith("Skill ")?Oe||me:le,Be=ue||(De==null?void 0:De.icon),Ne=Number(x.connectedHits??0),_e=Number(x.hits??0),Ae=Ne>0?Ne:_e,Te=Number(x.totalDamage??0);if(!Number.isFinite(Ae)&&!Number.isFinite(Te))return;const qe=he[me]||{name:me,icon:fe,applications:0,damage:0};qe.applications+=Number.isFinite(Ae)?Ae:0,qe.damage+=Number.isFinite(Te)?Te:0,!qe.icon&&fe&&(qe.icon=fe),he[me]=qe;const Ie=te[y][me]||{icon:fe,applications:0,damage:0,skills:{}};Ie.applications+=Number.isFinite(Ae)?Ae:0,Ie.damage+=Number.isFinite(Te)?Te:0;const $e=Ie.skills[Ue]||{name:Ue,hits:0,damage:0,icon:Be};$e.hits+=Number.isFinite(Ae)?Ae:0,$e.damage+=Number.isFinite(Te)?Te:0,!$e.icon&&Be&&($e.icon=Be),Ie.skills[Ue]=$e,!Ie.icon&&fe&&(Ie.icon=fe),te[y][me]=Ie})}))});const Le=new Map;c.forEach(O=>{if(O!=null&&O.notInSquad)return;const y=W(O);y&&O!=null&&O.name&&Le.set(O.name,y)});let We=0,Ce=0,Se=0;return m.forEach(O=>{O!=null&&O.buffs&&O.buffs.forEach(y=>{const be=Number(y==null?void 0:y.id);if(!Number.isFinite(be))return;const x=j==null?void 0:j[`b${be}`],le=ft(x==null?void 0:x.name);if(!le||x!=null&&x.classification&&x.classification!=="Condition")return;const ue=le;if(!ue)return;const me=y.statesPerSource||{};Se+=1,Object.entries(me).forEach(([De,Oe])=>{var Ae;const fe=Le.get(De);if(!fe)return;Ce+=1;const Ue=ci(Oe),Be=li(Oe);We+=Ue;const Ne=((Ae=te[fe])==null?void 0:Ae[ue])||{applications:0,damage:0,skills:{}};Ne.applicationsFromBuffs=(Ne.applicationsFromBuffs||0)+Ue,Ne.applicationsFromBuffsActive=(Ne.applicationsFromBuffsActive||0)+Be,te[fe]=te[fe]||{},te[fe][ue]=Ne;const _e=he[ue]||{name:ue,applications:0,damage:0};_e.applicationsFromBuffs=(_e.applicationsFromBuffs||0)+Ue,_e.applicationsFromBuffsActive=(_e.applicationsFromBuffsActive||0)+Be,he[ue]=_e})})}),Object.values(te).forEach(O=>{Object.values(O).forEach(y=>{typeof y.applicationsFromBuffs=="number"&&(y.applications=y.applicationsFromBuffs)})}),Object.values(he).forEach(O=>{typeof O.applicationsFromBuffs=="number"&&(O.applications=O.applicationsFromBuffs)}),{playerConditions:te,summary:he,meta:{buffStateApplicationsTotal:We,targetBuffEntriesSeen:Se,buffStateSourcesSeen:Ce}}},mi=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),di=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],fi=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],gi=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],pi=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],hi=new Set([10244]),bi=(o,c)=>{var j;if(hi.has(o))return!0;const m=(c==null?void 0:c[`s${o}`])||(c==null?void 0:c[`${o}`]),P=((j=m==null?void 0:m.name)==null?void 0:j.toLowerCase())||"";return pi.some(W=>P.includes(W))},ki=o=>{if(!o||!Number.isFinite(o))return"--:--";const c=Math.max(0,Math.round(o/1e3)),m=Math.floor(c/3600),P=Math.floor(c%3600/60),j=c%60;return m>0?`${m}:${String(P).padStart(2,"0")}:${String(j).padStart(2,"0")}`:`${P}:${String(j).padStart(2,"0")}`},At={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function on(o){return At[o]||At.Unknown}const Si=o=>{if(o==null||o==="")return 0;if(typeof o=="number")return!Number.isFinite(o)||o<=0?0:o>1e12?o:o*1e3;if(o instanceof Date){const pe=o.getTime();return Number.isFinite(pe)&&pe>0?pe:0}const c=String(o).trim();if(!c)return 0;const m=Number(c);if(Number.isFinite(m)&&m>0)return m>1e12?m:m*1e3;const P=Date.parse(c);if(Number.isFinite(P)&&P>0)return P;const j=c.replace(/([+-]\d{2})$/,"$1:00"),W=Date.parse(j);return Number.isFinite(W)&&W>0?W:0},Qe=(o,c)=>Si((o==null?void 0:o.uploadTime)??(c==null?void 0:c.uploadTime)??(o==null?void 0:o.timeStartStd)??(o==null?void 0:o.timeStart)??(o==null?void 0:o.timeEndStd)??(o==null?void 0:o.timeEnd)??(o==null?void 0:o.timeStartText)??(o==null?void 0:o.timeEndText)),Ci=({logs:o,precomputedStats:c,mvpWeights:m,statsViewSettings:P,disruptionMethod:j})=>{const W=(()=>{const Ce=o.filter(Se=>Se.details&&Se.details.players&&Se.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:o.length,passed:Ce.length,statuses:o.map(Se=>Se.status),hasDetails:o.map(Se=>!!Se.details)}),Ce})(),pe=P||oi,te=m||ii,he=Ce=>{if(!Ce||typeof Ce!="object")return Ce;const Se=Array.isArray(Ce.fightBreakdown)?Ce.fightBreakdown:null;if(!Se||Se.length===0)return Ce;const O=new Map,y=new Map;o.forEach(x=>{var me;const le=(x==null?void 0:x.filePath)||(x==null?void 0:x.id);le&&O.set(String(le),x);const ue=(x==null?void 0:x.permalink)||((me=x==null?void 0:x.details)==null?void 0:me.permalink);typeof ue=="string"&&ue.trim()&&y.set(ue.trim(),x)});const be=Se.map(x=>{if(!x||typeof x!="object"||Number(x.timestamp)>0)return x;const ue=x.id?String(x.id):"",me=typeof x.permalink=="string"?x.permalink.trim():"",De=(ue?O.get(ue):void 0)||(me?y.get(me):void 0);if(!De)return x;const Oe=Qe(De==null?void 0:De.details,De);return Oe?{...x,timestamp:Oe}:x});return{...Ce,fightBreakdown:be}},Le=(()=>{if(c)return he(c);const Ce=j||ni,Se=pe.topSkillDamageSource||"target",O=pe.topSkillsMetric||"damage",y=W.length;let be=0,x=0,le=0,ue=0,me=0,De=0,Oe=0,fe=0;const Ue=e=>{const n=((e==null?void 0:e.players)||[]).filter(K=>!K.notInSquad);let d=0,r=0,C=0,M=0;return n.forEach(K=>{var de;const U=(de=K.defenses)==null?void 0:de[0];if(!U)return;const Y=Number(U.downCount||0),ke=Number(U.deadCount||0);d+=Y+ke,C+=ke}),n.forEach(K=>{!K.statsTargets||K.statsTargets.length===0||K.statsTargets.forEach(U=>{const Y=U==null?void 0:U[0];if(!Y)return;const ke=Number(Y.downed||0),de=Number(Y.killed||0);r+=ke+de,M+=de})}),{squadDownsDeaths:d,enemyDownsDeaths:r,squadDeaths:C,enemyDeaths:M}},Be=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:n}=Ue(e);return t>0||n>0?n>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},Ne=new Map,_e=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),Ae={},Te={},qe=new Map,Ie={},$e={},Ee={},tt=new Map,Xe=new Map,Tt=new Set(Object.keys(At)),Mt=Object.keys(At).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),wt=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],at=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Tt.has(t))return t;const n=t.toLowerCase();for(const r of Mt)if(n.includes(r.toLowerCase()))return r;return wt.find(r=>n.includes(r.toLowerCase()))||t||"Unknown"},Ni=e=>e!=null&&e.classification?e.classification==="Boon":!0,vt=new Map,Et=new Map,gt=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),re=e=>{const t=Number(e);return Number.isFinite(t)?t:0},un=e=>{const t=String(e).split("|"),n=t[0]||"Unknown",d=at(t[1]||"Unknown"),r=t[2]||n||"Unknown";return{name:n,profession:d,account:r}},mn=(e,t,n)=>{let d=e.get(t);return d?n.profession&&!d.professionList.includes(n.profession)&&d.professionList.push(n.profession):(d={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt()},e.set(t,d)),d},dn=(e,t,n)=>{let d=e.get(t);return d?n.profession&&!d.professionList.includes(n.profession)&&d.professionList.push(n.profession):(d={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt(),minion:n.minion},e.set(t,d)),d},fn=(e,t)=>{e.totalHits+=re((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=re(t==null?void 0:t.blocked),e.evaded+=re(t==null?void 0:t.evaded),e.glanced+=re(t==null?void 0:t.glanced),e.missed+=re(t==null?void 0:t.missed),e.invulned+=re(t==null?void 0:t.invulned),e.interrupted+=re(t==null?void 0:t.interrupted),e.totalMitigation+=re((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=re((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},Ai=e=>Object.values(e).some(t=>t>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:W.length});const Ft=(e,t,n)=>{var C,M,K,U;const d=`s${e}`;if((C=t==null?void 0:t[d])!=null&&C.name)return t[d].name;if((M=t==null?void 0:t[String(e)])!=null&&M.name)return t[String(e)].name;const r=`b${e}`;return(K=n==null?void 0:n[r])!=null&&K.name?n[r].name:(U=n==null?void 0:n[String(e)])!=null&&U.name?n[String(e)].name:`Unknown Skill ${e}`},pt=new Map,rt=e=>{const t=pt.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const n=t.connectedHits||0,d=n>0?t.totalDamage/n:0,r=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:d,min:r,hits:n}},Bt="Ashtonlightstone.9145",gn="Illusionary Warden",Rt=[],ct=[],Ot=[],_t=[],pn=new Map,hn=new Map,bn=(e,t,n)=>{const d=e.get(t)||gt();return d.totalHits+=n.totalHits,d.blocked+=n.blocked,d.evaded+=n.evaded,d.glanced+=n.glanced,d.missed+=n.missed,d.invulned+=n.invulned,d.interrupted+=n.interrupted,e.set(t,d),d};W.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(d=>{const r=(d==null?void 0:d.totalDamageDist)||[],C=Array.isArray(r)?r[0]:null;C==null||C.forEach(M=>{if(!(M!=null&&M.id))return;const K=Number(M.id),U=pt.get(K)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};U.totalDamage+=Number(M.totalDamage||0),U.connectedHits+=Number(M.connectedHits||0);const Y=Number.isFinite(Number(M.min))?Number(M.min):0;U.minTotal+=Y,U.minCount+=1,pt.set(K,U)})})}),W.forEach((e,t)=>{var ce,He;const n=e.details;if(!n)return;const d=n.players;console.log(`[useStatsAggregation] Processing log ${t}:`,{playerCount:d==null?void 0:d.length,hasTargets:!!n.targets,firstPlayer:d!=null&&d[0]?{account:d[0].account,notInSquad:d[0].notInSquad}:"none"});const r=n.targets||[],C=n.skillMap||{},M=n.buffMap||{},K=new Map,U=new Map;r.forEach(s=>{const g=(s==null?void 0:s.totalDamageDist)||[],$=Array.isArray(g)?g[0]:null;$==null||$.forEach(Q=>{var Z;if(!(Q!=null&&Q.id))return;const V=Number(Q.id),a=((Z=C==null?void 0:C[V])==null?void 0:Z.name)||Q.name||Q.skillName||String(V),N=K.get(V)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};N.totalDamage+=Number(Q.totalDamage||0),N.connectedHits+=Number(Q.connectedHits||0);const A=Number.isFinite(Number(Q.min))?Number(Q.min):0;N.minTotal+=A,N.minCount+=1,K.set(V,N);const H=U.get(a)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};H.totalDamage+=Number(Q.totalDamage||0),H.connectedHits+=Number(Q.connectedHits||0);const ie=Number.isFinite(Number(Q.min))?Number(Q.min):0;H.minTotal+=ie,H.minCount+=1,U.set(a,H)})});const Y=s=>{const g=K.get(s);if(!g||g.connectedHits<=0)return{avg:1,min:1};const $=g.connectedHits>0?g.totalDamage/g.connectedHits:0,Q=g.minCount>0?g.minTotal/g.minCount:$;return{avg:$||1,min:Q||1}},ke=s=>{const g=U.get(s);if(!g||g.connectedHits<=0)return{avg:1,min:1};const $=g.connectedHits>0?g.totalDamage/g.connectedHits:0,Q=g.minCount>0?g.minTotal/g.minCount:$;return{avg:$||1,min:Q||1}},de=n.combatReplayMetaData||{},Re=(de==null?void 0:de.inchToPixel)>0?de.inchToPixel:1,F=(de==null?void 0:de.pollingRate)>0?de.pollingRate:1,w=5e3,I=s=>Array.isArray(s)?s.map(g=>Array.isArray(g)?[Number(g[0]),Number(g[1])]:null).filter(g=>!!g&&Number.isFinite(g[0])):[];let J=[],se=n.durationMS||0,l=!1;const u=d.find(s=>(s==null?void 0:s.hasCommanderTag)&&!(s!=null&&s.notInSquad));(ce=u==null?void 0:u.combatReplayData)!=null&&ce.positions&&(J=u.combatReplayData.positions,I(u.combatReplayData.dead).forEach(([g])=>{g>0&&(l=!0,se=Math.min(se,g))}));const b=s=>{var H;const g=(H=s.statsAll)==null?void 0:H[0];if((g==null?void 0:g.distToCom)!==void 0&&(g==null?void 0:g.distToCom)!=="Infinity")return Math.round(Number(g.distToCom));if((g==null?void 0:g.stackDist)!==void 0)return Math.round(Number(g.stackDist))||0;if(s.hasCommanderTag)return 0;const $=s.combatReplayData;if(!($!=null&&$.positions)||!J.length)return 0;const Q=$.positions,V=I($.dead),a=I($.down),N=Math.floor(($.start||0)/F);let A=0;if(V.length&&a.length)for(const[ie]of V){if(ie<0)continue;const Z=Math.max(0,Math.floor(ie/F))-N;for(const[_,G]of a){if(ie!==G)continue;const ee=l&&_>se?Math.max(1,Math.floor(se/F)):Z,R=Math.max(0,Math.min(ee,Q.length,J.length));if(R<=0)continue;let T=0;for(let z=0;z<R;z++){const[L,oe]=Q[z],[ae,X]=J[z];T+=Math.hypot(L-ae,oe-X)}A=Math.round(T/R/Re)}}return A},h=d.filter(s=>!s.notInSquad);le+=h.length,ue+=r.filter(s=>!s.isFake).length,ti(d,{durationMS:n.durationMS,buffMap:n.buffMap});const{squadDeaths:E,enemyDeaths:i}=Ue(n);me+=E,De+=i,fe+=E,Oe+=i,Be(n)?be++:x++;const B=n.skillMap?Number((He=Object.keys(n.skillMap).find(s=>{var g,$;return(($=(g=n.skillMap)==null?void 0:g[s])==null?void 0:$.name)==="Battle Standard"}))==null?void 0:He.replace(/^s/,"")):null;d.forEach((s,g)=>{var nt,it,lt,ut,Ht,ht,bt,Tn,Mn,wn,vn,En;if(s.notInSquad)return;const $=s.account||"Unknown",Q=$!=="Unknown"?$:s.name||"Unknown",V=s.name||"Unknown";Ne.has(Q)||Ne.set(Q,{name:V,account:Q,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:s.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const a=Ne.get(Q);if(s.hasCommanderTag&&(a.isCommander=!0),s.profession&&s.profession!=="Unknown"){a.profession=s.profession,a.professions.add(s.profession);const f=Array.isArray(s.activeTimes)&&typeof s.activeTimes[0]=="number"?s.activeTimes[0]:n.durationMS||0;a.professionTimeMs[s.profession]=(a.professionTimeMs[s.profession]||0)+f}a.logsJoined++,a.downContrib+=Qn(s),a.cleanses+=Yn(s),a.strips+=Jn(s,Ce),a.healing+=Xn(s),a.barrier+=Zn(s),a.cc+=ei(s,Ce),a.stab+=s.stabGeneration||0;const N=b(s);N<=w&&(a.totalDist+=N,a.distCount++),(nt=s.defenses)!=null&&nt[0]&&(a.dodges+=s.defenses[0].dodgeCount||0,a.downs+=s.defenses[0].downCount||0,a.deaths+=s.defenses[0].deadCount||0),n.durationMS&&(a.totalFightMs+=n.durationMS);const A=Array.isArray(s.activeTimes)&&typeof s.activeTimes[0]=="number"?s.activeTimes[0]:n.durationMS||0;a.defenseActiveMs+=A,a.supportActiveMs+=A,a.healingActiveMs+=A,Array.isArray(s.buffUptimes)&&s.buffUptimes.length>0&&s.buffUptimes.forEach(f=>{var Pn,Hn,Un,$n,Ln,xn;if(typeof(f==null?void 0:f.id)!="number")return;const S=`b${f.id}`,v=((Pn=n.buffMap)==null?void 0:Pn[S])||((Hn=n.buffMap)==null?void 0:Hn[String(f.id)]);if(!v||Ni(v))return;const ne=Number((($n=(Un=f.buffData)==null?void 0:Un[0])==null?void 0:$n.uptime)??0),Fe=Number(((xn=(Ln=f.buffData)==null?void 0:Ln[0])==null?void 0:xn.presence)??0);if((!Number.isFinite(ne)||ne<=0)&&(!Number.isFinite(Fe)||Fe<=0))return;const Ve=(v==null?void 0:v.stacking)??!1,ze=(Ve?Number.isFinite(ne)?ne:0:Number.isFinite(ne)?ne/100:0)*A,st=Ve?Fe:ne,Kt=Math.min(Math.max(Number.isFinite(st)?st:0,0),100)/100*A,Fn=Number.isFinite(ze)&&ze>0,Bn=Number.isFinite(Kt)&&Kt>0;if(!Fn&&!Bn)return;const Ke=ai(v==null?void 0:v.name);if(Ke&&mi.has(Ke)&&(!(v!=null&&v.classification)||v.classification==="Condition")){const Ut=ze/1e3,Ge=v==null?void 0:v.icon,kt=Ie[Ke]||{name:Ke,icon:Ge,applications:0,damage:0};kt.applicationsFromUptime=(kt.applicationsFromUptime||0)+Ut,!kt.icon&&Ge&&(kt.icon=Ge),Ie[Ke]=kt;const St=a.outgoingConditions[Ke]||{applications:0,damage:0,skills:{},icon:Ge};St.applicationsFromUptime=(St.applicationsFromUptime||0)+Ut,!St.icon&&Ge&&(St.icon=Ge),a.outgoingConditions[Ke]=St;const Ct=$e[Ke]||{name:Ke,icon:Ge,applications:0,damage:0};Ct.applicationsFromUptime=(Ct.applicationsFromUptime||0)+Ut,!Ct.icon&&Ge&&(Ct.icon=Ge),$e[Ke]=Ct;const Dt=a.incomingConditions[Ke]||{applications:0,damage:0,skills:{},icon:Ge};Dt.applicationsFromUptime=(Dt.applicationsFromUptime||0)+Ut,!Dt.icon&&Ge&&(Dt.icon=Ge),a.incomingConditions[Ke]=Dt}tt.has(S)||tt.set(S,{name:v==null?void 0:v.name,stacking:Ve,icon:v==null?void 0:v.icon}),Xe.has(S)||Xe.set(S,new Map);const In=Xe.get(S),Gt=a.account||s.account||s.name||"Unknown";let et=In.get(Gt);et||(et={account:Gt,profession:a.profession||s.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,uptimeMs:0,durationMs:0},In.set(Gt,et));const dt=s.profession||a.profession;dt&&dt!=="Unknown"&&(et.professions.add(dt),et.professionTimeMs[dt]=(et.professionTimeMs[dt]||0)+A,et.profession=dt),et.totalMs+=Fn?ze:0,et.uptimeMs+=Bn?Kt:0,et.durationMs+=A}),(it=s.defenses)!=null&&it[0]&&fi.forEach(f=>{const S=Number(s.defenses[0][f.field]??0);Number.isFinite(S)&&(a.defenseTotals[f.id]=(a.defenseTotals[f.id]||0)+S)}),(lt=s.support)!=null&&lt[0]&&gi.forEach(f=>{let S=Number(s.support[0][f.field]??0);Number.isFinite(S)&&(_e.has(f.field)&&S>999999&&(S=0),a.supportTotals[f.id]=(a.supportTotals[f.id]||0)+S)});const H=(f,S)=>{Number.isFinite(S)&&(a.healingTotals[f]=(a.healingTotals[f]||0)+S)},ie=(f,S)=>Array.isArray(f)?f.reduce((v,ne)=>v+Number((ne==null?void 0:ne[S])??0),0):0,Z=(f,S,v)=>{if(!Number.isFinite(v)||v<=0)return;const ne=d[S],Fe=S===g,Ve=ne==null?void 0:ne.notInSquad,ot=!Ve,ze=ot&&(ne==null?void 0:ne.group)!=null&&ne.group===s.group;H(f,v),ot&&H(`squad${f[0].toUpperCase()}${f.slice(1)}`,v),ze&&H(`group${f[0].toUpperCase()}${f.slice(1)}`,v),Fe&&H(`self${f[0].toUpperCase()}${f.slice(1)}`,v),Ve&&H(`offSquad${f[0].toUpperCase()}${f.slice(1)}`,v)};if(Array.isArray(s.rotation)){let f=0;s.rotation.forEach(S=>{var ne;if(!(S!=null&&S.id)||!bi(S.id,n.skillMap))return;const v=((ne=S.skills)==null?void 0:ne.length)||0;v>0&&(f+=v,H(`resUtility_s${S.id}`,v))}),f>0&&H("resUtility",f)}const _=(ut=s.extHealingStats)==null?void 0:ut.outgoingHealingAllies;Array.isArray(_)&&_.forEach((f,S)=>{const v=ie(f,"healing"),ne=ie(f,"downedHealing");Z("healing",S,v),Z("downedHealing",S,ne)});const G=(Ht=s.extBarrierStats)==null?void 0:Ht.outgoingBarrierAllies;Array.isArray(G)&&G.forEach((f,S)=>{const v=ie(f,"barrier");Z("barrier",S,v)});const ee=(ht=s.statsAll)==null?void 0:ht[0],R=(bt=s.dpsAll)==null?void 0:bt[0],T=(Tn=s.support)==null?void 0:Tn[0];if(di.forEach(f=>{if(f.id==="downContributionPercent"||!f.field)return;let S=0,v=0;f.source==="dpsAll"&&R?S=Number(R[f.field]??0):f.source==="statsAll"&&ee?(S=Number(ee[f.field]??0),v=Number(ee[f.denomField||f.weightField||"connectedDamageCount"]??0)):f.source==="support"&&T?S=Number(T[f.field]??0):s.statsTargets&&s.statsTargets.forEach(ne=>{ne!=null&&ne[0]&&(S+=Number(ne[0][f.field]??0),v+=Number(ne[0][f.denomField||f.weightField||"connectedDamageCount"]??0))}),Number.isFinite(S)&&(a.offenseTotals[f.id]=(a.offenseTotals[f.id]||0)+S,f.isRate&&v>0&&(a.offenseRateWeights[f.id]=(a.offenseRateWeights[f.id]||0)+v))}),s.targetDamageDist&&Number.isFinite(B)){const f=s.targetDamageDist.flatMap(S=>S||[]).flatMap(S=>S||[]).reduce((S,v)=>v!=null&&v.id&&v.id===B?S+((v==null?void 0:v.connectedHits)||0):S,0);a.offenseTotals.battleStandardHits=(a.offenseTotals.battleStandardHits||0)+f}a.revives+=((wn=(Mn=s.support)==null?void 0:Mn[0])==null?void 0:wn.resurrects)||0,R&&(a.damage+=R.damage||0,a.dps+=R.dps||0);const z=f=>{var Fe,Ve,ot,ze;let S=`Skill ${f.id}`;const v=((Fe=n.skillMap)==null?void 0:Fe[`s${f.id}`])||((Ve=n.skillMap)==null?void 0:Ve[`${f.id}`]);let ne=v==null?void 0:v.icon;if(v!=null&&v.name&&(S=v.name),S.startsWith("Skill ")){const st=Nt(S,f.id,n.buffMap);st&&(S=st,ne=((ze=(ot=n.buffMap)==null?void 0:ot[`b${f.id}`])==null?void 0:ze.icon)||ne)}return{name:S,icon:ne}},L=f=>{if(!(f!=null&&f.id))return;const{name:S,icon:v}=z(f);Ae[f.id]||(Ae[f.id]={name:S,icon:v,damage:0,hits:0,downContribution:0}),Ae[f.id].name.startsWith("Skill ")&&!S.startsWith("Skill ")&&(Ae[f.id].name=S),!Ae[f.id].icon&&v&&(Ae[f.id].icon=v),Ae[f.id].damage+=f.totalDamage,Ae[f.id].hits+=f.connectedHits,Ae[f.id].downContribution+=Number(f.downContribution||0)},oe=s.account||s.name||"Unknown",ae=s.profession||"Unknown",X=`${oe}|${ae}`;let we=qe.get(X);we||(we={key:X,account:oe,displayName:oe,profession:ae,professionList:[ae],totalFightMs:0,skills:new Map},qe.set(X,we)),we.professionList.includes(ae)||we.professionList.push(ae),we.totalFightMs+=n.durationMS||0;const je=f=>{if(!(f!=null&&f.id))return;const{name:S,icon:v}=z(f),ne=`s${f.id}`;let Fe=we.skills.get(ne);Fe||(Fe={id:ne,name:S,icon:v,damage:0,downContribution:0},we.skills.set(ne,Fe)),Fe.name.startsWith("Skill ")&&!S.startsWith("Skill ")&&(Fe.name=S),!Fe.icon&&v&&(Fe.icon=v),Fe.damage+=Number(f.totalDamage||0),Fe.downContribution+=Number(f.downContribution||0)};Se==="total"?(vn=s.totalDamageDist)==null||vn.forEach(f=>{f==null||f.forEach(S=>{L(S),je(S)})}):(En=s.targetDamageDist)==null||En.forEach(f=>{f==null||f.forEach(S=>{S==null||S.forEach(v=>{L(v),je(v)})})}),s.totalDamageTaken&&s.totalDamageTaken.forEach(f=>{f==null||f.forEach(S=>{var Ve,ot,ze,st;if(!(S!=null&&S.id))return;let v=`Skill ${S.id}`;const ne=((Ve=n.skillMap)==null?void 0:Ve[`s${S.id}`])||((ot=n.skillMap)==null?void 0:ot[`${S.id}`]);let Fe=ne==null?void 0:ne.icon;if(ne!=null&&ne.name&&(v=ne.name),v.startsWith("Skill ")){const zt=Nt(v,S.id,n.buffMap);zt&&(v=zt,Fe=((st=(ze=n.buffMap)==null?void 0:ze[`b${S.id}`])==null?void 0:st.icon)||Fe)}Te[S.id]||(Te[S.id]={name:v,icon:Fe,damage:0,hits:0}),(!Te[S.id].name.startsWith("Skill ")||v.startsWith("Skill "))&&(Te[S.id].name=v),!Te[S.id].icon&&Fe&&(Te[S.id].icon=Fe),Te[S.id].damage+=S.totalDamage,Te[S.id].hits+=S.hits})})}),r.forEach(s=>{if(s!=null&&s.isFake)return;const g=at((s==null?void 0:s.profession)||(s==null?void 0:s.name)||(s==null?void 0:s.id));g&&(Ee[g]=(Ee[g]||0)+1)});const p=ui({players:d,targets:r,skillMap:n.skillMap,buffMap:n.buffMap,getPlayerKey:s=>s.account&&s.account!=="Unknown"?s.account:s.name||null}),k=nn(n.buffMap);Object.entries(p.playerConditions).forEach(([s,g])=>{const $=Ne.get(s);$&&Object.entries(g).forEach(([Q,V])=>{const a=$.outgoingConditions[Q]||{applications:0,damage:0,skills:{},icon:V.icon};a.applications+=Number(V.applications||0),a.damage+=Number(V.damage||0),V.applicationsFromBuffs&&(a.applicationsFromBuffs=(a.applicationsFromBuffs||0)+V.applicationsFromBuffs),V.applicationsFromBuffsActive&&(a.applicationsFromBuffsActive=(a.applicationsFromBuffsActive||0)+V.applicationsFromBuffsActive),Object.entries(V.skills||{}).forEach(([N,A])=>{const H=a.skills[N]||{name:A.name,hits:0,damage:0,icon:A.icon};H.hits+=Number(A.hits||0),H.damage+=Number(A.damage||0),!H.icon&&A.icon&&(H.icon=A.icon),a.skills[N]=H}),!a.icon&&V.icon&&(a.icon=V.icon),$.outgoingConditions[Q]=a})}),Object.entries(p.summary).forEach(([s,g])=>{const $=Ie[s]||{name:g.name||s,icon:g.icon,applications:0,damage:0};$.applications+=Number(g.applications||0),$.damage+=Number(g.damage||0),g.applicationsFromBuffs&&($.applicationsFromBuffs=($.applicationsFromBuffs||0)+g.applicationsFromBuffs),g.applicationsFromBuffsActive&&($.applicationsFromBuffsActive=($.applicationsFromBuffsActive||0)+g.applicationsFromBuffsActive),!$.icon&&g.icon&&($.icon=g.icon),Ie[s]=$}),h.forEach(s=>{const g=s.account&&s.account!=="Unknown"?s.account:s.name||"Unknown",$=Ne.get(g);!$||!s.totalDamageTaken||s.totalDamageTaken.forEach(Q=>Q==null?void 0:Q.forEach(V=>{var z,L,oe,ae,X,we;if(!(V!=null&&V.id))return;let a=`Skill ${V.id}`;const N=((z=n.skillMap)==null?void 0:z[`s${V.id}`])||((L=n.skillMap)==null?void 0:L[`${V.id}`]);N!=null&&N.name&&(a=N.name);const A=Nt(a,V.id,n.buffMap);if(!A)return;const H=(ae=(oe=n.buffMap)==null?void 0:oe[`b${V.id}`])==null?void 0:ae.name,ie=k.get(A)||((we=(X=n.buffMap)==null?void 0:X[`b${V.id}`])==null?void 0:we.icon),Z=(N==null?void 0:N.icon)||ie;a.startsWith("Skill ")&&(H||A)&&(a=H||A);const _=Number(V.hits??0),G=Number(V.totalDamage??0),ee=$e[A]||{name:A,icon:ie,applications:0,damage:0};ee.applications+=Number.isFinite(_)?_:0,ee.damage+=Number.isFinite(G)?G:0,!ee.icon&&ie&&(ee.icon=ie),$e[A]=ee;const R=$.incomingConditions[A]||{applications:0,damage:0,skills:{},icon:ie};R.applications+=Number.isFinite(_)?_:0,R.damage+=Number.isFinite(G)?G:0;const T=R.skills[a]||{name:a,hits:0,damage:0,icon:Z};T.hits+=Number.isFinite(_)?_:0,T.damage+=Number.isFinite(G)?G:0,!T.icon&&Z&&(T.icon=Z),R.skills[a]=T,!R.icon&&ie&&(R.icon=ie),$.incomingConditions[A]=R}))});const q=n.player_damage_mitigation||n.playerDamageMitigation,Me=q&&typeof q=="object"&&Object.keys(q).length>0;Me&&Object.entries(q).forEach(([s,g])=>{if(!g||typeof g!="object")return;const $=un(s),Q=mn(vt,$.account,$);Object.values(g).forEach(V=>{re((V==null?void 0:V.avoided_damage)??(V==null?void 0:V.avoidedDamage))<=0||fn(Q.mitigationTotals,V)})});const ge=n.player_minion_damage_mitigation||n.playerMinionDamageMitigation,xe=ge&&typeof ge=="object"&&Object.keys(ge).length>0;xe&&Object.entries(ge).forEach(([s,g])=>{if(!g||typeof g!="object")return;const $=un(s);Object.entries(g).forEach(([Q,V])=>{if(!V||typeof V!="object")return;const a=`${$.account}::${Q}`,N=dn(Et,a,{...$,minion:String(Q||"Unknown")});Object.values(V).forEach(A=>{fn(N.mitigationTotals,A)})})}),(!Me||!xe)&&(Me||h.forEach(s=>{const g=(s==null?void 0:s.totalDamageTaken)||[];if(!Array.isArray(g)||g.length===0)return;const $=s.account||s.name||"Unknown",Q={account:$,name:s.name||$,profession:at(s.profession||"Unknown")};mn(vt,$,Q);const V=n.skillMap||{},a=n.buffMap||{},N=Array.isArray(g)?g[0]:null;if(N==null||N.forEach(A=>{if(!(A!=null&&A.id))return;const H=re(A.blocked),ie=re(A.evaded),Z=re(A.glance??A.glanced),_=re(A.missed),G=re(A.invulned),ee=re(A.interrupted),R=re(A.hits??A.connectedHits),T=Number(A.id),z=Ft(T,V,a);if(bn(pn,`${$}::${T}`,{totalHits:R,blocked:H,evaded:ie,glanced:Z,missed:_,invulned:G,interrupted:ee}),$===Bt){const L=pt.get(T),oe=rt(T),ae=oe.hasSkill?oe.hits>0?oe.avg:0:1,X=oe.hasSkill?oe.min||0:1,we=oe.hits>0?Z*ae/2+(H+ie+_+G+ee)*ae:0,je=oe.hits>0?Z*X/2+(H+ie+_+G+ee)*X:0;Ot.push({logId:e.filePath||e.id||t,skillId:A.id,skillName:z,blocked:H,evaded:ie,glanced:Z,missed:_,invulned:G,interrupted:ee,totalAvoids:H+ie+Z+_+G+ee,avg:ae,min:X,enemyHits:(L==null?void 0:L.connectedHits)??0,enemyTotalDmg:(L==null?void 0:L.totalDamage)??0,avoidDmg:we,avoidMinDmg:je})}}),$===Bt){const A=(H,ie)=>{let Z=0,_=0,G=0;if(!Array.isArray(H))return{total:Z,minTotal:_,hits:G};for(const ee of H){if(!(ee!=null&&ee.id))continue;const R=re(ee.blocked),T=re(ee.evaded),z=re(ee.glance??ee.glanced),L=re(ee.missed),oe=re(ee.invulned),ae=re(ee.interrupted),X=Ft(Number(ee.id),C,M),we=ie(Number(ee.id),X);(we.hits??0)>0&&(Z+=z*we.avg/2+(R+T+L+oe+ae)*we.avg,_+=z*we.min/2+(R+T+L+oe+ae)*we.min),G+=re(ee.hits??ee.connectedHits)}return{total:Z,minTotal:_,hits:G}};_t.push({logId:e.filePath||e.id||t,variant:"current_global_name_taken0",...A(N,(H,ie)=>{const Z=rt(H),_=Z.hasSkill?Z.hits>0?Z.avg:0:1,G=Z.hasSkill?Z.min||0:1;return{avg:_,min:G,hits:Z.hits}})})}}),xe||h.forEach(s=>{const g=(s==null?void 0:s.minions)||[];if(!Array.isArray(g)||g.length===0)return;const $=s.account||s.name||"Unknown",Q={account:$,name:s.name||$,profession:at(s.profession||"Unknown")},V=n.skillMap||{},a=n.buffMap||{};g.forEach(N=>{const A=(N==null?void 0:N.totalDamageTakenDist)||[];if(!Array.isArray(A)||A.length===0)return;let H=String((N==null?void 0:N.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";H.toUpperCase().includes("UNKNOWN")&&(H="Unknown");const ie=`${$}::${H}`;dn(Et,ie,{...Q,minion:H});const Z=Array.isArray(A)?A[0]:null;if(Z==null||Z.forEach(_=>{if(!(_!=null&&_.id))return;const G=re(_.blocked),ee=re(_.evaded),R=re(_.glance??_.glanced),T=re(_.missed),z=re(_.invulned),L=re(_.interrupted),oe=re(_.hits??_.connectedHits),ae=Number(_.id),X=Ft(ae,V,a);if(bn(hn,`${ie}::${ae}`,{totalHits:oe,blocked:G,evaded:ee,glanced:R,missed:T,invulned:z,interrupted:L}),$===Bt&&H===gn){const we=pt.get(ae),je=rt(ae),nt=je.hasSkill?je.hits>0?je.avg:0:1,it=je.hasSkill?je.min||0:1,lt=je.hits>0?R*nt/2+(G+ee+T+z+L)*nt:0,ut=je.hits>0?R*it/2+(G+ee+T+z+L)*it:0;Rt.push({logId:e.filePath||e.id||t,skillId:_.id,skillName:X,blocked:G,evaded:ee,glanced:R,missed:T,invulned:z,interrupted:L,totalAvoids:G+ee+R+T+z+L,avg:nt,min:it,enemyHits:(we==null?void 0:we.connectedHits)??0,enemyTotalDmg:(we==null?void 0:we.totalDamage)??0,avoidDmg:lt,avoidMinDmg:ut})}}),$===Bt&&H===gn){const _=(T,z)=>{let L=0,oe=0,ae=0;if(!Array.isArray(T))return{total:L,minTotal:oe,hits:ae};for(const X of T){if(!(X!=null&&X.id))continue;const we=re(X.blocked),je=re(X.evaded),nt=re(X.glance??X.glanced),it=re(X.missed),lt=re(X.invulned),ut=re(X.interrupted),Ht=Ft(Number(X.id),C,M),{avg:ht,min:bt}=z(Number(X.id),Ht);re(X.hits??X.connectedHits)>0&&(L+=nt*ht/2+(we+je+it+lt+ut)*ht,oe+=nt*bt/2+(we+je+it+lt+ut)*bt),ae+=re(X.hits??X.connectedHits)}return{total:L,minTotal:oe,hits:ae}},G=Array.isArray(A)?A[0]||[]:[],ee=Array.isArray(A)?A.flat():[],R=Array.isArray(N==null?void 0:N.totalDamageTaken)?N.totalDamageTaken[0]||[]:[];ct.push({logId:e.filePath||e.id||t,variant:"current_global_name_dist0",..._(G,(T,z)=>{const L=rt(T),oe=L.hasSkill?L.hits>0?L.avg:0:1,ae=L.hasSkill&&L.min||0;return{avg:oe,min:ae}})}),ct.push({logId:e.filePath||e.id||t,variant:"local_name_dist0",..._(G,(T,z)=>ke(z))}),ct.push({logId:e.filePath||e.id||t,variant:"local_id_dist0",..._(G,T=>Y(T))}),ct.push({logId:e.filePath||e.id||t,variant:"global_name_alllists",..._(ee,(T,z)=>{const L=rt(T),oe=L.hasSkill?L.hits>0?L.avg:0:1,ae=L.hasSkill&&L.min||0;return{avg:oe,min:ae}})}),ct.push({logId:e.filePath||e.id||t,variant:"global_name_taken0",..._(R,(T,z)=>{const L=rt(T),oe=L.hasSkill?L.hits>0?L.avg:0:1,ae=L.hasSkill&&L.min||0;return{avg:oe,min:ae}})})}})}))}),Rt.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table(Rt),ct.length>0&&console.table(ct),console.groupEnd()),Ot.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(Ot),_t.length>0&&console.table(_t),console.groupEnd());const kn=(e,t)=>{const n=new Map,d=r=>{let C=n.get(r);return C||(C=gt(),n.set(r,C)),C};t.forEach((r,C)=>{const M=C.lastIndexOf("::"),K=M>-1?C.slice(0,M):C,U=M>-1?Number(C.slice(M+2)):Number.NaN,Y=Number.isFinite(U)?rt(U):{hasSkill:!1,avg:0,min:0,hits:0};if(!Y.hasSkill||Y.hits<=0)return;const ke=Y.avg,de=Y.min,Re=r.glanced*ke/2+(r.blocked+r.evaded+r.missed+r.invulned+r.interrupted)*ke,F=r.glanced*de/2+(r.blocked+r.evaded+r.missed+r.invulned+r.interrupted)*de;if(Re<=0)return;const w=d(K);w.totalHits+=r.totalHits,w.blocked+=r.blocked,w.evaded+=r.evaded,w.glanced+=r.glanced,w.missed+=r.missed,w.invulned+=r.invulned,w.interrupted+=r.interrupted,w.totalMitigation+=Re,w.minMitigation+=F}),e.forEach((r,C)=>{const M=n.get(C)||gt();r.mitigationTotals.totalHits=M.totalHits,r.mitigationTotals.blocked=M.blocked,r.mitigationTotals.evaded=M.evaded,r.mitigationTotals.glanced=M.glanced,r.mitigationTotals.missed=M.missed,r.mitigationTotals.invulned=M.invulned,r.mitigationTotals.interrupted=M.interrupted,r.mitigationTotals.totalMitigation=M.totalMitigation,r.mitigationTotals.minMitigation=M.minMitigation})};kn(vt,pn),kn(Et,hn);const Ti=y>0?Math.round(le/y):0,Mi=y>0?Math.round(ue/y):0,wi=me>0?(De/me).toFixed(2):De>0?"∞":"0.00",vi=Oe>0?(fe/Oe).toFixed(2):fe>0?"∞":"0.00",Sn=(e,t)=>{const d=e.filter(M=>Number.isFinite(M.value)&&(t?M.value>0:M.value>=0)).sort((M,K)=>{const U=t?K.value-M.value:M.value-K.value;return U!==0?U:M.account.localeCompare(K.account)});let r=null,C=0;return d.map((M,K)=>((r===null||M.value!==r)&&(C=K+1,r=M.value),{rank:C,...M}))},qt=Array.from(Ne.values()).map(e=>{const t=Array.from(e.professions).filter(n=>n!=="Unknown");if(e.professionList=t,t.length>0){let n=t[0],d=e.professionTimeMs[n]||0;t.forEach(r=>{const C=e.professionTimeMs[r]||0;C>d&&(d=C,n=r)}),e.profession=n}return{key:e.account,stat:e}}),Cn=e=>{const t=Ne.get(e.account);if(!t){const r=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:r}}const n=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(r=>r&&r!=="Unknown"),d=t.profession||e.profession;return{...e,profession:d,professionList:n.length>0?n:d?[d]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},Ei=Array.from(vt.values()).map(Cn).filter(e=>Ai(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),Fi=Array.from(Et.values()).map(Cn).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const n=e.account.localeCompare(t.account);return n!==0?n:String(e.minion||"").localeCompare(String(t.minion||""))}),It=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},ye=(e,t)=>Sn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:It(n,e),count:n.logsJoined})),t),Pe={downContrib:ye("downContrib",!0),barrier:ye("barrier",!0),healing:ye("healing",!0),dodges:ye("dodges",!0),strips:ye("strips",!0),cleanses:ye("cleanses",!0),cc:ye("cc",!0),stability:ye("stability",!0),revives:ye("revives",!0),participation:ye("participation",!0),dps:ye("dps",!0),damage:ye("damage",!0),closestToTag:ye("closestToTag",!1).filter(e=>Number.isFinite(e.value))},Bi={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},ve=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},Ze={maxDownContrib:ve([]),maxBarrier:ve([]),maxHealing:ve([]),maxDodges:ve([]),maxStrips:ve([]),maxCleanses:ve([]),maxCC:ve([]),maxStab:ve([]),closestToTag:ve([])},Je={},Ii=(e,t)=>{if(t==="closestToTag")return It(e,t);const n=Math.max(1,(e.totalFightMs||0)/1e3);return It(e,t)/n};Object.values(Bi).forEach(e=>{const t=e!=="closestToTag";Je[e]=Sn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:Ii(n,e),count:n.logsJoined})),t)}),Ze.maxDownContrib=ve(Je.downContrib),Ze.maxBarrier=ve(Je.barrier),Ze.maxHealing=ve(Je.healing),Ze.maxDodges=ve(Je.dodges),Ze.maxStrips=ve(Je.strips),Ze.maxCleanses=ve(Je.cleanses),Ze.maxCC=ve(Je.cc),Ze.maxStab=ve(Je.stability),Ze.closestToTag=ve(Je.closestToTag);const Pi={maxDownContrib:ve(Pe.downContrib),maxBarrier:ve(Pe.barrier),maxHealing:ve(Pe.healing),maxDodges:ve(Pe.dodges),maxStrips:ve(Pe.strips),maxCleanses:ve(Pe.cleanses),maxCC:ve(Pe.cc),maxStab:ve(Pe.stability),closestToTag:ve(Pe.closestToTag)};let jt={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},Dn,Nn,An=0;if(pe!=null&&pe.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=C=>{const M=e[C];return M?Number(te[M]||0)>0:!1},n=[],d=C=>[...C||[]].filter(M=>t(M==null?void 0:M.name)).sort((M,K)=>K.ratio-M.ratio||M.rank-K.rank||M.name.localeCompare(K.name)).slice(0,3),r=C=>{var K;if(!C)return;const M=d(C.contribs);return{...C,player:C.name,reason:((K=M[0])==null?void 0:K.name)||"Top Performance",topStats:M}};qt.forEach(({stat:C})=>{let M=0;const K=[],U=(Y,ke,de,Re,F=!0)=>{var I,J;if(de<=0)return;const w=((I=ke[0])==null?void 0:I.value)||0;if(w&&Number.isFinite(Y)&&(F?Y>0:Y<Number.POSITIVE_INFINITY)){const se=F?Y/w:w/Y;M+=se*de;const l=((J=ke.find(u=>u.account===C.account))==null?void 0:J.rank)||0;K.push({name:Re,ratio:se,val:Y.toLocaleString(),rank:l})}};U(C.downContrib,Pe.downContrib,te.downContribution,"Down Contribution"),U(C.healing,Pe.healing,te.healing,"Healing"),U(C.cleanses,Pe.cleanses,te.cleanses,"Cleanses"),U(C.strips,Pe.strips,te.strips,"Strips"),U(C.stab,Pe.stability,te.stability,"Stability"),U(C.cc,Pe.cc,te.cc,"CC"),U(C.revives,Pe.revives,te.revives,"Revives"),U(It(C,"closestToTag"),Pe.closestToTag,te.distanceToTag,"Distance to Tag",!1),U(C.logsJoined,Pe.participation,te.participation,"Participation"),U(C.dodges,Pe.dodges,te.dodging,"Dodging"),U(C.dps,Pe.dps,te.dps,"DPS"),U(C.damage,Pe.damage,te.damage,"Damage"),n.push({...C,score:M,contribs:K.filter(Y=>t(Y.name))})}),n.sort((C,M)=>M.score-C.score),n[0]&&n[0].score>0&&(jt=r(n[0])||jt),Dn=r(n[1]),Nn=r(n[2]),An=n.length>0?n.reduce((C,M)=>C+M.score,0)/n.length:0}const Hi=Object.values(Ae).sort((e,t)=>{const n=O==="downContribution"?e.downContribution:e.damage;return(O==="downContribution"?t.downContribution:t.damage)-n}).slice(0,25),Ui=Object.values(Te).sort((e,t)=>t.damage-e.damage).slice(0,25),$i=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),n=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return n?`${n[1]} Borderlands`:t||"Unknown"},Pt=(e,t)=>$i((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),Li=(e,t)=>{const n=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof n=="string"&&n.trim().length>0)return n.trim();const d=e==null?void 0:e.uploadLinks;if(!Array.isArray(d))return"";for(const r of d){if(typeof r=="string"&&r.trim().length>0)return r.trim();if(r&&typeof r=="object"){const C=r.permalink||r.link||r.url||r.reportLink;if(typeof C=="string"&&C.trim().length>0)return C.trim()}}return""},Wt={};W.forEach(e=>{const t=Pt(e==null?void 0:e.details,e);Wt[t]=(Wt[t]||0)+1});const xi=Object.entries(Wt).map(([e,t])=>{const n=String(e).trim(),d=/eternal battlegrounds|^ebg$/i.test(n);let r="#64748b";return d?r="#ffffff":/red/i.test(n)?r="#ef4444":/blue/i.test(n)?r="#3b82f6":/green/i.test(n)&&(r="#22c55e"),{name:e,value:t,color:r}}).sort((e,t)=>t.value-e.value),{boonTables:Ri}=On(W),Oi=W.map((e,t)=>{var d,r;const n=((d=e.details)==null?void 0:d.players)||[];return{index:t+1,label:`Log ${t+1}`,timestamp:Qe(e.details,e),squadCount:n.filter(C=>!C.notInSquad).length,friendlyCount:n.length,enemies:((r=e.details)==null?void 0:r.targets).filter(C=>!C.isFake).length}}).sort((e,t)=>e.timestamp-t.timestamp),yt={};Array.from(Ne.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(yt[e.profession]=(yt[e.profession]||0)+1)});const _i=Object.entries(yt).map(([e,t])=>({name:e,value:t,color:on(e)})).sort((e,t)=>t.value-e.value),Vt={};Object.keys(Ee).length===0&&W.forEach(e=>{var t,n;(n=(t=e.details)==null?void 0:t.targets)==null||n.forEach(d=>{if(d.isFake)return;const r=d.profession&&d.profession!=="Unknown"?d.profession:d.name||d.id||"Unknown",C=at(r);Vt[C]=(Vt[C]||0)+1})});const qi=Object.keys(Ee).length>0?Ee:Vt,ji=Object.entries(qi).map(([e,t])=>({name:e,value:t,color:on(e)})).sort((e,t)=>t.value-e.value),Wi=W.map((e,t)=>({log:e,originalIndex:t})).sort((e,t)=>Qe(e.log.details,e.log)-Qe(t.log.details,t.log)).map(({log:e},t)=>{const n=e.details;if(!n)return null;const d=n.players||[],r=d.filter(i=>!i.notInSquad),C=d.filter(i=>i.notInSquad),M=n.targets||[],K=M.filter(i=>!i.isFake),U=r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.dpsAll)==null?void 0:B[0])==null?void 0:p.damage)||0)},0),Y=r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.defenses)==null?void 0:B[0])==null?void 0:p.damageTaken)||0)},0),{enemyDeaths:ke,enemyDownsDeaths:de}=Ue(n),Re=Be(n),F=Qe(n,e),w=Pt(n,e),I={red:0,green:0,blue:0},J=i=>{const D=Number(i);return Number.isFinite(D)?D:0},se=i=>{if(!i||typeof i!="object")return;const D=i.teamID??i.teamId??i.team??i.teamColor??i.team_color;if(D!=null)return D;const B=Object.keys(i).find(p=>/^team/i.test(p));return B?i[B]:void 0},l=(i,D)=>{if(i==null)return null;if(typeof i=="string"){const B=i.toLowerCase();return B.includes("red")?"red":B.includes("green")?"green":B.includes("blue")?"blue":B==="r"?"red":B==="g"?"green":B==="b"?"blue":null}if(typeof i=="number")if(D==="zeroBased"){if(i===0)return"red";if(i===1)return"green";if(i===2)return"blue"}else{if(i===1)return"red";if(i===2)return"green";if(i===3)return"blue"}return null},u=(i,D)=>{const B={};return i.forEach(p=>{const k=D(p),q=at(k);q&&(B[q]=(B[q]||0)+1)}),B},b=u(r,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)),h=u(C,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)),E=u(K,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)||(i==null?void 0:i.id));if(n.teamCounts&&typeof n.teamCounts=="object"){const i=n.teamCounts;I.red=J(i.red??i.r??i[0]??i[1]),I.green=J(i.green??i.g??i[1]??i[2]),I.blue=J(i.blue??i.b??i[2]??i[3])}else{const i=[];M.forEach(k=>{if(k!=null&&k.isFake)return;const q=se(k);q!=null&&i.push(q)}),d.forEach(k=>{if(!(k!=null&&k.notInSquad))return;const q=se(k);q!=null&&i.push(q)}),i.length===0&&d.forEach(k=>{const q=se(k);q!=null&&i.push(q)});const D=new Set;i.forEach(k=>{typeof k=="number"&&D.add(k)});const B=D.has(0)?"zeroBased":D.has(3)?"oneBased":"zeroBased";if(i.forEach(k=>{const q=l(k,B);q&&(I[q]+=1)}),I.red+I.green+I.blue===0&&i.length>0){const k=new Map;i.forEach(Me=>{const ge=String(Me);k.set(ge,(k.get(ge)||0)+1)});const q=Array.from(k.values()).sort((Me,ge)=>ge-Me);I.red=q[0]||0,I.green=q[1]||0,I.blue=q[2]||0}I.red+I.green+I.blue===0&&(I.red=Math.max(K.length,d.filter(k=>k==null?void 0:k.notInSquad).length))}return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:Li(n,e),timestamp:F,mapName:w,duration:ki(n.durationMS),isWin:Re,squadCount:r.length,allyCount:C.length,enemyCount:K.length,teamCounts:I,alliesDown:r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.defenses)==null?void 0:B[0])==null?void 0:p.downCount)||0)},0),alliesDead:r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.defenses)==null?void 0:B[0])==null?void 0:p.deadCount)||0)},0),alliesRevived:r.reduce((i,D)=>{var B,p;return Number(((p=(B=D.statsAll)==null?void 0:B[0])==null?void 0:p.saved)||0)>0?i+1:i},0),rallies:0,enemyDeaths:ke,enemyDowns:Math.max(0,de-ke),totalOutgoingDamage:U,totalIncomingDamage:Y,incomingBarrierAbsorbed:r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.defenses)==null?void 0:B[0])==null?void 0:p.damageBarrier)||0)},0),outgoingBarrierAbsorbed:r.reduce((i,D)=>{var k;const B=(k=D.extBarrierStats)==null?void 0:k.outgoingBarrier;if(!Array.isArray(B))return i;let p=0;return B.forEach(q=>{if(Array.isArray(q)){q.forEach(Me=>{p+=Number((Me==null?void 0:Me.barrier)||0)});return}p+=Number((q==null?void 0:q.barrier)||0)}),i+p},0),squadClassCountsFight:b,allyClassCountsFight:h,enemyClassCounts:E}}).filter(Boolean),yi=(e,t)=>{const n=(t==null?void 0:t.skillMap)||{},d=(t==null?void 0:t.buffMap)||{};let r=0,C="";const M=U=>{const Y=Number(U);if(!Number.isFinite(Y))return String(U||"Unknown Skill");const ke=(n==null?void 0:n[`s${Y}`])||(n==null?void 0:n[`${Y}`]);if(ke!=null&&ke.name)return String(ke.name);const de=(d==null?void 0:d[`b${Y}`])||(d==null?void 0:d[`${Y}`]);return de!=null&&de.name?String(de.name):`Skill ${Y}`},K=U=>{if(!U||typeof U!="object")return;const Y=[Number(U.max),Number(U.maxDamage),Number(U.maxHit),Number(U.totalDamage)>0&&Number(U.connectedHits)>0?Number(U.totalDamage)/Number(U.connectedHits):0].filter(de=>Number.isFinite(de)),ke=Y.length>0?Math.max(...Y):0;ke>r&&(r=ke,C=M(U.id))};return Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(U=>{Array.isArray(U)&&U.forEach(Y=>K(Y))}),Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(U=>{Array.isArray(U)&&U.forEach(Y=>{Array.isArray(Y)&&Y.forEach(ke=>K(ke))})}),{peak:r,skillName:C||"Unknown Skill"}},Vi=(()=>{const e=F=>String(F||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=F=>e(F).toLowerCase().split(/[^a-z0-9]+/i).map(w=>w.trim()).filter(Boolean).map(w=>w.length>3&&w.endsWith("s")?w.slice(0,-1):w),n=(F,w)=>{const I=e(F),J=e(w);if(!J)return I;if(!I)return J;const se=t(I),l=t(J),u=new Set(se),b=new Set(l),h=l.length>0&&l.every(i=>u.has(i)),E=se.length>0&&se.every(i=>b.has(i));return h||E?I:`${I} - ${J}`},d=[],r=new Map,C=F=>{const w=h=>{if(!Array.isArray(h)||h.length===0)return[];const E=[];for(let i=0;i<h.length;i+=1){const D=Number(h[i]||0),B=i>0?Number(h[i-1]||0):0;E.push(Math.max(0,D-B))}return E},I=h=>{if(!Array.isArray(h))return[];const E=h.reduce((D,B)=>Math.max(D,Array.isArray(B)?B.length:0),0);if(E<=0)return[];const i=new Array(E).fill(0);return h.forEach(D=>{if(Array.isArray(D))for(let B=0;B<E;B+=1)i[B]+=Number(D[B]||0)}),i},J=h=>Array.isArray(h)?h.map(E=>Number(E||0)):null,l=(h=>{if(!Array.isArray(h)||h.length===0)return null;const E=h[0];if(!Array.isArray(E))return null;if(Array.isArray(E[0])&&Array.isArray(E[0][0]))return I(E);if(Array.isArray(E[0])&&!Array.isArray(E[0][0])){const i=h.map(D=>J(Array.isArray(D)?D[0]:null)).filter(D=>Array.isArray(D)&&D.length>0);if(i.length>0)return I(i)}return null})(F==null?void 0:F.targetDamage1S),u=Array.isArray(F==null?void 0:F.damage1S)&&Array.isArray(F.damage1S[0])?F.damage1S[0]:null,b=l||(Array.isArray(u)?u.map(h=>Number(h||0)):[]);return w(b)},M=(F,w)=>{if(!Array.isArray(F)||F.length===0||w<=0)return 0;let I=0,J=0;for(let se=0;se<F.length;se+=1)I+=Number(F[se]||0),se>=w&&(I-=Number(F[se-w]||0)),se>=w-1&&I>J&&(J=I);return Math.max(0,J)},K=(F,w)=>{if(!Array.isArray(F)||F.length===0||w<=0)return[];const I=[];for(let J=0;J<F.length;J+=w){const se=Math.min(J+w,F.length),l=F.slice(J,se).reduce((u,b)=>u+Number(b||0),0);I.push(l)}return I},U=(F,w)=>{const I=Number(F);if(!Number.isFinite(I))return{name:String(F||"Unknown Skill"),icon:void 0};const J=(w==null?void 0:w.skillMap)||{},se=(w==null?void 0:w.buffMap)||{},l=(J==null?void 0:J[`s${I}`])||(J==null?void 0:J[`${I}`]);if(l!=null&&l.name)return{name:String(l.name),icon:l==null?void 0:l.icon};const u=(se==null?void 0:se[`b${I}`])||(se==null?void 0:se[`${I}`]);return u!=null&&u.name?{name:String(u.name),icon:u==null?void 0:u.icon}:{name:`Skill ${I}`,icon:void 0}},Y=F=>Array.isArray(F)?F.map(w=>Array.isArray(w)?[Number(w[0]),Number(w[1])]:w&&typeof w=="object"?[Number(w.time),Number(w.value)]:null).filter(w=>!!w&&Number.isFinite(w[0])&&w[0]>=0):[],ke=(F,w,I,J,se)=>{if(!F.length||J<=0)return[];const l=Math.max(J*5e3,se||0),u=k=>k.reduce((q,Me)=>Me>=0&&Me<=l+2e3?q+1:q,0),b=F.map(k=>Number(k||0)).filter(k=>Number.isFinite(k)&&k>=0);if(!b.length)return[];const h=[b],E=b.reduce((k,q)=>Math.max(k,q),0),i=b.reduce((k,q)=>Math.min(k,q),Number.POSITIVE_INFINITY);E>l*20&&h.push(b.map(k=>k/1e3)),E<=l*2&&i>=0&&E>0&&E<Math.max(120,J*5+10)&&h.push(b.map(k=>k*1e3));let D=b,B=0,p=-1;return h.forEach(k=>{const q=k.reduce((ge,xe)=>Math.min(ge,xe),Number.POSITIVE_INFINITY),Me=new Set([0,...w,...I]);if(Number.isFinite(q)&&l>0&&q>l){const ge=Math.floor(q/l)*l;Me.add(ge),Me.add(Math.max(0,ge-l))}Me.forEach(ge=>{const xe=k.map(He=>He-ge),ce=u(xe);ce>p&&(p=ce,B=ge,D=k)})}),D.map(k=>k-B).filter(k=>Number.isFinite(k)&&k>=0)},de=(F,w,I,J,se)=>{const l=ke(F,w,I,J,se);return Array.from(new Set(l.map(u=>Math.floor(u/5e3)).filter(u=>Number.isFinite(u)&&u>=0&&u<J)))};W.map(F=>({log:F,ts:Qe(F==null?void 0:F.details,F)})).sort((F,w)=>F.ts-w.ts).forEach(({log:F},w)=>{const I=F==null?void 0:F.details;if(!I)return;const J=e(I.fightName||F.fightName||`Fight ${w+1}`),se=Pt(I,F),l=n(J,String(se||"")),u={},b=Array.isArray(I.players)?I.players:[],h=b.flatMap(p=>{const k=p==null?void 0:p.combatReplayData;return Array.isArray(k)?k.map(q=>Number(q==null?void 0:q.start)):[Number(k==null?void 0:k.start)]}).filter(p=>Number.isFinite(p)&&p>=0);b.forEach(p=>{if(p!=null&&p.notInSquad)return;const k=String((p==null?void 0:p.account)||(p==null?void 0:p.name)||"Unknown"),q=String((p==null?void 0:p.character_name)||(p==null?void 0:p.display_name)||(p==null?void 0:p.name)||""),Me=String((p==null?void 0:p.profession)||"Unknown"),ge=`${k}|${Me}`,xe=yi(p,I),ce=Number(xe.peak||0),He=C(p),s=Number(M(He,1)||0),g=Number(M(He,5)||0),$=Number(M(He,30)||0),Q=Math.max(0,Math.ceil(Number((I==null?void 0:I.durationMS)||0)/5e3)),V=Math.max(0,Math.ceil(He.length/5)),a=Math.max(Q,V),N=K(He,5),A=Array.from({length:a},(T,z)=>Number(N[z]||0)),H=new Map,ie=T=>{if(!T||typeof T!="object"||T.indirectDamage)return;const z=Number(T.totalDamage||0);if(!Number.isFinite(z)||z<=0)return;const L=Number(T.connectedHits||T.hits||0),oe=U(T.id,I),ae=oe.name,X=H.get(ae)||{skillName:ae,damage:0,hits:0,icon:oe.icon};X.damage+=z,X.hits+=Number.isFinite(L)?L:0,!X.icon&&oe.icon&&(X.icon=oe.icon),H.set(ae,X)};Array.isArray(p==null?void 0:p.targetDamageDist)&&p.targetDamageDist.forEach(T=>{Array.isArray(T)&&T.forEach(z=>{Array.isArray(z)&&z.forEach(L=>ie(L))})}),H.size===0&&Array.isArray(p==null?void 0:p.totalDamageDist)&&p.totalDamageDist.forEach(T=>{Array.isArray(T)&&T.forEach(z=>ie(z))});const Z=(()=>{const T=p==null?void 0:p.combatReplayData;return Array.isArray(T)?T.filter(z=>z&&typeof z=="object"):T&&typeof T=="object"?[T]:[]})(),_=Z.map(T=>Number(T==null?void 0:T.start)).filter(T=>Number.isFinite(T)&&T>=0),G=Z.flatMap(T=>Y(T==null?void 0:T.down).map(([z])=>Number(z||0))),ee=Z.flatMap(T=>Y(T==null?void 0:T.dead).map(([z])=>Number(z||0)));u[ge]={hit:ce,burst1s:s,burst5s:g,burst30s:$,skillName:xe.skillName,buckets5s:A,downIndices5s:de(G,_,h,a,Number((I==null?void 0:I.durationMS)||0)),deathIndices5s:de(ee,_,h,a,Number((I==null?void 0:I.durationMS)||0)),skillRows:Array.from(H.values()).sort((T,z)=>z.damage-T.damage).slice(0,50)};const R=r.get(ge)||{key:ge,account:k,displayName:k,characterName:q,profession:Me,professionList:[Me],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};R.logs+=1,R.professionList.includes(Me)||R.professionList.push(Me),!R.characterName&&q&&(R.characterName=q),ce>R.peakHit&&(R.peakHit=ce,R.peakFightLabel=l,R.peakSkillName=xe.skillName),s>R.peak1s&&(R.peak1s=s),g>R.peak5s&&(R.peak5s=g),$>R.peak30s&&(R.peak30s=$),r.set(ge,R)});const E=Object.values(u).reduce((p,k)=>Math.max(p,Number((k==null?void 0:k.hit)||0)),0),i=Object.values(u).reduce((p,k)=>Math.max(p,Number((k==null?void 0:k.burst1s)||0)),0),D=Object.values(u).reduce((p,k)=>Math.max(p,Number((k==null?void 0:k.burst5s)||0)),0),B=Object.values(u).reduce((p,k)=>Math.max(p,Number((k==null?void 0:k.burst30s)||0)),0);d.push({id:F.filePath||F.id||`fight-${w+1}`,shortLabel:`F${w+1}`,fullLabel:l,timestamp:Qe(I,F),values:u,maxHit:E,max1s:i,max5s:D,max30s:B})});const Re=Array.from(r.values()).sort((F,w)=>w.peakHit!==F.peakHit?w.peakHit-F.peakHit:F.displayName.localeCompare(w.displayName));return{fights:d,players:Re}})(),zi=(()=>{const e=l=>String(l||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=l=>e(l).toLowerCase().split(/[^a-z0-9]+/i).map(u=>u.trim()).filter(Boolean).map(u=>u.length>3&&u.endsWith("s")?u.slice(0,-1):u),n=(l,u)=>{const b=e(l),h=e(u);if(!h)return b;if(!b)return h;const E=t(b),i=t(h),D=new Set(E),B=new Set(i),p=i.length>0&&i.every(q=>D.has(q)),k=E.length>0&&E.every(q=>B.has(q));return p||k?b:`${b} - ${h}`},d=[],r=new Map,C=(l,u)=>{const b=Number(l);if(!Number.isFinite(b))return{name:String(l||"Unknown Skill"),icon:void 0};const h=(u==null?void 0:u.skillMap)||{},E=(u==null?void 0:u.buffMap)||{},i=(h==null?void 0:h[`s${b}`])||(h==null?void 0:h[`${b}`]);if(i!=null&&i.name)return{name:String(i.name),icon:i==null?void 0:i.icon};const D=(E==null?void 0:E[`b${b}`])||(E==null?void 0:E[`${b}`]);return D!=null&&D.name?{name:String(D.name),icon:D==null?void 0:D.icon}:{name:`Skill ${b}`,icon:void 0}},M=(l,u)=>{let b=0,h="";const E=i=>{if(!i||typeof i!="object"||i.indirectDamage)return;const D=[Number(i.max),Number(i.maxDamage),Number(i.maxHit),Number(i.totalDamage)>0&&Number(i.connectedHits)>0?Number(i.totalDamage)/Number(i.connectedHits):0].filter(p=>Number.isFinite(p)),B=D.length>0?Math.max(...D):0;B>b&&(b=B,h=C(i.id,u).name)};return Array.isArray(l==null?void 0:l.totalDamageDist)&&l.totalDamageDist.forEach(i=>{Array.isArray(i)&&i.forEach(D=>E(D))}),Array.isArray(l==null?void 0:l.targetDamageDist)&&l.targetDamageDist.forEach(i=>{Array.isArray(i)&&i.forEach(D=>{Array.isArray(D)&&D.forEach(B=>E(B))})}),{peak:b,skillName:h||"Unknown Skill"}},K=l=>{if(!Array.isArray(l)||l.length===0)return[];const u=[];for(let b=0;b<l.length;b+=1){const h=Number(l[b]||0),E=b>0?Number(l[b-1]||0):0;u.push(Math.max(0,h-E))}return u},U=l=>{if(!Array.isArray(l)||l.length===0)return[];const u=l.reduce((h,E)=>Math.max(h,Array.isArray(E)?E.length:0),0);if(u<=0)return[];const b=new Array(u).fill(0);return l.forEach(h=>{if(Array.isArray(h))for(let E=0;E<u;E+=1)b[E]+=Number(h[E]||0)}),b},Y=l=>{if(!Array.isArray(l)||l.length===0)return[];const u=l[0];if(typeof u=="number")return l.map(b=>Number(b||0));if(Array.isArray(u)&&u.length>0){if(typeof u[0]=="number")return u.map(b=>Number(b||0));if(Array.isArray(u[0])){const b=u.map(h=>Array.isArray(h)?h.map(E=>Number(E||0)):null).filter(h=>Array.isArray(h)&&h.length>0);if(b.length>0)return U(b)}}return[]},ke=l=>{const u=Y(l==null?void 0:l.powerDamage1S),b=Y(l==null?void 0:l.damage1S),h=u.length>0?u:b;return K(h)},de=(l,u)=>{const b=l==null?void 0:l.targetPowerDamage1S;if(!Array.isArray(b)||!Array.isArray(b[u]))return[];const h=b[u];if(!Array.isArray(h)||h.length===0)return[];if(typeof h[0]=="number")return h.map(E=>Number(E||0));if(Array.isArray(h[0])&&!Array.isArray(h[0][0]))return h[0].map(E=>Number(E||0));if(Array.isArray(h[0])&&Array.isArray(h[0][0])){const i=h[0].map(D=>Array.isArray(D)?D.map(B=>Number(B||0)):null).filter(D=>Array.isArray(D)&&D.length>0);return U(i)}return[]},Re=(l,u)=>{if(!Array.isArray(l)||l.length===0||u<=0)return 0;let b=0,h=0;for(let E=0;E<l.length;E+=1)b+=Number(l[E]||0),E>=u&&(b-=Number(l[E-u]||0)),E>=u-1&&b>h&&(h=b);return Math.max(0,h)},F=(l,u)=>{if(!Array.isArray(l)||l.length===0||u<=0)return[];const b=[];for(let h=0;h<l.length;h+=u){const E=Math.min(h+u,l.length),i=l.slice(h,E).reduce((D,B)=>D+Number(B||0),0);b.push(i)}return b},w=l=>Array.isArray(l)?l.map(u=>Array.isArray(u)?[Number(u[0]),Number(u[1])]:u&&typeof u=="object"?[Number(u.time),Number(u.value)]:null).filter(u=>!!u&&Number.isFinite(u[0])&&u[0]>=0):[],I=(l,u,b,h,E)=>{if(!l.length||h<=0)return[];const i=Math.max(h*5e3,E||0),D=ce=>ce.reduce((He,s)=>s>=0&&s<=i+2e3?He+1:He,0),B=l.map(ce=>Number(ce||0)).filter(ce=>Number.isFinite(ce)&&ce>=0);if(!B.length)return[];const p=[B],k=B.reduce((ce,He)=>Math.max(ce,He),0),q=B.reduce((ce,He)=>Math.min(ce,He),Number.POSITIVE_INFINITY);k>i*20&&p.push(B.map(ce=>ce/1e3)),k<=i*2&&q>=0&&k>0&&k<Math.max(120,h*5+10)&&p.push(B.map(ce=>ce*1e3));let Me=B,ge=0,xe=-1;return p.forEach(ce=>{const He=ce.reduce((g,$)=>Math.min(g,$),Number.POSITIVE_INFINITY),s=new Set([0,...u,...b]);if(Number.isFinite(He)&&i>0&&He>i){const g=Math.floor(He/i)*i;s.add(g),s.add(Math.max(0,g-i))}s.forEach(g=>{const $=ce.map(V=>V-g),Q=D($);Q>xe&&(xe=Q,ge=g,Me=ce)})}),Me.map(ce=>ce-ge).filter(ce=>Number.isFinite(ce)&&ce>=0)},J=(l,u,b,h,E)=>{const i=I(l,u,b,h,E);return Array.from(new Set(i.map(D=>Math.floor(D/5e3)).filter(D=>Number.isFinite(D)&&D>=0&&D<h)))};W.map(l=>({log:l,ts:Qe(l==null?void 0:l.details,l)})).sort((l,u)=>l.ts-u.ts).forEach(({log:l},u)=>{const b=l==null?void 0:l.details;if(!b)return;const h=e(b.fightName||l.fightName||`Fight ${u+1}`),E=Pt(b,l),i=n(h,String(E||"")),D={},p=(Array.isArray(b.players)?b.players:[]).filter(a=>!(a!=null&&a.notInSquad)),k=p.flatMap(a=>{const N=a==null?void 0:a.combatReplayData;return Array.isArray(N)?N.map(A=>Number(A==null?void 0:A.start)):[Number(N==null?void 0:N.start)]}).filter(a=>Number.isFinite(a)&&a>=0),q=p.flatMap(a=>{const N=a==null?void 0:a.combatReplayData;return(Array.isArray(N)?N:N?[N]:[]).flatMap(H=>w(H==null?void 0:H.down).map(([ie])=>Number(ie||0)))}),Me=p.flatMap(a=>{const N=a==null?void 0:a.combatReplayData;return(Array.isArray(N)?N:N?[N]:[]).flatMap(H=>w(H==null?void 0:H.dead).map(([ie])=>Number(ie||0)))}),ge=new Map,xe=new Map,ce=new Map;(Array.isArray(b.targets)?b.targets:[]).forEach((a,N)=>{if(!a||a.isFake||!a.enemyPlayer)return;const A=at((a==null?void 0:a.profession)||(a==null?void 0:a.name)||(a==null?void 0:a.id))||"Unknown";ce.set(A,(ce.get(A)||0)+1);const H=xe.get(A)||new Map;Array.isArray(a==null?void 0:a.totalDamageDist)&&a.totalDamageDist.forEach(R=>{Array.isArray(R)&&R.forEach(T=>{if(!T||typeof T!="object"||T.indirectDamage)return;const z=Number(T.totalDamage||0);if(!Number.isFinite(z)||z<=0)return;const L=Number(T.connectedHits||T.hits||0),oe=C(T.id,b),ae=oe.name,X=H.get(ae)||{skillName:ae,damage:0,hits:0,icon:oe.icon};X.damage+=z,X.hits+=Number.isFinite(L)?L:0,!X.icon&&oe.icon&&(X.icon=oe.icon),H.set(ae,X)})}),xe.set(A,H);const ie=U(p.map(R=>de(R,N))),Z=ie.length>0?K(ie):ke(a),_=M(a,b);let G=ge.get(A);G||(G={perSecond:[],hit:0,skillName:""},ge.set(A,G)),Z.length>G.perSecond.length&&(G.perSecond.length=Z.length);for(let R=0;R<Z.length;R+=1)G.perSecond[R]=Number(G.perSecond[R]||0)+Number(Z[R]||0);const ee=Number(_.peak||0);ee>G.hit&&(G.hit=ee,G.skillName=_.skillName||"Unknown Skill")});const s=Array.from(ge.values()).some(a=>Array.isArray(a.perSecond)&&a.perSecond.some(N=>Number(N||0)>0));if(ge.size===0||!s){const a=U(p.map(A=>{const H=Y(A==null?void 0:A.powerDamageTaken1S);return K(H)})),N=Array.from(ce.values()).reduce((A,H)=>A+Number(H||0),0);a.length>0&&N>0&&ce.forEach((A,H)=>{const ie=Number(A||0)/N,Z=a.map(G=>Number(G||0)*ie),_=ge.get(H);ge.set(H,{perSecond:Z,hit:Number((_==null?void 0:_.hit)||0),skillName:String((_==null?void 0:_.skillName)||"")})})}ge.forEach((a,N)=>{var oe;const A=N,H=Number(a.hit||0),ie=Number(Re(a.perSecond,1)||0),Z=Number(Re(a.perSecond,5)||0),_=Number(Re(a.perSecond,30)||0),G=Math.max(0,Math.ceil(Number((b==null?void 0:b.durationMS)||0)/5e3)),ee=Math.max(0,Math.ceil(a.perSecond.length/5)),R=Math.max(G,ee),T=F(a.perSecond,5),z=Array.from({length:R},(ae,X)=>Number(T[X]||0));D[A]={hit:H,burst1s:ie,burst5s:Z,burst30s:_,skillName:a.skillName||"Unknown Skill",buckets5s:z,downIndices5s:J(q,[],k,R,Number((b==null?void 0:b.durationMS)||0)),deathIndices5s:J(Me,[],k,R,Number((b==null?void 0:b.durationMS)||0)),skillRows:Array.from(((oe=xe.get(N))==null?void 0:oe.values())||[]).sort((ae,X)=>X.damage-ae.damage).slice(0,50)};const L=r.get(A)||{key:A,account:N,displayName:N,characterName:"",profession:N,professionList:[N],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};L.logs+=1,H>L.peakHit&&(L.peakHit=H,L.peakFightLabel=i,L.peakSkillName=a.skillName||"Unknown Skill"),ie>L.peak1s&&(L.peak1s=ie),Z>L.peak5s&&(L.peak5s=Z),_>L.peak30s&&(L.peak30s=_),r.set(A,L)});const g=Object.values(D).reduce((a,N)=>Math.max(a,Number((N==null?void 0:N.hit)||0)),0),$=Object.values(D).reduce((a,N)=>Math.max(a,Number((N==null?void 0:N.burst1s)||0)),0),Q=Object.values(D).reduce((a,N)=>Math.max(a,Number((N==null?void 0:N.burst5s)||0)),0),V=Object.values(D).reduce((a,N)=>Math.max(a,Number((N==null?void 0:N.burst30s)||0)),0);d.push({id:l.filePath||l.id||`fight-${u+1}`,shortLabel:`F${u+1}`,fullLabel:i,timestamp:Qe(b,l),values:D,maxHit:g,max1s:$,max5s:Q,max30s:V})});const se=Array.from(r.values()).sort((l,u)=>u.peakHit!==l.peakHit?u.peakHit-l.peakHit:l.displayName.localeCompare(u.displayName));return{fights:d,players:se}})(),Ki=Array.from(Xe.entries()).map(([e,t])=>{const n=tt.get(e)||{},d=Array.from(t.values()).map(r=>{var Re,F;const C=Array.from(r.professions||[]).filter(w=>w&&w!=="Unknown");let M=r.profession||"Unknown";if(C.length>0){M=C[0];let w=((Re=r.professionTimeMs)==null?void 0:Re[M])||0;C.forEach(I=>{var se;const J=((se=r.professionTimeMs)==null?void 0:se[I])||0;J>w&&(w=J,M=I)})}const K=r.durationMs||0,U=r.totalMs/1e3,Y=K>0?r.totalMs/K:0,ke=((F=Ne.get(r.account))==null?void 0:F.supportActiveMs)||K,de=ke>0?r.uptimeMs/ke:0;return{account:r.account,profession:M,professionList:C,total:U,perSecond:Y,uptimePerSecond:de,duration:K/1e3}}).filter(r=>r.total>0||r.perSecond>0);return{id:e,name:n.name||e,icon:n.icon,rows:d}}).filter(e=>e.rows.length>0),Gi=Array.from(qe.values()).map(e=>{const t=Array.from(e.skills.values()).sort((d,r)=>r.damage-d.damage),n=t.reduce((d,r)=>(d[r.id]=r,d),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t,skillMap:n}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:y,wins:be,losses:x,avgSquadSize:Ti,avgEnemies:Mi,squadKDR:wi,enemyKDR:vi,totalSquadKills:De,totalSquadDeaths:me,totalEnemyKills:fe,totalEnemyDeaths:Oe,leaderboards:Pe,...Pi,outgoingConditionSummary:Object.values(Ie).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values($e).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(Ne.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(Ne.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:Hi,topIncomingSkills:Ui,playerSkillBreakdowns:Gi,topSkillsMetric:O,mapData:xi,timelineData:Oi,boonTables:Ri,offensePlayers:Array.from(Ne.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(Ne.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:Ei,damageMitigationMinions:Fi,supportPlayers:Array.from(Ne.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(Ne.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:jt,silver:Dn,bronze:Nn,squadClassData:_i,enemyClassData:ji,fightBreakdown:Wi,spikeDamage:Vi,incomingStrikeDamage:zi,specialTables:Ki,topStatsPerSecond:Ze,topStatsLeaderboardsPerSecond:Je,avgMvpScore:An}})(),We=(()=>{const Ce=new Map,Se=new Map,O=[],y=new Map,be=new Map;W.forEach(le=>{const ue=le.details;if(!ue)return;const me=ue.skillMap||{},De=ue.fightName||"Log",Oe=Qe(ue,le)||Date.now(),fe={id:le.filePath||le.id||De,label:De,timestamp:Oe,skillEntries:{},playerActiveSeconds:{},durationSeconds:ue.durationMS?ue.durationMS/1e3:0};(ue.players||[]).forEach(Be=>{if(Be.notInSquad)return;const Ne=Be.account||Be.name||"Unknown",_e=Be.profession||"Unknown",Ae=`${Ne}|${_e}`;let Te=Se.get(Ae);Te||(Te={key:Ae,account:Ne,displayName:Ne,profession:_e,professionList:[_e],logs:0,totalActiveSeconds:0,skillTotals:{}},Se.set(Ae,Te)),Te.logs++;const qe=(Array.isArray(Be.activeTimes)?Be.activeTimes[0]:0)/1e3;Te.totalActiveSeconds=(Te.totalActiveSeconds||0)+qe,fe.playerActiveSeconds[Ae]=qe,(Be.rotation||[]).forEach(Ie=>{var Tt,Mt,wt;if(!(Ie!=null&&Ie.id))return;const $e=((Tt=Ie.skills)==null?void 0:Tt.length)||0;if($e<=0)return;const Ee=`s${Ie.id}`,tt=((Mt=me[Ee])==null?void 0:Mt.name)||`Skill ${Ie.id}`,Xe=(wt=me[Ee])==null?void 0:wt.icon;Te.skillTotals[Ee]=(Te.skillTotals[Ee]||0)+$e,Ce.set(Ee,(Ce.get(Ee)||0)+$e),y.set(Ee,tt),Xe&&!be.has(Ee)&&be.set(Ee,Xe),fe.skillEntries[Ee]||(fe.skillEntries[Ee]={name:tt,icon:Xe,players:{}}),!fe.skillEntries[Ee].icon&&Xe&&(fe.skillEntries[Ee].icon=Xe),fe.skillEntries[Ee].players[Ae]=(fe.skillEntries[Ee].players[Ae]||0)+$e})}),O.push(fe)});const x=Array.from(Ce.entries()).map(([le,ue])=>({id:le,name:y.get(le)||le,total:ue,icon:be.get(le)})).sort((le,ue)=>ue.total-le.total);return{logRecords:O,players:Array.from(Se.values()),skillOptions:x,resUtilitySkills:[]}})();return{validLogs:W,stats:Le,skillUsageData:We}};let Ye=null,mt=!1,sn=null,an=0,rn=0,Lt=null;const cn=o=>{if(!o||typeof o!="object")return o;const c=(P,j)=>{const W={};return j.forEach(pe=>{P&&Object.prototype.hasOwnProperty.call(P,pe)&&(W[pe]=P[pe])}),W},m=c(o,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(m.players)&&(m.players=m.players.map(P=>c(P,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","powerDamageTaken1S","targetPowerDamage1S","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(m.targets)&&(m.targets=m.targets.map(P=>c(P,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist","powerDamage1S","damage1S"]))),m},Di=o=>{if(!o||typeof o!="object")return o;const c={...o};return o.details?c.details=cn(o.details):c.details=cn(o),c},ln=()=>{if(!mt||!Ye)return;mt=!1,an+=1;const o=Lt;Lt=null;const c=Ci(Ye);self.postMessage({type:"result",result:c,computeId:an,logCount:Ye.logs.length,token:rn,completedAt:Date.now(),flushId:o})},xt=()=>{sn===null&&(sn=setInterval(()=>{ln()},5e3))};self.onmessage=o=>{var m,P,j,W;const c=o.data;if((c==null?void 0:c.type)==="reset"){Ye={logs:[]},typeof c.token=="number"&&(rn=c.token),mt=!0,xt();return}if((c==null?void 0:c.type)==="settings"){Ye={logs:(Ye==null?void 0:Ye.logs)||[],precomputedStats:(m=c.payload)==null?void 0:m.precomputedStats,mvpWeights:(P=c.payload)==null?void 0:P.mvpWeights,statsViewSettings:(j=c.payload)==null?void 0:j.statsViewSettings,disruptionMethod:(W=c.payload)==null?void 0:W.disruptionMethod},mt=!0,xt();return}if((c==null?void 0:c.type)==="log"){Ye||(Ye={logs:[]}),Ye.logs.push(Di(c.payload)),mt=!0,xt();return}(c==null?void 0:c.type)==="flush"&&(typeof c.flushId=="number"&&(Lt=c.flushId),mt=!0,ln())}})();
