(function(){"use strict";const zt=["selfBuffs","groupBuffs","squadBuffs"],Kt=o=>o!=null&&o.classification?o.classification==="Boon":!0,Gt=o=>`b${o}`,Bn=(o,c)=>{const m=Array.isArray(o==null?void 0:o.activeTimes)?o.activeTimes:[],I=typeof m[0]=="number"?m[0]:0;return I>0?I:c},Yt=(o,c,m,I,j,W,pe)=>{const ee=o==="selfBuffs"?1:Math.max(o==="groupBuffs"?W-1:pe-1,0);return!ee||!j?{generationMs:0,wastedMs:0}:c?{generationMs:m*j*ee,wastedMs:I*j*ee}:{generationMs:m/100*j*ee,wastedMs:I/100*j*ee}},In=o=>{const c=new Map,m=new Map;return o.forEach(W=>{const pe=W.details;if(!pe)return;const ee=pe.durationMS||0,he=pe.buffMap||{};Object.entries(he).forEach(([R,y])=>{if(!c.has(R)){c.set(R,y);return}const be=c.get(R)||{},x={name:be.name||y.name,stacking:be.stacking??y.stacking,icon:be.icon||y.icon,classification:be.classification||y.classification};c.set(R,x)});const ye=(pe.players||[]).filter(R=>!R.notInSquad),Ce=ye.length,Se=new Map;ye.forEach(R=>{const y=R.group??0;Se.set(y,(Se.get(y)||0)+1)}),ye.forEach(R=>{const y=R.account||R.name||R.character_name||"Unknown",be=R.profession||"Unknown",x=R.group??0,ue=Se.get(x)||1,me=Bn(R,ee);m.has(y)||m.set(y,{account:y,profession:be,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const de=m.get(y);de.profession=be,be!=="Unknown"&&(de.professions.add(be),de.professionTimeMs[be]=(de.professionTimeMs[be]||0)+me),de.activeTimeMs+=me,de.numFights+=1,de.groupSupported+=ue,de.squadSupported+=Ce,zt.forEach(De=>{(R[De]||[]).forEach(fe=>{var Be,Le,Ee,Ze;if(typeof(fe==null?void 0:fe.id)!="number")return;const Ue=Gt(fe.id),Fe=he[Ue];if(!Kt(Fe))return;const Ae=(Fe==null?void 0:Fe.stacking)??!1,qe=((Le=(Be=fe.buffData)==null?void 0:Be[0])==null?void 0:Le.generation)??0,Ne=((Ze=(Ee=fe.buffData)==null?void 0:Ee[0])==null?void 0:Ze.wasted)??0,{generationMs:Te,wastedMs:je}=Yt(De,Ae,qe,Ne,ee,ue,Ce);!Te&&!je||(c.has(Ue)||c.set(Ue,Fe||{}),de.boons[Ue]||(de.boons[Ue]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),de.boons[Ue][De].generationMs+=Te,de.boons[Ue][De].wastedMs+=je)})})})}),{boonTables:Array.from(c.keys()).filter(W=>Kt(c.get(W))).map(W=>{const pe=c.get(W)||{},ee=[];return m.forEach(he=>{var R;const xe=he.boons[W];if(!xe||!zt.some(y=>xe[y].generationMs>0||xe[y].wastedMs>0))return;const Ce=Array.from(he.professions||[]).filter(y=>y&&y!=="Unknown");let Se=he.profession;if(Ce.length>0){Se=Ce[0];let y=((R=he.professionTimeMs)==null?void 0:R[Se])||0;Ce.forEach(be=>{var ue;const x=((ue=he.professionTimeMs)==null?void 0:ue[be])||0;x>y&&(y=x,Se=be)})}ee.push({account:he.account,profession:Se||"Unknown",professionList:Ce,activeTimeMs:he.activeTimeMs||1,numFights:he.numFights||1,groupSupported:he.groupSupported||1,squadSupported:he.squadSupported||1,categories:{selfBuffs:{...xe.selfBuffs},groupBuffs:{...xe.groupBuffs},squadBuffs:{...xe.squadBuffs}}})}),{id:W,name:pe.name||W,icon:pe.icon,stacking:pe.stacking??!1,rows:ee}}).filter(W=>W.rows.length>0)}},Jt=(o,c,m,I,j,W,pe={})=>{var R,y,be,x;const he=((o==null?void 0:o[c])||[]).find(ue=>ue.id===m);if(!he)return{generationMs:0,wastedMs:0};const xe=pe[Gt(m)],ye=(xe==null?void 0:xe.stacking)??!1,Ce=((y=(R=he.buffData)==null?void 0:R[0])==null?void 0:y.generation)??0,Se=((x=(be=he.buffData)==null?void 0:be[0])==null?void 0:x.wasted)??0;return Yt(c,ye,Ce,Se,I,j,W)};var Pn={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Hn=Pn,$t="count",Un=o=>(o||0)/1e3,$n=(o,c)=>{var j;if(!o)return 0;const m=(j=Hn.methods.tiered)==null?void 0:j.tiers;if(!m)return o;const I=c/Math.max(o,1);return I<=m.shortMs?o*m.weights.short:I<=m.mediumMs?o*m.weights.medium:o*m.weights.long},Qt=(o,c,m)=>m==="duration"?Un(c):m==="tiered"?$n(o,c):o;function Ln(o,c=$t){var W;const m=(W=o.statsAll)==null?void 0:W[0],I=Number((m==null?void 0:m.appliedCrowdControl)??0),j=Number((m==null?void 0:m.appliedCrowdControlDuration)??0);return Qt(I,j,c)}function xn(o,c){const m=(c==null?void 0:c.durationMS)||0,I=(c==null?void 0:c.buffMap)||{},j=o.filter(ee=>!ee.notInSquad),W=j.length,pe=new Map;j.forEach(ee=>{const he=ee.group??0;pe.set(he,(pe.get(he)||0)+1)}),j.forEach(ee=>{const he=pe.get(ee.group??0)||1,xe=Jt(ee,"selfBuffs",1122,m,he,W,I),ye=Jt(ee,"squadBuffs",1122,m,he,W,I);ee.stabGeneration=(xe.generationMs+ye.generationMs)/1e3})}function On(o){if(!o.statsTargets)return 0;let c=0;for(const m of o.statsTargets)m&&m.length>0&&(c+=m[0].downContribution||0);return c}function Rn(o){if(!o.extBarrierStats||!o.extBarrierStats.outgoingBarrierAllies)return 0;let c=0;for(const m of o.extBarrierStats.outgoingBarrierAllies)if(m)for(const I of m)I&&(c+=I.barrier||0);return c}function _n(o){if(!o.extHealingStats||!o.extHealingStats.outgoingHealingAllies)return 0;let c=0;for(const m of o.extHealingStats.outgoingHealingAllies)if(m)for(const I of m)I&&(c+=I.healing||0);return c}const qn=o=>{var c,m,I,j;return(((m=(c=o.support)==null?void 0:c[0])==null?void 0:m.condiCleanse)||0)+(((j=(I=o.support)==null?void 0:I[0])==null?void 0:j.condiCleanseSelf)||0)},jn=(o,c=$t)=>{var W;const m=(W=o.support)==null?void 0:W[0],I=Number((m==null?void 0:m.boonStrips)??0),j=Number((m==null?void 0:m.boonStripsTime)??0);return Qt(I,j,c)},Wn=o=>On(o),yn=o=>_n(o),Vn=o=>Rn(o),zn=(o,c=$t)=>Ln(o,c),Kn=(o,c)=>xn(o,c),Gn="count",Yn={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},Jn={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},Xt=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),Qn={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},ft=o=>{if(!o)return null;const c=o.trim().toLowerCase(),m=Xt.get(c);if(m)return m;const I=c.split(/[^a-z]+/).filter(Boolean);for(const j of I){const W=Xt.get(j);if(W)return W}return null},Xn=o=>ft(o),Zt=o=>{const c=new Map;return o&&(Object.values(o).forEach(m=>{if(!(m!=null&&m.icon)||!(m!=null&&m.name))return;const I=ft(m.name);I&&(c.has(I)||c.set(I,m.icon))}),Object.entries(Qn).forEach(([m,I])=>{c.has(m)||c.set(m,I)})),c},Nt=(o,c,m)=>{var I;if(c&&m){const j=(I=m[`b${c}`])==null?void 0:I.name,W=ft(j);if(W)return W}return o?ft(o):null},Zn=o=>{const c=(o==null?void 0:o.account)||"Unknown";return c&&c!=="Unknown"?c:(o==null?void 0:o.name)||"Unknown"||null},ei=o=>{if(!o||o.length===0)return 0;let c=0,m=null;return o.forEach(I=>{const j=Number(I[1]??0);if(Number.isFinite(j)){if(m===null){m=j;return}j>m&&(c+=j-m),m=j}}),c},ti=o=>{if(!o||o.length===0)return 0;let c=0;return o.forEach(m=>{const I=Number(m[0]??0),j=Number(m[1]??0);Number.isFinite(j)&&I!==0&&j>0&&(c+=1)}),c},ni=o=>{const{players:c,targets:m,skillMap:I,buffMap:j}=o,W=o.getPlayerKey||Zn,pe=Zt(j),ee={},he={};c.forEach(R=>{if(R!=null&&R.notInSquad)return;const y=W(R);y&&(ee[y]||(ee[y]={}),R!=null&&R.totalDamageDist&&R.totalDamageDist.forEach(be=>{be&&be.forEach(x=>{if(!x.id)return;let ue=`Skill ${x.id}`,me;I&&(I[`s${x.id}`]?(ue=I[`s${x.id}`].name||ue,me=I[`s${x.id}`].icon||me):I[`${x.id}`]&&(ue=I[`${x.id}`].name||ue,me=I[`${x.id}`].icon||me));const de=Nt(ue,x.id,j);if(!de)return;const De=j==null?void 0:j[`b${x.id}`],_e=De==null?void 0:De.name,fe=pe.get(de)||(De==null?void 0:De.icon),Ue=ue.startsWith("Skill ")?_e||de:ue,Fe=me||(De==null?void 0:De.icon),Ae=Number(x.connectedHits??0),qe=Number(x.hits??0),Ne=Ae>0?Ae:qe,Te=Number(x.totalDamage??0);if(!Number.isFinite(Ne)&&!Number.isFinite(Te))return;const je=he[de]||{name:de,icon:fe,applications:0,damage:0};je.applications+=Number.isFinite(Ne)?Ne:0,je.damage+=Number.isFinite(Te)?Te:0,!je.icon&&fe&&(je.icon=fe),he[de]=je;const Be=ee[y][de]||{icon:fe,applications:0,damage:0,skills:{}};Be.applications+=Number.isFinite(Ne)?Ne:0,Be.damage+=Number.isFinite(Te)?Te:0;const Le=Be.skills[Ue]||{name:Ue,hits:0,damage:0,icon:Fe};Le.hits+=Number.isFinite(Ne)?Ne:0,Le.damage+=Number.isFinite(Te)?Te:0,!Le.icon&&Fe&&(Le.icon=Fe),Be.skills[Ue]=Le,!Be.icon&&fe&&(Be.icon=fe),ee[y][de]=Be})}))});const xe=new Map;c.forEach(R=>{if(R!=null&&R.notInSquad)return;const y=W(R);y&&R!=null&&R.name&&xe.set(R.name,y)});let ye=0,Ce=0,Se=0;return m.forEach(R=>{R!=null&&R.buffs&&R.buffs.forEach(y=>{const be=Number(y==null?void 0:y.id);if(!Number.isFinite(be))return;const x=j==null?void 0:j[`b${be}`],ue=ft(x==null?void 0:x.name);if(!ue||x!=null&&x.classification&&x.classification!=="Condition")return;const me=ue;if(!me)return;const de=y.statesPerSource||{};Se+=1,Object.entries(de).forEach(([De,_e])=>{var Ne;const fe=xe.get(De);if(!fe)return;Ce+=1;const Ue=ei(_e),Fe=ti(_e);ye+=Ue;const Ae=((Ne=ee[fe])==null?void 0:Ne[me])||{applications:0,damage:0,skills:{}};Ae.applicationsFromBuffs=(Ae.applicationsFromBuffs||0)+Ue,Ae.applicationsFromBuffsActive=(Ae.applicationsFromBuffsActive||0)+Fe,ee[fe]=ee[fe]||{},ee[fe][me]=Ae;const qe=he[me]||{name:me,applications:0,damage:0};qe.applicationsFromBuffs=(qe.applicationsFromBuffs||0)+Ue,qe.applicationsFromBuffsActive=(qe.applicationsFromBuffsActive||0)+Fe,he[me]=qe})})}),Object.values(ee).forEach(R=>{Object.values(R).forEach(y=>{typeof y.applicationsFromBuffs=="number"&&(y.applications=y.applicationsFromBuffs)})}),Object.values(he).forEach(R=>{typeof R.applicationsFromBuffs=="number"&&(R.applications=R.applicationsFromBuffs)}),{playerConditions:ee,summary:he,meta:{buffStateApplicationsTotal:ye,targetBuffEntriesSeen:Se,buffStateSourcesSeen:Ce}}},ii=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),oi=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],si=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],ai=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],ri=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],ci=new Set([10244]),li=(o,c)=>{var j;if(ci.has(o))return!0;const m=(c==null?void 0:c[`s${o}`])||(c==null?void 0:c[`${o}`]),I=((j=m==null?void 0:m.name)==null?void 0:j.toLowerCase())||"";return ri.some(W=>I.includes(W))},ui=o=>{if(!o||!Number.isFinite(o))return"--:--";const c=Math.max(0,Math.round(o/1e3)),m=Math.floor(c/3600),I=Math.floor(c%3600/60),j=c%60;return m>0?`${m}:${String(I).padStart(2,"0")}:${String(j).padStart(2,"0")}`:`${I}:${String(j).padStart(2,"0")}`},At={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function en(o){return At[o]||At.Unknown}const mi=o=>{if(o==null||o==="")return 0;if(typeof o=="number")return!Number.isFinite(o)||o<=0?0:o>1e12?o:o*1e3;if(o instanceof Date){const pe=o.getTime();return Number.isFinite(pe)&&pe>0?pe:0}const c=String(o).trim();if(!c)return 0;const m=Number(c);if(Number.isFinite(m)&&m>0)return m>1e12?m:m*1e3;const I=Date.parse(c);if(Number.isFinite(I)&&I>0)return I;const j=c.replace(/([+-]\d{2})$/,"$1:00"),W=Date.parse(j);return Number.isFinite(W)&&W>0?W:0},Je=(o,c)=>mi((o==null?void 0:o.uploadTime)??(c==null?void 0:c.uploadTime)??(o==null?void 0:o.timeStartStd)??(o==null?void 0:o.timeStart)??(o==null?void 0:o.timeEndStd)??(o==null?void 0:o.timeEnd)??(o==null?void 0:o.timeStartText)??(o==null?void 0:o.timeEndText)),di=({logs:o,precomputedStats:c,mvpWeights:m,statsViewSettings:I,disruptionMethod:j})=>{const W=(()=>{const Ce=o.filter(Se=>Se.details&&Se.details.players&&Se.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:o.length,passed:Ce.length,statuses:o.map(Se=>Se.status),hasDetails:o.map(Se=>!!Se.details)}),Ce})(),pe=I||Jn,ee=m||Yn,he=Ce=>{if(!Ce||typeof Ce!="object")return Ce;const Se=Array.isArray(Ce.fightBreakdown)?Ce.fightBreakdown:null;if(!Se||Se.length===0)return Ce;const R=new Map,y=new Map;o.forEach(x=>{var de;const ue=(x==null?void 0:x.filePath)||(x==null?void 0:x.id);ue&&R.set(String(ue),x);const me=(x==null?void 0:x.permalink)||((de=x==null?void 0:x.details)==null?void 0:de.permalink);typeof me=="string"&&me.trim()&&y.set(me.trim(),x)});const be=Se.map(x=>{if(!x||typeof x!="object"||Number(x.timestamp)>0)return x;const me=x.id?String(x.id):"",de=typeof x.permalink=="string"?x.permalink.trim():"",De=(me?R.get(me):void 0)||(de?y.get(de):void 0);if(!De)return x;const _e=Je(De==null?void 0:De.details,De);return _e?{...x,timestamp:_e}:x});return{...Ce,fightBreakdown:be}},xe=(()=>{if(c)return he(c);const Ce=j||Gn,Se=pe.topSkillDamageSource||"target",R=pe.topSkillsMetric||"damage",y=W.length;let be=0,x=0,ue=0,me=0,de=0,De=0,_e=0,fe=0;const Ue=e=>{const n=((e==null?void 0:e.players)||[]).filter(K=>!K.notInSquad);let d=0,r=0,C=0,M=0;return n.forEach(K=>{var ae;const H=(ae=K.defenses)==null?void 0:ae[0];if(!H)return;const Y=Number(H.downCount||0),ke=Number(H.deadCount||0);d+=Y+ke,C+=ke}),n.forEach(K=>{!K.statsTargets||K.statsTargets.length===0||K.statsTargets.forEach(H=>{const Y=H==null?void 0:H[0];if(!Y)return;const ke=Number(Y.downed||0),ae=Number(Y.killed||0);r+=ke+ae,M+=ae})}),{squadDownsDeaths:d,enemyDownsDeaths:r,squadDeaths:C,enemyDeaths:M}},Fe=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:n}=Ue(e);return t>0||n>0?n>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},Ae=new Map,qe=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),Ne={},Te={},je=new Map,Be={},Le={},Ee={},Ze=new Map,Qe=new Map,Tt=new Set(Object.keys(At)),Mt=Object.keys(At).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),wt=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],st=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Tt.has(t))return t;const n=t.toLowerCase();for(const r of Mt)if(n.includes(r.toLowerCase()))return r;return wt.find(r=>n.includes(r.toLowerCase()))||t||"Unknown"},gi=e=>e!=null&&e.classification?e.classification==="Boon":!0,vt=new Map,Et=new Map,gt=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),ce=e=>{const t=Number(e);return Number.isFinite(t)?t:0},rn=e=>{const t=String(e).split("|"),n=t[0]||"Unknown",d=st(t[1]||"Unknown"),r=t[2]||n||"Unknown";return{name:n,profession:d,account:r}},cn=(e,t,n)=>{let d=e.get(t);return d?n.profession&&!d.professionList.includes(n.profession)&&d.professionList.push(n.profession):(d={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt()},e.set(t,d)),d},ln=(e,t,n)=>{let d=e.get(t);return d?n.profession&&!d.professionList.includes(n.profession)&&d.professionList.push(n.profession):(d={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:gt(),minion:n.minion},e.set(t,d)),d},un=(e,t)=>{e.totalHits+=ce((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=ce(t==null?void 0:t.blocked),e.evaded+=ce(t==null?void 0:t.evaded),e.glanced+=ce(t==null?void 0:t.glanced),e.missed+=ce(t==null?void 0:t.missed),e.invulned+=ce(t==null?void 0:t.invulned),e.interrupted+=ce(t==null?void 0:t.interrupted),e.totalMitigation+=ce((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=ce((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},pi=e=>Object.values(e).some(t=>t>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:W.length});const Ft=(e,t,n)=>{var C,M,K,H;const d=`s${e}`;if((C=t==null?void 0:t[d])!=null&&C.name)return t[d].name;if((M=t==null?void 0:t[String(e)])!=null&&M.name)return t[String(e)].name;const r=`b${e}`;return(K=n==null?void 0:n[r])!=null&&K.name?n[r].name:(H=n==null?void 0:n[String(e)])!=null&&H.name?n[String(e)].name:`Unknown Skill ${e}`},pt=new Map,at=e=>{const t=pt.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const n=t.connectedHits||0,d=n>0?t.totalDamage/n:0,r=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:d,min:r,hits:n}},Bt="Ashtonlightstone.9145",mn="Illusionary Warden",Ot=[],rt=[],Rt=[],_t=[],dn=new Map,fn=new Map,gn=(e,t,n)=>{const d=e.get(t)||gt();return d.totalHits+=n.totalHits,d.blocked+=n.blocked,d.evaded+=n.evaded,d.glanced+=n.glanced,d.missed+=n.missed,d.invulned+=n.invulned,d.interrupted+=n.interrupted,e.set(t,d),d};W.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(d=>{const r=(d==null?void 0:d.totalDamageDist)||[],C=Array.isArray(r)?r[0]:null;C==null||C.forEach(M=>{if(!(M!=null&&M.id))return;const K=Number(M.id),H=pt.get(K)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};H.totalDamage+=Number(M.totalDamage||0),H.connectedHits+=Number(M.connectedHits||0);const Y=Number.isFinite(Number(M.min))?Number(M.min):0;H.minTotal+=Y,H.minCount+=1,pt.set(K,H)})})}),W.forEach((e,t)=>{var le,He;const n=e.details;if(!n)return;const d=n.players;console.log(`[useStatsAggregation] Processing log ${t}:`,{playerCount:d==null?void 0:d.length,hasTargets:!!n.targets,firstPlayer:d!=null&&d[0]?{account:d[0].account,notInSquad:d[0].notInSquad}:"none"});const r=n.targets||[],C=n.skillMap||{},M=n.buffMap||{},K=new Map,H=new Map;r.forEach(s=>{const g=(s==null?void 0:s.totalDamageDist)||[],$=Array.isArray(g)?g[0]:null;$==null||$.forEach(J=>{var X;if(!(J!=null&&J.id))return;const V=Number(J.id),a=((X=C==null?void 0:C[V])==null?void 0:X.name)||J.name||J.skillName||String(V),N=K.get(V)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};N.totalDamage+=Number(J.totalDamage||0),N.connectedHits+=Number(J.connectedHits||0);const T=Number.isFinite(Number(J.min))?Number(J.min):0;N.minTotal+=T,N.minCount+=1,K.set(V,N);const P=H.get(a)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};P.totalDamage+=Number(J.totalDamage||0),P.connectedHits+=Number(J.connectedHits||0);const ne=Number.isFinite(Number(J.min))?Number(J.min):0;P.minTotal+=ne,P.minCount+=1,H.set(a,P)})});const Y=s=>{const g=K.get(s);if(!g||g.connectedHits<=0)return{avg:1,min:1};const $=g.connectedHits>0?g.totalDamage/g.connectedHits:0,J=g.minCount>0?g.minTotal/g.minCount:$;return{avg:$||1,min:J||1}},ke=s=>{const g=H.get(s);if(!g||g.connectedHits<=0)return{avg:1,min:1};const $=g.connectedHits>0?g.totalDamage/g.connectedHits:0,J=g.minCount>0?g.minTotal/g.minCount:$;return{avg:$||1,min:J||1}},ae=n.combatReplayMetaData||{},Re=(ae==null?void 0:ae.inchToPixel)>0?ae.inchToPixel:1,F=(ae==null?void 0:ae.pollingRate)>0?ae.pollingRate:1,v=5e3,U=s=>Array.isArray(s)?s.map(g=>Array.isArray(g)?[Number(g[0]),Number(g[1])]:null).filter(g=>!!g&&Number.isFinite(g[0])):[];let te=[],re=n.durationMS||0,l=!1;const u=d.find(s=>(s==null?void 0:s.hasCommanderTag)&&!(s!=null&&s.notInSquad));(le=u==null?void 0:u.combatReplayData)!=null&&le.positions&&(te=u.combatReplayData.positions,U(u.combatReplayData.dead).forEach(([g])=>{g>0&&(l=!0,re=Math.min(re,g))}));const b=s=>{var P;const g=(P=s.statsAll)==null?void 0:P[0];if((g==null?void 0:g.distToCom)!==void 0&&(g==null?void 0:g.distToCom)!=="Infinity")return Math.round(Number(g.distToCom));if((g==null?void 0:g.stackDist)!==void 0)return Math.round(Number(g.stackDist))||0;if(s.hasCommanderTag)return 0;const $=s.combatReplayData;if(!($!=null&&$.positions)||!te.length)return 0;const J=$.positions,V=U($.dead),a=U($.down),N=Math.floor(($.start||0)/F);let T=0;if(V.length&&a.length)for(const[ne]of V){if(ne<0)continue;const X=Math.max(0,Math.floor(ne/F))-N;for(const[_,G]of a){if(ne!==G)continue;const Z=l&&_>re?Math.max(1,Math.floor(re/F)):X,O=Math.max(0,Math.min(Z,J.length,te.length));if(O<=0)continue;let A=0;for(let z=0;z<O;z++){const[L,ie]=J[z],[oe,Q]=te[z];A+=Math.hypot(L-oe,ie-Q)}T=Math.round(A/O/Re)}}return T},h=d.filter(s=>!s.notInSquad);ue+=h.length,me+=r.filter(s=>!s.isFake).length,Kn(d,{durationMS:n.durationMS,buffMap:n.buffMap});const{squadDeaths:E,enemyDeaths:i}=Ue(n);de+=E,De+=i,fe+=E,_e+=i,Fe(n)?be++:x++;const B=n.skillMap?Number((He=Object.keys(n.skillMap).find(s=>{var g,$;return(($=(g=n.skillMap)==null?void 0:g[s])==null?void 0:$.name)==="Battle Standard"}))==null?void 0:He.replace(/^s/,"")):null;d.forEach((s,g)=>{var et,tt,ct,lt,Ht,ht,bt,Dn,Nn,An,Tn,Mn;if(s.notInSquad)return;const $=s.account||"Unknown",J=$!=="Unknown"?$:s.name||"Unknown",V=s.name||"Unknown";Ae.has(J)||Ae.set(J,{name:V,account:J,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:s.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const a=Ae.get(J);if(s.hasCommanderTag&&(a.isCommander=!0),s.profession&&s.profession!=="Unknown"){a.profession=s.profession,a.professions.add(s.profession);const f=Array.isArray(s.activeTimes)&&typeof s.activeTimes[0]=="number"?s.activeTimes[0]:n.durationMS||0;a.professionTimeMs[s.profession]=(a.professionTimeMs[s.profession]||0)+f}a.logsJoined++,a.downContrib+=Wn(s),a.cleanses+=qn(s),a.strips+=jn(s,Ce),a.healing+=yn(s),a.barrier+=Vn(s),a.cc+=zn(s,Ce),a.stab+=s.stabGeneration||0;const N=b(s);N<=v&&(a.totalDist+=N,a.distCount++),(et=s.defenses)!=null&&et[0]&&(a.dodges+=s.defenses[0].dodgeCount||0,a.downs+=s.defenses[0].downCount||0,a.deaths+=s.defenses[0].deadCount||0),n.durationMS&&(a.totalFightMs+=n.durationMS);const T=Array.isArray(s.activeTimes)&&typeof s.activeTimes[0]=="number"?s.activeTimes[0]:n.durationMS||0;a.defenseActiveMs+=T,a.supportActiveMs+=T,a.healingActiveMs+=T,Array.isArray(s.buffUptimes)&&s.buffUptimes.length>0&&s.buffUptimes.forEach(f=>{var wn,vn,En,Fn;if(typeof(f==null?void 0:f.id)!="number")return;const S=`b${f.id}`,w=((wn=n.buffMap)==null?void 0:wn[S])||((vn=n.buffMap)==null?void 0:vn[String(f.id)]);if(!w||gi(w))return;const se=Number(((Fn=(En=f.buffData)==null?void 0:En[0])==null?void 0:Fn.uptime)??0);if(!Number.isFinite(se)||se<=0)return;const Ie=(w==null?void 0:w.stacking)??!1,ze=(Ie?se:se/100)*T;if(!Number.isFinite(ze)||ze<=0)return;const $e=Xn(w==null?void 0:w.name);if($e&&ii.has($e)&&(!(w!=null&&w.classification)||w.classification==="Condition")){const Ut=ze/1e3,Ke=w==null?void 0:w.icon,kt=Be[$e]||{name:$e,icon:Ke,applications:0,damage:0};kt.applicationsFromUptime=(kt.applicationsFromUptime||0)+Ut,!kt.icon&&Ke&&(kt.icon=Ke),Be[$e]=kt;const St=a.outgoingConditions[$e]||{applications:0,damage:0,skills:{},icon:Ke};St.applicationsFromUptime=(St.applicationsFromUptime||0)+Ut,!St.icon&&Ke&&(St.icon=Ke),a.outgoingConditions[$e]=St;const Ct=Le[$e]||{name:$e,icon:Ke,applications:0,damage:0};Ct.applicationsFromUptime=(Ct.applicationsFromUptime||0)+Ut,!Ct.icon&&Ke&&(Ct.icon=Ke),Le[$e]=Ct;const Dt=a.incomingConditions[$e]||{applications:0,damage:0,skills:{},icon:Ke};Dt.applicationsFromUptime=(Dt.applicationsFromUptime||0)+Ut,!Dt.icon&&Ke&&(Dt.icon=Ke),a.incomingConditions[$e]=Dt}Ze.has(S)||Ze.set(S,{name:w==null?void 0:w.name,stacking:Ie,icon:w==null?void 0:w.icon}),Qe.has(S)||Qe.set(S,new Map);const ot=Qe.get(S),mt=a.account||s.account||s.name||"Unknown";let it=ot.get(mt);it||(it={account:mt,profession:a.profession||s.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},ot.set(mt,it));const dt=s.profession||a.profession;dt&&dt!=="Unknown"&&(it.professions.add(dt),it.professionTimeMs[dt]=(it.professionTimeMs[dt]||0)+T,it.profession=dt),it.totalMs+=ze,it.durationMs+=T}),(tt=s.defenses)!=null&&tt[0]&&si.forEach(f=>{const S=Number(s.defenses[0][f.field]??0);Number.isFinite(S)&&(a.defenseTotals[f.id]=(a.defenseTotals[f.id]||0)+S)}),(ct=s.support)!=null&&ct[0]&&ai.forEach(f=>{let S=Number(s.support[0][f.field]??0);Number.isFinite(S)&&(qe.has(f.field)&&S>999999&&(S=0),a.supportTotals[f.id]=(a.supportTotals[f.id]||0)+S)});const P=(f,S)=>{Number.isFinite(S)&&(a.healingTotals[f]=(a.healingTotals[f]||0)+S)},ne=(f,S)=>Array.isArray(f)?f.reduce((w,se)=>w+Number((se==null?void 0:se[S])??0),0):0,X=(f,S,w)=>{if(!Number.isFinite(w)||w<=0)return;const se=d[S],Ie=S===g,nt=se==null?void 0:se.notInSquad,ze=!nt,$e=ze&&(se==null?void 0:se.group)!=null&&se.group===s.group;P(f,w),ze&&P(`squad${f[0].toUpperCase()}${f.slice(1)}`,w),$e&&P(`group${f[0].toUpperCase()}${f.slice(1)}`,w),Ie&&P(`self${f[0].toUpperCase()}${f.slice(1)}`,w),nt&&P(`offSquad${f[0].toUpperCase()}${f.slice(1)}`,w)};if(Array.isArray(s.rotation)){let f=0;s.rotation.forEach(S=>{var se;if(!(S!=null&&S.id)||!li(S.id,n.skillMap))return;const w=((se=S.skills)==null?void 0:se.length)||0;w>0&&(f+=w,P(`resUtility_s${S.id}`,w))}),f>0&&P("resUtility",f)}const _=(lt=s.extHealingStats)==null?void 0:lt.outgoingHealingAllies;Array.isArray(_)&&_.forEach((f,S)=>{const w=ne(f,"healing"),se=ne(f,"downedHealing");X("healing",S,w),X("downedHealing",S,se)});const G=(Ht=s.extBarrierStats)==null?void 0:Ht.outgoingBarrierAllies;Array.isArray(G)&&G.forEach((f,S)=>{const w=ne(f,"barrier");X("barrier",S,w)});const Z=(ht=s.statsAll)==null?void 0:ht[0],O=(bt=s.dpsAll)==null?void 0:bt[0],A=(Dn=s.support)==null?void 0:Dn[0];if(oi.forEach(f=>{if(f.id==="downContributionPercent"||!f.field)return;let S=0,w=0;f.source==="dpsAll"&&O?S=Number(O[f.field]??0):f.source==="statsAll"&&Z?(S=Number(Z[f.field]??0),w=Number(Z[f.denomField||f.weightField||"connectedDamageCount"]??0)):f.source==="support"&&A?S=Number(A[f.field]??0):s.statsTargets&&s.statsTargets.forEach(se=>{se!=null&&se[0]&&(S+=Number(se[0][f.field]??0),w+=Number(se[0][f.denomField||f.weightField||"connectedDamageCount"]??0))}),Number.isFinite(S)&&(a.offenseTotals[f.id]=(a.offenseTotals[f.id]||0)+S,f.isRate&&w>0&&(a.offenseRateWeights[f.id]=(a.offenseRateWeights[f.id]||0)+w))}),s.targetDamageDist&&Number.isFinite(B)){const f=s.targetDamageDist.flatMap(S=>S||[]).flatMap(S=>S||[]).reduce((S,w)=>w!=null&&w.id&&w.id===B?S+((w==null?void 0:w.connectedHits)||0):S,0);a.offenseTotals.battleStandardHits=(a.offenseTotals.battleStandardHits||0)+f}a.revives+=((An=(Nn=s.support)==null?void 0:Nn[0])==null?void 0:An.resurrects)||0,O&&(a.damage+=O.damage||0,a.dps+=O.dps||0);const z=f=>{var Ie,nt,ze,$e;let S=`Skill ${f.id}`;const w=((Ie=n.skillMap)==null?void 0:Ie[`s${f.id}`])||((nt=n.skillMap)==null?void 0:nt[`${f.id}`]);let se=w==null?void 0:w.icon;if(w!=null&&w.name&&(S=w.name),S.startsWith("Skill ")){const ot=Nt(S,f.id,n.buffMap);ot&&(S=ot,se=(($e=(ze=n.buffMap)==null?void 0:ze[`b${f.id}`])==null?void 0:$e.icon)||se)}return{name:S,icon:se}},L=f=>{if(!(f!=null&&f.id))return;const{name:S,icon:w}=z(f);Ne[f.id]||(Ne[f.id]={name:S,icon:w,damage:0,hits:0,downContribution:0}),Ne[f.id].name.startsWith("Skill ")&&!S.startsWith("Skill ")&&(Ne[f.id].name=S),!Ne[f.id].icon&&w&&(Ne[f.id].icon=w),Ne[f.id].damage+=f.totalDamage,Ne[f.id].hits+=f.connectedHits,Ne[f.id].downContribution+=Number(f.downContribution||0)},ie=s.account||s.name||"Unknown",oe=s.profession||"Unknown",Q=`${ie}|${oe}`;let we=je.get(Q);we||(we={key:Q,account:ie,displayName:ie,profession:oe,professionList:[oe],totalFightMs:0,skills:new Map},je.set(Q,we)),we.professionList.includes(oe)||we.professionList.push(oe),we.totalFightMs+=n.durationMS||0;const We=f=>{if(!(f!=null&&f.id))return;const{name:S,icon:w}=z(f),se=`s${f.id}`;let Ie=we.skills.get(se);Ie||(Ie={id:se,name:S,icon:w,damage:0,downContribution:0},we.skills.set(se,Ie)),Ie.name.startsWith("Skill ")&&!S.startsWith("Skill ")&&(Ie.name=S),!Ie.icon&&w&&(Ie.icon=w),Ie.damage+=Number(f.totalDamage||0),Ie.downContribution+=Number(f.downContribution||0)};Se==="total"?(Tn=s.totalDamageDist)==null||Tn.forEach(f=>{f==null||f.forEach(S=>{L(S),We(S)})}):(Mn=s.targetDamageDist)==null||Mn.forEach(f=>{f==null||f.forEach(S=>{S==null||S.forEach(w=>{L(w),We(w)})})}),s.totalDamageTaken&&s.totalDamageTaken.forEach(f=>{f==null||f.forEach(S=>{var nt,ze,$e,ot;if(!(S!=null&&S.id))return;let w=`Skill ${S.id}`;const se=((nt=n.skillMap)==null?void 0:nt[`s${S.id}`])||((ze=n.skillMap)==null?void 0:ze[`${S.id}`]);let Ie=se==null?void 0:se.icon;if(se!=null&&se.name&&(w=se.name),w.startsWith("Skill ")){const mt=Nt(w,S.id,n.buffMap);mt&&(w=mt,Ie=((ot=($e=n.buffMap)==null?void 0:$e[`b${S.id}`])==null?void 0:ot.icon)||Ie)}Te[S.id]||(Te[S.id]={name:w,icon:Ie,damage:0,hits:0}),(!Te[S.id].name.startsWith("Skill ")||w.startsWith("Skill "))&&(Te[S.id].name=w),!Te[S.id].icon&&Ie&&(Te[S.id].icon=Ie),Te[S.id].damage+=S.totalDamage,Te[S.id].hits+=S.hits})})}),r.forEach(s=>{if(s!=null&&s.isFake)return;const g=st((s==null?void 0:s.profession)||(s==null?void 0:s.name)||(s==null?void 0:s.id));g&&(Ee[g]=(Ee[g]||0)+1)});const p=ni({players:d,targets:r,skillMap:n.skillMap,buffMap:n.buffMap,getPlayerKey:s=>s.account&&s.account!=="Unknown"?s.account:s.name||null}),k=Zt(n.buffMap);Object.entries(p.playerConditions).forEach(([s,g])=>{const $=Ae.get(s);$&&Object.entries(g).forEach(([J,V])=>{const a=$.outgoingConditions[J]||{applications:0,damage:0,skills:{},icon:V.icon};a.applications+=Number(V.applications||0),a.damage+=Number(V.damage||0),V.applicationsFromBuffs&&(a.applicationsFromBuffs=(a.applicationsFromBuffs||0)+V.applicationsFromBuffs),V.applicationsFromBuffsActive&&(a.applicationsFromBuffsActive=(a.applicationsFromBuffsActive||0)+V.applicationsFromBuffsActive),Object.entries(V.skills||{}).forEach(([N,T])=>{const P=a.skills[N]||{name:T.name,hits:0,damage:0,icon:T.icon};P.hits+=Number(T.hits||0),P.damage+=Number(T.damage||0),!P.icon&&T.icon&&(P.icon=T.icon),a.skills[N]=P}),!a.icon&&V.icon&&(a.icon=V.icon),$.outgoingConditions[J]=a})}),Object.entries(p.summary).forEach(([s,g])=>{const $=Be[s]||{name:g.name||s,icon:g.icon,applications:0,damage:0};$.applications+=Number(g.applications||0),$.damage+=Number(g.damage||0),g.applicationsFromBuffs&&($.applicationsFromBuffs=($.applicationsFromBuffs||0)+g.applicationsFromBuffs),g.applicationsFromBuffsActive&&($.applicationsFromBuffsActive=($.applicationsFromBuffsActive||0)+g.applicationsFromBuffsActive),!$.icon&&g.icon&&($.icon=g.icon),Be[s]=$}),h.forEach(s=>{const g=s.account&&s.account!=="Unknown"?s.account:s.name||"Unknown",$=Ae.get(g);!$||!s.totalDamageTaken||s.totalDamageTaken.forEach(J=>J==null?void 0:J.forEach(V=>{var z,L,ie,oe,Q,we;if(!(V!=null&&V.id))return;let a=`Skill ${V.id}`;const N=((z=n.skillMap)==null?void 0:z[`s${V.id}`])||((L=n.skillMap)==null?void 0:L[`${V.id}`]);N!=null&&N.name&&(a=N.name);const T=Nt(a,V.id,n.buffMap);if(!T)return;const P=(oe=(ie=n.buffMap)==null?void 0:ie[`b${V.id}`])==null?void 0:oe.name,ne=k.get(T)||((we=(Q=n.buffMap)==null?void 0:Q[`b${V.id}`])==null?void 0:we.icon),X=(N==null?void 0:N.icon)||ne;a.startsWith("Skill ")&&(P||T)&&(a=P||T);const _=Number(V.hits??0),G=Number(V.totalDamage??0),Z=Le[T]||{name:T,icon:ne,applications:0,damage:0};Z.applications+=Number.isFinite(_)?_:0,Z.damage+=Number.isFinite(G)?G:0,!Z.icon&&ne&&(Z.icon=ne),Le[T]=Z;const O=$.incomingConditions[T]||{applications:0,damage:0,skills:{},icon:ne};O.applications+=Number.isFinite(_)?_:0,O.damage+=Number.isFinite(G)?G:0;const A=O.skills[a]||{name:a,hits:0,damage:0,icon:X};A.hits+=Number.isFinite(_)?_:0,A.damage+=Number.isFinite(G)?G:0,!A.icon&&X&&(A.icon=X),O.skills[a]=A,!O.icon&&ne&&(O.icon=ne),$.incomingConditions[T]=O}))});const q=n.player_damage_mitigation||n.playerDamageMitigation,Me=q&&typeof q=="object"&&Object.keys(q).length>0;Me&&Object.entries(q).forEach(([s,g])=>{if(!g||typeof g!="object")return;const $=rn(s),J=cn(vt,$.account,$);Object.values(g).forEach(V=>{ce((V==null?void 0:V.avoided_damage)??(V==null?void 0:V.avoidedDamage))<=0||un(J.mitigationTotals,V)})});const ge=n.player_minion_damage_mitigation||n.playerMinionDamageMitigation,Oe=ge&&typeof ge=="object"&&Object.keys(ge).length>0;Oe&&Object.entries(ge).forEach(([s,g])=>{if(!g||typeof g!="object")return;const $=rn(s);Object.entries(g).forEach(([J,V])=>{if(!V||typeof V!="object")return;const a=`${$.account}::${J}`,N=ln(Et,a,{...$,minion:String(J||"Unknown")});Object.values(V).forEach(T=>{un(N.mitigationTotals,T)})})}),(!Me||!Oe)&&(Me||h.forEach(s=>{const g=(s==null?void 0:s.totalDamageTaken)||[];if(!Array.isArray(g)||g.length===0)return;const $=s.account||s.name||"Unknown",J={account:$,name:s.name||$,profession:st(s.profession||"Unknown")};cn(vt,$,J);const V=n.skillMap||{},a=n.buffMap||{},N=Array.isArray(g)?g[0]:null;if(N==null||N.forEach(T=>{if(!(T!=null&&T.id))return;const P=ce(T.blocked),ne=ce(T.evaded),X=ce(T.glance??T.glanced),_=ce(T.missed),G=ce(T.invulned),Z=ce(T.interrupted),O=ce(T.hits??T.connectedHits),A=Number(T.id),z=Ft(A,V,a);if(gn(dn,`${$}::${A}`,{totalHits:O,blocked:P,evaded:ne,glanced:X,missed:_,invulned:G,interrupted:Z}),$===Bt){const L=pt.get(A),ie=at(A),oe=ie.hasSkill?ie.hits>0?ie.avg:0:1,Q=ie.hasSkill?ie.min||0:1,we=ie.hits>0?X*oe/2+(P+ne+_+G+Z)*oe:0,We=ie.hits>0?X*Q/2+(P+ne+_+G+Z)*Q:0;Rt.push({logId:e.filePath||e.id||t,skillId:T.id,skillName:z,blocked:P,evaded:ne,glanced:X,missed:_,invulned:G,interrupted:Z,totalAvoids:P+ne+X+_+G+Z,avg:oe,min:Q,enemyHits:(L==null?void 0:L.connectedHits)??0,enemyTotalDmg:(L==null?void 0:L.totalDamage)??0,avoidDmg:we,avoidMinDmg:We})}}),$===Bt){const T=(P,ne)=>{let X=0,_=0,G=0;if(!Array.isArray(P))return{total:X,minTotal:_,hits:G};for(const Z of P){if(!(Z!=null&&Z.id))continue;const O=ce(Z.blocked),A=ce(Z.evaded),z=ce(Z.glance??Z.glanced),L=ce(Z.missed),ie=ce(Z.invulned),oe=ce(Z.interrupted),Q=Ft(Number(Z.id),C,M),we=ne(Number(Z.id),Q);(we.hits??0)>0&&(X+=z*we.avg/2+(O+A+L+ie+oe)*we.avg,_+=z*we.min/2+(O+A+L+ie+oe)*we.min),G+=ce(Z.hits??Z.connectedHits)}return{total:X,minTotal:_,hits:G}};_t.push({logId:e.filePath||e.id||t,variant:"current_global_name_taken0",...T(N,(P,ne)=>{const X=at(P),_=X.hasSkill?X.hits>0?X.avg:0:1,G=X.hasSkill?X.min||0:1;return{avg:_,min:G,hits:X.hits}})})}}),Oe||h.forEach(s=>{const g=(s==null?void 0:s.minions)||[];if(!Array.isArray(g)||g.length===0)return;const $=s.account||s.name||"Unknown",J={account:$,name:s.name||$,profession:st(s.profession||"Unknown")},V=n.skillMap||{},a=n.buffMap||{};g.forEach(N=>{const T=(N==null?void 0:N.totalDamageTakenDist)||[];if(!Array.isArray(T)||T.length===0)return;let P=String((N==null?void 0:N.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";P.toUpperCase().includes("UNKNOWN")&&(P="Unknown");const ne=`${$}::${P}`;ln(Et,ne,{...J,minion:P});const X=Array.isArray(T)?T[0]:null;if(X==null||X.forEach(_=>{if(!(_!=null&&_.id))return;const G=ce(_.blocked),Z=ce(_.evaded),O=ce(_.glance??_.glanced),A=ce(_.missed),z=ce(_.invulned),L=ce(_.interrupted),ie=ce(_.hits??_.connectedHits),oe=Number(_.id),Q=Ft(oe,V,a);if(gn(fn,`${ne}::${oe}`,{totalHits:ie,blocked:G,evaded:Z,glanced:O,missed:A,invulned:z,interrupted:L}),$===Bt&&P===mn){const we=pt.get(oe),We=at(oe),et=We.hasSkill?We.hits>0?We.avg:0:1,tt=We.hasSkill?We.min||0:1,ct=We.hits>0?O*et/2+(G+Z+A+z+L)*et:0,lt=We.hits>0?O*tt/2+(G+Z+A+z+L)*tt:0;Ot.push({logId:e.filePath||e.id||t,skillId:_.id,skillName:Q,blocked:G,evaded:Z,glanced:O,missed:A,invulned:z,interrupted:L,totalAvoids:G+Z+O+A+z+L,avg:et,min:tt,enemyHits:(we==null?void 0:we.connectedHits)??0,enemyTotalDmg:(we==null?void 0:we.totalDamage)??0,avoidDmg:ct,avoidMinDmg:lt})}}),$===Bt&&P===mn){const _=(A,z)=>{let L=0,ie=0,oe=0;if(!Array.isArray(A))return{total:L,minTotal:ie,hits:oe};for(const Q of A){if(!(Q!=null&&Q.id))continue;const we=ce(Q.blocked),We=ce(Q.evaded),et=ce(Q.glance??Q.glanced),tt=ce(Q.missed),ct=ce(Q.invulned),lt=ce(Q.interrupted),Ht=Ft(Number(Q.id),C,M),{avg:ht,min:bt}=z(Number(Q.id),Ht);ce(Q.hits??Q.connectedHits)>0&&(L+=et*ht/2+(we+We+tt+ct+lt)*ht,ie+=et*bt/2+(we+We+tt+ct+lt)*bt),oe+=ce(Q.hits??Q.connectedHits)}return{total:L,minTotal:ie,hits:oe}},G=Array.isArray(T)?T[0]||[]:[],Z=Array.isArray(T)?T.flat():[],O=Array.isArray(N==null?void 0:N.totalDamageTaken)?N.totalDamageTaken[0]||[]:[];rt.push({logId:e.filePath||e.id||t,variant:"current_global_name_dist0",..._(G,(A,z)=>{const L=at(A),ie=L.hasSkill?L.hits>0?L.avg:0:1,oe=L.hasSkill&&L.min||0;return{avg:ie,min:oe}})}),rt.push({logId:e.filePath||e.id||t,variant:"local_name_dist0",..._(G,(A,z)=>ke(z))}),rt.push({logId:e.filePath||e.id||t,variant:"local_id_dist0",..._(G,A=>Y(A))}),rt.push({logId:e.filePath||e.id||t,variant:"global_name_alllists",..._(Z,(A,z)=>{const L=at(A),ie=L.hasSkill?L.hits>0?L.avg:0:1,oe=L.hasSkill&&L.min||0;return{avg:ie,min:oe}})}),rt.push({logId:e.filePath||e.id||t,variant:"global_name_taken0",..._(O,(A,z)=>{const L=at(A),ie=L.hasSkill?L.hits>0?L.avg:0:1,oe=L.hasSkill&&L.min||0;return{avg:ie,min:oe}})})}})}))}),Ot.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table(Ot),rt.length>0&&console.table(rt),console.groupEnd()),Rt.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(Rt),_t.length>0&&console.table(_t),console.groupEnd());const pn=(e,t)=>{const n=new Map,d=r=>{let C=n.get(r);return C||(C=gt(),n.set(r,C)),C};t.forEach((r,C)=>{const M=C.lastIndexOf("::"),K=M>-1?C.slice(0,M):C,H=M>-1?Number(C.slice(M+2)):Number.NaN,Y=Number.isFinite(H)?at(H):{hasSkill:!1,avg:0,min:0,hits:0};if(!Y.hasSkill||Y.hits<=0)return;const ke=Y.avg,ae=Y.min,Re=r.glanced*ke/2+(r.blocked+r.evaded+r.missed+r.invulned+r.interrupted)*ke,F=r.glanced*ae/2+(r.blocked+r.evaded+r.missed+r.invulned+r.interrupted)*ae;if(Re<=0)return;const v=d(K);v.totalHits+=r.totalHits,v.blocked+=r.blocked,v.evaded+=r.evaded,v.glanced+=r.glanced,v.missed+=r.missed,v.invulned+=r.invulned,v.interrupted+=r.interrupted,v.totalMitigation+=Re,v.minMitigation+=F}),e.forEach((r,C)=>{const M=n.get(C)||gt();r.mitigationTotals.totalHits=M.totalHits,r.mitigationTotals.blocked=M.blocked,r.mitigationTotals.evaded=M.evaded,r.mitigationTotals.glanced=M.glanced,r.mitigationTotals.missed=M.missed,r.mitigationTotals.invulned=M.invulned,r.mitigationTotals.interrupted=M.interrupted,r.mitigationTotals.totalMitigation=M.totalMitigation,r.mitigationTotals.minMitigation=M.minMitigation})};pn(vt,dn),pn(Et,fn);const hi=y>0?Math.round(ue/y):0,bi=y>0?Math.round(me/y):0,ki=de>0?(De/de).toFixed(2):De>0?"∞":"0.00",Si=_e>0?(fe/_e).toFixed(2):fe>0?"∞":"0.00",hn=(e,t)=>{const d=e.filter(M=>Number.isFinite(M.value)&&(t?M.value>0:M.value>=0)).sort((M,K)=>{const H=t?K.value-M.value:M.value-K.value;return H!==0?H:M.account.localeCompare(K.account)});let r=null,C=0;return d.map((M,K)=>((r===null||M.value!==r)&&(C=K+1,r=M.value),{rank:C,...M}))},qt=Array.from(Ae.values()).map(e=>{const t=Array.from(e.professions).filter(n=>n!=="Unknown");if(e.professionList=t,t.length>0){let n=t[0],d=e.professionTimeMs[n]||0;t.forEach(r=>{const C=e.professionTimeMs[r]||0;C>d&&(d=C,n=r)}),e.profession=n}return{key:e.account,stat:e}}),bn=e=>{const t=Ae.get(e.account);if(!t){const r=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:r}}const n=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(r=>r&&r!=="Unknown"),d=t.profession||e.profession;return{...e,profession:d,professionList:n.length>0?n:d?[d]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},Ci=Array.from(vt.values()).map(bn).filter(e=>pi(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),Di=Array.from(Et.values()).map(bn).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const n=e.account.localeCompare(t.account);return n!==0?n:String(e.minion||"").localeCompare(String(t.minion||""))}),It=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},Ve=(e,t)=>hn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:It(n,e),count:n.logsJoined})),t),Pe={downContrib:Ve("downContrib",!0),barrier:Ve("barrier",!0),healing:Ve("healing",!0),dodges:Ve("dodges",!0),strips:Ve("strips",!0),cleanses:Ve("cleanses",!0),cc:Ve("cc",!0),stability:Ve("stability",!0),revives:Ve("revives",!0),participation:Ve("participation",!0),dps:Ve("dps",!0),damage:Ve("damage",!0),closestToTag:Ve("closestToTag",!1).filter(e=>Number.isFinite(e.value))},Ni={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},ve=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},Xe={maxDownContrib:ve([]),maxBarrier:ve([]),maxHealing:ve([]),maxDodges:ve([]),maxStrips:ve([]),maxCleanses:ve([]),maxCC:ve([]),maxStab:ve([]),closestToTag:ve([])},Ye={},Ai=(e,t)=>{if(t==="closestToTag")return It(e,t);const n=Math.max(1,(e.totalFightMs||0)/1e3);return It(e,t)/n};Object.values(Ni).forEach(e=>{const t=e!=="closestToTag";Ye[e]=hn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:Ai(n,e),count:n.logsJoined})),t)}),Xe.maxDownContrib=ve(Ye.downContrib),Xe.maxBarrier=ve(Ye.barrier),Xe.maxHealing=ve(Ye.healing),Xe.maxDodges=ve(Ye.dodges),Xe.maxStrips=ve(Ye.strips),Xe.maxCleanses=ve(Ye.cleanses),Xe.maxCC=ve(Ye.cc),Xe.maxStab=ve(Ye.stability),Xe.closestToTag=ve(Ye.closestToTag);const Ti={maxDownContrib:ve(Pe.downContrib),maxBarrier:ve(Pe.barrier),maxHealing:ve(Pe.healing),maxDodges:ve(Pe.dodges),maxStrips:ve(Pe.strips),maxCleanses:ve(Pe.cleanses),maxCC:ve(Pe.cc),maxStab:ve(Pe.stability),closestToTag:ve(Pe.closestToTag)};let jt={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},kn,Sn,Cn=0;if(pe!=null&&pe.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=C=>{const M=e[C];return M?Number(ee[M]||0)>0:!1},n=[],d=C=>[...C||[]].filter(M=>t(M==null?void 0:M.name)).sort((M,K)=>K.ratio-M.ratio||M.rank-K.rank||M.name.localeCompare(K.name)).slice(0,3),r=C=>{var K;if(!C)return;const M=d(C.contribs);return{...C,player:C.name,reason:((K=M[0])==null?void 0:K.name)||"Top Performance",topStats:M}};qt.forEach(({stat:C})=>{let M=0;const K=[],H=(Y,ke,ae,Re,F=!0)=>{var U,te;if(ae<=0)return;const v=((U=ke[0])==null?void 0:U.value)||0;if(v&&Number.isFinite(Y)&&(F?Y>0:Y<Number.POSITIVE_INFINITY)){const re=F?Y/v:v/Y;M+=re*ae;const l=((te=ke.find(u=>u.account===C.account))==null?void 0:te.rank)||0;K.push({name:Re,ratio:re,val:Y.toLocaleString(),rank:l})}};H(C.downContrib,Pe.downContrib,ee.downContribution,"Down Contribution"),H(C.healing,Pe.healing,ee.healing,"Healing"),H(C.cleanses,Pe.cleanses,ee.cleanses,"Cleanses"),H(C.strips,Pe.strips,ee.strips,"Strips"),H(C.stab,Pe.stability,ee.stability,"Stability"),H(C.cc,Pe.cc,ee.cc,"CC"),H(C.revives,Pe.revives,ee.revives,"Revives"),H(It(C,"closestToTag"),Pe.closestToTag,ee.distanceToTag,"Distance to Tag",!1),H(C.logsJoined,Pe.participation,ee.participation,"Participation"),H(C.dodges,Pe.dodges,ee.dodging,"Dodging"),H(C.dps,Pe.dps,ee.dps,"DPS"),H(C.damage,Pe.damage,ee.damage,"Damage"),n.push({...C,score:M,contribs:K.filter(Y=>t(Y.name))})}),n.sort((C,M)=>M.score-C.score),n[0]&&n[0].score>0&&(jt=r(n[0])||jt),kn=r(n[1]),Sn=r(n[2]),Cn=n.length>0?n.reduce((C,M)=>C+M.score,0)/n.length:0}const Mi=Object.values(Ne).sort((e,t)=>{const n=R==="downContribution"?e.downContribution:e.damage;return(R==="downContribution"?t.downContribution:t.damage)-n}).slice(0,25),wi=Object.values(Te).sort((e,t)=>t.damage-e.damage).slice(0,25),vi=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),n=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return n?`${n[1]} Borderlands`:t||"Unknown"},Pt=(e,t)=>vi((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),Ei=(e,t)=>{const n=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof n=="string"&&n.trim().length>0)return n.trim();const d=e==null?void 0:e.uploadLinks;if(!Array.isArray(d))return"";for(const r of d){if(typeof r=="string"&&r.trim().length>0)return r.trim();if(r&&typeof r=="object"){const C=r.permalink||r.link||r.url||r.reportLink;if(typeof C=="string"&&C.trim().length>0)return C.trim()}}return""},Wt={};W.forEach(e=>{const t=Pt(e==null?void 0:e.details,e);Wt[t]=(Wt[t]||0)+1});const Fi=Object.entries(Wt).map(([e,t])=>{const n=String(e).trim(),d=/eternal battlegrounds|^ebg$/i.test(n);let r="#64748b";return d?r="#ffffff":/red/i.test(n)?r="#ef4444":/blue/i.test(n)?r="#3b82f6":/green/i.test(n)&&(r="#22c55e"),{name:e,value:t,color:r}}).sort((e,t)=>t.value-e.value),{boonTables:Bi}=In(W),Ii=W.map((e,t)=>{var d,r;const n=((d=e.details)==null?void 0:d.players)||[];return{index:t+1,label:`Log ${t+1}`,timestamp:Je(e.details,e),squadCount:n.filter(C=>!C.notInSquad).length,friendlyCount:n.length,enemies:((r=e.details)==null?void 0:r.targets).filter(C=>!C.isFake).length}}).sort((e,t)=>e.timestamp-t.timestamp),yt={};Array.from(Ae.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(yt[e.profession]=(yt[e.profession]||0)+1)});const Pi=Object.entries(yt).map(([e,t])=>({name:e,value:t,color:en(e)})).sort((e,t)=>t.value-e.value),Vt={};Object.keys(Ee).length===0&&W.forEach(e=>{var t,n;(n=(t=e.details)==null?void 0:t.targets)==null||n.forEach(d=>{if(d.isFake)return;const r=d.profession&&d.profession!=="Unknown"?d.profession:d.name||d.id||"Unknown",C=st(r);Vt[C]=(Vt[C]||0)+1})});const Hi=Object.keys(Ee).length>0?Ee:Vt,Ui=Object.entries(Hi).map(([e,t])=>({name:e,value:t,color:en(e)})).sort((e,t)=>t.value-e.value),$i=W.map((e,t)=>({log:e,originalIndex:t})).sort((e,t)=>Je(e.log.details,e.log)-Je(t.log.details,t.log)).map(({log:e},t)=>{const n=e.details;if(!n)return null;const d=n.players||[],r=d.filter(i=>!i.notInSquad),C=d.filter(i=>i.notInSquad),M=n.targets||[],K=M.filter(i=>!i.isFake),H=r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.dpsAll)==null?void 0:B[0])==null?void 0:p.damage)||0)},0),Y=r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.defenses)==null?void 0:B[0])==null?void 0:p.damageTaken)||0)},0),{enemyDeaths:ke,enemyDownsDeaths:ae}=Ue(n),Re=Fe(n),F=Je(n,e),v=Pt(n,e),U={red:0,green:0,blue:0},te=i=>{const D=Number(i);return Number.isFinite(D)?D:0},re=i=>{if(!i||typeof i!="object")return;const D=i.teamID??i.teamId??i.team??i.teamColor??i.team_color;if(D!=null)return D;const B=Object.keys(i).find(p=>/^team/i.test(p));return B?i[B]:void 0},l=(i,D)=>{if(i==null)return null;if(typeof i=="string"){const B=i.toLowerCase();return B.includes("red")?"red":B.includes("green")?"green":B.includes("blue")?"blue":B==="r"?"red":B==="g"?"green":B==="b"?"blue":null}if(typeof i=="number")if(D==="zeroBased"){if(i===0)return"red";if(i===1)return"green";if(i===2)return"blue"}else{if(i===1)return"red";if(i===2)return"green";if(i===3)return"blue"}return null},u=(i,D)=>{const B={};return i.forEach(p=>{const k=D(p),q=st(k);q&&(B[q]=(B[q]||0)+1)}),B},b=u(r,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)),h=u(C,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)),E=u(K,i=>(i==null?void 0:i.profession)||(i==null?void 0:i.name)||(i==null?void 0:i.id));if(n.teamCounts&&typeof n.teamCounts=="object"){const i=n.teamCounts;U.red=te(i.red??i.r??i[0]??i[1]),U.green=te(i.green??i.g??i[1]??i[2]),U.blue=te(i.blue??i.b??i[2]??i[3])}else{const i=[];M.forEach(k=>{if(k!=null&&k.isFake)return;const q=re(k);q!=null&&i.push(q)}),d.forEach(k=>{if(!(k!=null&&k.notInSquad))return;const q=re(k);q!=null&&i.push(q)}),i.length===0&&d.forEach(k=>{const q=re(k);q!=null&&i.push(q)});const D=new Set;i.forEach(k=>{typeof k=="number"&&D.add(k)});const B=D.has(0)?"zeroBased":D.has(3)?"oneBased":"zeroBased";if(i.forEach(k=>{const q=l(k,B);q&&(U[q]+=1)}),U.red+U.green+U.blue===0&&i.length>0){const k=new Map;i.forEach(Me=>{const ge=String(Me);k.set(ge,(k.get(ge)||0)+1)});const q=Array.from(k.values()).sort((Me,ge)=>ge-Me);U.red=q[0]||0,U.green=q[1]||0,U.blue=q[2]||0}U.red+U.green+U.blue===0&&(U.red=Math.max(K.length,d.filter(k=>k==null?void 0:k.notInSquad).length))}return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:Ei(n,e),timestamp:F,mapName:v,duration:ui(n.durationMS),isWin:Re,squadCount:r.length,allyCount:C.length,enemyCount:K.length,teamCounts:U,alliesDown:r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.defenses)==null?void 0:B[0])==null?void 0:p.downCount)||0)},0),alliesDead:r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.defenses)==null?void 0:B[0])==null?void 0:p.deadCount)||0)},0),alliesRevived:r.reduce((i,D)=>{var B,p;return Number(((p=(B=D.statsAll)==null?void 0:B[0])==null?void 0:p.saved)||0)>0?i+1:i},0),rallies:0,enemyDeaths:ke,enemyDowns:Math.max(0,ae-ke),totalOutgoingDamage:H,totalIncomingDamage:Y,incomingBarrierAbsorbed:r.reduce((i,D)=>{var B,p;return i+(((p=(B=D.defenses)==null?void 0:B[0])==null?void 0:p.damageBarrier)||0)},0),outgoingBarrierAbsorbed:r.reduce((i,D)=>{var k;const B=(k=D.extBarrierStats)==null?void 0:k.outgoingBarrier;if(!Array.isArray(B))return i;let p=0;return B.forEach(q=>{if(Array.isArray(q)){q.forEach(Me=>{p+=Number((Me==null?void 0:Me.barrier)||0)});return}p+=Number((q==null?void 0:q.barrier)||0)}),i+p},0),squadClassCountsFight:b,allyClassCountsFight:h,enemyClassCounts:E}}).filter(Boolean),Li=(e,t)=>{const n=(t==null?void 0:t.skillMap)||{},d=(t==null?void 0:t.buffMap)||{};let r=0,C="";const M=H=>{const Y=Number(H);if(!Number.isFinite(Y))return String(H||"Unknown Skill");const ke=(n==null?void 0:n[`s${Y}`])||(n==null?void 0:n[`${Y}`]);if(ke!=null&&ke.name)return String(ke.name);const ae=(d==null?void 0:d[`b${Y}`])||(d==null?void 0:d[`${Y}`]);return ae!=null&&ae.name?String(ae.name):`Skill ${Y}`},K=H=>{if(!H||typeof H!="object")return;const Y=[Number(H.max),Number(H.maxDamage),Number(H.maxHit),Number(H.totalDamage)>0&&Number(H.connectedHits)>0?Number(H.totalDamage)/Number(H.connectedHits):0].filter(ae=>Number.isFinite(ae)),ke=Y.length>0?Math.max(...Y):0;ke>r&&(r=ke,C=M(H.id))};return Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(H=>{Array.isArray(H)&&H.forEach(Y=>K(Y))}),Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(H=>{Array.isArray(H)&&H.forEach(Y=>{Array.isArray(Y)&&Y.forEach(ke=>K(ke))})}),{peak:r,skillName:C||"Unknown Skill"}},xi=(()=>{const e=F=>String(F||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=F=>e(F).toLowerCase().split(/[^a-z0-9]+/i).map(v=>v.trim()).filter(Boolean).map(v=>v.length>3&&v.endsWith("s")?v.slice(0,-1):v),n=(F,v)=>{const U=e(F),te=e(v);if(!te)return U;if(!U)return te;const re=t(U),l=t(te),u=new Set(re),b=new Set(l),h=l.length>0&&l.every(i=>u.has(i)),E=re.length>0&&re.every(i=>b.has(i));return h||E?U:`${U} - ${te}`},d=[],r=new Map,C=F=>{const v=h=>{if(!Array.isArray(h)||h.length===0)return[];const E=[];for(let i=0;i<h.length;i+=1){const D=Number(h[i]||0),B=i>0?Number(h[i-1]||0):0;E.push(Math.max(0,D-B))}return E},U=h=>{if(!Array.isArray(h))return[];const E=h.reduce((D,B)=>Math.max(D,Array.isArray(B)?B.length:0),0);if(E<=0)return[];const i=new Array(E).fill(0);return h.forEach(D=>{if(Array.isArray(D))for(let B=0;B<E;B+=1)i[B]+=Number(D[B]||0)}),i},te=h=>Array.isArray(h)?h.map(E=>Number(E||0)):null,l=(h=>{if(!Array.isArray(h)||h.length===0)return null;const E=h[0];if(!Array.isArray(E))return null;if(Array.isArray(E[0])&&Array.isArray(E[0][0]))return U(E);if(Array.isArray(E[0])&&!Array.isArray(E[0][0])){const i=h.map(D=>te(Array.isArray(D)?D[0]:null)).filter(D=>Array.isArray(D)&&D.length>0);if(i.length>0)return U(i)}return null})(F==null?void 0:F.targetDamage1S),u=Array.isArray(F==null?void 0:F.damage1S)&&Array.isArray(F.damage1S[0])?F.damage1S[0]:null,b=l||(Array.isArray(u)?u.map(h=>Number(h||0)):[]);return v(b)},M=(F,v)=>{if(!Array.isArray(F)||F.length===0||v<=0)return 0;let U=0,te=0;for(let re=0;re<F.length;re+=1)U+=Number(F[re]||0),re>=v&&(U-=Number(F[re-v]||0)),re>=v-1&&U>te&&(te=U);return Math.max(0,te)},K=(F,v)=>{if(!Array.isArray(F)||F.length===0||v<=0)return[];const U=[];for(let te=0;te<F.length;te+=v){const re=Math.min(te+v,F.length),l=F.slice(te,re).reduce((u,b)=>u+Number(b||0),0);U.push(l)}return U},H=(F,v)=>{const U=Number(F);if(!Number.isFinite(U))return{name:String(F||"Unknown Skill"),icon:void 0};const te=(v==null?void 0:v.skillMap)||{},re=(v==null?void 0:v.buffMap)||{},l=(te==null?void 0:te[`s${U}`])||(te==null?void 0:te[`${U}`]);if(l!=null&&l.name)return{name:String(l.name),icon:l==null?void 0:l.icon};const u=(re==null?void 0:re[`b${U}`])||(re==null?void 0:re[`${U}`]);return u!=null&&u.name?{name:String(u.name),icon:u==null?void 0:u.icon}:{name:`Skill ${U}`,icon:void 0}},Y=F=>Array.isArray(F)?F.map(v=>Array.isArray(v)?[Number(v[0]),Number(v[1])]:v&&typeof v=="object"?[Number(v.time),Number(v.value)]:null).filter(v=>!!v&&Number.isFinite(v[0])&&v[0]>=0):[],ke=(F,v,U,te,re)=>{if(!F.length||te<=0)return[];const l=Math.max(te*5e3,re||0),u=k=>k.reduce((q,Me)=>Me>=0&&Me<=l+2e3?q+1:q,0),b=F.map(k=>Number(k||0)).filter(k=>Number.isFinite(k)&&k>=0);if(!b.length)return[];const h=[b],E=b.reduce((k,q)=>Math.max(k,q),0),i=b.reduce((k,q)=>Math.min(k,q),Number.POSITIVE_INFINITY);E>l*20&&h.push(b.map(k=>k/1e3)),E<=l*2&&i>=0&&E>0&&E<Math.max(120,te*5+10)&&h.push(b.map(k=>k*1e3));let D=b,B=0,p=-1;return h.forEach(k=>{const q=k.reduce((ge,Oe)=>Math.min(ge,Oe),Number.POSITIVE_INFINITY),Me=new Set([0,...v,...U]);if(Number.isFinite(q)&&l>0&&q>l){const ge=Math.floor(q/l)*l;Me.add(ge),Me.add(Math.max(0,ge-l))}Me.forEach(ge=>{const Oe=k.map(He=>He-ge),le=u(Oe);le>p&&(p=le,B=ge,D=k)})}),D.map(k=>k-B).filter(k=>Number.isFinite(k)&&k>=0)},ae=(F,v,U,te,re)=>{const l=ke(F,v,U,te,re);return Array.from(new Set(l.map(u=>Math.floor(u/5e3)).filter(u=>Number.isFinite(u)&&u>=0&&u<te)))};W.map(F=>({log:F,ts:Je(F==null?void 0:F.details,F)})).sort((F,v)=>F.ts-v.ts).forEach(({log:F},v)=>{const U=F==null?void 0:F.details;if(!U)return;const te=e(U.fightName||F.fightName||`Fight ${v+1}`),re=Pt(U,F),l=n(te,String(re||"")),u={},b=Array.isArray(U.players)?U.players:[],h=b.flatMap(p=>{const k=p==null?void 0:p.combatReplayData;return Array.isArray(k)?k.map(q=>Number(q==null?void 0:q.start)):[Number(k==null?void 0:k.start)]}).filter(p=>Number.isFinite(p)&&p>=0);b.forEach(p=>{if(p!=null&&p.notInSquad)return;const k=String((p==null?void 0:p.account)||(p==null?void 0:p.name)||"Unknown"),q=String((p==null?void 0:p.character_name)||(p==null?void 0:p.display_name)||(p==null?void 0:p.name)||""),Me=String((p==null?void 0:p.profession)||"Unknown"),ge=`${k}|${Me}`,Oe=Li(p,U),le=Number(Oe.peak||0),He=C(p),s=Number(M(He,1)||0),g=Number(M(He,5)||0),$=Number(M(He,30)||0),J=Math.max(0,Math.ceil(Number((U==null?void 0:U.durationMS)||0)/5e3)),V=Math.max(0,Math.ceil(He.length/5)),a=Math.max(J,V),N=K(He,5),T=Array.from({length:a},(A,z)=>Number(N[z]||0)),P=new Map,ne=A=>{if(!A||typeof A!="object"||A.indirectDamage)return;const z=Number(A.totalDamage||0);if(!Number.isFinite(z)||z<=0)return;const L=Number(A.connectedHits||A.hits||0),ie=H(A.id,U),oe=ie.name,Q=P.get(oe)||{skillName:oe,damage:0,hits:0,icon:ie.icon};Q.damage+=z,Q.hits+=Number.isFinite(L)?L:0,!Q.icon&&ie.icon&&(Q.icon=ie.icon),P.set(oe,Q)};Array.isArray(p==null?void 0:p.targetDamageDist)&&p.targetDamageDist.forEach(A=>{Array.isArray(A)&&A.forEach(z=>{Array.isArray(z)&&z.forEach(L=>ne(L))})}),P.size===0&&Array.isArray(p==null?void 0:p.totalDamageDist)&&p.totalDamageDist.forEach(A=>{Array.isArray(A)&&A.forEach(z=>ne(z))});const X=(()=>{const A=p==null?void 0:p.combatReplayData;return Array.isArray(A)?A.filter(z=>z&&typeof z=="object"):A&&typeof A=="object"?[A]:[]})(),_=X.map(A=>Number(A==null?void 0:A.start)).filter(A=>Number.isFinite(A)&&A>=0),G=X.flatMap(A=>Y(A==null?void 0:A.down).map(([z])=>Number(z||0))),Z=X.flatMap(A=>Y(A==null?void 0:A.dead).map(([z])=>Number(z||0)));u[ge]={hit:le,burst1s:s,burst5s:g,burst30s:$,skillName:Oe.skillName,buckets5s:T,downIndices5s:ae(G,_,h,a,Number((U==null?void 0:U.durationMS)||0)),deathIndices5s:ae(Z,_,h,a,Number((U==null?void 0:U.durationMS)||0)),skillRows:Array.from(P.values()).sort((A,z)=>z.damage-A.damage).slice(0,50)};const O=r.get(ge)||{key:ge,account:k,displayName:k,characterName:q,profession:Me,professionList:[Me],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};O.logs+=1,O.professionList.includes(Me)||O.professionList.push(Me),!O.characterName&&q&&(O.characterName=q),le>O.peakHit&&(O.peakHit=le,O.peakFightLabel=l,O.peakSkillName=Oe.skillName),s>O.peak1s&&(O.peak1s=s),g>O.peak5s&&(O.peak5s=g),$>O.peak30s&&(O.peak30s=$),r.set(ge,O)});const E=Object.values(u).reduce((p,k)=>Math.max(p,Number((k==null?void 0:k.hit)||0)),0),i=Object.values(u).reduce((p,k)=>Math.max(p,Number((k==null?void 0:k.burst1s)||0)),0),D=Object.values(u).reduce((p,k)=>Math.max(p,Number((k==null?void 0:k.burst5s)||0)),0),B=Object.values(u).reduce((p,k)=>Math.max(p,Number((k==null?void 0:k.burst30s)||0)),0);d.push({id:F.filePath||F.id||`fight-${v+1}`,shortLabel:`F${v+1}`,fullLabel:l,timestamp:Je(U,F),values:u,maxHit:E,max1s:i,max5s:D,max30s:B})});const Re=Array.from(r.values()).sort((F,v)=>v.peakHit!==F.peakHit?v.peakHit-F.peakHit:F.displayName.localeCompare(v.displayName));return{fights:d,players:Re}})(),Oi=(()=>{const e=l=>String(l||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=l=>e(l).toLowerCase().split(/[^a-z0-9]+/i).map(u=>u.trim()).filter(Boolean).map(u=>u.length>3&&u.endsWith("s")?u.slice(0,-1):u),n=(l,u)=>{const b=e(l),h=e(u);if(!h)return b;if(!b)return h;const E=t(b),i=t(h),D=new Set(E),B=new Set(i),p=i.length>0&&i.every(q=>D.has(q)),k=E.length>0&&E.every(q=>B.has(q));return p||k?b:`${b} - ${h}`},d=[],r=new Map,C=(l,u)=>{const b=Number(l);if(!Number.isFinite(b))return{name:String(l||"Unknown Skill"),icon:void 0};const h=(u==null?void 0:u.skillMap)||{},E=(u==null?void 0:u.buffMap)||{},i=(h==null?void 0:h[`s${b}`])||(h==null?void 0:h[`${b}`]);if(i!=null&&i.name)return{name:String(i.name),icon:i==null?void 0:i.icon};const D=(E==null?void 0:E[`b${b}`])||(E==null?void 0:E[`${b}`]);return D!=null&&D.name?{name:String(D.name),icon:D==null?void 0:D.icon}:{name:`Skill ${b}`,icon:void 0}},M=(l,u)=>{let b=0,h="";const E=i=>{if(!i||typeof i!="object"||i.indirectDamage)return;const D=[Number(i.max),Number(i.maxDamage),Number(i.maxHit),Number(i.totalDamage)>0&&Number(i.connectedHits)>0?Number(i.totalDamage)/Number(i.connectedHits):0].filter(p=>Number.isFinite(p)),B=D.length>0?Math.max(...D):0;B>b&&(b=B,h=C(i.id,u).name)};return Array.isArray(l==null?void 0:l.totalDamageDist)&&l.totalDamageDist.forEach(i=>{Array.isArray(i)&&i.forEach(D=>E(D))}),Array.isArray(l==null?void 0:l.targetDamageDist)&&l.targetDamageDist.forEach(i=>{Array.isArray(i)&&i.forEach(D=>{Array.isArray(D)&&D.forEach(B=>E(B))})}),{peak:b,skillName:h||"Unknown Skill"}},K=l=>{if(!Array.isArray(l)||l.length===0)return[];const u=[];for(let b=0;b<l.length;b+=1){const h=Number(l[b]||0),E=b>0?Number(l[b-1]||0):0;u.push(Math.max(0,h-E))}return u},H=l=>{if(!Array.isArray(l)||l.length===0)return[];const u=l.reduce((h,E)=>Math.max(h,Array.isArray(E)?E.length:0),0);if(u<=0)return[];const b=new Array(u).fill(0);return l.forEach(h=>{if(Array.isArray(h))for(let E=0;E<u;E+=1)b[E]+=Number(h[E]||0)}),b},Y=l=>{if(!Array.isArray(l)||l.length===0)return[];const u=l[0];if(typeof u=="number")return l.map(b=>Number(b||0));if(Array.isArray(u)&&u.length>0){if(typeof u[0]=="number")return u.map(b=>Number(b||0));if(Array.isArray(u[0])){const b=u.map(h=>Array.isArray(h)?h.map(E=>Number(E||0)):null).filter(h=>Array.isArray(h)&&h.length>0);if(b.length>0)return H(b)}}return[]},ke=l=>{const u=Y(l==null?void 0:l.powerDamage1S),b=Y(l==null?void 0:l.damage1S),h=u.length>0?u:b;return K(h)},ae=(l,u)=>{const b=l==null?void 0:l.targetPowerDamage1S;if(!Array.isArray(b)||!Array.isArray(b[u]))return[];const h=b[u];if(!Array.isArray(h)||h.length===0)return[];if(typeof h[0]=="number")return h.map(E=>Number(E||0));if(Array.isArray(h[0])&&!Array.isArray(h[0][0]))return h[0].map(E=>Number(E||0));if(Array.isArray(h[0])&&Array.isArray(h[0][0])){const i=h[0].map(D=>Array.isArray(D)?D.map(B=>Number(B||0)):null).filter(D=>Array.isArray(D)&&D.length>0);return H(i)}return[]},Re=(l,u)=>{if(!Array.isArray(l)||l.length===0||u<=0)return 0;let b=0,h=0;for(let E=0;E<l.length;E+=1)b+=Number(l[E]||0),E>=u&&(b-=Number(l[E-u]||0)),E>=u-1&&b>h&&(h=b);return Math.max(0,h)},F=(l,u)=>{if(!Array.isArray(l)||l.length===0||u<=0)return[];const b=[];for(let h=0;h<l.length;h+=u){const E=Math.min(h+u,l.length),i=l.slice(h,E).reduce((D,B)=>D+Number(B||0),0);b.push(i)}return b},v=l=>Array.isArray(l)?l.map(u=>Array.isArray(u)?[Number(u[0]),Number(u[1])]:u&&typeof u=="object"?[Number(u.time),Number(u.value)]:null).filter(u=>!!u&&Number.isFinite(u[0])&&u[0]>=0):[],U=(l,u,b,h,E)=>{if(!l.length||h<=0)return[];const i=Math.max(h*5e3,E||0),D=le=>le.reduce((He,s)=>s>=0&&s<=i+2e3?He+1:He,0),B=l.map(le=>Number(le||0)).filter(le=>Number.isFinite(le)&&le>=0);if(!B.length)return[];const p=[B],k=B.reduce((le,He)=>Math.max(le,He),0),q=B.reduce((le,He)=>Math.min(le,He),Number.POSITIVE_INFINITY);k>i*20&&p.push(B.map(le=>le/1e3)),k<=i*2&&q>=0&&k>0&&k<Math.max(120,h*5+10)&&p.push(B.map(le=>le*1e3));let Me=B,ge=0,Oe=-1;return p.forEach(le=>{const He=le.reduce((g,$)=>Math.min(g,$),Number.POSITIVE_INFINITY),s=new Set([0,...u,...b]);if(Number.isFinite(He)&&i>0&&He>i){const g=Math.floor(He/i)*i;s.add(g),s.add(Math.max(0,g-i))}s.forEach(g=>{const $=le.map(V=>V-g),J=D($);J>Oe&&(Oe=J,ge=g,Me=le)})}),Me.map(le=>le-ge).filter(le=>Number.isFinite(le)&&le>=0)},te=(l,u,b,h,E)=>{const i=U(l,u,b,h,E);return Array.from(new Set(i.map(D=>Math.floor(D/5e3)).filter(D=>Number.isFinite(D)&&D>=0&&D<h)))};W.map(l=>({log:l,ts:Je(l==null?void 0:l.details,l)})).sort((l,u)=>l.ts-u.ts).forEach(({log:l},u)=>{const b=l==null?void 0:l.details;if(!b)return;const h=e(b.fightName||l.fightName||`Fight ${u+1}`),E=Pt(b,l),i=n(h,String(E||"")),D={},p=(Array.isArray(b.players)?b.players:[]).filter(a=>!(a!=null&&a.notInSquad)),k=p.flatMap(a=>{const N=a==null?void 0:a.combatReplayData;return Array.isArray(N)?N.map(T=>Number(T==null?void 0:T.start)):[Number(N==null?void 0:N.start)]}).filter(a=>Number.isFinite(a)&&a>=0),q=p.flatMap(a=>{const N=a==null?void 0:a.combatReplayData;return(Array.isArray(N)?N:N?[N]:[]).flatMap(P=>v(P==null?void 0:P.down).map(([ne])=>Number(ne||0)))}),Me=p.flatMap(a=>{const N=a==null?void 0:a.combatReplayData;return(Array.isArray(N)?N:N?[N]:[]).flatMap(P=>v(P==null?void 0:P.dead).map(([ne])=>Number(ne||0)))}),ge=new Map,Oe=new Map,le=new Map;(Array.isArray(b.targets)?b.targets:[]).forEach((a,N)=>{if(!a||a.isFake||!a.enemyPlayer)return;const T=st((a==null?void 0:a.profession)||(a==null?void 0:a.name)||(a==null?void 0:a.id))||"Unknown";le.set(T,(le.get(T)||0)+1);const P=Oe.get(T)||new Map;Array.isArray(a==null?void 0:a.totalDamageDist)&&a.totalDamageDist.forEach(O=>{Array.isArray(O)&&O.forEach(A=>{if(!A||typeof A!="object"||A.indirectDamage)return;const z=Number(A.totalDamage||0);if(!Number.isFinite(z)||z<=0)return;const L=Number(A.connectedHits||A.hits||0),ie=C(A.id,b),oe=ie.name,Q=P.get(oe)||{skillName:oe,damage:0,hits:0,icon:ie.icon};Q.damage+=z,Q.hits+=Number.isFinite(L)?L:0,!Q.icon&&ie.icon&&(Q.icon=ie.icon),P.set(oe,Q)})}),Oe.set(T,P);const ne=H(p.map(O=>ae(O,N))),X=ne.length>0?K(ne):ke(a),_=M(a,b);let G=ge.get(T);G||(G={perSecond:[],hit:0,skillName:""},ge.set(T,G)),X.length>G.perSecond.length&&(G.perSecond.length=X.length);for(let O=0;O<X.length;O+=1)G.perSecond[O]=Number(G.perSecond[O]||0)+Number(X[O]||0);const Z=Number(_.peak||0);Z>G.hit&&(G.hit=Z,G.skillName=_.skillName||"Unknown Skill")});const s=Array.from(ge.values()).some(a=>Array.isArray(a.perSecond)&&a.perSecond.some(N=>Number(N||0)>0));if(ge.size===0||!s){const a=H(p.map(T=>{const P=Y(T==null?void 0:T.powerDamageTaken1S);return K(P)})),N=Array.from(le.values()).reduce((T,P)=>T+Number(P||0),0);a.length>0&&N>0&&le.forEach((T,P)=>{const ne=Number(T||0)/N,X=a.map(G=>Number(G||0)*ne),_=ge.get(P);ge.set(P,{perSecond:X,hit:Number((_==null?void 0:_.hit)||0),skillName:String((_==null?void 0:_.skillName)||"")})})}ge.forEach((a,N)=>{var ie;const T=N,P=Number(a.hit||0),ne=Number(Re(a.perSecond,1)||0),X=Number(Re(a.perSecond,5)||0),_=Number(Re(a.perSecond,30)||0),G=Math.max(0,Math.ceil(Number((b==null?void 0:b.durationMS)||0)/5e3)),Z=Math.max(0,Math.ceil(a.perSecond.length/5)),O=Math.max(G,Z),A=F(a.perSecond,5),z=Array.from({length:O},(oe,Q)=>Number(A[Q]||0));D[T]={hit:P,burst1s:ne,burst5s:X,burst30s:_,skillName:a.skillName||"Unknown Skill",buckets5s:z,downIndices5s:te(q,[],k,O,Number((b==null?void 0:b.durationMS)||0)),deathIndices5s:te(Me,[],k,O,Number((b==null?void 0:b.durationMS)||0)),skillRows:Array.from(((ie=Oe.get(N))==null?void 0:ie.values())||[]).sort((oe,Q)=>Q.damage-oe.damage).slice(0,50)};const L=r.get(T)||{key:T,account:N,displayName:N,characterName:"",profession:N,professionList:[N],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};L.logs+=1,P>L.peakHit&&(L.peakHit=P,L.peakFightLabel=i,L.peakSkillName=a.skillName||"Unknown Skill"),ne>L.peak1s&&(L.peak1s=ne),X>L.peak5s&&(L.peak5s=X),_>L.peak30s&&(L.peak30s=_),r.set(T,L)});const g=Object.values(D).reduce((a,N)=>Math.max(a,Number((N==null?void 0:N.hit)||0)),0),$=Object.values(D).reduce((a,N)=>Math.max(a,Number((N==null?void 0:N.burst1s)||0)),0),J=Object.values(D).reduce((a,N)=>Math.max(a,Number((N==null?void 0:N.burst5s)||0)),0),V=Object.values(D).reduce((a,N)=>Math.max(a,Number((N==null?void 0:N.burst30s)||0)),0);d.push({id:l.filePath||l.id||`fight-${u+1}`,shortLabel:`F${u+1}`,fullLabel:i,timestamp:Je(b,l),values:D,maxHit:g,max1s:$,max5s:J,max30s:V})});const re=Array.from(r.values()).sort((l,u)=>u.peakHit!==l.peakHit?u.peakHit-l.peakHit:l.displayName.localeCompare(u.displayName));return{fights:d,players:re}})(),Ri=Array.from(Qe.entries()).map(([e,t])=>{const n=Ze.get(e)||{},d=Array.from(t.values()).map(r=>{var ke;const C=Array.from(r.professions||[]).filter(ae=>ae&&ae!=="Unknown");let M=r.profession||"Unknown";if(C.length>0){M=C[0];let ae=((ke=r.professionTimeMs)==null?void 0:ke[M])||0;C.forEach(Re=>{var v;const F=((v=r.professionTimeMs)==null?void 0:v[Re])||0;F>ae&&(ae=F,M=Re)})}const K=r.durationMs||0,H=r.totalMs/1e3,Y=K>0?r.totalMs/K:0;return{account:r.account,profession:M,professionList:C,total:H,perSecond:Y,duration:K/1e3}}).filter(r=>r.total>0||r.perSecond>0);return{id:e,name:n.name||e,icon:n.icon,rows:d}}).filter(e=>e.rows.length>0),_i=Array.from(je.values()).map(e=>{const t=Array.from(e.skills.values()).sort((d,r)=>r.damage-d.damage),n=t.reduce((d,r)=>(d[r.id]=r,d),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t,skillMap:n}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:y,wins:be,losses:x,avgSquadSize:hi,avgEnemies:bi,squadKDR:ki,enemyKDR:Si,totalSquadKills:De,totalSquadDeaths:de,totalEnemyKills:fe,totalEnemyDeaths:_e,leaderboards:Pe,...Ti,outgoingConditionSummary:Object.values(Be).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values(Le).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:Mi,topIncomingSkills:wi,playerSkillBreakdowns:_i,topSkillsMetric:R,mapData:Fi,timelineData:Ii,boonTables:Bi,offensePlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:Ci,damageMitigationMinions:Di,supportPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(Ae.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:jt,silver:kn,bronze:Sn,squadClassData:Pi,enemyClassData:Ui,fightBreakdown:$i,spikeDamage:xi,incomingStrikeDamage:Oi,specialTables:Ri,topStatsPerSecond:Xe,topStatsLeaderboardsPerSecond:Ye,avgMvpScore:Cn}})(),ye=(()=>{const Ce=new Map,Se=new Map,R=[],y=new Map,be=new Map;W.forEach(ue=>{const me=ue.details;if(!me)return;const de=me.skillMap||{},De=me.fightName||"Log",_e=Je(me,ue)||Date.now(),fe={id:ue.filePath||ue.id||De,label:De,timestamp:_e,skillEntries:{},playerActiveSeconds:{},durationSeconds:me.durationMS?me.durationMS/1e3:0};(me.players||[]).forEach(Fe=>{if(Fe.notInSquad)return;const Ae=Fe.account||Fe.name||"Unknown",qe=Fe.profession||"Unknown",Ne=`${Ae}|${qe}`;let Te=Se.get(Ne);Te||(Te={key:Ne,account:Ae,displayName:Ae,profession:qe,professionList:[qe],logs:0,totalActiveSeconds:0,skillTotals:{}},Se.set(Ne,Te)),Te.logs++;const je=(Array.isArray(Fe.activeTimes)?Fe.activeTimes[0]:0)/1e3;Te.totalActiveSeconds=(Te.totalActiveSeconds||0)+je,fe.playerActiveSeconds[Ne]=je,(Fe.rotation||[]).forEach(Be=>{var Tt,Mt,wt;if(!(Be!=null&&Be.id))return;const Le=((Tt=Be.skills)==null?void 0:Tt.length)||0;if(Le<=0)return;const Ee=`s${Be.id}`,Ze=((Mt=de[Ee])==null?void 0:Mt.name)||`Skill ${Be.id}`,Qe=(wt=de[Ee])==null?void 0:wt.icon;Te.skillTotals[Ee]=(Te.skillTotals[Ee]||0)+Le,Ce.set(Ee,(Ce.get(Ee)||0)+Le),y.set(Ee,Ze),Qe&&!be.has(Ee)&&be.set(Ee,Qe),fe.skillEntries[Ee]||(fe.skillEntries[Ee]={name:Ze,icon:Qe,players:{}}),!fe.skillEntries[Ee].icon&&Qe&&(fe.skillEntries[Ee].icon=Qe),fe.skillEntries[Ee].players[Ne]=(fe.skillEntries[Ee].players[Ne]||0)+Le})}),R.push(fe)});const x=Array.from(Ce.entries()).map(([ue,me])=>({id:ue,name:y.get(ue)||ue,total:me,icon:be.get(ue)})).sort((ue,me)=>me.total-ue.total);return{logRecords:R,players:Array.from(Se.values()),skillOptions:x,resUtilitySkills:[]}})();return{validLogs:W,stats:xe,skillUsageData:ye}};let Ge=null,ut=!1,tn=null,nn=0,on=0,Lt=null;const sn=o=>{if(!o||typeof o!="object")return o;const c=(I,j)=>{const W={};return j.forEach(pe=>{I&&Object.prototype.hasOwnProperty.call(I,pe)&&(W[pe]=I[pe])}),W},m=c(o,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(m.players)&&(m.players=m.players.map(I=>c(I,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","powerDamageTaken1S","targetPowerDamage1S","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(m.targets)&&(m.targets=m.targets.map(I=>c(I,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist","powerDamage1S","damage1S"]))),m},fi=o=>{if(!o||typeof o!="object")return o;const c={...o};return o.details?c.details=sn(o.details):c.details=sn(o),c},an=()=>{if(!ut||!Ge)return;ut=!1,nn+=1;const o=Lt;Lt=null;const c=di(Ge);self.postMessage({type:"result",result:c,computeId:nn,logCount:Ge.logs.length,token:on,completedAt:Date.now(),flushId:o})},xt=()=>{tn===null&&(tn=setInterval(()=>{an()},5e3))};self.onmessage=o=>{var m,I,j,W;const c=o.data;if((c==null?void 0:c.type)==="reset"){Ge={logs:[]},typeof c.token=="number"&&(on=c.token),ut=!0,xt();return}if((c==null?void 0:c.type)==="settings"){Ge={logs:(Ge==null?void 0:Ge.logs)||[],precomputedStats:(m=c.payload)==null?void 0:m.precomputedStats,mvpWeights:(I=c.payload)==null?void 0:I.mvpWeights,statsViewSettings:(j=c.payload)==null?void 0:j.statsViewSettings,disruptionMethod:(W=c.payload)==null?void 0:W.disruptionMethod},ut=!0,xt();return}if((c==null?void 0:c.type)==="log"){Ge||(Ge={logs:[]}),Ge.logs.push(fi(c.payload)),ut=!0,xt();return}(c==null?void 0:c.type)==="flush"&&(typeof c.flushId=="number"&&(Lt=c.flushId),ut=!0,an())}})();
