(function(){"use strict";const Kt=["selfBuffs","groupBuffs","squadBuffs"],Vt=i=>i!=null&&i.classification?i.classification==="Boon":!0,Gt=i=>`b${i}`,jn=(i,a)=>{const m=Array.isArray(i==null?void 0:i.activeTimes)?i.activeTimes:[],F=typeof m[0]=="number"?m[0]:0;return F>0?F:a},Jt=(i,a,m,F,L,A,pe)=>{const G=i==="selfBuffs"?1:Math.max(i==="groupBuffs"?A-1:pe-1,0);return!G||!L?{generationMs:0,wastedMs:0}:a?{generationMs:m*L*G,wastedMs:F*L*G}:{generationMs:m/100*L*G,wastedMs:F/100*L*G}},Wn=i=>{const a=new Map,m=new Map;return i.forEach(A=>{const pe=A.details;if(!pe)return;const G=pe.durationMS||0,oe=pe.buffMap||{};Object.entries(oe).forEach(([R,Y])=>{if(!a.has(R)){a.set(R,Y);return}const fe=a.get(R)||{},ie={name:fe.name||Y.name,stacking:fe.stacking??Y.stacking,icon:fe.icon||Y.icon,classification:fe.classification||Y.classification};a.set(R,ie)});const We=(pe.players||[]).filter(R=>!R.notInSquad),Oe=We.length,Ue=new Map;We.forEach(R=>{const Y=R.group??0;Ue.set(Y,(Ue.get(Y)||0)+1)}),We.forEach(R=>{const Y=R.account||R.name||R.character_name||"Unknown",fe=R.profession||"Unknown",ie=R.group??0,Me=Ue.get(ie)||1,Le=jn(R,G);m.has(Y)||m.set(Y,{account:Y,profession:fe,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const ae=m.get(Y);ae.profession=fe,fe!=="Unknown"&&(ae.professions.add(fe),ae.professionTimeMs[fe]=(ae.professionTimeMs[fe]||0)+Le),ae.activeTimeMs+=Le,ae.numFights+=1,ae.groupSupported+=Me,ae.squadSupported+=Oe,Kt.forEach(he=>{(R[he]||[]).forEach(l=>{var Se,$e,je,Ke;if(typeof(l==null?void 0:l.id)!="number")return;const re=Gt(l.id),le=oe[re];if(!Vt(le))return;const ke=(le==null?void 0:le.stacking)??!1,De=(($e=(Se=l.buffData)==null?void 0:Se[0])==null?void 0:$e.generation)??0,me=((Ke=(je=l.buffData)==null?void 0:je[0])==null?void 0:Ke.wasted)??0,{generationMs:Re,wastedMs:ge}=Jt(he,ke,De,me,G,Me,Oe);!Re&&!ge||(a.has(re)||a.set(re,le||{}),ae.boons[re]||(ae.boons[re]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),ae.boons[re][he].generationMs+=Re,ae.boons[re][he].wastedMs+=ge)})})})}),{boonTables:Array.from(a.keys()).filter(A=>Vt(a.get(A))).map(A=>{const pe=a.get(A)||{},G=[];return m.forEach(oe=>{var R;const be=oe.boons[A];if(!be||!Kt.some(Y=>be[Y].generationMs>0||be[Y].wastedMs>0))return;const Oe=Array.from(oe.professions||[]).filter(Y=>Y&&Y!=="Unknown");let Ue=oe.profession;if(Oe.length>0){Ue=Oe[0];let Y=((R=oe.professionTimeMs)==null?void 0:R[Ue])||0;Oe.forEach(fe=>{var Me;const ie=((Me=oe.professionTimeMs)==null?void 0:Me[fe])||0;ie>Y&&(Y=ie,Ue=fe)})}G.push({account:oe.account,profession:Ue||"Unknown",professionList:Oe,activeTimeMs:oe.activeTimeMs||1,numFights:oe.numFights||1,groupSupported:oe.groupSupported||1,squadSupported:oe.squadSupported||1,categories:{selfBuffs:{...be.selfBuffs},groupBuffs:{...be.groupBuffs},squadBuffs:{...be.squadBuffs}}})}),{id:A,name:pe.name||A,icon:pe.icon,stacking:pe.stacking??!1,rows:G}}).filter(A=>A.rows.length>0)}},Yt=(i,a,m,F,L,A,pe={})=>{var R,Y,fe,ie;const oe=((i==null?void 0:i[a])||[]).find(Me=>Me.id===m);if(!oe)return{generationMs:0,wastedMs:0};const be=pe[Gt(m)],We=(be==null?void 0:be.stacking)??!1,Oe=((Y=(R=oe.buffData)==null?void 0:R[0])==null?void 0:Y.generation)??0,Ue=((ie=(fe=oe.buffData)==null?void 0:fe[0])==null?void 0:ie.wasted)??0;return Jt(a,We,Oe,Ue,F,L,A)};var _n={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const zn=_n,qt="count",Kn=i=>(i||0)/1e3,Vn=(i,a)=>{var L;if(!i)return 0;const m=(L=zn.methods.tiered)==null?void 0:L.tiers;if(!m)return i;const F=a/Math.max(i,1);return F<=m.shortMs?i*m.weights.short:F<=m.mediumMs?i*m.weights.medium:i*m.weights.long},Qt=(i,a,m)=>m==="duration"?Kn(a):m==="tiered"?Vn(i,a):i;function Gn(i,a=qt){var A;const m=(A=i.statsAll)==null?void 0:A[0],F=Number((m==null?void 0:m.appliedCrowdControl)??0),L=Number((m==null?void 0:m.appliedCrowdControlDuration)??0);return Qt(F,L,a)}function Jn(i,a){const m=(a==null?void 0:a.durationMS)||0,F=(a==null?void 0:a.buffMap)||{},L=i.filter(G=>!G.notInSquad),A=L.length,pe=new Map;L.forEach(G=>{const oe=G.group??0;pe.set(oe,(pe.get(oe)||0)+1)}),L.forEach(G=>{const oe=pe.get(G.group??0)||1,be=Yt(G,"selfBuffs",1122,m,oe,A,F),We=Yt(G,"squadBuffs",1122,m,oe,A,F);G.stabGeneration=(be.generationMs+We.generationMs)/1e3})}function Yn(i){if(!i.statsTargets)return 0;let a=0;for(const m of i.statsTargets)m&&m.length>0&&(a+=m[0].downContribution||0);return a}function Qn(i){if(!i.extBarrierStats||!i.extBarrierStats.outgoingBarrierAllies)return 0;let a=0;for(const m of i.extBarrierStats.outgoingBarrierAllies)if(m)for(const F of m)F&&(a+=F.barrier||0);return a}function Xn(i){if(!i.extHealingStats||!i.extHealingStats.outgoingHealingAllies)return 0;let a=0;for(const m of i.extHealingStats.outgoingHealingAllies)if(m)for(const F of m)F&&(a+=F.healing||0);return a}const Xt=i=>{var a,m,F,L;return(((m=(a=i.support)==null?void 0:a[0])==null?void 0:m.condiCleanse)||0)+(((L=(F=i.support)==null?void 0:F[0])==null?void 0:L.condiCleanseSelf)||0)},Zt=(i,a=qt)=>{var A;const m=(A=i.support)==null?void 0:A[0],F=Number((m==null?void 0:m.boonStrips)??0),L=Number((m==null?void 0:m.boonStripsTime)??0);return Qt(F,L,a)},yt=i=>Yn(i),en=i=>Xn(i),tn=i=>Qn(i),nn=(i,a=qt)=>Gn(i,a),Zn=(i,a)=>Jn(i,a),yn="count",ei={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},ti={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},sn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),ni={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},ft=i=>{if(!i)return null;const a=i.trim().toLowerCase(),m=sn.get(a);if(m)return m;const F=a.split(/[^a-z]+/).filter(Boolean);for(const L of F){const A=sn.get(L);if(A)return A}return null},ii=i=>ft(i),on=i=>{const a=new Map;return i&&(Object.values(i).forEach(m=>{if(!(m!=null&&m.icon)||!(m!=null&&m.name))return;const F=ft(m.name);F&&(a.has(F)||a.set(F,m.icon))}),Object.entries(ni).forEach(([m,F])=>{a.has(m)||a.set(m,F)})),a},At=(i,a,m)=>{var F;if(a&&m){const L=(F=m[`b${a}`])==null?void 0:F.name,A=ft(L);if(A)return A}return i?ft(i):null},si=i=>{const a=(i==null?void 0:i.account)||"Unknown";return a&&a!=="Unknown"?a:(i==null?void 0:i.name)||"Unknown"||null},oi=i=>{if(!i||i.length===0)return 0;let a=0,m=null;return i.forEach(F=>{const L=Number(F[1]??0);if(Number.isFinite(L)){if(m===null){m=L;return}L>m&&(a+=L-m),m=L}}),a},ai=i=>{if(!i||i.length===0)return 0;let a=0;return i.forEach(m=>{const F=Number(m[0]??0),L=Number(m[1]??0);Number.isFinite(L)&&F!==0&&L>0&&(a+=1)}),a},ri=i=>{const{players:a,targets:m,skillMap:F,buffMap:L}=i,A=i.getPlayerKey||si,pe=on(L),G={},oe={};a.forEach(R=>{if(R!=null&&R.notInSquad)return;const Y=A(R);Y&&(G[Y]||(G[Y]={}),R!=null&&R.totalDamageDist&&R.totalDamageDist.forEach(fe=>{fe&&fe.forEach(ie=>{if(!ie.id)return;let Me=`Skill ${ie.id}`,Le;F&&(F[`s${ie.id}`]?(Me=F[`s${ie.id}`].name||Me,Le=F[`s${ie.id}`].icon||Le):F[`${ie.id}`]&&(Me=F[`${ie.id}`].name||Me,Le=F[`${ie.id}`].icon||Le));const ae=At(Me,ie.id,L);if(!ae)return;const he=L==null?void 0:L[`b${ie.id}`],Je=he==null?void 0:he.name,l=pe.get(ae)||(he==null?void 0:he.icon),re=Me.startsWith("Skill ")?Je||ae:Me,le=Le||(he==null?void 0:he.icon),ke=Number(ie.connectedHits??0),De=Number(ie.hits??0),me=ke>0?ke:De,Re=Number(ie.totalDamage??0);if(!Number.isFinite(me)&&!Number.isFinite(Re))return;const ge=oe[ae]||{name:ae,icon:l,applications:0,damage:0};ge.applications+=Number.isFinite(me)?me:0,ge.damage+=Number.isFinite(Re)?Re:0,!ge.icon&&l&&(ge.icon=l),oe[ae]=ge;const Se=G[Y][ae]||{icon:l,applications:0,damage:0,skills:{}};Se.applications+=Number.isFinite(me)?me:0,Se.damage+=Number.isFinite(Re)?Re:0;const $e=Se.skills[re]||{name:re,hits:0,damage:0,icon:le};$e.hits+=Number.isFinite(me)?me:0,$e.damage+=Number.isFinite(Re)?Re:0,!$e.icon&&le&&($e.icon=le),Se.skills[re]=$e,!Se.icon&&l&&(Se.icon=l),G[Y][ae]=Se})}))});const be=new Map;a.forEach(R=>{if(R!=null&&R.notInSquad)return;const Y=A(R);Y&&R!=null&&R.name&&be.set(R.name,Y)});let We=0,Oe=0,Ue=0;return m.forEach(R=>{R!=null&&R.buffs&&R.buffs.forEach(Y=>{const fe=Number(Y==null?void 0:Y.id);if(!Number.isFinite(fe))return;const ie=L==null?void 0:L[`b${fe}`],Me=ft(ie==null?void 0:ie.name);if(!Me||ie!=null&&ie.classification&&ie.classification!=="Condition")return;const Le=Me;if(!Le)return;const ae=Y.statesPerSource||{};Ue+=1,Object.entries(ae).forEach(([he,Je])=>{var me;const l=be.get(he);if(!l)return;Oe+=1;const re=oi(Je),le=ai(Je);We+=re;const ke=((me=G[l])==null?void 0:me[Le])||{applications:0,damage:0,skills:{}};ke.applicationsFromBuffs=(ke.applicationsFromBuffs||0)+re,ke.applicationsFromBuffsActive=(ke.applicationsFromBuffsActive||0)+le,G[l]=G[l]||{},G[l][Le]=ke;const De=oe[Le]||{name:Le,applications:0,damage:0};De.applicationsFromBuffs=(De.applicationsFromBuffs||0)+re,De.applicationsFromBuffsActive=(De.applicationsFromBuffsActive||0)+le,oe[Le]=De})})}),Object.values(G).forEach(R=>{Object.values(R).forEach(Y=>{typeof Y.applicationsFromBuffs=="number"&&(Y.applications=Y.applicationsFromBuffs)})}),Object.values(oe).forEach(R=>{typeof R.applicationsFromBuffs=="number"&&(R.applications=R.applicationsFromBuffs)}),{playerConditions:G,summary:oe,meta:{buffStateApplicationsTotal:We,targetBuffEntriesSeen:Ue,buffStateSourcesSeen:Oe}}},ci=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),ui=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],mi=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"minionDamageTaken",label:"Minion Damage Taken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],li=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],di=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],fi=new Set([10244]),gi=(i,a)=>{var L;if(fi.has(i))return!0;const m=(a==null?void 0:a[`s${i}`])||(a==null?void 0:a[`${i}`]),F=((L=m==null?void 0:m.name)==null?void 0:L.toLowerCase())||"";return di.some(A=>F.includes(A))},Nt=i=>{if(!i||!Number.isFinite(i))return"--:--";const a=Math.max(0,Math.round(i/1e3)),m=Math.floor(a/3600),F=Math.floor(a%3600/60),L=a%60;return m>0?`${m}:${String(F).padStart(2,"0")}:${String(L).padStart(2,"0")}`:`${F}:${String(L).padStart(2,"0")}`},Mt={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function an(i){return Mt[i]||Mt.Unknown}const pi=i=>{if(i==null||i==="")return 0;if(typeof i=="number")return!Number.isFinite(i)||i<=0?0:i>1e12?i:i*1e3;if(i instanceof Date){const pe=i.getTime();return Number.isFinite(pe)&&pe>0?pe:0}const a=String(i).trim();if(!a)return 0;const m=Number(a);if(Number.isFinite(m)&&m>0)return m>1e12?m:m*1e3;const F=Date.parse(a);if(Number.isFinite(F)&&F>0)return F;const L=a.replace(/([+-]\d{2})$/,"$1:00"),A=Date.parse(L);return Number.isFinite(A)&&A>0?A:0},Ge=(i,a)=>pi((i==null?void 0:i.uploadTime)??(a==null?void 0:a.uploadTime)??(i==null?void 0:i.timeStartStd)??(i==null?void 0:i.timeStart)??(i==null?void 0:i.timeEndStd)??(i==null?void 0:i.timeEnd)??(i==null?void 0:i.timeStartText)??(i==null?void 0:i.timeEndText)),bi=({logs:i,precomputedStats:a,mvpWeights:m,statsViewSettings:F,disruptionMethod:L,includePlayerSkillMap:A})=>{const pe=R=>{var fe;return(Array.isArray((fe=R==null?void 0:R.details)==null?void 0:fe.players)?R.details.players:[]).length>0},G=i.filter(R=>pe(R)),oe=F||ti,be=m||ei,We=R=>{if(!R||typeof R!="object")return R;const Y=Array.isArray(R.fightBreakdown)?R.fightBreakdown:null;if(!Y||Y.length===0)return R;const fe=l=>Array.isArray(l)&&l.some(re=>re&&Number(re.count)>0),ie=new Map,Me=new Map;i.forEach(l=>{var ke;const re=(l==null?void 0:l.filePath)||(l==null?void 0:l.id);re&&ie.set(String(re),l);const le=(l==null?void 0:l.permalink)||((ke=l==null?void 0:l.details)==null?void 0:ke.permalink);typeof le=="string"&&le.trim()&&Me.set(le.trim(),l)});const Le=Y.map(l=>{var Re;if(!l||typeof l!="object")return l;const re=l.id?String(l.id):"",le=typeof l.permalink=="string"?l.permalink.trim():"",ke=(re?ie.get(re):void 0)||(le?Me.get(le):void 0);if(!ke)return l;let De=l;if(Number(l.timestamp)<=0){const ge=Ge(ke==null?void 0:ke.details,ke);ge&&(De={...De,timestamp:ge})}const me=(Re=ke==null?void 0:ke.details)==null?void 0:Re.teamBreakdown;return fe(me)&&(De={...De,teamBreakdown:me}),De}),ae=Array.isArray(R.fightDiffMode)?R.fightDiffMode:[],Je=ae.some(l=>Array.isArray(l==null?void 0:l.targetFocus)&&l.targetFocus.some(re=>Number((re==null?void 0:re.damage)||0)>0||Number((re==null?void 0:re.hits)||0)>0))?ae:Le.map((l,re)=>{const le=l&&typeof l.enemyClassCounts=="object"&&l.enemyClassCounts?l.enemyClassCounts:{},ke=Object.entries(le).map(([He,_e])=>({label:String(He||"Unknown"),count:Number(_e||0)})).filter(He=>He.count>0).sort((He,_e)=>_e.count-He.count||He.label.localeCompare(_e.label)),De=ke.reduce((He,_e)=>He+_e.count,0),me=ke.map(He=>({label:He.label,damage:He.count,hits:0,share:De>0?He.count/De:0})),Re=Number((l==null?void 0:l.enemyDowns)||0),ge=Number((l==null?void 0:l.enemyDeaths)||0),Se=Number((l==null?void 0:l.alliesDown)||0),$e=Number((l==null?void 0:l.alliesDead)||0),je=Number((l==null?void 0:l.totalOutgoingDamage)||0),Ke=Number((l==null?void 0:l.totalIncomingDamage)||0),Pe=[{metricId:"winFlag",metricLabel:"Win (1) / Loss (0)",higherIsBetter:!0,value:l!=null&&l.isWin?1:0},{metricId:"squadCount",metricLabel:"Squad Size",higherIsBetter:!0,value:Number((l==null?void 0:l.squadCount)||0)},{metricId:"enemyCount",metricLabel:"Enemy Count",higherIsBetter:!1,value:Number((l==null?void 0:l.enemyCount)||0)},{metricId:"squadKdr",metricLabel:"Squad KDR",higherIsBetter:!0,value:$e>0?ge/$e:ge},{metricId:"enemyDeaths",metricLabel:"Enemy Deaths",higherIsBetter:!0,value:ge},{metricId:"enemyDowns",metricLabel:"Enemy Downs",higherIsBetter:!0,value:Re},{metricId:"squadDeaths",metricLabel:"Squad Deaths",higherIsBetter:!1,value:$e},{metricId:"squadDowns",metricLabel:"Squad Downs",higherIsBetter:!1,value:Se},{metricId:"damageDelta",metricLabel:"Damage Delta",higherIsBetter:!0,value:je-Ke},{metricId:"outgoingDamage",metricLabel:"Outgoing Damage",higherIsBetter:!0,value:je},{metricId:"incomingDamage",metricLabel:"Incoming Damage",higherIsBetter:!1,value:Ke},{metricId:"barrierIncomingAbsorb",metricLabel:"Barrier Absorption (Incoming)",higherIsBetter:!0,value:Number((l==null?void 0:l.incomingBarrierAbsorbed)||0)},{metricId:"enemyBarrierAbsorb",metricLabel:"Enemy Barrier Absorption",higherIsBetter:!1,value:Number((l==null?void 0:l.outgoingBarrierAbsorbed)||0)},{metricId:"alliesRevived",metricLabel:"Allies Revived (Players)",higherIsBetter:!0,value:Number((l==null?void 0:l.alliesRevived)||0)}];return{id:String((l==null?void 0:l.id)||`fight-${re+1}`),shortLabel:`F${re+1}`,fullLabel:`${String((l==null?void 0:l.mapName)||(l==null?void 0:l.label)||"Unknown Map")} • ${String((l==null?void 0:l.duration)||"--:--")}`,mapName:String((l==null?void 0:l.mapName)||""),timestamp:Number((l==null?void 0:l.timestamp)||0),duration:String((l==null?void 0:l.duration)||"--:--"),isWin:!!(l!=null&&l.isWin),targetFocus:me,squadMetrics:Pe}});return{...R,fightBreakdown:Le,fightDiffMode:Je}},Oe=(()=>{if(a)return We(a);const R=L||yn,Y=oe.topSkillDamageSource||"target",fe=oe.topSkillsMetric||"damage",ie=G.length;let Me=0,Le=0,ae=0,he=0,Je=0,l=0,re=0,le=0;const ke=e=>{const s=((e==null?void 0:e.players)||[]).filter(W=>!W.notInSquad);let p=0,o=0,M=0,f=0;return s.forEach(W=>{var se;const U=(se=W.defenses)==null?void 0:se[0];if(!U)return;const K=Number(U.downCount||0),ee=Number(U.deadCount||0);p+=K+ee,M+=ee}),s.forEach(W=>{!W.statsTargets||W.statsTargets.length===0||W.statsTargets.forEach(U=>{const K=U==null?void 0:U[0];if(!K)return;const ee=Number(K.downed||0),se=Number(K.killed||0);o+=ee+se,f+=se})}),{squadDownsDeaths:p,enemyDownsDeaths:o,squadDeaths:M,enemyDeaths:f}},De=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:s}=ke(e);return t>0||s>0?s>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},me=new Map,Re=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),ge={},Se={},$e=new Map,je={},Ke={},Pe={},He=new Map,_e=new Map,Ft=new Set(Object.keys(Mt)),vt=Object.keys(Mt).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),Et=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],et=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Ft.has(t))return t;const s=t.toLowerCase();for(const o of vt)if(s.includes(o.toLowerCase()))return o;return Et.find(o=>s.includes(o.toLowerCase()))||t||"Unknown"},Ai=e=>e!=null&&e.classification?e.classification==="Boon":!0,Bt=new Map,It=new Map,pt=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),Ee=e=>{const t=Number(e);return Number.isFinite(t)?t:0},dn=e=>{const t=String(e).split("|"),s=t[0]||"Unknown",p=et(t[1]||"Unknown"),o=t[2]||s||"Unknown";return{name:s,profession:p,account:o}},fn=(e,t,s)=>{let p=e.get(t);return p?s.profession&&!p.professionList.includes(s.profession)&&p.professionList.push(s.profession):(p={account:s.account,name:s.name,profession:s.profession,professionList:s.profession?[s.profession]:[],activeMs:0,mitigationTotals:pt()},e.set(t,p)),p},gn=(e,t,s)=>{let p=e.get(t);return p?s.profession&&!p.professionList.includes(s.profession)&&p.professionList.push(s.profession):(p={account:s.account,name:s.name,profession:s.profession,professionList:s.profession?[s.profession]:[],activeMs:0,mitigationTotals:pt(),minion:s.minion},e.set(t,p)),p},pn=(e,t)=>{e.totalHits+=Ee((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=Ee(t==null?void 0:t.blocked),e.evaded+=Ee(t==null?void 0:t.evaded),e.glanced+=Ee(t==null?void 0:t.glanced),e.missed+=Ee(t==null?void 0:t.missed),e.invulned+=Ee(t==null?void 0:t.invulned),e.interrupted+=Ee(t==null?void 0:t.interrupted),e.totalMitigation+=Ee((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=Ee((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},Ni=e=>Object.values(e).some(t=>t>0),Ut=new Map,Mi=e=>{const t=Ut.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const s=t.connectedHits||0,p=s>0?t.totalDamage/s:0,o=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:p,min:o,hits:s}},bn=new Map,hn=new Map,kn=(e,t,s)=>{const p=e.get(t)||pt();return p.totalHits+=s.totalHits,p.blocked+=s.blocked,p.evaded+=s.evaded,p.glanced+=s.glanced,p.missed+=s.missed,p.invulned+=s.invulned,p.interrupted+=s.interrupted,e.set(t,p),p};G.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(p=>{const o=(p==null?void 0:p.totalDamageDist)||[],M=Array.isArray(o)?o[0]:null;M==null||M.forEach(f=>{if(!(f!=null&&f.id))return;const W=Number(f.id),U=Ut.get(W)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};U.totalDamage+=Number(f.totalDamage||0),U.connectedHits+=Number(f.connectedHits||0);const K=Number.isFinite(Number(f.min))?Number(f.min):0;U.minTotal+=K,U.minCount+=1,Ut.set(W,U)})})}),G.forEach(e=>{var O,b;const t=e.details;if(!t)return;const s=t.players,p=t.targets||[],o=t.combatReplayMetaData||{},M=(o==null?void 0:o.inchToPixel)>0?o.inchToPixel:1,f=(o==null?void 0:o.pollingRate)>0?o.pollingRate:1,W=5e3,U=n=>Array.isArray(n)?n.map(C=>Array.isArray(C)?[Number(C[0]),Number(C[1])]:null).filter(C=>!!C&&Number.isFinite(C[0])):[];let K=[],ee=t.durationMS||0,se=!1;const ue=s.find(n=>(n==null?void 0:n.hasCommanderTag)&&!(n!=null&&n.notInSquad));(O=ue==null?void 0:ue.combatReplayData)!=null&&O.positions&&(K=ue.combatReplayData.positions,U(ue.combatReplayData.dead).forEach(([C])=>{C>0&&(se=!0,ee=Math.min(ee,C))}));const E=n=>{var k;const C=(k=n.statsAll)==null?void 0:k[0];if((C==null?void 0:C.distToCom)!==void 0&&(C==null?void 0:C.distToCom)!=="Infinity")return Math.round(Number(C.distToCom));if((C==null?void 0:C.stackDist)!==void 0)return Math.round(Number(C.stackDist))||0;if(n.hasCommanderTag)return 0;const x=n.combatReplayData;if(!(x!=null&&x.positions)||!K.length)return 0;const X=x.positions,_=U(x.dead),r=U(x.down),te=Math.floor((x.start||0)/f);let u=0;if(_.length&&r.length)for(const[I]of _){if(I<0)continue;const z=Math.max(0,Math.floor(I/f))-te;for(const[j,D]of r){if(I!==D)continue;const q=se&&j>ee?Math.max(1,Math.floor(ee/f)):z,$=Math.max(0,Math.min(q,X.length,K.length));if($<=0)continue;let y=0;for(let de=0;de<$;de++){const[Be,xe]=X[de],[Te,Ve]=K[de];y+=Math.hypot(Be-Te,xe-Ve)}u=Math.round(y/$/M)}}return u},w=s.filter(n=>!n.notInSquad);ae+=w.length,he+=p.filter(n=>!n.isFake).length,Zn(s,{durationMS:t.durationMS,buffMap:t.buffMap});const{squadDeaths:V,enemyDeaths:Z}=ke(t);Je+=V,l+=Z,le+=V,re+=Z,De(t)?Me++:Le++;const d=t.skillMap?Number((b=Object.keys(t.skillMap).find(n=>{var C,x;return((x=(C=t.skillMap)==null?void 0:C[n])==null?void 0:x.name)==="Battle Standard"}))==null?void 0:b.replace(/^s/,"")):null;s.forEach((n,C)=>{var ne,Ae,ve,ot,Qe,bt,lt,vn,En,Bn,In,Ln,Pn;if(n.notInSquad)return;const x=n.account||"Unknown",X=x!=="Unknown"?x:n.name||"Unknown",_=n.name||"Unknown";me.has(X)||me.set(X,{name:_,account:X,characterNames:new Set,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},defenseMinionDamageTaken:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:n.profession||"Unknown",professions:new Set,professionTimeMs:{},squadActiveMs:0,firstSeenFightTs:0,lastSeenFightTs:0,lastSeenFightDurationMs:0,isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const r=me.get(X);if(n.hasCommanderTag&&(r.isCommander=!0),_!=="Unknown"&&r.characterNames.add(String(_)),n.profession&&n.profession!=="Unknown"){r.profession=n.profession,r.professions.add(n.profession);const h=Array.isArray(n.activeTimes)&&typeof n.activeTimes[0]=="number"?n.activeTimes[0]:t.durationMS||0;r.professionTimeMs[n.profession]=(r.professionTimeMs[n.profession]||0)+h}r.logsJoined++,r.downContrib+=yt(n),r.cleanses+=Xt(n),r.strips+=Zt(n,R),r.healing+=en(n),r.barrier+=tn(n),r.cc+=nn(n,R),r.stab+=n.stabGeneration||0;const te=E(n);te<=W&&(r.totalDist+=te,r.distCount++),(ne=n.defenses)!=null&&ne[0]&&(r.dodges+=n.defenses[0].dodgeCount||0,r.downs+=n.defenses[0].downCount||0,r.deaths+=n.defenses[0].deadCount||0),t.durationMS&&(r.totalFightMs+=t.durationMS);const u=Array.isArray(n.activeTimes)&&typeof n.activeTimes[0]=="number"?n.activeTimes[0]:t.durationMS||0;r.squadActiveMs+=u;const k=Ge(t,e),I=Number((t==null?void 0:t.durationMS)||0);if(k>0&&((r.firstSeenFightTs<=0||k<r.firstSeenFightTs)&&(r.firstSeenFightTs=k),r.lastSeenFightTs<=0||k>r.lastSeenFightTs?(r.lastSeenFightTs=k,r.lastSeenFightDurationMs=I):k===r.lastSeenFightTs&&I>r.lastSeenFightDurationMs&&(r.lastSeenFightDurationMs=I)),r.defenseActiveMs+=u,r.supportActiveMs+=u,r.healingActiveMs+=u,Array.isArray(n.buffUptimes)&&n.buffUptimes.length>0&&n.buffUptimes.forEach(h=>{var xn,Rn,Un,$n,Hn,On;if(typeof(h==null?void 0:h.id)!="number")return;const v=`b${h.id}`,T=((xn=t.buffMap)==null?void 0:xn[v])||((Rn=t.buffMap)==null?void 0:Rn[String(h.id)]);if(!T||Ai(T))return;const P=Number((($n=(Un=h.buffData)==null?void 0:Un[0])==null?void 0:$n.uptime)??0),Q=Number(((On=(Hn=h.buffData)==null?void 0:Hn[0])==null?void 0:On.presence)??0);if((!Number.isFinite(P)||P<=0)&&(!Number.isFinite(Q)||Q<=0))return;const Ne=(T==null?void 0:T.stacking)??!1,ze=(Ne?Number.isFinite(P)?P:0:Number.isFinite(P)?P/100:0)*u,tt=Ne?Q:P,ye=Math.min(Math.max(Number.isFinite(tt)?tt:0,0),100)/100*u,ut=Number.isFinite(ze)&&ze>0,ht=Number.isFinite(ye)&&ye>0;if(!ut&&!ht)return;const nt=ii(T==null?void 0:T.name);if(nt&&ci.has(nt)&&(!(T!=null&&T.classification)||T.classification==="Condition")){const Pt=ze/1e3,it=T==null?void 0:T.icon,kt=je[nt]||{name:nt,icon:it,applications:0,damage:0};kt.applicationsFromUptime=(kt.applicationsFromUptime||0)+Pt,!kt.icon&&it&&(kt.icon=it),je[nt]=kt;const Dt=r.outgoingConditions[nt]||{applications:0,damage:0,skills:{},icon:it};Dt.applicationsFromUptime=(Dt.applicationsFromUptime||0)+Pt,!Dt.icon&&it&&(Dt.icon=it),r.outgoingConditions[nt]=Dt;const St=Ke[nt]||{name:nt,icon:it,applications:0,damage:0};St.applicationsFromUptime=(St.applicationsFromUptime||0)+Pt,!St.icon&&it&&(St.icon=it),Ke[nt]=St;const Ct=r.incomingConditions[nt]||{applications:0,damage:0,skills:{},icon:it};Ct.applicationsFromUptime=(Ct.applicationsFromUptime||0)+Pt,!Ct.icon&&it&&(Ct.icon=it),r.incomingConditions[nt]=Ct}He.has(v)||He.set(v,{name:T==null?void 0:T.name,stacking:Ne,icon:T==null?void 0:T.icon}),_e.has(v)||_e.set(v,new Map);const qn=_e.get(v),zt=r.account||n.account||n.name||"Unknown";let rt=qn.get(zt);rt||(rt={account:zt,profession:r.profession||n.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,uptimeMs:0,durationMs:0},qn.set(zt,rt));const dt=n.profession||r.profession;dt&&dt!=="Unknown"&&(rt.professions.add(dt),rt.professionTimeMs[dt]=(rt.professionTimeMs[dt]||0)+u,rt.profession=dt),rt.totalMs+=ut?ze:0,rt.uptimeMs+=ht?ye:0,rt.durationMs+=u}),(Ae=n.defenses)!=null&&Ae[0]){const h=P=>{let Q=String(P||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";return Q.toUpperCase().includes("UNKNOWN")&&(Q="Unknown"),Q},T=(()=>{const P=Array.isArray(n==null?void 0:n.minions)?n.minions:[];if(P.length===0)return{total:0,byMinion:{}};let Q=0;const Ne={};return P.forEach(Ie=>{const ze=Array.isArray(Ie==null?void 0:Ie.totalDamageTakenDist)?Ie.totalDamageTakenDist:[],tt=Array.isArray(ze[0])?ze[0]:[],ct=h(Ie==null?void 0:Ie.name);tt.forEach(ye=>{const ut=Number((ye==null?void 0:ye.totalDamage)??(ye==null?void 0:ye.damageTaken)??0);Number.isFinite(ut)&&(Q+=ut,Ne[ct]=(Ne[ct]||0)+ut)})}),{total:Q,byMinion:Ne}})();T.byMinion&&typeof T.byMinion=="object"&&Object.entries(T.byMinion).forEach(([P,Q])=>{const Ne=Number(Q||0);!Number.isFinite(Ne)||Ne<=0||(r.defenseMinionDamageTaken[P]=(r.defenseMinionDamageTaken[P]||0)+Ne)}),mi.forEach(P=>{const Q=P.id==="minionDamageTaken"?T.total:Number(n.defenses[0][P.field]??0);Number.isFinite(Q)&&(r.defenseTotals[P.id]=(r.defenseTotals[P.id]||0)+Q)})}(ve=n.support)!=null&&ve[0]&&li.forEach(h=>{let v=Number(n.support[0][h.field]??0);Number.isFinite(v)&&(Re.has(h.field)&&v>999999&&(v=0),r.supportTotals[h.id]=(r.supportTotals[h.id]||0)+v)});const z=(h,v)=>{Number.isFinite(v)&&(r.healingTotals[h]=(r.healingTotals[h]||0)+v)},j=(h,v)=>Array.isArray(h)?h.reduce((T,P)=>T+Number((P==null?void 0:P[v])??0),0):0,D=(h,v,T)=>{if(!Number.isFinite(T)||T<=0)return;const P=s[v],Q=v===C,Ne=P==null?void 0:P.notInSquad,Ie=!Ne,ze=Ie&&(P==null?void 0:P.group)!=null&&P.group===n.group;z(h,T),Ie&&z(`squad${h[0].toUpperCase()}${h.slice(1)}`,T),ze&&z(`group${h[0].toUpperCase()}${h.slice(1)}`,T),Q&&z(`self${h[0].toUpperCase()}${h.slice(1)}`,T),Ne&&z(`offSquad${h[0].toUpperCase()}${h.slice(1)}`,T)};if(Array.isArray(n.rotation)){let h=0;n.rotation.forEach(v=>{var P;if(!(v!=null&&v.id)||!gi(v.id,t.skillMap))return;const T=((P=v.skills)==null?void 0:P.length)||0;T>0&&(h+=T,z(`resUtility_s${v.id}`,T))}),h>0&&z("resUtility",h)}const q=(ot=n.extHealingStats)==null?void 0:ot.outgoingHealingAllies;Array.isArray(q)&&q.forEach((h,v)=>{const T=j(h,"healing"),P=j(h,"downedHealing");D("healing",v,T),D("downedHealing",v,P)});const $=(Qe=n.extBarrierStats)==null?void 0:Qe.outgoingBarrierAllies;Array.isArray($)&&$.forEach((h,v)=>{const T=j(h,"barrier");D("barrier",v,T)});const y=(bt=n.statsAll)==null?void 0:bt[0],de=(lt=n.dpsAll)==null?void 0:lt[0],Be=(vn=n.support)==null?void 0:vn[0];if(ui.forEach(h=>{if(h.id==="downContributionPercent"||!h.field)return;let v=0,T=0;h.source==="dpsAll"&&de?v=Number(de[h.field]??0):h.source==="statsAll"&&y?(v=Number(y[h.field]??0),T=Number(y[h.denomField||h.weightField||"connectedDamageCount"]??0)):h.source==="support"&&Be?v=Number(Be[h.field]??0):n.statsTargets&&n.statsTargets.forEach(P=>{P!=null&&P[0]&&(v+=Number(P[0][h.field]??0),T+=Number(P[0][h.denomField||h.weightField||"connectedDamageCount"]??0))}),Number.isFinite(v)&&(r.offenseTotals[h.id]=(r.offenseTotals[h.id]||0)+v,h.isRate&&T>0&&(r.offenseRateWeights[h.id]=(r.offenseRateWeights[h.id]||0)+T))}),n.targetDamageDist&&Number.isFinite(d)){const h=n.targetDamageDist.flatMap(v=>v||[]).flatMap(v=>v||[]).reduce((v,T)=>T!=null&&T.id&&T.id===d?v+((T==null?void 0:T.connectedHits)||0):v,0);r.offenseTotals.battleStandardHits=(r.offenseTotals.battleStandardHits||0)+h}r.revives+=((Bn=(En=n.support)==null?void 0:En[0])==null?void 0:Bn.resurrects)||0,de&&(r.damage+=de.damage||0,r.dps+=de.dps||0);const xe=h=>{var Q,Ne,Ie,ze;let v=`Skill ${h.id}`;const T=((Q=t.skillMap)==null?void 0:Q[`s${h.id}`])||((Ne=t.skillMap)==null?void 0:Ne[`${h.id}`]);let P=T==null?void 0:T.icon;if(T!=null&&T.name&&(v=T.name),v.startsWith("Skill ")){const tt=At(v,h.id,t.buffMap);tt&&(v=tt,P=((ze=(Ie=t.buffMap)==null?void 0:Ie[`b${h.id}`])==null?void 0:ze.icon)||P)}return{name:v,icon:P}},Te=h=>{if(!(h!=null&&h.id))return;const{name:v,icon:T}=xe(h);ge[h.id]||(ge[h.id]={name:v,icon:T,damage:0,hits:0,downContribution:0}),ge[h.id].name.startsWith("Skill ")&&!v.startsWith("Skill ")&&(ge[h.id].name=v),!ge[h.id].icon&&T&&(ge[h.id].icon=T),ge[h.id].damage+=h.totalDamage,ge[h.id].hits+=h.connectedHits,ge[h.id].downContribution+=Number(h.downContribution||0)},Ve=n.account||n.name||"Unknown",Fe=n.profession||"Unknown",Ye=`${Ve}|${Fe}`;let Ce=$e.get(Ye);Ce||(Ce={key:Ye,account:Ve,displayName:Ve,profession:Fe,professionList:[Fe],totalFightMs:0,skills:new Map},$e.set(Ye,Ce)),Ce.professionList.includes(Fe)||Ce.professionList.push(Fe),Ce.totalFightMs+=t.durationMS||0;const J=h=>{if(!(h!=null&&h.id))return;const{name:v,icon:T}=xe(h),P=`s${h.id}`;let Q=Ce.skills.get(P);Q||(Q={id:P,name:v,icon:T,damage:0,downContribution:0},Ce.skills.set(P,Q)),Q.name.startsWith("Skill ")&&!v.startsWith("Skill ")&&(Q.name=v),!Q.icon&&T&&(Q.icon=T),Q.damage+=Number(h.totalDamage||0),Q.downContribution+=Number(h.downContribution||0)};if(Y==="total")(In=n.totalDamageDist)==null||In.forEach(h=>{h==null||h.forEach(v=>{Te(v),J(v)})});else{const h=new Map;(Ln=n.targetDamageDist)==null||Ln.forEach(T=>{T==null||T.forEach(P=>{P==null||P.forEach(Q=>{const Ne=Number(Q==null?void 0:Q.id);if(Number.isFinite(Ne)){const Ie=h.get(Ne)||{damage:0,hits:0,downContribution:0};Ie.damage+=Number((Q==null?void 0:Q.totalDamage)||0),Ie.hits+=Number((Q==null?void 0:Q.connectedHits)||0),Ie.downContribution+=Number((Q==null?void 0:Q.downContribution)||0),h.set(Ne,Ie)}Te(Q),J(Q)})})}),!(t!=null&&t.detailedWvW)&&((Pn=n.totalDamageDist)==null||Pn.forEach(T=>{T==null||T.forEach(P=>{const Q=Number(P==null?void 0:P.id);if(!Number.isFinite(Q))return;const Ne=h.get(Q);if(!Ne){Te(P),J(P);return}const Ie=Number((P==null?void 0:P.totalDamage)||0),ze=Number((P==null?void 0:P.connectedHits)||0),tt=Number((P==null?void 0:P.downContribution)||0),ct=Ie-Number(Ne.damage||0),ye=ze-Number(Ne.hits||0),ut=tt-Number(Ne.downContribution||0);if(ct<=0&&ye<=0&&ut<=0)return;const ht={...P,totalDamage:Math.max(0,ct),connectedHits:Math.max(0,ye),downContribution:Math.max(0,ut)};Te(ht),J(ht)})}))}n.totalDamageTaken&&n.totalDamageTaken.forEach(h=>{h==null||h.forEach(v=>{var Ne,Ie,ze,tt;if(!(v!=null&&v.id))return;let T=`Skill ${v.id}`;const P=((Ne=t.skillMap)==null?void 0:Ne[`s${v.id}`])||((Ie=t.skillMap)==null?void 0:Ie[`${v.id}`]);let Q=P==null?void 0:P.icon;if(P!=null&&P.name&&(T=P.name),T.startsWith("Skill ")){const ct=At(T,v.id,t.buffMap);ct&&(T=ct,Q=((tt=(ze=t.buffMap)==null?void 0:ze[`b${v.id}`])==null?void 0:tt.icon)||Q)}Se[v.id]||(Se[v.id]={name:T,icon:Q,damage:0,hits:0}),(!Se[v.id].name.startsWith("Skill ")||T.startsWith("Skill "))&&(Se[v.id].name=T),!Se[v.id].icon&&Q&&(Se[v.id].icon=Q),Se[v.id].damage+=v.totalDamage,Se[v.id].hits+=v.hits})})}),p.forEach(n=>{if(n!=null&&n.isFake)return;const C=et((n==null?void 0:n.profession)||(n==null?void 0:n.name)||(n==null?void 0:n.id));C&&(Pe[C]=(Pe[C]||0)+1)});const g=ri({players:s,targets:p,skillMap:t.skillMap,buffMap:t.buffMap,getPlayerKey:n=>n.account&&n.account!=="Unknown"?n.account:n.name||null}),N=on(t.buffMap);Object.entries(g.playerConditions).forEach(([n,C])=>{const x=me.get(n);x&&Object.entries(C).forEach(([X,_])=>{const r=x.outgoingConditions[X]||{applications:0,damage:0,skills:{},icon:_.icon};r.applications+=Number(_.applications||0),r.damage+=Number(_.damage||0),_.applicationsFromBuffs&&(r.applicationsFromBuffs=(r.applicationsFromBuffs||0)+_.applicationsFromBuffs),_.applicationsFromBuffsActive&&(r.applicationsFromBuffsActive=(r.applicationsFromBuffsActive||0)+_.applicationsFromBuffsActive),Object.entries(_.skills||{}).forEach(([te,u])=>{const k=r.skills[te]||{name:u.name,hits:0,damage:0,icon:u.icon};k.hits+=Number(u.hits||0),k.damage+=Number(u.damage||0),!k.icon&&u.icon&&(k.icon=u.icon),r.skills[te]=k}),!r.icon&&_.icon&&(r.icon=_.icon),x.outgoingConditions[X]=r})}),Object.entries(g.summary).forEach(([n,C])=>{const x=je[n]||{name:C.name||n,icon:C.icon,applications:0,damage:0};x.applications+=Number(C.applications||0),x.damage+=Number(C.damage||0),C.applicationsFromBuffs&&(x.applicationsFromBuffs=(x.applicationsFromBuffs||0)+C.applicationsFromBuffs),C.applicationsFromBuffsActive&&(x.applicationsFromBuffsActive=(x.applicationsFromBuffsActive||0)+C.applicationsFromBuffsActive),!x.icon&&C.icon&&(x.icon=C.icon),je[n]=x}),w.forEach(n=>{const C=n.account&&n.account!=="Unknown"?n.account:n.name||"Unknown",x=me.get(C);!x||!n.totalDamageTaken||n.totalDamageTaken.forEach(X=>X==null?void 0:X.forEach(_=>{var de,Be,xe,Te,Ve,Fe;if(!(_!=null&&_.id))return;let r=`Skill ${_.id}`;const te=((de=t.skillMap)==null?void 0:de[`s${_.id}`])||((Be=t.skillMap)==null?void 0:Be[`${_.id}`]);te!=null&&te.name&&(r=te.name);const u=At(r,_.id,t.buffMap);if(!u)return;const k=(Te=(xe=t.buffMap)==null?void 0:xe[`b${_.id}`])==null?void 0:Te.name,I=N.get(u)||((Fe=(Ve=t.buffMap)==null?void 0:Ve[`b${_.id}`])==null?void 0:Fe.icon),z=(te==null?void 0:te.icon)||I;r.startsWith("Skill ")&&(k||u)&&(r=k||u);const j=Number(_.hits??0),D=Number(_.totalDamage??0),q=Ke[u]||{name:u,icon:I,applications:0,damage:0};q.applications+=Number.isFinite(j)?j:0,q.damage+=Number.isFinite(D)?D:0,!q.icon&&I&&(q.icon=I),Ke[u]=q;const $=x.incomingConditions[u]||{applications:0,damage:0,skills:{},icon:I};$.applications+=Number.isFinite(j)?j:0,$.damage+=Number.isFinite(D)?D:0;const y=$.skills[r]||{name:r,hits:0,damage:0,icon:z};y.hits+=Number.isFinite(j)?j:0,y.damage+=Number.isFinite(D)?D:0,!y.icon&&z&&(y.icon=z),$.skills[r]=y,!$.icon&&I&&($.icon=I),x.incomingConditions[u]=$}))});const S=t.player_damage_mitigation||t.playerDamageMitigation,B=S&&typeof S=="object"&&Object.keys(S).length>0;B&&Object.entries(S).forEach(([n,C])=>{if(!C||typeof C!="object")return;const x=dn(n),X=fn(Bt,x.account,x);Object.values(C).forEach(_=>{Ee((_==null?void 0:_.avoided_damage)??(_==null?void 0:_.avoidedDamage))<=0||pn(X.mitigationTotals,_)})});const H=t.player_minion_damage_mitigation||t.playerMinionDamageMitigation,c=H&&typeof H=="object"&&Object.keys(H).length>0;c&&Object.entries(H).forEach(([n,C])=>{if(!C||typeof C!="object")return;const x=dn(n);Object.entries(C).forEach(([X,_])=>{if(!_||typeof _!="object")return;const r=`${x.account}::${X}`,te=gn(It,r,{...x,minion:String(X||"Unknown")});Object.values(_).forEach(u=>{pn(te.mitigationTotals,u)})})}),(!B||!c)&&(B||w.forEach(n=>{const C=(n==null?void 0:n.totalDamageTaken)||[];if(!Array.isArray(C)||C.length===0)return;const x=n.account||n.name||"Unknown",X={account:x,name:n.name||x,profession:et(n.profession||"Unknown")};fn(Bt,x,X);const _=Array.isArray(C)?C[0]:null;_==null||_.forEach(r=>{if(!(r!=null&&r.id))return;const te=Ee(r.blocked),u=Ee(r.evaded),k=Ee(r.glance??r.glanced),I=Ee(r.missed),z=Ee(r.invulned),j=Ee(r.interrupted),D=Ee(r.hits??r.connectedHits),q=Number(r.id);kn(bn,`${x}::${q}`,{totalHits:D,blocked:te,evaded:u,glanced:k,missed:I,invulned:z,interrupted:j})})}),c||w.forEach(n=>{const C=(n==null?void 0:n.minions)||[];if(!Array.isArray(C)||C.length===0)return;const x=n.account||n.name||"Unknown",X={account:x,name:n.name||x,profession:et(n.profession||"Unknown")};C.forEach(_=>{const r=(_==null?void 0:_.totalDamageTakenDist)||[];if(!Array.isArray(r)||r.length===0)return;let te=String((_==null?void 0:_.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";te.toUpperCase().includes("UNKNOWN")&&(te="Unknown");const u=`${x}::${te}`;gn(It,u,{...X,minion:te});const k=Array.isArray(r)?r[0]:null;k==null||k.forEach(I=>{if(!(I!=null&&I.id))return;const z=Ee(I.blocked),j=Ee(I.evaded),D=Ee(I.glance??I.glanced),q=Ee(I.missed),$=Ee(I.invulned),y=Ee(I.interrupted),de=Ee(I.hits??I.connectedHits),Be=Number(I.id);kn(hn,`${u}::${Be}`,{totalHits:de,blocked:z,evaded:j,glanced:D,missed:q,invulned:$,interrupted:y})})})}))});const Dn=(e,t)=>{const s=new Map,p=o=>{let M=s.get(o);return M||(M=pt(),s.set(o,M)),M};t.forEach((o,M)=>{const f=M.lastIndexOf("::"),W=f>-1?M.slice(0,f):M,U=f>-1?Number(M.slice(f+2)):Number.NaN,K=Number.isFinite(U)?Mi(U):{hasSkill:!1,avg:0,min:0,hits:0};if(!K.hasSkill||K.hits<=0)return;const ee=K.avg,se=K.min,ue=o.glanced*ee/2+(o.blocked+o.evaded+o.missed+o.invulned+o.interrupted)*ee,E=o.glanced*se/2+(o.blocked+o.evaded+o.missed+o.invulned+o.interrupted)*se;if(ue<=0)return;const w=p(W);w.totalHits+=o.totalHits,w.blocked+=o.blocked,w.evaded+=o.evaded,w.glanced+=o.glanced,w.missed+=o.missed,w.invulned+=o.invulned,w.interrupted+=o.interrupted,w.totalMitigation+=ue,w.minMitigation+=E}),e.forEach((o,M)=>{const f=s.get(M)||pt();o.mitigationTotals.totalHits=f.totalHits,o.mitigationTotals.blocked=f.blocked,o.mitigationTotals.evaded=f.evaded,o.mitigationTotals.glanced=f.glanced,o.mitigationTotals.missed=f.missed,o.mitigationTotals.invulned=f.invulned,o.mitigationTotals.interrupted=f.interrupted,o.mitigationTotals.totalMitigation=f.totalMitigation,o.mitigationTotals.minMitigation=f.minMitigation})};Dn(Bt,bn),Dn(It,hn);const Ti=ie>0?Math.round(ae/ie):0,wi=ie>0?Math.round(he/ie):0,Fi=Je>0?(l/Je).toFixed(2):l>0?"∞":"0.00",vi=re>0?(le/re).toFixed(2):le>0?"∞":"0.00",Sn=(e,t)=>{const p=e.filter(f=>Number.isFinite(f.value)&&(t?f.value>0:f.value>=0)).sort((f,W)=>{const U=t?W.value-f.value:f.value-W.value;return U!==0?U:f.account.localeCompare(W.account)});let o=null,M=0;return p.map((f,W)=>((o===null||f.value!==o)&&(M=W+1,o=f.value),{rank:M,...f}))},$t=Array.from(me.values()).map(e=>{const t=Array.from(e.professions).filter(s=>s!=="Unknown");if(e.professionList=t,t.length>0){let s=t[0],p=e.professionTimeMs[s]||0;t.forEach(o=>{const M=e.professionTimeMs[o]||0;M>p&&(p=M,s=o)}),e.profession=s}return{key:e.account,stat:e}}),Cn=e=>{const t=me.get(e.account);if(!t){const o=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:o}}const s=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(o=>o&&o!=="Unknown"),p=t.profession||e.profession;return{...e,profession:p,professionList:s.length>0?s:p?[p]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},Ei=Array.from(Bt.values()).map(Cn).filter(e=>Ni(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),Bi=Array.from(It.values()).map(Cn).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const s=e.account.localeCompare(t.account);return s!==0?s:String(e.minion||"").localeCompare(String(t.minion||""))}),Lt=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},Ze=(e,t)=>Sn($t.map(({stat:s})=>({account:s.account,profession:s.profession,professionList:s.professionList,value:Lt(s,e),count:s.logsJoined})),t),qe={downContrib:Ze("downContrib",!0),barrier:Ze("barrier",!0),healing:Ze("healing",!0),dodges:Ze("dodges",!0),strips:Ze("strips",!0),cleanses:Ze("cleanses",!0),cc:Ze("cc",!0),stability:Ze("stability",!0),revives:Ze("revives",!0),participation:Ze("participation",!0),dps:Ze("dps",!0),damage:Ze("damage",!0),closestToTag:Ze("closestToTag",!1).filter(e=>Number.isFinite(e.value))},Ii={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},we=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},at={maxDownContrib:we([]),maxBarrier:we([]),maxHealing:we([]),maxDodges:we([]),maxStrips:we([]),maxCleanses:we([]),maxCC:we([]),maxStab:we([]),closestToTag:we([])},st={},Li=(e,t)=>{if(t==="closestToTag")return Lt(e,t);const s=Math.max(1,(e.totalFightMs||0)/1e3);return Lt(e,t)/s};Object.values(Ii).forEach(e=>{const t=e!=="closestToTag";st[e]=Sn($t.map(({stat:s})=>({account:s.account,profession:s.profession,professionList:s.professionList,value:Li(s,e),count:s.logsJoined})),t)}),at.maxDownContrib=we(st.downContrib),at.maxBarrier=we(st.barrier),at.maxHealing=we(st.healing),at.maxDodges=we(st.dodges),at.maxStrips=we(st.strips),at.maxCleanses=we(st.cleanses),at.maxCC=we(st.cc),at.maxStab=we(st.stability),at.closestToTag=we(st.closestToTag);const Pi={maxDownContrib:we(qe.downContrib),maxBarrier:we(qe.barrier),maxHealing:we(qe.healing),maxDodges:we(qe.dodges),maxStrips:we(qe.strips),maxCleanses:we(qe.cleanses),maxCC:we(qe.cc),maxStab:we(qe.stability),closestToTag:we(qe.closestToTag)};let Ht={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},An,Nn,Mn=0;if(oe!=null&&oe.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=M=>{const f=e[M];return f?Number(be[f]||0)>0:!1},s=[],p=M=>[...M||[]].filter(f=>t(f==null?void 0:f.name)).sort((f,W)=>W.ratio-f.ratio||f.rank-W.rank||f.name.localeCompare(W.name)).slice(0,3),o=M=>{var W;if(!M)return;const f=p(M.contribs);return{...M,player:M.name,reason:((W=f[0])==null?void 0:W.name)||"Top Performance",topStats:f}};$t.forEach(({stat:M})=>{let f=0;const W=[],U=(K,ee,se,ue,E=!0)=>{var V,Z;if(se<=0)return;const w=((V=ee[0])==null?void 0:V.value)||0;if(w&&Number.isFinite(K)&&(E?K>0:K<Number.POSITIVE_INFINITY)){const ce=E?K/w:w/K;f+=ce*se;const d=((Z=ee.find(g=>g.account===M.account))==null?void 0:Z.rank)||0;W.push({name:ue,ratio:ce,val:K.toLocaleString(),rank:d})}};U(M.downContrib,qe.downContrib,be.downContribution,"Down Contribution"),U(M.healing,qe.healing,be.healing,"Healing"),U(M.cleanses,qe.cleanses,be.cleanses,"Cleanses"),U(M.strips,qe.strips,be.strips,"Strips"),U(M.stab,qe.stability,be.stability,"Stability"),U(M.cc,qe.cc,be.cc,"CC"),U(M.revives,qe.revives,be.revives,"Revives"),U(Lt(M,"closestToTag"),qe.closestToTag,be.distanceToTag,"Distance to Tag",!1),U(M.logsJoined,qe.participation,be.participation,"Participation"),U(M.dodges,qe.dodges,be.dodging,"Dodging"),U(M.dps,qe.dps,be.dps,"DPS"),U(M.damage,qe.damage,be.damage,"Damage"),s.push({...M,score:f,contribs:W.filter(K=>t(K.name))})}),s.sort((M,f)=>f.score-M.score),s[0]&&s[0].score>0&&(Ht=o(s[0])||Ht),An=o(s[1]),Nn=o(s[2]),Mn=s.length>0?s.reduce((M,f)=>M+f.score,0)/s.length:0}const Tn=Object.values(ge).sort((e,t)=>t.damage-e.damage||t.hits-e.hits||String(e.name||"").localeCompare(String(t.name||""))).slice(0,25),wn=Object.values(ge).sort((e,t)=>t.downContribution-e.downContribution||t.hits-e.hits||String(e.name||"").localeCompare(String(t.name||""))).slice(0,25),qi=fe==="downContribution"?wn:Tn,xi=Object.values(Se).sort((e,t)=>t.damage-e.damage).slice(0,25),Ri=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),s=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return s?`${s[1]} Borderlands`:t||"Unknown"},mt=(e,t)=>Ri((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),Ui=(e,t)=>{const s=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof s=="string"&&s.trim().length>0)return s.trim();const p=e==null?void 0:e.uploadLinks;if(!Array.isArray(p))return"";for(const o of p){if(typeof o=="string"&&o.trim().length>0)return o.trim();if(o&&typeof o=="object"){const M=o.permalink||o.link||o.url||o.reportLink;if(typeof M=="string"&&M.trim().length>0)return M.trim()}}return""},$i=(e,t)=>{const s=Number((e==null?void 0:e.durationMS)||0);return s>0?Nt(s):(typeof(t==null?void 0:t.encounterDuration)=="string"?t.encounterDuration.trim():"")||"--:--"},Fn=(e,t)=>{if((Array.isArray(e==null?void 0:e.players)?e.players:[]).length>0)return De(e);if(typeof(e==null?void 0:e.success)=="boolean")return e.success;const p=t==null?void 0:t.dashboardSummary;if(p&&typeof p=="object"){if(p.isWin===!0)return!0;if(p.isWin===!1)return!1}return null},Hi=(e,t)=>{var f,W;const s=Ge((f=e.log)==null?void 0:f.details,e.log),p=Ge((W=t.log)==null?void 0:W.details,t.log),o=s>0,M=p>0;return o&&M&&s!==p?s-p:o!==M?o?-1:1:e.originalIndex-t.originalIndex},Ot=i.map((e,t)=>({log:e,originalIndex:t})).sort(Hi),Oi=Ot.filter(({log:e})=>pe(e)),jt={};G.forEach(e=>{const t=mt(e==null?void 0:e.details,e);jt[t]=(jt[t]||0)+1});const ji=Object.entries(jt).map(([e,t])=>{const s=String(e).trim(),p=/eternal battlegrounds|^ebg$/i.test(s);let o="#64748b";return p?o="#ffffff":/red/i.test(s)?o="#ef4444":/blue/i.test(s)?o="#3b82f6":/green/i.test(s)&&(o="#22c55e"),{name:e,value:t,color:o}}).sort((e,t)=>t.value-e.value),{boonTables:Wi}=Wn(G),_i=Ot.map(({log:e})=>{const t=e==null?void 0:e.details,s=Array.isArray(t==null?void 0:t.players)?t.players:[],p=Array.isArray(t==null?void 0:t.targets)?t.targets:[],o=e!=null&&e.dashboardSummary&&typeof e.dashboardSummary=="object"?e.dashboardSummary:null,M=s.filter(ue=>!ue.notInSquad),f=p.filter(ue=>!ue.isFake),W=Math.max(0,Number((o==null?void 0:o.squadCount)||0)),U=Math.max(0,Number((o==null?void 0:o.enemyCount)||0)),K=M.length>0?M.length:W,ee=f.length>0?f.length:U,se=s.length>0?s.length:K;return{timestamp:Ge(t,e),squadCount:K,friendlyCount:se,enemies:ee,isWin:Fn(t,e)}}).map((e,t)=>({...e,index:t+1,label:`Log ${t+1}`})),Wt={};Array.from(me.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(Wt[e.profession]=(Wt[e.profession]||0)+1)});const zi=Object.entries(Wt).map(([e,t])=>({name:e,value:t,color:an(e)})).sort((e,t)=>t.value-e.value),_t={};Object.keys(Pe).length===0&&G.forEach(e=>{var t,s;(s=(t=e.details)==null?void 0:t.targets)==null||s.forEach(p=>{if(p.isFake)return;const o=p.profession&&p.profession!=="Unknown"?p.profession:p.name||p.id||"Unknown",M=et(o);_t[M]=(_t[M]||0)+1})});const Ki=Object.keys(Pe).length>0?Pe:_t,Vi=Object.entries(Ki).map(([e,t])=>({name:e,value:t,color:an(e)})).sort((e,t)=>t.value-e.value),Gi=Ot.map(({log:e},t)=>{const s=e==null?void 0:e.details,p=Array.isArray(s==null?void 0:s.players)?s.players:[],o=p.filter(c=>!c.notInSquad),M=p.filter(c=>c.notInSquad),W=(Array.isArray(s==null?void 0:s.targets)?s.targets:[]).filter(c=>!c.isFake),U=e!=null&&e.dashboardSummary&&typeof e.dashboardSummary=="object"?e.dashboardSummary:null,K=o.reduce((c,O)=>{var b,n;return c+(((n=(b=O.dpsAll)==null?void 0:b[0])==null?void 0:n.damage)||0)},0),ee=o.reduce((c,O)=>{var b,n;return c+(((n=(b=O.defenses)==null?void 0:b[0])==null?void 0:n.damageTaken)||0)},0),{enemyDeaths:se,enemyDownsDeaths:ue}=ke(s),E=Fn(s,e),w=Ge(s,e),V=mt(s,e),Z=c=>{if(!c||typeof c!="object")return;const O=c.teamID??c.teamId??c.team??c.teamColor??c.team_color;if(O!=null)return O;const b=Object.keys(c).find(n=>/^team/i.test(n));return b?c[b]:void 0},ce=(c,O)=>{const b={};return c.forEach(n=>{const C=O(n),x=et(C);x&&(b[x]=(b[x]||0)+1)}),b},d=ce(o,c=>(c==null?void 0:c.profession)||(c==null?void 0:c.name)),g=ce(M,c=>(c==null?void 0:c.profession)||(c==null?void 0:c.name)),N=ce(W,c=>(c==null?void 0:c.profession)||(c==null?void 0:c.name)||(c==null?void 0:c.id)),S=new Set;o.forEach(c=>{const O=Z(c);O!=null&&S.add(String(O))});const B=new Map;W.forEach(c=>{if((c==null?void 0:c.enemyPlayer)===!1)return;const O=Z(c);if(O==null)return;const b=String(O);S.has(b)||B.set(b,(B.get(b)||0)+1)});const H=Array.from(B.entries()).sort((c,O)=>{const b=O[1]-c[1];return b!==0?b:c[0].localeCompare(O[0],void 0,{numeric:!0})}).slice(0,3).map(([c,O])=>({teamId:c,count:O}));return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:Ui(s,e),timestamp:w,mapName:V,duration:$i(s,e),isWin:E,squadCount:o.length>0?o.length:Math.max(0,Number((U==null?void 0:U.squadCount)||0)),allyCount:M.length,enemyCount:W.length>0?W.length:Math.max(0,Number((U==null?void 0:U.enemyCount)||0)),teamBreakdown:H,alliesDown:o.reduce((c,O)=>{var b,n;return c+(((n=(b=O.defenses)==null?void 0:b[0])==null?void 0:n.downCount)||0)},0),alliesDead:o.length>0?o.reduce((c,O)=>{var b,n;return c+(((n=(b=O.defenses)==null?void 0:b[0])==null?void 0:n.deadCount)||0)},0):Math.max(0,Number((U==null?void 0:U.squadDeaths)||0)),alliesRevived:o.reduce((c,O)=>{var b,n;return Number(((n=(b=O.statsAll)==null?void 0:b[0])==null?void 0:n.saved)||0)>0?c+1:c},0),rallies:0,enemyDeaths:W.length>0||o.length>0?se:Math.max(0,Number((U==null?void 0:U.enemyDeaths)||0)),enemyDowns:Math.max(0,ue-se),totalOutgoingDamage:K,totalIncomingDamage:ee,incomingBarrierAbsorbed:o.reduce((c,O)=>{var b,n;return c+(((n=(b=O.defenses)==null?void 0:b[0])==null?void 0:n.damageBarrier)||0)},0),outgoingBarrierAbsorbed:o.reduce((c,O)=>{var C;const b=(C=O.extBarrierStats)==null?void 0:C.outgoingBarrier;if(!Array.isArray(b))return c;let n=0;return b.forEach(x=>{if(Array.isArray(x)){x.forEach(X=>{n+=Number((X==null?void 0:X.barrier)||0)});return}n+=Number((x==null?void 0:x.barrier)||0)}),c+n},0),squadClassCountsFight:d,allyClassCountsFight:g,enemyClassCounts:N}}),Ji=Oi.map(({log:e},t)=>{const s=e.details;if(!s)return null;const o=(Array.isArray(s.players)?s.players:[]).filter(u=>!u.notInSquad),M=Array.isArray(s.targets)?s.targets:[],f=Ge(s,e),W=mt(s,e),U=Number(s.durationMS||0),{squadDownsDeaths:K,enemyDownsDeaths:ee,squadDeaths:se,enemyDeaths:ue}=ke(s),E=new Map,w=(u,k,I)=>{const z=E.get(u)||{label:u,damage:0,hits:0};z.damage+=k,z.hits+=I,E.set(u,z)};if(o.forEach(u=>{(Array.isArray(u==null?void 0:u.statsTargets)?u.statsTargets:[]).forEach((I,z)=>{const j=Array.isArray(I)?I[0]:I,D=Number((j==null?void 0:j.damage)??(j==null?void 0:j.totalDmg)??(j==null?void 0:j.connectedDmg)??0),q=Number((j==null?void 0:j.connectedHits)??(j==null?void 0:j.connectedDamageCount)??(j==null?void 0:j.hits)??0);if(D<=0&&q<=0)return;const $=M[z];if($!=null&&$.isFake)return;const y=($==null?void 0:$.profession)||($==null?void 0:$.name)||($==null?void 0:$.id)||`Target ${z+1}`,de=et(y);w(de||String(y),D,q)})}),E.size===0){const u=new Map,k=I=>{if(!Array.isArray(I)||I.length===0)return[];const z=I[0];if(Array.isArray(z)&&Array.isArray(z[0])){if(typeof z[0][0]=="number")return z;if(Array.isArray(z[0])&&typeof z[0][0]=="number")return I.map(j=>Array.isArray(j)?j[0]||[]:[])}return[]};o.forEach(I=>{k(I==null?void 0:I.targetDamage1S).forEach((j,D)=>{if(!Array.isArray(j)||j.length===0)return;const q=j.map(y=>Number(y)).filter(y=>Number.isFinite(y)&&y>=0);if(q.length===0)return;const $=Math.max(0,q[q.length-1]||0);$<=0||u.set(D,(u.get(D)||0)+$)})}),u.forEach((I,z)=>{if(I<=0)return;const j=M[z];if(j!=null&&j.isFake)return;const D=(j==null?void 0:j.profession)||(j==null?void 0:j.name)||(j==null?void 0:j.id)||`Target ${z+1}`,q=et(D);w(q||String(D),I,0)})}if(E.size===0&&M.forEach((u,k)=>{if(u!=null&&u.isFake)return;const I=Array.isArray(u==null?void 0:u.totalDamageTaken)?u.totalDamageTaken:Array.isArray(u==null?void 0:u.totalDamageDist)?u.totalDamageDist:[];let z=0,j=0;if(I.forEach($=>{z+=Number(($==null?void 0:$.totalDamage)||($==null?void 0:$.damage)||0),j+=Number(($==null?void 0:$.connectedHits)||($==null?void 0:$.hits)||0)}),z<=0&&Number((u==null?void 0:u.damageTaken)||0)>0&&(z=Number(u.damageTaken||0)),z<=0&&j<=0)return;const D=(u==null?void 0:u.profession)||(u==null?void 0:u.name)||(u==null?void 0:u.id)||`Target ${k+1}`,q=et(D);w(q||String(D),z,j)}),E.size===0){const u=new Map;M.forEach((k,I)=>{if(k!=null&&k.isFake)return;const z=(k==null?void 0:k.profession)||(k==null?void 0:k.name)||(k==null?void 0:k.id)||`Target ${I+1}`,j=et(z)||String(z);u.set(j,(u.get(j)||0)+1)}),u.forEach((k,I)=>{k>0&&w(I,k,0)})}const V=Array.from(E.values()).sort((u,k)=>k.damage-u.damage||k.hits-u.hits||u.label.localeCompare(k.label)),Z=V.reduce((u,k)=>u+k.damage,0),ce=V.map(u=>({label:u.label,damage:u.damage,hits:u.hits,share:Z>0?u.damage/Z:0})),d=M.filter(u=>!(u!=null&&u.isFake)).length,g=o.length,N=o.reduce((u,k)=>{var I,z;return u+Number(((z=(I=k==null?void 0:k.dpsAll)==null?void 0:I[0])==null?void 0:z.damage)||0)},0),S=o.reduce((u,k)=>{var I,z;return u+Number(((z=(I=k==null?void 0:k.defenses)==null?void 0:I[0])==null?void 0:z.damageTaken)||0)},0),B=o.reduce((u,k)=>{var I,z;return u+Number(((z=(I=k==null?void 0:k.defenses)==null?void 0:I[0])==null?void 0:z.damageBarrier)||0)},0),H=o.reduce((u,k)=>{var j;const I=(j=k==null?void 0:k.extBarrierStats)==null?void 0:j.outgoingBarrier;if(!Array.isArray(I))return u;let z=0;return I.forEach(D=>{Array.isArray(D)?D.forEach(q=>{z+=Number((q==null?void 0:q.barrier)||0)}):z+=Number((D==null?void 0:D.barrier)||0)}),u+z},0),c=o.reduce((u,k)=>{var I,z;return Number(((z=(I=k==null?void 0:k.statsAll)==null?void 0:I[0])==null?void 0:z.saved)||0)>0?u+1:u},0),O=o.reduce((u,k)=>u+Number(Xt(k)||0),0),b=o.reduce((u,k)=>u+Number(Zt(k)||0),0),n=o.reduce((u,k)=>u+Number((k==null?void 0:k.stabGeneration)||0),0),C=o.reduce((u,k)=>u+Number(en(k)||0),0),x=o.reduce((u,k)=>u+Number(tn(k)||0),0),X=o.reduce((u,k)=>u+Number(nn(k)||0),0),_=o.reduce((u,k)=>u+Number(yt(k)||0),0),r=se>0?ue/se:ue,te=[{metricId:"winFlag",metricLabel:"Win (1) / Loss (0)",higherIsBetter:!0,value:De(s)?1:0},{metricId:"squadCount",metricLabel:"Squad Size",higherIsBetter:!0,value:g},{metricId:"enemyCount",metricLabel:"Enemy Count",higherIsBetter:!1,value:d},{metricId:"squadKdr",metricLabel:"Squad KDR",higherIsBetter:!0,value:r},{metricId:"enemyDeaths",metricLabel:"Enemy Deaths",higherIsBetter:!0,value:ue},{metricId:"enemyDowns",metricLabel:"Enemy Downs",higherIsBetter:!0,value:Math.max(0,ee-ue)},{metricId:"squadDeaths",metricLabel:"Squad Deaths",higherIsBetter:!1,value:se},{metricId:"squadDowns",metricLabel:"Squad Downs",higherIsBetter:!1,value:Math.max(0,K-se)},{metricId:"damageDelta",metricLabel:"Damage Delta",higherIsBetter:!0,value:N-S},{metricId:"outgoingDamage",metricLabel:"Outgoing Damage",higherIsBetter:!0,value:N},{metricId:"incomingDamage",metricLabel:"Incoming Damage",higherIsBetter:!1,value:S},{metricId:"cleanses",metricLabel:"Squad Cleanses",higherIsBetter:!0,value:O},{metricId:"strips",metricLabel:"Squad Strips",higherIsBetter:!0,value:b},{metricId:"stability",metricLabel:"Squad Stability",higherIsBetter:!0,value:n},{metricId:"healing",metricLabel:"Squad Healing",higherIsBetter:!0,value:C},{metricId:"barrierOut",metricLabel:"Squad Barrier Out",higherIsBetter:!0,value:x},{metricId:"barrierIncomingAbsorb",metricLabel:"Barrier Absorption (Incoming)",higherIsBetter:!0,value:B},{metricId:"enemyBarrierAbsorb",metricLabel:"Enemy Barrier Absorption",higherIsBetter:!1,value:H},{metricId:"cc",metricLabel:"Squad CC",higherIsBetter:!0,value:X},{metricId:"downContrib",metricLabel:"Squad Down Contribution",higherIsBetter:!0,value:_},{metricId:"alliesRevived",metricLabel:"Allies Revived (Players)",higherIsBetter:!0,value:c}];return{id:e.filePath||e.id||`fight-${t+1}`,shortLabel:`F${t+1}`,fullLabel:`${W||e.encounterName||"Unknown Map"} • ${Nt(U)}`,mapName:W,timestamp:f,duration:Nt(U),isWin:De(s),targetFocus:ce,squadMetrics:te}}).filter(Boolean),Yi=Array.from(me.values()).map(e=>{const t=Object.entries(e.professionTimeMs||{}).map(([s,p])=>({profession:s,timeMs:Number(p||0)})).filter(s=>s.profession&&s.profession!=="Unknown"&&s.timeMs>0).sort((s,p)=>{const o=p.timeMs-s.timeMs;return o!==0?o:s.profession.localeCompare(p.profession)});return{account:e.account||"Unknown",characterNames:Array.from(e.characterNames||[]).filter(Boolean).sort((s,p)=>s.localeCompare(p)),classTimes:t,combatTimeMs:Number(e.squadActiveMs||e.totalFightMs||0),squadTimeMs:(()=>{const s=Number(e.firstSeenFightTs||0),p=Number(e.lastSeenFightTs||0),o=Math.max(0,Number(e.lastSeenFightDurationMs||0));return s>0&&p>0?Math.max(0,p+o-s):Number(e.squadActiveMs||e.totalFightMs||0)})()}}).filter(e=>e.account&&e.account!=="Unknown").sort((e,t)=>{const s=t.squadTimeMs-e.squadTimeMs;return s!==0?s:String(e.account).localeCompare(String(t.account))}),Qi=G.map(e=>e).sort((e,t)=>Ge(e.details,e)-Ge(t.details,t)).map((e,t)=>{const s=e==null?void 0:e.details,p=Array.isArray(s==null?void 0:s.players)?s.players.filter(f=>!(f!=null&&f.notInSquad)):[],o=new Map;p.forEach(f=>{const W=Number(f==null?void 0:f.group),U=Number.isFinite(W)&&W>0?W:0;o.has(U)||o.set(U,{party:U,players:[],classCounts:{}});const K=et((f==null?void 0:f.profession)||(f==null?void 0:f.name)||"Unknown"),ee=String((f==null?void 0:f.account)||"Unknown"),se=String((f==null?void 0:f.name)||(f==null?void 0:f.character_name)||""),ue=!!(f!=null&&f.hasCommanderTag),E=o.get(U);E.players.push({account:ee,characterName:se,profession:K,isCommander:ue}),E.classCounts[K]=(E.classCounts[K]||0)+1});const M=Array.from(o.values()).map(f=>({...f,players:f.players.sort((W,U)=>{const K=+!!U.isCommander-+!!W.isCommander;if(K!==0)return K;const ee=String(W.profession).localeCompare(String(U.profession));return ee!==0?ee:String(W.account).localeCompare(String(U.account))})})).sort((f,W)=>f.party===0&&W.party!==0?1:W.party===0&&f.party!==0?-1:f.party-W.party);return{id:String((e==null?void 0:e.filePath)||(e==null?void 0:e.id)||`fight-${t+1}`),label:`F${t+1}`,timestamp:Ge(s,e),mapName:mt(s,e),duration:Nt(Number((s==null?void 0:s.durationMS)||0)),parties:M}}),Xi=(e,t)=>{const s=(t==null?void 0:t.skillMap)||{},p=(t==null?void 0:t.buffMap)||{};let o=0,M="";const f=K=>{const ee=Number(K);if(!Number.isFinite(ee))return String(K||"Unknown Skill");const se=(s==null?void 0:s[`s${ee}`])||(s==null?void 0:s[`${ee}`]);if(se!=null&&se.name)return String(se.name);const ue=(p==null?void 0:p[`b${ee}`])||(p==null?void 0:p[`${ee}`]);return ue!=null&&ue.name?String(ue.name):`Skill ${ee}`},W=K=>{if(!K||typeof K!="object")return;const ee=[Number(K.max),Number(K.maxDamage),Number(K.maxHit)].filter(ue=>Number.isFinite(ue)),se=ee.length>0?Math.max(...ee):0;se>o&&(o=se,M=f(K.id))};let U=!1;return Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(K=>{Array.isArray(K)&&K.forEach(ee=>{Array.isArray(ee)&&ee.forEach(se=>{U=!0,W(se)})})}),(!U||o<=0)&&Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(K=>{Array.isArray(K)&&K.forEach(ee=>W(ee))}),{peak:o,skillName:M||"Unknown Skill"}},Zi=(()=>{const e=E=>String(E||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=E=>e(E).toLowerCase().split(/[^a-z0-9]+/i).map(w=>w.trim()).filter(Boolean).map(w=>w.length>3&&w.endsWith("s")?w.slice(0,-1):w),s=(E,w)=>{const V=e(E),Z=e(w);if(!Z)return V;if(!V)return Z;const ce=t(V),d=t(Z),g=new Set(ce),N=new Set(d),S=d.length>0&&d.every(H=>g.has(H)),B=ce.length>0&&ce.every(H=>N.has(H));return S||B?V:`${V} - ${Z}`},p=[],o=new Map,M=E=>{const w=S=>{if(!Array.isArray(S)||S.length===0)return[];const B=[];for(let H=0;H<S.length;H+=1){const c=Number(S[H]||0),O=H>0?Number(S[H-1]||0):0;B.push(Math.max(0,c-O))}return B},V=S=>{if(!Array.isArray(S))return[];const B=S.reduce((c,O)=>Math.max(c,Array.isArray(O)?O.length:0),0);if(B<=0)return[];const H=new Array(B).fill(0);return S.forEach(c=>{if(Array.isArray(c))for(let O=0;O<B;O+=1)H[O]+=Number(c[O]||0)}),H},Z=S=>Array.isArray(S)?S.map(B=>Number(B||0)):null,d=(S=>{if(!Array.isArray(S)||S.length===0)return null;const B=S[0];if(!Array.isArray(B))return null;if(Array.isArray(B[0])&&Array.isArray(B[0][0]))return V(B);if(Array.isArray(B[0])&&!Array.isArray(B[0][0])){const H=S.map(c=>Z(Array.isArray(c)?c[0]:null)).filter(c=>Array.isArray(c)&&c.length>0);if(H.length>0)return V(H)}return null})(E==null?void 0:E.targetDamage1S),g=Array.isArray(E==null?void 0:E.damage1S)&&Array.isArray(E.damage1S[0])?E.damage1S[0]:null,N=d||(Array.isArray(g)?g.map(S=>Number(S||0)):[]);return w(N)},f=(E,w)=>{if(!Array.isArray(E)||E.length===0||w<=0)return 0;let V=0,Z=0;for(let ce=0;ce<E.length;ce+=1)V+=Number(E[ce]||0),ce>=w&&(V-=Number(E[ce-w]||0)),ce>=w-1&&V>Z&&(Z=V);return Math.max(0,Z)},W=(E,w)=>{if(!Array.isArray(E)||E.length===0||w<=0)return[];const V=[];for(let Z=0;Z<E.length;Z+=w){const ce=Math.min(Z+w,E.length),d=E.slice(Z,ce).reduce((g,N)=>g+Number(N||0),0);V.push(d)}return V},U=(E,w)=>{const V=Number(E);if(!Number.isFinite(V))return{name:String(E||"Unknown Skill"),icon:void 0};const Z=(w==null?void 0:w.skillMap)||{},ce=(w==null?void 0:w.buffMap)||{},d=(Z==null?void 0:Z[`s${V}`])||(Z==null?void 0:Z[`${V}`]);if(d!=null&&d.name)return{name:String(d.name),icon:d==null?void 0:d.icon};const g=(ce==null?void 0:ce[`b${V}`])||(ce==null?void 0:ce[`${V}`]);return g!=null&&g.name?{name:String(g.name),icon:g==null?void 0:g.icon}:{name:`Skill ${V}`,icon:void 0}},K=E=>Array.isArray(E)?E.map(w=>Array.isArray(w)?[Number(w[0]),Number(w[1])]:w&&typeof w=="object"?[Number(w.time),Number(w.value)]:null).filter(w=>!!w&&Number.isFinite(w[0])&&w[0]>=0):[],ee=(E,w,V,Z,ce)=>{if(!E.length||Z<=0)return[];const d=Math.max(Z*5e3,ce||0),g=n=>n.reduce((C,x)=>x>=0&&x<=d+2e3?C+1:C,0),N=E.map(n=>Number(n||0)).filter(n=>Number.isFinite(n)&&n>=0);if(!N.length)return[];const S=[N],B=N.reduce((n,C)=>Math.max(n,C),0),H=N.reduce((n,C)=>Math.min(n,C),Number.POSITIVE_INFINITY);B>d*20&&S.push(N.map(n=>n/1e3)),B<=d*2&&H>=0&&B>0&&B<Math.max(120,Z*5+10)&&S.push(N.map(n=>n*1e3));let c=N,O=0,b=-1;return S.forEach(n=>{const C=n.reduce((X,_)=>Math.min(X,_),Number.POSITIVE_INFINITY),x=new Set([0,...w,...V]);if(Number.isFinite(C)&&d>0&&C>d){const X=Math.floor(C/d)*d;x.add(X),x.add(Math.max(0,X-d))}x.forEach(X=>{const _=n.map(te=>te-X),r=g(_);r>b&&(b=r,O=X,c=n)})}),c.map(n=>n-O).filter(n=>Number.isFinite(n)&&n>=0)},se=(E,w,V,Z,ce)=>{const d=ee(E,w,V,Z,ce);return Array.from(new Set(d.map(g=>Math.floor(g/5e3)).filter(g=>Number.isFinite(g)&&g>=0&&g<Z)))};G.map(E=>({log:E,ts:Ge(E==null?void 0:E.details,E)})).sort((E,w)=>E.ts-w.ts).forEach(({log:E},w)=>{const V=E==null?void 0:E.details;if(!V)return;const Z=e(V.fightName||E.fightName||`Fight ${w+1}`),ce=mt(V,E),d=s(Z,String(ce||"")),g={},N=Array.isArray(V.players)?V.players:[],S=N.flatMap(b=>{const n=b==null?void 0:b.combatReplayData;return Array.isArray(n)?n.map(C=>Number(C==null?void 0:C.start)):[Number(n==null?void 0:n.start)]}).filter(b=>Number.isFinite(b)&&b>=0);N.forEach(b=>{if(b!=null&&b.notInSquad)return;const n=String((b==null?void 0:b.account)||(b==null?void 0:b.name)||"Unknown"),C=String((b==null?void 0:b.character_name)||(b==null?void 0:b.display_name)||(b==null?void 0:b.name)||""),x=String((b==null?void 0:b.profession)||"Unknown"),X=`${n}|${x}`,_=Xi(b,V),r=Number(_.peak||0),te=M(b),u=Number(f(te,1)||0),k=Number(f(te,5)||0),I=Number(f(te,30)||0),z=Math.max(0,Math.ceil(Number((V==null?void 0:V.durationMS)||0)/5e3)),j=Math.max(0,Math.ceil(te.length/5)),D=Math.max(z,j),q=W(te,5),$=Array.from({length:D},(J,ne)=>Number(q[ne]||0)),y=new Map,de=J=>{if(!J||typeof J!="object"||J.indirectDamage)return;const ne=Number(J.totalDamage||0);if(!Number.isFinite(ne)||ne<=0)return;const Ae=Number(J.connectedHits||J.hits||0),ve=U(J.id,V),ot=ve.name,Qe=y.get(ot)||{skillName:ot,damage:0,hits:0,icon:ve.icon};Qe.damage+=ne,Qe.hits+=Number.isFinite(Ae)?Ae:0,!Qe.icon&&ve.icon&&(Qe.icon=ve.icon),y.set(ot,Qe)},Be=new Map;Array.isArray(b==null?void 0:b.targetDamageDist)&&b.targetDamageDist.forEach(J=>{Array.isArray(J)&&J.forEach(ne=>{Array.isArray(ne)&&ne.forEach(Ae=>{const ve=Number(Ae==null?void 0:Ae.id),ot=Number((Ae==null?void 0:Ae.totalDamage)||0);if(Number.isFinite(ve)){const Qe=Be.get(ve)||{damage:0,hits:0};Qe.damage+=Number.isFinite(ot)?ot:0,Qe.hits+=Number((Ae==null?void 0:Ae.connectedHits)||(Ae==null?void 0:Ae.hits)||0),Be.set(ve,Qe)}de(Ae)})})}),!(V!=null&&V.detailedWvW)&&Array.isArray(b==null?void 0:b.totalDamageDist)&&b.totalDamageDist.forEach(J=>{Array.isArray(J)&&J.forEach(ne=>{const Ae=Number(ne==null?void 0:ne.id);if(!Number.isFinite(Ae)){de(ne);return}const ve=Be.get(Ae);if(!ve){de(ne);return}const ot=Number((ne==null?void 0:ne.totalDamage)||0),Qe=Number((ne==null?void 0:ne.connectedHits)||(ne==null?void 0:ne.hits)||0),bt=ot-Number(ve.damage||0),lt=Qe-Number(ve.hits||0);bt<=0&&lt<=0||de({...ne,totalDamage:Math.max(0,bt),connectedHits:Math.max(0,lt),hits:Math.max(0,lt)})})});const Te=(()=>{const J=b==null?void 0:b.combatReplayData;return Array.isArray(J)?J.filter(ne=>ne&&typeof ne=="object"):J&&typeof J=="object"?[J]:[]})(),Ve=Te.map(J=>Number(J==null?void 0:J.start)).filter(J=>Number.isFinite(J)&&J>=0),Fe=Te.flatMap(J=>K(J==null?void 0:J.down).map(([ne])=>Number(ne||0))),Ye=Te.flatMap(J=>K(J==null?void 0:J.dead).map(([ne])=>Number(ne||0)));g[X]={hit:r,burst1s:u,burst5s:k,burst30s:I,skillName:_.skillName,buckets5s:$,downIndices5s:se(Fe,Ve,S,D,Number((V==null?void 0:V.durationMS)||0)),deathIndices5s:se(Ye,Ve,S,D,Number((V==null?void 0:V.durationMS)||0)),skillRows:Array.from(y.values()).sort((J,ne)=>ne.damage-J.damage).slice(0,50)};const Ce=o.get(X)||{key:X,account:n,displayName:n,characterName:C,profession:x,professionList:[x],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};Ce.logs+=1,Ce.professionList.includes(x)||Ce.professionList.push(x),!Ce.characterName&&C&&(Ce.characterName=C),r>Ce.peakHit&&(Ce.peakHit=r,Ce.peakFightLabel=d,Ce.peakSkillName=_.skillName),u>Ce.peak1s&&(Ce.peak1s=u),k>Ce.peak5s&&(Ce.peak5s=k),I>Ce.peak30s&&(Ce.peak30s=I),o.set(X,Ce)});const B=Object.values(g).reduce((b,n)=>Math.max(b,Number((n==null?void 0:n.hit)||0)),0),H=Object.values(g).reduce((b,n)=>Math.max(b,Number((n==null?void 0:n.burst1s)||0)),0),c=Object.values(g).reduce((b,n)=>Math.max(b,Number((n==null?void 0:n.burst5s)||0)),0),O=Object.values(g).reduce((b,n)=>Math.max(b,Number((n==null?void 0:n.burst30s)||0)),0);p.push({id:E.filePath||E.id||`fight-${w+1}`,shortLabel:`F${w+1}`,fullLabel:d,timestamp:Ge(V,E),values:g,maxHit:B,max1s:H,max5s:c,max30s:O})});const ue=Array.from(o.values()).sort((E,w)=>w.peakHit!==E.peakHit?w.peakHit-E.peakHit:E.displayName.localeCompare(w.displayName));return{fights:p,players:ue}})(),yi=(()=>{const e=d=>String(d||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=d=>e(d).toLowerCase().split(/[^a-z0-9]+/i).map(g=>g.trim()).filter(Boolean).map(g=>g.length>3&&g.endsWith("s")?g.slice(0,-1):g),s=(d,g)=>{const N=e(d),S=e(g);if(!S)return N;if(!N)return S;const B=t(N),H=t(S),c=new Set(B),O=new Set(H),b=H.length>0&&H.every(C=>c.has(C)),n=B.length>0&&B.every(C=>O.has(C));return b||n?N:`${N} - ${S}`},p=[],o=new Map,M=(d,g)=>{const N=Number(d);if(!Number.isFinite(N))return{name:String(d||"Unknown Skill"),icon:void 0};const S=(g==null?void 0:g.skillMap)||{},B=(g==null?void 0:g.buffMap)||{},H=(S==null?void 0:S[`s${N}`])||(S==null?void 0:S[`${N}`]);if(H!=null&&H.name)return{name:String(H.name),icon:H==null?void 0:H.icon};const c=(B==null?void 0:B[`b${N}`])||(B==null?void 0:B[`${N}`]);return c!=null&&c.name?{name:String(c.name),icon:c==null?void 0:c.icon}:{name:`Skill ${N}`,icon:void 0}},f=(d,g)=>{let N=0,S="";const B=H=>{if(!H||typeof H!="object"||H.indirectDamage)return;const c=[Number(H.max),Number(H.maxDamage),Number(H.maxHit)].filter(b=>Number.isFinite(b)),O=c.length>0?Math.max(...c):0;O>N&&(N=O,S=M(H.id,g).name)};return Array.isArray(d==null?void 0:d.totalDamageDist)&&d.totalDamageDist.forEach(H=>{Array.isArray(H)&&H.forEach(c=>B(c))}),Array.isArray(d==null?void 0:d.targetDamageDist)&&d.targetDamageDist.forEach(H=>{Array.isArray(H)&&H.forEach(c=>{Array.isArray(c)&&c.forEach(O=>B(O))})}),{peak:N,skillName:S||"Unknown Skill"}},W=d=>{if(!Array.isArray(d)||d.length===0)return[];const g=[];for(let N=0;N<d.length;N+=1){const S=Number(d[N]||0),B=N>0?Number(d[N-1]||0):0;g.push(Math.max(0,S-B))}return g},U=d=>{if(!Array.isArray(d)||d.length===0)return[];const g=d.reduce((S,B)=>Math.max(S,Array.isArray(B)?B.length:0),0);if(g<=0)return[];const N=new Array(g).fill(0);return d.forEach(S=>{if(Array.isArray(S))for(let B=0;B<g;B+=1)N[B]+=Number(S[B]||0)}),N},K=d=>{if(!Array.isArray(d)||d.length===0)return[];const g=d[0];if(typeof g=="number")return d.map(N=>Number(N||0));if(Array.isArray(g)&&g.length>0){if(typeof g[0]=="number")return g.map(N=>Number(N||0));if(Array.isArray(g[0])){const N=g.map(S=>Array.isArray(S)?S.map(B=>Number(B||0)):null).filter(S=>Array.isArray(S)&&S.length>0);if(N.length>0)return U(N)}}return[]},ee=d=>{const g=K(d==null?void 0:d.powerDamage1S),N=K(d==null?void 0:d.damage1S),S=g.length>0?g:N;return W(S)},se=(d,g)=>{const N=d==null?void 0:d.targetPowerDamage1S;if(!Array.isArray(N)||!Array.isArray(N[g]))return[];const S=N[g];if(!Array.isArray(S)||S.length===0)return[];if(typeof S[0]=="number")return S.map(B=>Number(B||0));if(Array.isArray(S[0])&&!Array.isArray(S[0][0]))return S[0].map(B=>Number(B||0));if(Array.isArray(S[0])&&Array.isArray(S[0][0])){const H=S[0].map(c=>Array.isArray(c)?c.map(O=>Number(O||0)):null).filter(c=>Array.isArray(c)&&c.length>0);return U(H)}return[]},ue=(d,g)=>{if(!Array.isArray(d)||d.length===0||g<=0)return 0;let N=0,S=0;for(let B=0;B<d.length;B+=1)N+=Number(d[B]||0),B>=g&&(N-=Number(d[B-g]||0)),B>=g-1&&N>S&&(S=N);return Math.max(0,S)},E=(d,g)=>{if(!Array.isArray(d)||d.length===0||g<=0)return[];const N=[];for(let S=0;S<d.length;S+=g){const B=Math.min(S+g,d.length),H=d.slice(S,B).reduce((c,O)=>c+Number(O||0),0);N.push(H)}return N},w=d=>Array.isArray(d)?d.map(g=>Array.isArray(g)?[Number(g[0]),Number(g[1])]:g&&typeof g=="object"?[Number(g.time),Number(g.value)]:null).filter(g=>!!g&&Number.isFinite(g[0])&&g[0]>=0):[],V=(d,g,N,S,B)=>{if(!d.length||S<=0)return[];const H=Math.max(S*5e3,B||0),c=r=>r.reduce((te,u)=>u>=0&&u<=H+2e3?te+1:te,0),O=d.map(r=>Number(r||0)).filter(r=>Number.isFinite(r)&&r>=0);if(!O.length)return[];const b=[O],n=O.reduce((r,te)=>Math.max(r,te),0),C=O.reduce((r,te)=>Math.min(r,te),Number.POSITIVE_INFINITY);n>H*20&&b.push(O.map(r=>r/1e3)),n<=H*2&&C>=0&&n>0&&n<Math.max(120,S*5+10)&&b.push(O.map(r=>r*1e3));let x=O,X=0,_=-1;return b.forEach(r=>{const te=r.reduce((k,I)=>Math.min(k,I),Number.POSITIVE_INFINITY),u=new Set([0,...g,...N]);if(Number.isFinite(te)&&H>0&&te>H){const k=Math.floor(te/H)*H;u.add(k),u.add(Math.max(0,k-H))}u.forEach(k=>{const I=r.map(j=>j-k),z=c(I);z>_&&(_=z,X=k,x=r)})}),x.map(r=>r-X).filter(r=>Number.isFinite(r)&&r>=0)},Z=(d,g,N,S,B)=>{const H=V(d,g,N,S,B);return Array.from(new Set(H.map(c=>Math.floor(c/5e3)).filter(c=>Number.isFinite(c)&&c>=0&&c<S)))};G.map(d=>({log:d,ts:Ge(d==null?void 0:d.details,d)})).sort((d,g)=>d.ts-g.ts).forEach(({log:d},g)=>{const N=d==null?void 0:d.details;if(!N)return;const S=e(N.fightName||d.fightName||`Fight ${g+1}`),B=mt(N,d),H=s(S,String(B||"")),c={},b=(Array.isArray(N.players)?N.players:[]).filter(D=>!(D!=null&&D.notInSquad)),n=b.flatMap(D=>{const q=D==null?void 0:D.combatReplayData;return Array.isArray(q)?q.map($=>Number($==null?void 0:$.start)):[Number(q==null?void 0:q.start)]}).filter(D=>Number.isFinite(D)&&D>=0),C=b.flatMap(D=>{const q=D==null?void 0:D.combatReplayData;return(Array.isArray(q)?q:q?[q]:[]).flatMap(y=>w(y==null?void 0:y.down).map(([de])=>Number(de||0)))}),x=b.flatMap(D=>{const q=D==null?void 0:D.combatReplayData;return(Array.isArray(q)?q:q?[q]:[]).flatMap(y=>w(y==null?void 0:y.dead).map(([de])=>Number(de||0)))}),X=new Map,_=new Map,r=new Map;(Array.isArray(N.targets)?N.targets:[]).forEach((D,q)=>{if(!D||D.isFake||!D.enemyPlayer)return;const $=et((D==null?void 0:D.profession)||(D==null?void 0:D.name)||(D==null?void 0:D.id))||"Unknown";r.set($,(r.get($)||0)+1);const y=_.get($)||new Map;Array.isArray(D==null?void 0:D.totalDamageDist)&&D.totalDamageDist.forEach(Fe=>{Array.isArray(Fe)&&Fe.forEach(Ye=>{if(!Ye||typeof Ye!="object"||Ye.indirectDamage)return;const Ce=Number(Ye.totalDamage||0);if(!Number.isFinite(Ce)||Ce<=0)return;const J=Number(Ye.connectedHits||Ye.hits||0),ne=M(Ye.id,N),Ae=ne.name,ve=y.get(Ae)||{skillName:Ae,damage:0,hits:0,icon:ne.icon};ve.damage+=Ce,ve.hits+=Number.isFinite(J)?J:0,!ve.icon&&ne.icon&&(ve.icon=ne.icon),y.set(Ae,ve)})}),_.set($,y);const de=U(b.map(Fe=>se(Fe,q))),Be=de.length>0?W(de):ee(D),xe=f(D,N);let Te=X.get($);Te||(Te={perSecond:[],hit:0,skillName:""},X.set($,Te)),Be.length>Te.perSecond.length&&(Te.perSecond.length=Be.length);for(let Fe=0;Fe<Be.length;Fe+=1)Te.perSecond[Fe]=Number(Te.perSecond[Fe]||0)+Number(Be[Fe]||0);const Ve=Number(xe.peak||0);Ve>Te.hit&&(Te.hit=Ve,Te.skillName=xe.skillName||"Unknown Skill")});const u=Array.from(X.values()).some(D=>Array.isArray(D.perSecond)&&D.perSecond.some(q=>Number(q||0)>0));if(X.size===0||!u){const D=U(b.map($=>{const y=K($==null?void 0:$.powerDamageTaken1S);return W(y)})),q=Array.from(r.values()).reduce(($,y)=>$+Number(y||0),0);D.length>0&&q>0&&r.forEach(($,y)=>{const de=Number($||0)/q,Be=D.map(Te=>Number(Te||0)*de),xe=X.get(y);X.set(y,{perSecond:Be,hit:Number((xe==null?void 0:xe.hit)||0),skillName:String((xe==null?void 0:xe.skillName)||"")})})}X.forEach((D,q)=>{var ne;const $=q,y=Number(D.hit||0),de=Number(ue(D.perSecond,1)||0),Be=Number(ue(D.perSecond,5)||0),xe=Number(ue(D.perSecond,30)||0),Te=Math.max(0,Math.ceil(Number((N==null?void 0:N.durationMS)||0)/5e3)),Ve=Math.max(0,Math.ceil(D.perSecond.length/5)),Fe=Math.max(Te,Ve),Ye=E(D.perSecond,5),Ce=Array.from({length:Fe},(Ae,ve)=>Number(Ye[ve]||0));c[$]={hit:y,burst1s:de,burst5s:Be,burst30s:xe,skillName:D.skillName||"Unknown Skill",buckets5s:Ce,downIndices5s:Z(C,[],n,Fe,Number((N==null?void 0:N.durationMS)||0)),deathIndices5s:Z(x,[],n,Fe,Number((N==null?void 0:N.durationMS)||0)),skillRows:Array.from(((ne=_.get(q))==null?void 0:ne.values())||[]).sort((Ae,ve)=>ve.damage-Ae.damage).slice(0,50)};const J=o.get($)||{key:$,account:q,displayName:q,characterName:"",profession:q,professionList:[q],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};J.logs+=1,y>J.peakHit&&(J.peakHit=y,J.peakFightLabel=H,J.peakSkillName=D.skillName||"Unknown Skill"),de>J.peak1s&&(J.peak1s=de),Be>J.peak5s&&(J.peak5s=Be),xe>J.peak30s&&(J.peak30s=xe),o.set($,J)});const k=Object.values(c).reduce((D,q)=>Math.max(D,Number((q==null?void 0:q.hit)||0)),0),I=Object.values(c).reduce((D,q)=>Math.max(D,Number((q==null?void 0:q.burst1s)||0)),0),z=Object.values(c).reduce((D,q)=>Math.max(D,Number((q==null?void 0:q.burst5s)||0)),0),j=Object.values(c).reduce((D,q)=>Math.max(D,Number((q==null?void 0:q.burst30s)||0)),0);p.push({id:d.filePath||d.id||`fight-${g+1}`,shortLabel:`F${g+1}`,fullLabel:H,timestamp:Ge(N,d),values:c,maxHit:k,max1s:I,max5s:z,max30s:j})});const ce=Array.from(o.values()).sort((d,g)=>g.peakHit!==d.peakHit?g.peakHit-d.peakHit:d.displayName.localeCompare(g.displayName));return{fights:p,players:ce}})(),es=Array.from(_e.entries()).map(([e,t])=>{const s=He.get(e)||{},p=Array.from(t.values()).map(o=>{var ue,E;const M=Array.from(o.professions||[]).filter(w=>w&&w!=="Unknown");let f=o.profession||"Unknown";if(M.length>0){f=M[0];let w=((ue=o.professionTimeMs)==null?void 0:ue[f])||0;M.forEach(V=>{var ce;const Z=((ce=o.professionTimeMs)==null?void 0:ce[V])||0;Z>w&&(w=Z,f=V)})}const W=o.durationMs||0,U=o.totalMs/1e3,K=W>0?o.totalMs/W:0,ee=((E=me.get(o.account))==null?void 0:E.supportActiveMs)||W,se=ee>0?o.uptimeMs/ee:0;return{account:o.account,profession:f,professionList:M,total:U,perSecond:K,uptimePerSecond:se,duration:W/1e3}}).filter(o=>o.total>0||o.perSecond>0);return{id:e,name:s.name||e,icon:s.icon,rows:p}}).filter(e=>e.rows.length>0),ts=Array.from($e.values()).map(e=>{const t=Array.from(e.skills.values()).sort((p,o)=>o.damage-p.damage);return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:ie,wins:Me,losses:Le,avgSquadSize:Ti,avgEnemies:wi,squadKDR:Fi,enemyKDR:vi,totalSquadKills:l,totalSquadDeaths:Je,totalEnemyKills:le,totalEnemyDeaths:re,leaderboards:qe,...Pi,outgoingConditionSummary:Object.values(je).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values(Ke).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(me.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(me.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:qi,topIncomingSkills:xi,topSkillsByDamage:Tn,topSkillsByDownContribution:wn,playerSkillBreakdowns:ts,topSkillsMetric:fe,mapData:ji,timelineData:_i,boonTables:Wi,offensePlayers:Array.from(me.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(me.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs,minionDamageTakenByMinion:e.defenseMinionDamageTaken})),damageMitigationPlayers:Ei,damageMitigationMinions:Bi,supportPlayers:Array.from(me.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(me.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:Ht,silver:An,bronze:Nn,squadClassData:zi,enemyClassData:Vi,fightBreakdown:Gi,fightDiffMode:Ji,attendanceData:Yi,squadCompByFight:Qi,spikeDamage:Zi,incomingStrikeDamage:yi,specialTables:es,topStatsPerSecond:at,topStatsLeaderboardsPerSecond:st,avgMvpScore:Mn}})(),Ue=(()=>{const R=new Map,Y=new Map,fe=[],ie=new Map,Me=new Map;G.forEach(ae=>{const he=ae.details;if(!he)return;const Je=he.skillMap||{},l=he.fightName||"Log",re=Ge(he,ae)||Date.now(),le={id:ae.filePath||ae.id||l,label:l,timestamp:re,skillEntries:{},playerActiveSeconds:{},durationSeconds:he.durationMS?he.durationMS/1e3:0};(he.players||[]).forEach(De=>{if(De.notInSquad)return;const me=De.account||De.name||"Unknown",Re=De.profession||"Unknown",ge=`${me}|${Re}`;let Se=Y.get(ge);Se||(Se={key:ge,account:me,displayName:me,profession:Re,professionList:[Re],logs:0,totalActiveSeconds:0,skillTotals:{}},Y.set(ge,Se)),Se.logs++;const $e=(Array.isArray(De.activeTimes)?De.activeTimes[0]:0)/1e3;Se.totalActiveSeconds=(Se.totalActiveSeconds||0)+$e,le.playerActiveSeconds[ge]=$e,(De.rotation||[]).forEach(je=>{var Ft,vt,Et;if(!(je!=null&&je.id))return;const Ke=((Ft=je.skills)==null?void 0:Ft.length)||0;if(Ke<=0)return;const Pe=`s${je.id}`,He=((vt=Je[Pe])==null?void 0:vt.name)||`Skill ${je.id}`,_e=(Et=Je[Pe])==null?void 0:Et.icon;Se.skillTotals[Pe]=(Se.skillTotals[Pe]||0)+Ke,R.set(Pe,(R.get(Pe)||0)+Ke),ie.set(Pe,He),_e&&!Me.has(Pe)&&Me.set(Pe,_e),le.skillEntries[Pe]||(le.skillEntries[Pe]={name:He,icon:_e,players:{}}),!le.skillEntries[Pe].icon&&_e&&(le.skillEntries[Pe].icon=_e),le.skillEntries[Pe].players[ge]=(le.skillEntries[Pe].players[ge]||0)+Ke})}),fe.push(le)});const Le=Array.from(R.entries()).map(([ae,he])=>({id:ae,name:ie.get(ae)||ae,total:he,icon:Me.get(ae)})).sort((ae,he)=>he.total-ae.total);return{logRecords:fe,players:Array.from(Y.values()),skillOptions:Le,resUtilitySkills:[]}})();return{validLogs:G,stats:Oe,skillUsageData:Ue}},gt=(i,a)=>{const m={};return a.forEach(F=>{i&&Object.prototype.hasOwnProperty.call(i,F)&&(m[F]=i[F])}),m},rn=i=>!!(i&&i.__statsPruned===!0),cn=(i,a)=>{if(!i||typeof i!="object")return i;const m={};return Object.entries(i).forEach(([F,L])=>{if(!L||typeof L!="object")return;const A={};typeof L.name=="string"&&(A.name=L.name),typeof L.icon=="string"&&(A.icon=L.icon),a!=null&&a.includeClassification&&typeof L.classification=="string"&&(A.classification=L.classification),a!=null&&a.includeStacking&&(typeof L.stacking=="boolean"?A.stacking=L.stacking:typeof L.stacking=="number"&&(A.stacking=!!L.stacking)),Object.keys(A).length>0&&(m[F]=A)}),m},un=i=>{var m;const a=(m=i==null?void 0:i.statsAll)==null?void 0:m[0];return!a||typeof a!="object"?!1:a.distToCom!==void 0&&a.distToCom!=="Infinity"||a.stackDist!==void 0},hi=(i,a)=>{const m=F=>{if(!F||typeof F!="object")return null;const L=gt(F,["start","down","dead"]);return a&&Array.isArray(F.positions)&&(L.positions=F.positions),L};return Array.isArray(i)?i.map(F=>m(F)).filter(F=>!!F):i&&typeof i=="object"?m(i):i},mn=i=>{if(!i||typeof i!="object")return i;const a=gt(i,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","zone","mapName","map","location","permalink","uploadLinks","success","teamBreakdown","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);if(a.skillMap=cn(a.skillMap,{includeClassification:!1,includeStacking:!1}),a.buffMap=cn(a.buffMap,{includeClassification:!0,includeStacking:!0}),Array.isArray(a.players)){const m=i.players,L=m.filter(A=>!(A!=null&&A.notInSquad)).some(A=>!(A!=null&&A.hasCommanderTag)&&!un(A));a.players=m.map(A=>{const pe=gt(A,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","powerDamageTaken1S","targetPowerDamage1S","totalDamageTaken","totalDamageTakenDist","hasCommanderTag","notInSquad","account","activeTimes","teamID","teamId","team","teamColor","team_color"]),G=Array.isArray(A==null?void 0:A.minions)?A.minions:[];pe.minions=G.map(be=>gt(be,["name","totalDamageTakenDist"]));const oe=L&&((A==null?void 0:A.hasCommanderTag)&&!(A!=null&&A.notInSquad)||!(A!=null&&A.notInSquad)&&!un(A));return pe.combatReplayData=hi(A==null?void 0:A.combatReplayData,oe),pe})}return Array.isArray(a.targets)&&(a.targets=a.targets.map(m=>gt(m,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist","totalDamageTaken","totalDamageTakenDist","damageTaken","powerDamage1S","damage1S","profession","teamID","teamId","team","teamColor","team_color"]))),a},ki=i=>{if(!i||typeof i!="object"||rn(i))return i;const a={...i};return i.details?a.details=mn(i.details):a.details=mn(i),a.__statsPruned=!0,a};let Xe=null,ln=0,xt=0,Tt=null,wt=0,Rt=0;const Di=i=>typeof(i==null?void 0:i.token)=="number"&&i.token!==xt,Si=i=>{const a=i==null?void 0:i.stats;if(!a||typeof a!="object")return{spikeSkillRowsRemoved:0,incomingSkillRowsRemoved:0,playerSkillMapsRemoved:0};const m=G=>{let oe=0;return(Array.isArray(G==null?void 0:G.fights)?G.fights:[]).forEach(We=>{if(!We||typeof We!="object")return;const Oe=We.values;!Oe||typeof Oe!="object"||Object.values(Oe).forEach(Ue=>{!Ue||typeof Ue!="object"||Array.isArray(Ue.skillRows)&&(delete Ue.skillRows,oe+=1)})}),oe},F=m(a.spikeDamage),L=m(a.incomingStrikeDamage);let A=0;return(Array.isArray(a.playerSkillBreakdowns)?a.playerSkillBreakdowns:[]).forEach(G=>{!G||typeof G!="object"||G.skillMap&&typeof G.skillMap=="object"&&(delete G.skillMap,A+=1)}),{spikeSkillRowsRemoved:F,incomingSkillRowsRemoved:L,playerSkillMapsRemoved:A}},Ci=()=>{var pe,G;if(!Xe)return;ln+=1;const i=Tt;Tt=null;const a=performance.now(),m=bi({...Xe,includePlayerSkillMap:!1}),F=Si(m),L=Math.max(0,performance.now()-a),A=m==null?void 0:m.stats;self.postMessage({type:"result",result:m,computeId:ln,logCount:Xe.logs.length,token:xt,completedAt:Date.now(),flushId:i,diagnostics:{computeMs:L,logsInPayload:Xe.logs.length,expectedLogCount:wt,droppedLogMessages:Rt,transferStripStats:F,counts:{playerSkillBreakdowns:Array.isArray(A==null?void 0:A.playerSkillBreakdowns)?A.playerSkillBreakdowns.length:0,spikeFights:Array.isArray((pe=A==null?void 0:A.spikeDamage)==null?void 0:pe.fights)?A.spikeDamage.fights.length:0,incomingStrikeFights:Array.isArray((G=A==null?void 0:A.incomingStrikeDamage)==null?void 0:G.fights)?A.incomingStrikeDamage.fights.length:0}}})};self.onmessage=i=>{var m,F,L,A;const a=i.data;if((a==null?void 0:a.type)==="reset"){Xe={logs:[]},typeof a.token=="number"&&(xt=a.token),wt=Math.max(0,Number(a.totalLogs||0)),Rt=0,Tt=null;return}if(!Di(a)){if((a==null?void 0:a.type)==="settings"){Xe={logs:(Xe==null?void 0:Xe.logs)||[],precomputedStats:(m=a.payload)==null?void 0:m.precomputedStats,mvpWeights:(F=a.payload)==null?void 0:F.mvpWeights,statsViewSettings:(L=a.payload)==null?void 0:L.statsViewSettings,disruptionMethod:(A=a.payload)==null?void 0:A.disruptionMethod};return}if((a==null?void 0:a.type)==="log"){if(Xe||(Xe={logs:[]}),wt>0&&Xe.logs.length>=wt){Rt+=1;return}Xe.logs.push(rn(a.payload)?a.payload:ki(a.payload));return}(a==null?void 0:a.type)==="flush"&&(typeof a.flushId=="number"&&(Tt=a.flushId),Ci())}}})();
