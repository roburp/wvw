(function(){"use strict";const Gt=["selfBuffs","groupBuffs","squadBuffs"],Jt=o=>o!=null&&o.classification?o.classification==="Boon":!0,Yt=o=>`b${o}`,In=(o,s)=>{const c=Array.isArray(o==null?void 0:o.activeTimes)?o.activeTimes:[],k=typeof c[0]=="number"?c[0]:0;return k>0?k:s},Qt=(o,s,c,k,w,B,oe)=>{const O=o==="selfBuffs"?1:Math.max(o==="groupBuffs"?B-1:oe-1,0);return!O||!w?{generationMs:0,wastedMs:0}:s?{generationMs:c*w*O,wastedMs:k*w*O}:{generationMs:c/100*w*O,wastedMs:k/100*w*O}},Pn=o=>{const s=new Map,c=new Map;return o.forEach(B=>{const oe=B.details;if(!oe)return;const O=oe.durationMS||0,ie=oe.buffMap||{};Object.entries(ie).forEach(([N,I])=>{if(!s.has(N)){s.set(N,I);return}const se=s.get(N)||{},A={name:se.name||I.name,stacking:se.stacking??I.stacking,icon:se.icon||I.icon,classification:se.classification||I.classification};s.set(N,A)});const qe=(oe.players||[]).filter(N=>!N.notInSquad),ge=qe.length,ce=new Map;qe.forEach(N=>{const I=N.group??0;ce.set(I,(ce.get(I)||0)+1)}),qe.forEach(N=>{const I=N.account||N.name||N.character_name||"Unknown",se=N.profession||"Unknown",A=N.group??0,Y=ce.get(A)||1,Q=In(N,O);c.has(I)||c.set(I,{account:I,profession:se,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const X=c.get(I);X.profession=se,se!=="Unknown"&&(X.professions.add(se),X.professionTimeMs[se]=(X.professionTimeMs[se]||0)+Q),X.activeTimeMs+=Q,X.numFights+=1,X.groupSupported+=Y,X.squadSupported+=ge,Gt.forEach(pe=>{(N[pe]||[]).forEach(te=>{var Ee,He,we,Xe;if(typeof(te==null?void 0:te.id)!="number")return;const Pe=Yt(te.id),ve=ie[Pe];if(!Jt(ve))return;const Ce=(ve==null?void 0:ve.stacking)??!1,_e=((He=(Ee=te.buffData)==null?void 0:Ee[0])==null?void 0:He.generation)??0,be=((Xe=(we=te.buffData)==null?void 0:we[0])==null?void 0:Xe.wasted)??0,{generationMs:ke,wastedMs:Re}=Qt(pe,Ce,_e,be,O,Y,ge);!ke&&!Re||(s.has(Pe)||s.set(Pe,ve||{}),X.boons[Pe]||(X.boons[Pe]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),X.boons[Pe][pe].generationMs+=ke,X.boons[Pe][pe].wastedMs+=Re)})})})}),{boonTables:Array.from(s.keys()).filter(B=>Jt(s.get(B))).map(B=>{const oe=s.get(B)||{},O=[];return c.forEach(ie=>{var N;const Le=ie.boons[B];if(!Le||!Gt.some(I=>Le[I].generationMs>0||Le[I].wastedMs>0))return;const ge=Array.from(ie.professions||[]).filter(I=>I&&I!=="Unknown");let ce=ie.profession;if(ge.length>0){ce=ge[0];let I=((N=ie.professionTimeMs)==null?void 0:N[ce])||0;ge.forEach(se=>{var Y;const A=((Y=ie.professionTimeMs)==null?void 0:Y[se])||0;A>I&&(I=A,ce=se)})}O.push({account:ie.account,profession:ce||"Unknown",professionList:ge,activeTimeMs:ie.activeTimeMs||1,numFights:ie.numFights||1,groupSupported:ie.groupSupported||1,squadSupported:ie.squadSupported||1,categories:{selfBuffs:{...Le.selfBuffs},groupBuffs:{...Le.groupBuffs},squadBuffs:{...Le.squadBuffs}}})}),{id:B,name:oe.name||B,icon:oe.icon,stacking:oe.stacking??!1,rows:O}}).filter(B=>B.rows.length>0)}},Xt=(o,s,c,k,w,B,oe={})=>{var N,I,se,A;const ie=((o==null?void 0:o[s])||[]).find(Y=>Y.id===c);if(!ie)return{generationMs:0,wastedMs:0};const Le=oe[Yt(c)],qe=(Le==null?void 0:Le.stacking)??!1,ge=((I=(N=ie.buffData)==null?void 0:N[0])==null?void 0:I.generation)??0,ce=((A=(se=ie.buffData)==null?void 0:se[0])==null?void 0:A.wasted)??0;return Qt(s,qe,ge,ce,k,w,B)};var Un={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const Hn=Un,Lt="count",Ln=o=>(o||0)/1e3,$n=(o,s)=>{var w;if(!o)return 0;const c=(w=Hn.methods.tiered)==null?void 0:w.tiers;if(!c)return o;const k=s/Math.max(o,1);return k<=c.shortMs?o*c.weights.short:k<=c.mediumMs?o*c.weights.medium:o*c.weights.long},Zt=(o,s,c)=>c==="duration"?Ln(s):c==="tiered"?$n(o,s):o;function On(o,s=Lt){var B;const c=(B=o.statsAll)==null?void 0:B[0],k=Number((c==null?void 0:c.appliedCrowdControl)??0),w=Number((c==null?void 0:c.appliedCrowdControlDuration)??0);return Zt(k,w,s)}function _n(o,s){const c=(s==null?void 0:s.durationMS)||0,k=(s==null?void 0:s.buffMap)||{},w=o.filter(O=>!O.notInSquad),B=w.length,oe=new Map;w.forEach(O=>{const ie=O.group??0;oe.set(ie,(oe.get(ie)||0)+1)}),w.forEach(O=>{const ie=oe.get(O.group??0)||1,Le=Xt(O,"selfBuffs",1122,c,ie,B,k),qe=Xt(O,"squadBuffs",1122,c,ie,B,k);O.stabGeneration=(Le.generationMs+qe.generationMs)/1e3})}function Rn(o){if(!o.statsTargets)return 0;let s=0;for(const c of o.statsTargets)c&&c.length>0&&(s+=c[0].downContribution||0);return s}function xn(o){if(!o.extBarrierStats||!o.extBarrierStats.outgoingBarrierAllies)return 0;let s=0;for(const c of o.extBarrierStats.outgoingBarrierAllies)if(c)for(const k of c)k&&(s+=k.barrier||0);return s}function qn(o){if(!o.extHealingStats||!o.extHealingStats.outgoingHealingAllies)return 0;let s=0;for(const c of o.extHealingStats.outgoingHealingAllies)if(c)for(const k of c)k&&(s+=k.healing||0);return s}const jn=o=>{var s,c,k,w;return(((c=(s=o.support)==null?void 0:s[0])==null?void 0:c.condiCleanse)||0)+(((w=(k=o.support)==null?void 0:k[0])==null?void 0:w.condiCleanseSelf)||0)},Wn=(o,s=Lt)=>{var B;const c=(B=o.support)==null?void 0:B[0],k=Number((c==null?void 0:c.boonStrips)??0),w=Number((c==null?void 0:c.boonStripsTime)??0);return Zt(k,w,s)},Vn=o=>Rn(o),zn=o=>qn(o),Kn=o=>xn(o),Gn=(o,s=Lt)=>On(o,s),Jn=(o,s)=>_n(o,s),Yn="count",Qn={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},Xn={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},yt=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),Zn={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},gt=o=>{if(!o)return null;const s=o.trim().toLowerCase(),c=yt.get(s);if(c)return c;const k=s.split(/[^a-z]+/).filter(Boolean);for(const w of k){const B=yt.get(w);if(B)return B}return null},yn=o=>gt(o),en=o=>{const s=new Map;return o&&(Object.values(o).forEach(c=>{if(!(c!=null&&c.icon)||!(c!=null&&c.name))return;const k=gt(c.name);k&&(s.has(k)||s.set(k,c.icon))}),Object.entries(Zn).forEach(([c,k])=>{s.has(c)||s.set(c,k)})),s},At=(o,s,c)=>{var k;if(s&&c){const w=(k=c[`b${s}`])==null?void 0:k.name,B=gt(w);if(B)return B}return o?gt(o):null},eo=o=>{const s=(o==null?void 0:o.account)||"Unknown";return s&&s!=="Unknown"?s:(o==null?void 0:o.name)||"Unknown"||null},to=o=>{if(!o||o.length===0)return 0;let s=0,c=null;return o.forEach(k=>{const w=Number(k[1]??0);if(Number.isFinite(w)){if(c===null){c=w;return}w>c&&(s+=w-c),c=w}}),s},no=o=>{if(!o||o.length===0)return 0;let s=0;return o.forEach(c=>{const k=Number(c[0]??0),w=Number(c[1]??0);Number.isFinite(w)&&k!==0&&w>0&&(s+=1)}),s},oo=o=>{const{players:s,targets:c,skillMap:k,buffMap:w}=o,B=o.getPlayerKey||eo,oe=en(w),O={},ie={};s.forEach(N=>{if(N!=null&&N.notInSquad)return;const I=B(N);I&&(O[I]||(O[I]={}),N!=null&&N.totalDamageDist&&N.totalDamageDist.forEach(se=>{se&&se.forEach(A=>{if(!A.id)return;let Y=`Skill ${A.id}`,Q;k&&(k[`s${A.id}`]?(Y=k[`s${A.id}`].name||Y,Q=k[`s${A.id}`].icon||Q):k[`${A.id}`]&&(Y=k[`${A.id}`].name||Y,Q=k[`${A.id}`].icon||Q));const X=At(Y,A.id,w);if(!X)return;const pe=w==null?void 0:w[`b${A.id}`],Oe=pe==null?void 0:pe.name,te=oe.get(X)||(pe==null?void 0:pe.icon),Pe=Y.startsWith("Skill ")?Oe||X:Y,ve=Q||(pe==null?void 0:pe.icon),Ce=Number(A.connectedHits??0),_e=Number(A.hits??0),be=Ce>0?Ce:_e,ke=Number(A.totalDamage??0);if(!Number.isFinite(be)&&!Number.isFinite(ke))return;const Re=ie[X]||{name:X,icon:te,applications:0,damage:0};Re.applications+=Number.isFinite(be)?be:0,Re.damage+=Number.isFinite(ke)?ke:0,!Re.icon&&te&&(Re.icon=te),ie[X]=Re;const Ee=O[I][X]||{icon:te,applications:0,damage:0,skills:{}};Ee.applications+=Number.isFinite(be)?be:0,Ee.damage+=Number.isFinite(ke)?ke:0;const He=Ee.skills[Pe]||{name:Pe,hits:0,damage:0,icon:ve};He.hits+=Number.isFinite(be)?be:0,He.damage+=Number.isFinite(ke)?ke:0,!He.icon&&ve&&(He.icon=ve),Ee.skills[Pe]=He,!Ee.icon&&te&&(Ee.icon=te),O[I][X]=Ee})}))});const Le=new Map;s.forEach(N=>{if(N!=null&&N.notInSquad)return;const I=B(N);I&&N!=null&&N.name&&Le.set(N.name,I)});let qe=0,ge=0,ce=0;return c.forEach(N=>{N!=null&&N.buffs&&N.buffs.forEach(I=>{const se=Number(I==null?void 0:I.id);if(!Number.isFinite(se))return;const A=w==null?void 0:w[`b${se}`],Y=gt(A==null?void 0:A.name);if(!Y||A!=null&&A.classification&&A.classification!=="Condition")return;const Q=Y;if(!Q)return;const X=I.statesPerSource||{};ce+=1,Object.entries(X).forEach(([pe,Oe])=>{var be;const te=Le.get(pe);if(!te)return;ge+=1;const Pe=to(Oe),ve=no(Oe);qe+=Pe;const Ce=((be=O[te])==null?void 0:be[Q])||{applications:0,damage:0,skills:{}};Ce.applicationsFromBuffs=(Ce.applicationsFromBuffs||0)+Pe,Ce.applicationsFromBuffsActive=(Ce.applicationsFromBuffsActive||0)+ve,O[te]=O[te]||{},O[te][Q]=Ce;const _e=ie[Q]||{name:Q,applications:0,damage:0};_e.applicationsFromBuffs=(_e.applicationsFromBuffs||0)+Pe,_e.applicationsFromBuffsActive=(_e.applicationsFromBuffsActive||0)+ve,ie[Q]=_e})})}),Object.values(O).forEach(N=>{Object.values(N).forEach(I=>{typeof I.applicationsFromBuffs=="number"&&(I.applications=I.applicationsFromBuffs)})}),Object.values(ie).forEach(N=>{typeof N.applicationsFromBuffs=="number"&&(N.applications=N.applicationsFromBuffs)}),{playerConditions:O,summary:ie,meta:{buffStateApplicationsTotal:qe,targetBuffEntriesSeen:ce,buffStateSourcesSeen:ge}}},io=new Set(["Vulnerability","Weakness","Blind","Cripple","Chill","Immobilize","Slow","Fear","Taunt"]),so=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],ao=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],ro=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],co=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],lo=new Set([10244]),uo=(o,s)=>{var w;if(lo.has(o))return!0;const c=(s==null?void 0:s[`s${o}`])||(s==null?void 0:s[`${o}`]),k=((w=c==null?void 0:c.name)==null?void 0:w.toLowerCase())||"";return co.some(B=>k.includes(B))},mo=o=>{if(!o||!Number.isFinite(o))return"--:--";const s=Math.max(0,Math.round(o/1e3)),c=Math.floor(s/3600),k=Math.floor(s%3600/60),w=s%60;return c>0?`${c}:${String(k).padStart(2,"0")}:${String(w).padStart(2,"0")}`:`${k}:${String(w).padStart(2,"0")}`},Mt={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function tn(o){return Mt[o]||Mt.Unknown}const fo=o=>{if(o==null||o==="")return 0;if(typeof o=="number")return!Number.isFinite(o)||o<=0?0:o>1e12?o:o*1e3;if(o instanceof Date){const oe=o.getTime();return Number.isFinite(oe)&&oe>0?oe:0}const s=String(o).trim();if(!s)return 0;const c=Number(s);if(Number.isFinite(c)&&c>0)return c>1e12?c:c*1e3;const k=Date.parse(s);if(Number.isFinite(k)&&k>0)return k;const w=s.replace(/([+-]\d{2})$/,"$1:00"),B=Date.parse(w);return Number.isFinite(B)&&B>0?B:0},nt=(o,s)=>fo((o==null?void 0:o.uploadTime)??(s==null?void 0:s.uploadTime)??(o==null?void 0:o.timeStartStd)??(o==null?void 0:o.timeStart)??(o==null?void 0:o.timeEndStd)??(o==null?void 0:o.timeEnd)??(o==null?void 0:o.timeStartText)??(o==null?void 0:o.timeEndText)),go=({logs:o,precomputedStats:s,mvpWeights:c,statsViewSettings:k,disruptionMethod:w})=>{const B=(()=>{const ge=o.filter(ce=>ce.details&&ce.details.players&&ce.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:o.length,passed:ge.length,statuses:o.map(ce=>ce.status),hasDetails:o.map(ce=>!!ce.details)}),ge})(),oe=k||Xn,O=c||Qn,ie=ge=>{if(!ge||typeof ge!="object")return ge;const ce=Array.isArray(ge.fightBreakdown)?ge.fightBreakdown:null;if(!ce||ce.length===0)return ge;const N=new Map,I=new Map;o.forEach(A=>{var X;const Y=(A==null?void 0:A.filePath)||(A==null?void 0:A.id);Y&&N.set(String(Y),A);const Q=(A==null?void 0:A.permalink)||((X=A==null?void 0:A.details)==null?void 0:X.permalink);typeof Q=="string"&&Q.trim()&&I.set(Q.trim(),A)});const se=ce.map(A=>{if(!A||typeof A!="object"||Number(A.timestamp)>0)return A;const Q=A.id?String(A.id):"",X=typeof A.permalink=="string"?A.permalink.trim():"",pe=(Q?N.get(Q):void 0)||(X?I.get(X):void 0);if(!pe)return A;const Oe=nt(pe==null?void 0:pe.details,pe);return Oe?{...A,timestamp:Oe}:A});return{...ge,fightBreakdown:se}},Le=(()=>{if(s)return ie(s);const ge=w||Yn,ce=oe.topSkillDamageSource||"target",N=oe.topSkillsMetric||"damage",I=B.length;let se=0,A=0,Y=0,Q=0,X=0,pe=0,Oe=0,te=0;const Pe=e=>{const n=((e==null?void 0:e.players)||[]).filter(L=>!L.notInSquad);let l=0,a=0,m=0,p=0;return n.forEach(L=>{var Z;const S=(Z=L.defenses)==null?void 0:Z[0];if(!S)return;const j=Number(S.downCount||0),le=Number(S.deadCount||0);l+=j+le,m+=le}),n.forEach(L=>{!L.statsTargets||L.statsTargets.length===0||L.statsTargets.forEach(S=>{const j=S==null?void 0:S[0];if(!j)return;const le=Number(j.downed||0),Z=Number(j.killed||0);a+=le+Z,p+=Z})}),{squadDownsDeaths:l,enemyDownsDeaths:a,squadDeaths:m,enemyDeaths:p}},ve=e=>{const{squadDownsDeaths:t,enemyDownsDeaths:n}=Pe(e);return t>0||n>0?n>t:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},Ce=new Map,_e=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),be={},ke={},Re=new Map,Ee={},He={},we={},Xe=new Map,Ye=new Map,Nt=new Set(Object.keys(Mt)),wt=Object.keys(Mt).filter(e=>e&&e!=="Unknown").sort((e,t)=>t.length-e.length),vt=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],lt=e=>{if(!e)return"Unknown";const t=String(e).replace(/\s*\([^)]*\)\s*$/,"").replace(/\s*\[[^\]]*\]\s*$/,"").replace(/\s\d+$/,"").trim();if(Nt.has(t))return t;const n=t.toLowerCase();for(const a of wt)if(n.includes(a.toLowerCase()))return a;return vt.find(a=>n.includes(a.toLowerCase()))||t||"Unknown"},bo=e=>e!=null&&e.classification?e.classification==="Boon":!0,Et=new Map,Ft=new Map,pt=()=>({totalHits:0,blocked:0,evaded:0,glanced:0,missed:0,invulned:0,interrupted:0,totalMitigation:0,minMitigation:0}),J=e=>{const t=Number(e);return Number.isFinite(t)?t:0},cn=e=>{const t=String(e).split("|"),n=t[0]||"Unknown",l=lt(t[1]||"Unknown"),a=t[2]||n||"Unknown";return{name:n,profession:l,account:a}},ln=(e,t,n)=>{let l=e.get(t);return l?n.profession&&!l.professionList.includes(n.profession)&&l.professionList.push(n.profession):(l={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:pt()},e.set(t,l)),l},un=(e,t,n)=>{let l=e.get(t);return l?n.profession&&!l.professionList.includes(n.profession)&&l.professionList.push(n.profession):(l={account:n.account,name:n.name,profession:n.profession,professionList:n.profession?[n.profession]:[],activeMs:0,mitigationTotals:pt(),minion:n.minion},e.set(t,l)),l},dn=(e,t)=>{e.totalHits+=J((t==null?void 0:t.skill_hits)??(t==null?void 0:t.skillHits)),e.blocked+=J(t==null?void 0:t.blocked),e.evaded+=J(t==null?void 0:t.evaded),e.glanced+=J(t==null?void 0:t.glanced),e.missed+=J(t==null?void 0:t.missed),e.invulned+=J(t==null?void 0:t.invulned),e.interrupted+=J(t==null?void 0:t.interrupted),e.totalMitigation+=J((t==null?void 0:t.avoided_damage)??(t==null?void 0:t.avoidedDamage)),e.minMitigation+=J((t==null?void 0:t.min_avoided_damage)??(t==null?void 0:t.minAvoidedDamage))},ho=e=>Object.values(e).some(t=>t>0);console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:B.length});const Bt=(e,t,n)=>{var m,p,L,S;const l=`s${e}`;if((m=t==null?void 0:t[l])!=null&&m.name)return t[l].name;if((p=t==null?void 0:t[String(e)])!=null&&p.name)return t[String(e)].name;const a=`b${e}`;return(L=n==null?void 0:n[a])!=null&&L.name?n[a].name:(S=n==null?void 0:n[String(e)])!=null&&S.name?n[String(e)].name:`Unknown Skill ${e}`},bt=new Map,it=e=>{const t=bt.get(e);if(!t)return{hasSkill:!1,avg:1,min:1,hits:0};const n=t.connectedHits||0,l=n>0?t.totalDamage/n:0,a=t.minCount>0?t.minTotal/t.minCount:0;return{hasSkill:!0,avg:l,min:a,hits:n}},It="Ashtonlightstone.9145",mn="Illusionary Warden",_t=[],st=[],Rt=[],xt=[],fn=new Map,gn=new Map,pn=(e,t,n)=>{const l=e.get(t)||pt();return l.totalHits+=n.totalHits,l.blocked+=n.blocked,l.evaded+=n.evaded,l.glanced+=n.glanced,l.missed+=n.missed,l.invulned+=n.invulned,l.interrupted+=n.interrupted,e.set(t,l),l};B.forEach(e=>{const t=e.details;if(!t)return;(t.targets||[]).forEach(l=>{const a=(l==null?void 0:l.totalDamageDist)||[],m=Array.isArray(a)?a[0]:null;m==null||m.forEach(p=>{if(!(p!=null&&p.id))return;const L=Number(p.id),S=bt.get(L)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};S.totalDamage+=Number(p.totalDamage||0),S.connectedHits+=Number(p.connectedHits||0);const j=Number.isFinite(Number(p.min))?Number(p.min):0;S.minTotal+=j,S.minCount+=1,bt.set(L,S)})})}),B.forEach((e,t)=>{var ut,dt;const n=e.details;if(!n)return;const l=n.players;console.log(`[useStatsAggregation] Processing log ${t}:`,{playerCount:l==null?void 0:l.length,hasTargets:!!n.targets,firstPlayer:l!=null&&l[0]?{account:l[0].account,notInSquad:l[0].notInSquad}:"none"});const a=n.targets||[],m=n.skillMap||{},p=n.buffMap||{},L=new Map,S=new Map;a.forEach(i=>{const f=(i==null?void 0:i.totalDamageDist)||[],M=Array.isArray(f)?f[0]:null;M==null||M.forEach(R=>{var H;if(!(R!=null&&R.id))return;const U=Number(R.id),h=((H=m==null?void 0:m[U])==null?void 0:H.name)||R.name||R.skillName||String(U),V=L.get(U)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};V.totalDamage+=Number(R.totalDamage||0),V.connectedHits+=Number(R.connectedHits||0);const E=Number.isFinite(Number(R.min))?Number(R.min):0;V.minTotal+=E,V.minCount+=1,L.set(U,V);const x=S.get(h)||{totalDamage:0,connectedHits:0,minTotal:0,minCount:0};x.totalDamage+=Number(R.totalDamage||0),x.connectedHits+=Number(R.connectedHits||0);const me=Number.isFinite(Number(R.min))?Number(R.min):0;x.minTotal+=me,x.minCount+=1,S.set(h,x)})});const j=i=>{const f=L.get(i);if(!f||f.connectedHits<=0)return{avg:1,min:1};const M=f.connectedHits>0?f.totalDamage/f.connectedHits:0,R=f.minCount>0?f.minTotal/f.minCount:M;return{avg:M||1,min:R||1}},le=i=>{const f=S.get(i);if(!f||f.connectedHits<=0)return{avg:1,min:1};const M=f.connectedHits>0?f.totalDamage/f.connectedHits:0,R=f.minCount>0?f.minTotal/f.minCount:M;return{avg:M||1,min:R||1}},Z=n.combatReplayMetaData||{},D=(Z==null?void 0:Z.inchToPixel)>0?Z.inchToPixel:1,v=(Z==null?void 0:Z.pollingRate)>0?Z.pollingRate:1,F=5e3,$=i=>Array.isArray(i)?i.map(f=>Array.isArray(f)?[Number(f[0]),Number(f[1])]:null).filter(f=>!!f&&Number.isFinite(f[0])):[];let ue=[],ee=n.durationMS||0,Se=!1;const Te=l.find(i=>(i==null?void 0:i.hasCommanderTag)&&!(i!=null&&i.notInSquad));(ut=Te==null?void 0:Te.combatReplayData)!=null&&ut.positions&&(ue=Te.combatReplayData.positions,$(Te.combatReplayData.dead).forEach(([f])=>{f>0&&(Se=!0,ee=Math.min(ee,f))}));const ae=i=>{var x;const f=(x=i.statsAll)==null?void 0:x[0];if((f==null?void 0:f.distToCom)!==void 0&&(f==null?void 0:f.distToCom)!=="Infinity")return Math.round(Number(f.distToCom));if((f==null?void 0:f.stackDist)!==void 0)return Math.round(Number(f.stackDist))||0;if(i.hasCommanderTag)return 0;const M=i.combatReplayData;if(!(M!=null&&M.positions)||!ue.length)return 0;const R=M.positions,U=$(M.dead),h=$(M.down),V=Math.floor((M.start||0)/v);let E=0;if(U.length&&h.length)for(const[me]of U){if(me<0)continue;const H=Math.max(0,Math.floor(me/v))-V;for(const[T,K]of h){if(me!==K)continue;const G=Se&&T>ee?Math.max(1,Math.floor(ee/v)):H,he=Math.max(0,Math.min(G,R.length,ue.length));if(he<=0)continue;let y=0;for(let Ae=0;Ae<he;Ae++){const[q,fe]=R[Ae],[re,ne]=ue[Ae];y+=Math.hypot(q-re,fe-ne)}E=Math.round(y/he/D)}}return E},de=l.filter(i=>!i.notInSquad),Fe=l.filter(i=>i.notInSquad);Y+=de.length,Q+=a.filter(i=>!i.isFake).length,Jn(l,{durationMS:n.durationMS,buffMap:n.buffMap});const{squadDeaths:r,enemyDeaths:_}=Pe(n);X+=r,pe+=_,te+=r,Oe+=_,ve(n)?se++:A++;const b=n.skillMap?Number((dt=Object.keys(n.skillMap).find(i=>{var f,M;return((M=(f=n.skillMap)==null?void 0:f[i])==null?void 0:M.name)==="Battle Standard"}))==null?void 0:dt.replace(/^s/,"")):null;l.forEach((i,f)=>{var Ze,ye,at,rt,Ut,ht,Ct,Tn,An,Mn,Nn,wn;if(i.notInSquad)return;const M=i.account||"Unknown",R=M!=="Unknown"?M:i.name||"Unknown",U=i.name||"Unknown";Ce.has(R)||Ce.set(R,{name:U,account:R,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:i.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const h=Ce.get(R);if(i.hasCommanderTag&&(h.isCommander=!0),i.profession&&i.profession!=="Unknown"){h.profession=i.profession,h.professions.add(i.profession);const u=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:n.durationMS||0;h.professionTimeMs[i.profession]=(h.professionTimeMs[i.profession]||0)+u}h.logsJoined++,h.downContrib+=Vn(i),h.cleanses+=jn(i),h.strips+=Wn(i,ge),h.healing+=zn(i),h.barrier+=Kn(i),h.cc+=Gn(i,ge),h.stab+=i.stabGeneration||0;const V=ae(i);V<=F&&(h.totalDist+=V,h.distCount++),(Ze=i.defenses)!=null&&Ze[0]&&(h.dodges+=i.defenses[0].dodgeCount||0,h.downs+=i.defenses[0].downCount||0,h.deaths+=i.defenses[0].deadCount||0),n.durationMS&&(h.totalFightMs+=n.durationMS);const E=Array.isArray(i.activeTimes)&&typeof i.activeTimes[0]=="number"?i.activeTimes[0]:n.durationMS||0;h.defenseActiveMs+=E,h.supportActiveMs+=E,h.healingActiveMs+=E,Array.isArray(i.buffUptimes)&&i.buffUptimes.length>0&&i.buffUptimes.forEach(u=>{var vn,En,Fn,Bn;if(typeof(u==null?void 0:u.id)!="number")return;const d=`b${u.id}`,C=((vn=n.buffMap)==null?void 0:vn[d])||((En=n.buffMap)==null?void 0:En[String(u.id)]);if(!C||bo(C))return;const z=Number(((Bn=(Fn=u.buffData)==null?void 0:Fn[0])==null?void 0:Bn.uptime)??0);if(!Number.isFinite(z)||z<=0)return;const Be=(C==null?void 0:C.stacking)??!1,We=(Be?z:z/100)*E;if(!Number.isFinite(We)||We<=0)return;const Ue=yn(C==null?void 0:C.name);if(Ue&&io.has(Ue)&&(!(C!=null&&C.classification)||C.classification==="Condition")){const Ht=We/1e3,Ve=C==null?void 0:C.icon,kt=Ee[Ue]||{name:Ue,icon:Ve,applications:0,damage:0};kt.applicationsFromUptime=(kt.applicationsFromUptime||0)+Ht,!kt.icon&&Ve&&(kt.icon=Ve),Ee[Ue]=kt;const Dt=h.outgoingConditions[Ue]||{applications:0,damage:0,skills:{},icon:Ve};Dt.applicationsFromUptime=(Dt.applicationsFromUptime||0)+Ht,!Dt.icon&&Ve&&(Dt.icon=Ve),h.outgoingConditions[Ue]=Dt;const St=He[Ue]||{name:Ue,icon:Ve,applications:0,damage:0};St.applicationsFromUptime=(St.applicationsFromUptime||0)+Ht,!St.icon&&Ve&&(St.icon=Ve),He[Ue]=St;const Tt=h.incomingConditions[Ue]||{applications:0,damage:0,skills:{},icon:Ve};Tt.applicationsFromUptime=(Tt.applicationsFromUptime||0)+Ht,!Tt.icon&&Ve&&(Tt.icon=Ve),h.incomingConditions[Ue]=Tt}Xe.has(d)||Xe.set(d,{name:C==null?void 0:C.name,stacking:Be,icon:C==null?void 0:C.icon}),Ye.has(d)||Ye.set(d,new Map);const ot=Ye.get(d),mt=h.account||i.account||i.name||"Unknown";let tt=ot.get(mt);tt||(tt={account:mt,profession:h.profession||i.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},ot.set(mt,tt));const ft=i.profession||h.profession;ft&&ft!=="Unknown"&&(tt.professions.add(ft),tt.professionTimeMs[ft]=(tt.professionTimeMs[ft]||0)+E,tt.profession=ft),tt.totalMs+=We,tt.durationMs+=E}),(ye=i.defenses)!=null&&ye[0]&&ao.forEach(u=>{const d=Number(i.defenses[0][u.field]??0);Number.isFinite(d)&&(h.defenseTotals[u.id]=(h.defenseTotals[u.id]||0)+d)}),(at=i.support)!=null&&at[0]&&ro.forEach(u=>{let d=Number(i.support[0][u.field]??0);Number.isFinite(d)&&(_e.has(u.field)&&d>999999&&(d=0),h.supportTotals[u.id]=(h.supportTotals[u.id]||0)+d)});const x=(u,d)=>{Number.isFinite(d)&&(h.healingTotals[u]=(h.healingTotals[u]||0)+d)},me=(u,d)=>Array.isArray(u)?u.reduce((C,z)=>C+Number((z==null?void 0:z[d])??0),0):0,H=(u,d,C)=>{if(!Number.isFinite(C)||C<=0)return;const z=l[d],Be=d===f,et=z==null?void 0:z.notInSquad,We=!et,Ue=We&&(z==null?void 0:z.group)!=null&&z.group===i.group;x(u,C),We&&x(`squad${u[0].toUpperCase()}${u.slice(1)}`,C),Ue&&x(`group${u[0].toUpperCase()}${u.slice(1)}`,C),Be&&x(`self${u[0].toUpperCase()}${u.slice(1)}`,C),et&&x(`offSquad${u[0].toUpperCase()}${u.slice(1)}`,C)};if(Array.isArray(i.rotation)){let u=0;i.rotation.forEach(d=>{var z;if(!(d!=null&&d.id)||!uo(d.id,n.skillMap))return;const C=((z=d.skills)==null?void 0:z.length)||0;C>0&&(u+=C,x(`resUtility_s${d.id}`,C))}),u>0&&x("resUtility",u)}const T=(rt=i.extHealingStats)==null?void 0:rt.outgoingHealingAllies;Array.isArray(T)&&T.forEach((u,d)=>{const C=me(u,"healing"),z=me(u,"downedHealing");H("healing",d,C),H("downedHealing",d,z)});const K=(Ut=i.extBarrierStats)==null?void 0:Ut.outgoingBarrierAllies;Array.isArray(K)&&K.forEach((u,d)=>{const C=me(u,"barrier");H("barrier",d,C)});const G=(ht=i.statsAll)==null?void 0:ht[0],he=(Ct=i.dpsAll)==null?void 0:Ct[0],y=(Tn=i.support)==null?void 0:Tn[0];if(so.forEach(u=>{if(u.id==="downContributionPercent"||!u.field)return;let d=0,C=0;u.source==="dpsAll"&&he?d=Number(he[u.field]??0):u.source==="statsAll"&&G?(d=Number(G[u.field]??0),C=Number(G[u.denomField||u.weightField||"connectedDamageCount"]??0)):u.source==="support"&&y?d=Number(y[u.field]??0):i.statsTargets&&i.statsTargets.forEach(z=>{z!=null&&z[0]&&(d+=Number(z[0][u.field]??0),C+=Number(z[0][u.denomField||u.weightField||"connectedDamageCount"]??0))}),Number.isFinite(d)&&(h.offenseTotals[u.id]=(h.offenseTotals[u.id]||0)+d,u.isRate&&C>0&&(h.offenseRateWeights[u.id]=(h.offenseRateWeights[u.id]||0)+C))}),i.targetDamageDist&&Number.isFinite(b)){const u=i.targetDamageDist.flatMap(d=>d||[]).flatMap(d=>d||[]).reduce((d,C)=>C!=null&&C.id&&C.id===b?d+((C==null?void 0:C.connectedHits)||0):d,0);h.offenseTotals.battleStandardHits=(h.offenseTotals.battleStandardHits||0)+u}h.revives+=((Mn=(An=i.support)==null?void 0:An[0])==null?void 0:Mn.resurrects)||0,he&&(h.damage+=he.damage||0,h.dps+=he.dps||0);const Ae=u=>{var Be,et,We,Ue;let d=`Skill ${u.id}`;const C=((Be=n.skillMap)==null?void 0:Be[`s${u.id}`])||((et=n.skillMap)==null?void 0:et[`${u.id}`]);let z=C==null?void 0:C.icon;if(C!=null&&C.name&&(d=C.name),d.startsWith("Skill ")){const ot=At(d,u.id,n.buffMap);ot&&(d=ot,z=((Ue=(We=n.buffMap)==null?void 0:We[`b${u.id}`])==null?void 0:Ue.icon)||z)}return{name:d,icon:z}},q=u=>{if(!(u!=null&&u.id))return;const{name:d,icon:C}=Ae(u);be[u.id]||(be[u.id]={name:d,icon:C,damage:0,hits:0,downContribution:0}),be[u.id].name.startsWith("Skill ")&&!d.startsWith("Skill ")&&(be[u.id].name=d),!be[u.id].icon&&C&&(be[u.id].icon=C),be[u.id].damage+=u.totalDamage,be[u.id].hits+=u.connectedHits,be[u.id].downContribution+=Number(u.downContribution||0)},fe=i.account||i.name||"Unknown",re=i.profession||"Unknown",ne=`${fe}|${re}`;let De=Re.get(ne);De||(De={key:ne,account:fe,displayName:fe,profession:re,professionList:[re],totalFightMs:0,skills:new Map},Re.set(ne,De)),De.professionList.includes(re)||De.professionList.push(re),De.totalFightMs+=n.durationMS||0;const xe=u=>{if(!(u!=null&&u.id))return;const{name:d,icon:C}=Ae(u),z=`s${u.id}`;let Be=De.skills.get(z);Be||(Be={id:z,name:d,icon:C,damage:0,downContribution:0},De.skills.set(z,Be)),Be.name.startsWith("Skill ")&&!d.startsWith("Skill ")&&(Be.name=d),!Be.icon&&C&&(Be.icon=C),Be.damage+=Number(u.totalDamage||0),Be.downContribution+=Number(u.downContribution||0)};ce==="total"?(Nn=i.totalDamageDist)==null||Nn.forEach(u=>{u==null||u.forEach(d=>{q(d),xe(d)})}):(wn=i.targetDamageDist)==null||wn.forEach(u=>{u==null||u.forEach(d=>{d==null||d.forEach(C=>{q(C),xe(C)})})}),i.totalDamageTaken&&i.totalDamageTaken.forEach(u=>{u==null||u.forEach(d=>{var et,We,Ue,ot;if(!(d!=null&&d.id))return;let C=`Skill ${d.id}`;const z=((et=n.skillMap)==null?void 0:et[`s${d.id}`])||((We=n.skillMap)==null?void 0:We[`${d.id}`]);let Be=z==null?void 0:z.icon;if(z!=null&&z.name&&(C=z.name),C.startsWith("Skill ")){const mt=At(C,d.id,n.buffMap);mt&&(C=mt,Be=((ot=(Ue=n.buffMap)==null?void 0:Ue[`b${d.id}`])==null?void 0:ot.icon)||Be)}ke[d.id]||(ke[d.id]={name:C,icon:Be,damage:0,hits:0}),(!ke[d.id].name.startsWith("Skill ")||C.startsWith("Skill "))&&(ke[d.id].name=C),!ke[d.id].icon&&Be&&(ke[d.id].icon=Be),ke[d.id].damage+=d.totalDamage,ke[d.id].hits+=d.hits})})}),Fe.forEach(i=>{const f=lt(i.profession||i.name);f&&(we[f]=(we[f]||0)+1)});const P=oo({players:l,targets:a,skillMap:n.skillMap,buffMap:n.buffMap,getPlayerKey:i=>i.account&&i.account!=="Unknown"?i.account:i.name||null}),W=en(n.buffMap);Object.entries(P.playerConditions).forEach(([i,f])=>{const M=Ce.get(i);M&&Object.entries(f).forEach(([R,U])=>{const h=M.outgoingConditions[R]||{applications:0,damage:0,skills:{},icon:U.icon};h.applications+=Number(U.applications||0),h.damage+=Number(U.damage||0),U.applicationsFromBuffs&&(h.applicationsFromBuffs=(h.applicationsFromBuffs||0)+U.applicationsFromBuffs),U.applicationsFromBuffsActive&&(h.applicationsFromBuffsActive=(h.applicationsFromBuffsActive||0)+U.applicationsFromBuffsActive),Object.entries(U.skills||{}).forEach(([V,E])=>{const x=h.skills[V]||{name:E.name,hits:0,damage:0,icon:E.icon};x.hits+=Number(E.hits||0),x.damage+=Number(E.damage||0),!x.icon&&E.icon&&(x.icon=E.icon),h.skills[V]=x}),!h.icon&&U.icon&&(h.icon=U.icon),M.outgoingConditions[R]=h})}),Object.entries(P.summary).forEach(([i,f])=>{const M=Ee[i]||{name:f.name||i,icon:f.icon,applications:0,damage:0};M.applications+=Number(f.applications||0),M.damage+=Number(f.damage||0),f.applicationsFromBuffs&&(M.applicationsFromBuffs=(M.applicationsFromBuffs||0)+f.applicationsFromBuffs),f.applicationsFromBuffsActive&&(M.applicationsFromBuffsActive=(M.applicationsFromBuffsActive||0)+f.applicationsFromBuffsActive),!M.icon&&f.icon&&(M.icon=f.icon),Ee[i]=M}),de.forEach(i=>{const f=i.account&&i.account!=="Unknown"?i.account:i.name||"Unknown",M=Ce.get(f);!M||!i.totalDamageTaken||i.totalDamageTaken.forEach(R=>R==null?void 0:R.forEach(U=>{var Ae,q,fe,re,ne,De;if(!(U!=null&&U.id))return;let h=`Skill ${U.id}`;const V=((Ae=n.skillMap)==null?void 0:Ae[`s${U.id}`])||((q=n.skillMap)==null?void 0:q[`${U.id}`]);V!=null&&V.name&&(h=V.name);const E=At(h,U.id,n.buffMap);if(!E)return;const x=(re=(fe=n.buffMap)==null?void 0:fe[`b${U.id}`])==null?void 0:re.name,me=W.get(E)||((De=(ne=n.buffMap)==null?void 0:ne[`b${U.id}`])==null?void 0:De.icon),H=(V==null?void 0:V.icon)||me;h.startsWith("Skill ")&&(x||E)&&(h=x||E);const T=Number(U.hits??0),K=Number(U.totalDamage??0),G=He[E]||{name:E,icon:me,applications:0,damage:0};G.applications+=Number.isFinite(T)?T:0,G.damage+=Number.isFinite(K)?K:0,!G.icon&&me&&(G.icon=me),He[E]=G;const he=M.incomingConditions[E]||{applications:0,damage:0,skills:{},icon:me};he.applications+=Number.isFinite(T)?T:0,he.damage+=Number.isFinite(K)?K:0;const y=he.skills[h]||{name:h,hits:0,damage:0,icon:H};y.hits+=Number.isFinite(T)?T:0,y.damage+=Number.isFinite(K)?K:0,!y.icon&&H&&(y.icon=H),he.skills[h]=y,!he.icon&&me&&(he.icon=me),M.incomingConditions[E]=he}))});const Ne=n.player_damage_mitigation||n.playerDamageMitigation,$e=Ne&&typeof Ne=="object"&&Object.keys(Ne).length>0;$e&&Object.entries(Ne).forEach(([i,f])=>{if(!f||typeof f!="object")return;const M=cn(i),R=ln(Et,M.account,M);Object.values(f).forEach(U=>{J((U==null?void 0:U.avoided_damage)??(U==null?void 0:U.avoidedDamage))<=0||dn(R.mitigationTotals,U)})});const Ge=n.player_minion_damage_mitigation||n.playerMinionDamageMitigation,Je=Ge&&typeof Ge=="object"&&Object.keys(Ge).length>0;Je&&Object.entries(Ge).forEach(([i,f])=>{if(!f||typeof f!="object")return;const M=cn(i);Object.entries(f).forEach(([R,U])=>{if(!U||typeof U!="object")return;const h=`${M.account}::${R}`,V=un(Ft,h,{...M,minion:String(R||"Unknown")});Object.values(U).forEach(E=>{dn(V.mitigationTotals,E)})})}),(!$e||!Je)&&($e||de.forEach(i=>{const f=(i==null?void 0:i.totalDamageTaken)||[];if(!Array.isArray(f)||f.length===0)return;const M=i.account||i.name||"Unknown",R={account:M,name:i.name||M,profession:lt(i.profession||"Unknown")};ln(Et,M,R);const U=n.skillMap||{},h=n.buffMap||{},V=Array.isArray(f)?f[0]:null;if(V==null||V.forEach(E=>{if(!(E!=null&&E.id))return;const x=J(E.blocked),me=J(E.evaded),H=J(E.glance??E.glanced),T=J(E.missed),K=J(E.invulned),G=J(E.interrupted),he=J(E.hits??E.connectedHits),y=Number(E.id),Ae=Bt(y,U,h);if(pn(fn,`${M}::${y}`,{totalHits:he,blocked:x,evaded:me,glanced:H,missed:T,invulned:K,interrupted:G}),M===It){const q=bt.get(y),fe=it(y),re=fe.hasSkill?fe.hits>0?fe.avg:0:1,ne=fe.hasSkill?fe.min||0:1,De=fe.hits>0?H*re/2+(x+me+T+K+G)*re:0,xe=fe.hits>0?H*ne/2+(x+me+T+K+G)*ne:0;Rt.push({logId:e.filePath||e.id||t,skillId:E.id,skillName:Ae,blocked:x,evaded:me,glanced:H,missed:T,invulned:K,interrupted:G,totalAvoids:x+me+H+T+K+G,avg:re,min:ne,enemyHits:(q==null?void 0:q.connectedHits)??0,enemyTotalDmg:(q==null?void 0:q.totalDamage)??0,avoidDmg:De,avoidMinDmg:xe})}}),M===It){const E=(x,me)=>{let H=0,T=0,K=0;if(!Array.isArray(x))return{total:H,minTotal:T,hits:K};for(const G of x){if(!(G!=null&&G.id))continue;const he=J(G.blocked),y=J(G.evaded),Ae=J(G.glance??G.glanced),q=J(G.missed),fe=J(G.invulned),re=J(G.interrupted),ne=Bt(Number(G.id),m,p),De=me(Number(G.id),ne);(De.hits??0)>0&&(H+=Ae*De.avg/2+(he+y+q+fe+re)*De.avg,T+=Ae*De.min/2+(he+y+q+fe+re)*De.min),K+=J(G.hits??G.connectedHits)}return{total:H,minTotal:T,hits:K}};xt.push({logId:e.filePath||e.id||t,variant:"current_global_name_taken0",...E(V,(x,me)=>{const H=it(x),T=H.hasSkill?H.hits>0?H.avg:0:1,K=H.hasSkill?H.min||0:1;return{avg:T,min:K,hits:H.hits}})})}}),Je||de.forEach(i=>{const f=(i==null?void 0:i.minions)||[];if(!Array.isArray(f)||f.length===0)return;const M=i.account||i.name||"Unknown",R={account:M,name:i.name||M,profession:lt(i.profession||"Unknown")},U=n.skillMap||{},h=n.buffMap||{};f.forEach(V=>{const E=(V==null?void 0:V.totalDamageTakenDist)||[];if(!Array.isArray(E)||E.length===0)return;let x=String((V==null?void 0:V.name)||"Unknown").replace(/^Juvenile\s+/i,"")||"Unknown";x.toUpperCase().includes("UNKNOWN")&&(x="Unknown");const me=`${M}::${x}`;un(Ft,me,{...R,minion:x});const H=Array.isArray(E)?E[0]:null;if(H==null||H.forEach(T=>{if(!(T!=null&&T.id))return;const K=J(T.blocked),G=J(T.evaded),he=J(T.glance??T.glanced),y=J(T.missed),Ae=J(T.invulned),q=J(T.interrupted),fe=J(T.hits??T.connectedHits),re=Number(T.id),ne=Bt(re,U,h);if(pn(gn,`${me}::${re}`,{totalHits:fe,blocked:K,evaded:G,glanced:he,missed:y,invulned:Ae,interrupted:q}),M===It&&x===mn){const De=bt.get(re),xe=it(re),Ze=xe.hasSkill?xe.hits>0?xe.avg:0:1,ye=xe.hasSkill?xe.min||0:1,at=xe.hits>0?he*Ze/2+(K+G+y+Ae+q)*Ze:0,rt=xe.hits>0?he*ye/2+(K+G+y+Ae+q)*ye:0;_t.push({logId:e.filePath||e.id||t,skillId:T.id,skillName:ne,blocked:K,evaded:G,glanced:he,missed:y,invulned:Ae,interrupted:q,totalAvoids:K+G+he+y+Ae+q,avg:Ze,min:ye,enemyHits:(De==null?void 0:De.connectedHits)??0,enemyTotalDmg:(De==null?void 0:De.totalDamage)??0,avoidDmg:at,avoidMinDmg:rt})}}),M===It&&x===mn){const T=(y,Ae)=>{let q=0,fe=0,re=0;if(!Array.isArray(y))return{total:q,minTotal:fe,hits:re};for(const ne of y){if(!(ne!=null&&ne.id))continue;const De=J(ne.blocked),xe=J(ne.evaded),Ze=J(ne.glance??ne.glanced),ye=J(ne.missed),at=J(ne.invulned),rt=J(ne.interrupted),Ut=Bt(Number(ne.id),m,p),{avg:ht,min:Ct}=Ae(Number(ne.id),Ut);J(ne.hits??ne.connectedHits)>0&&(q+=Ze*ht/2+(De+xe+ye+at+rt)*ht,fe+=Ze*Ct/2+(De+xe+ye+at+rt)*Ct),re+=J(ne.hits??ne.connectedHits)}return{total:q,minTotal:fe,hits:re}},K=Array.isArray(E)?E[0]||[]:[],G=Array.isArray(E)?E.flat():[],he=Array.isArray(V==null?void 0:V.totalDamageTaken)?V.totalDamageTaken[0]||[]:[];st.push({logId:e.filePath||e.id||t,variant:"current_global_name_dist0",...T(K,(y,Ae)=>{const q=it(y),fe=q.hasSkill?q.hits>0?q.avg:0:1,re=q.hasSkill&&q.min||0;return{avg:fe,min:re}})}),st.push({logId:e.filePath||e.id||t,variant:"local_name_dist0",...T(K,(y,Ae)=>le(Ae))}),st.push({logId:e.filePath||e.id||t,variant:"local_id_dist0",...T(K,y=>j(y))}),st.push({logId:e.filePath||e.id||t,variant:"global_name_alllists",...T(G,(y,Ae)=>{const q=it(y),fe=q.hasSkill?q.hits>0?q.avg:0:1,re=q.hasSkill&&q.min||0;return{avg:fe,min:re}})}),st.push({logId:e.filePath||e.id||t,variant:"global_name_taken0",...T(he,(y,Ae)=>{const q=it(y),fe=q.hasSkill?q.hits>0?q.avg:0:1,re=q.hasSkill&&q.min||0;return{avg:fe,min:re}})})}})}))}),_t.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Illusionary Warden"),console.table(_t),st.length>0&&console.table(st),console.groupEnd()),Rt.length>0&&(console.groupCollapsed("[Mitigation Debug] Ashtonlightstone.9145 / Player"),console.table(Rt),xt.length>0&&console.table(xt),console.groupEnd());const bn=(e,t)=>{const n=new Map,l=a=>{let m=n.get(a);return m||(m=pt(),n.set(a,m)),m};t.forEach((a,m)=>{const p=m.lastIndexOf("::"),L=p>-1?m.slice(0,p):m,S=p>-1?Number(m.slice(p+2)):Number.NaN,j=Number.isFinite(S)?it(S):{hasSkill:!1,avg:0,min:0,hits:0};if(!j.hasSkill||j.hits<=0)return;const le=j.avg,Z=j.min,D=a.glanced*le/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*le,v=a.glanced*Z/2+(a.blocked+a.evaded+a.missed+a.invulned+a.interrupted)*Z;if(D<=0)return;const F=l(L);F.totalHits+=a.totalHits,F.blocked+=a.blocked,F.evaded+=a.evaded,F.glanced+=a.glanced,F.missed+=a.missed,F.invulned+=a.invulned,F.interrupted+=a.interrupted,F.totalMitigation+=D,F.minMitigation+=v}),e.forEach((a,m)=>{const p=n.get(m)||pt();a.mitigationTotals.totalHits=p.totalHits,a.mitigationTotals.blocked=p.blocked,a.mitigationTotals.evaded=p.evaded,a.mitigationTotals.glanced=p.glanced,a.mitigationTotals.missed=p.missed,a.mitigationTotals.invulned=p.invulned,a.mitigationTotals.interrupted=p.interrupted,a.mitigationTotals.totalMitigation=p.totalMitigation,a.mitigationTotals.minMitigation=p.minMitigation})};bn(Et,fn),bn(Ft,gn);const Co=I>0?Math.round(Y/I):0,ko=I>0?Math.round(Q/I):0,Do=X>0?(pe/X).toFixed(2):pe>0?"∞":"0.00",So=Oe>0?(te/Oe).toFixed(2):te>0?"∞":"0.00",hn=(e,t)=>{const l=e.filter(p=>Number.isFinite(p.value)&&(t?p.value>0:p.value>=0)).sort((p,L)=>{const S=t?L.value-p.value:p.value-L.value;return S!==0?S:p.account.localeCompare(L.account)});let a=null,m=0;return l.map((p,L)=>((a===null||p.value!==a)&&(m=L+1,a=p.value),{rank:m,...p}))},qt=Array.from(Ce.values()).map(e=>{const t=Array.from(e.professions).filter(n=>n!=="Unknown");if(e.professionList=t,t.length>0){let n=t[0],l=e.professionTimeMs[n]||0;t.forEach(a=>{const m=e.professionTimeMs[a]||0;m>l&&(l=m,n=a)}),e.profession=n}return{key:e.account,stat:e}}),Cn=e=>{const t=Ce.get(e.account);if(!t){const a=e.professionList.length>0?e.professionList:e.profession?[e.profession]:[];return{...e,professionList:a}}const n=t.professionList&&t.professionList.length>0?t.professionList:Array.from(t.professions||[]).filter(a=>a&&a!=="Unknown"),l=t.profession||e.profession;return{...e,profession:l,professionList:n.length>0?n:l?[l]:[],activeMs:t.defenseActiveMs||t.totalFightMs||e.activeMs}},To=Array.from(Et.values()).map(Cn).filter(e=>ho(e.mitigationTotals)).sort((e,t)=>e.account.localeCompare(t.account)),Ao=Array.from(Ft.values()).map(Cn).filter(e=>e.mitigationTotals.totalMitigation>0).sort((e,t)=>{const n=e.account.localeCompare(t.account);return n!==0?n:String(e.minion||"").localeCompare(String(t.minion||""))}),Pt=(e,t)=>{switch(t){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},je=(e,t)=>hn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:Pt(n,e),count:n.logsJoined})),t),Ie={downContrib:je("downContrib",!0),barrier:je("barrier",!0),healing:je("healing",!0),dodges:je("dodges",!0),strips:je("strips",!0),cleanses:je("cleanses",!0),cc:je("cc",!0),stability:je("stability",!0),revives:je("revives",!0),participation:je("participation",!0),dps:je("dps",!0),damage:je("damage",!0),closestToTag:je("closestToTag",!1).filter(e=>Number.isFinite(e.value))},Mo={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},Me=e=>{const t=e==null?void 0:e[0];return{value:(t==null?void 0:t.value)??0,player:(t==null?void 0:t.account)??"-",count:(t==null?void 0:t.count)??0,profession:(t==null?void 0:t.profession)??"Unknown",professionList:(t==null?void 0:t.professionList)??[]}},Qe={maxDownContrib:Me([]),maxBarrier:Me([]),maxHealing:Me([]),maxDodges:Me([]),maxStrips:Me([]),maxCleanses:Me([]),maxCC:Me([]),maxStab:Me([]),closestToTag:Me([])},Ke={},No=(e,t)=>{if(t==="closestToTag")return Pt(e,t);const n=Math.max(1,(e.totalFightMs||0)/1e3);return Pt(e,t)/n};Object.values(Mo).forEach(e=>{const t=e!=="closestToTag";Ke[e]=hn(qt.map(({stat:n})=>({account:n.account,profession:n.profession,professionList:n.professionList,value:No(n,e),count:n.logsJoined})),t)}),Qe.maxDownContrib=Me(Ke.downContrib),Qe.maxBarrier=Me(Ke.barrier),Qe.maxHealing=Me(Ke.healing),Qe.maxDodges=Me(Ke.dodges),Qe.maxStrips=Me(Ke.strips),Qe.maxCleanses=Me(Ke.cleanses),Qe.maxCC=Me(Ke.cc),Qe.maxStab=Me(Ke.stability),Qe.closestToTag=Me(Ke.closestToTag);const wo={maxDownContrib:Me(Ie.downContrib),maxBarrier:Me(Ie.barrier),maxHealing:Me(Ie.healing),maxDodges:Me(Ie.dodges),maxStrips:Me(Ie.strips),maxCleanses:Me(Ie.cleanses),maxCC:Me(Ie.cc),maxStab:Me(Ie.stability),closestToTag:Me(Ie.closestToTag)};let jt={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},kn,Dn,Sn=0;if(oe!=null&&oe.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},t=m=>{const p=e[m];return p?Number(O[p]||0)>0:!1},n=[],l=m=>[...m||[]].filter(p=>t(p==null?void 0:p.name)).sort((p,L)=>L.ratio-p.ratio||p.rank-L.rank||p.name.localeCompare(L.name)).slice(0,3),a=m=>{var L;if(!m)return;const p=l(m.contribs);return{...m,player:m.name,reason:((L=p[0])==null?void 0:L.name)||"Top Performance",topStats:p}};qt.forEach(({stat:m})=>{let p=0;const L=[],S=(j,le,Z,D,v=!0)=>{var $,ue;if(Z<=0)return;const F=(($=le[0])==null?void 0:$.value)||0;if(F&&Number.isFinite(j)&&(v?j>0:j<Number.POSITIVE_INFINITY)){const ee=v?j/F:F/j;p+=ee*Z;const Se=((ue=le.find(Te=>Te.account===m.account))==null?void 0:ue.rank)||0;L.push({name:D,ratio:ee,val:j.toLocaleString(),rank:Se})}};S(m.downContrib,Ie.downContrib,O.downContribution,"Down Contribution"),S(m.healing,Ie.healing,O.healing,"Healing"),S(m.cleanses,Ie.cleanses,O.cleanses,"Cleanses"),S(m.strips,Ie.strips,O.strips,"Strips"),S(m.stab,Ie.stability,O.stability,"Stability"),S(m.cc,Ie.cc,O.cc,"CC"),S(m.revives,Ie.revives,O.revives,"Revives"),S(Pt(m,"closestToTag"),Ie.closestToTag,O.distanceToTag,"Distance to Tag",!1),S(m.logsJoined,Ie.participation,O.participation,"Participation"),S(m.dodges,Ie.dodges,O.dodging,"Dodging"),S(m.dps,Ie.dps,O.dps,"DPS"),S(m.damage,Ie.damage,O.damage,"Damage"),n.push({...m,score:p,contribs:L.filter(j=>t(j.name))})}),n.sort((m,p)=>p.score-m.score),n[0]&&n[0].score>0&&(jt=a(n[0])||jt),kn=a(n[1]),Dn=a(n[2]),Sn=n.length>0?n.reduce((m,p)=>m+p.score,0)/n.length:0}const vo=Object.values(be).sort((e,t)=>{const n=N==="downContribution"?e.downContribution:e.damage;return(N==="downContribution"?t.downContribution:t.damage)-n}).slice(0,25),Eo=Object.values(ke).sort((e,t)=>t.damage-e.damage).slice(0,25),Fo=e=>{const t=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),n=t.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return n?`${n[1]} Borderlands`:t||"Unknown"},Wt=(e,t)=>Fo((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(t==null?void 0:t.fightName)||(t==null?void 0:t.encounterName)||"Unknown"),Bo=(e,t)=>{const n=(t==null?void 0:t.permalink)||(e==null?void 0:e.permalink);if(typeof n=="string"&&n.trim().length>0)return n.trim();const l=e==null?void 0:e.uploadLinks;if(!Array.isArray(l))return"";for(const a of l){if(typeof a=="string"&&a.trim().length>0)return a.trim();if(a&&typeof a=="object"){const m=a.permalink||a.link||a.url||a.reportLink;if(typeof m=="string"&&m.trim().length>0)return m.trim()}}return""},Vt={};B.forEach(e=>{const t=Wt(e==null?void 0:e.details,e);Vt[t]=(Vt[t]||0)+1});const Io=Object.entries(Vt).map(([e,t])=>{const n=String(e).trim(),l=/eternal battlegrounds|^ebg$/i.test(n);let a="#64748b";return l?a="#ffffff":/red/i.test(n)?a="#ef4444":/blue/i.test(n)?a="#3b82f6":/green/i.test(n)&&(a="#22c55e"),{name:e,value:t,color:a}}).sort((e,t)=>t.value-e.value),{boonTables:Po}=Pn(B),Uo=B.map((e,t)=>{var l,a;const n=((l=e.details)==null?void 0:l.players)||[];return{index:t+1,label:`Log ${t+1}`,timestamp:nt(e.details,e),squadCount:n.filter(m=>!m.notInSquad).length,friendlyCount:n.length,enemies:((a=e.details)==null?void 0:a.targets).filter(m=>!m.isFake).length}}).sort((e,t)=>e.timestamp-t.timestamp),zt={};Array.from(Ce.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(zt[e.profession]=(zt[e.profession]||0)+1)});const Ho=Object.entries(zt).map(([e,t])=>({name:e,value:t,color:tn(e)})).sort((e,t)=>t.value-e.value),Kt={};Object.keys(we).length===0&&B.forEach(e=>{var t,n;(n=(t=e.details)==null?void 0:t.targets)==null||n.forEach(l=>{if(l.isFake)return;const a=l.profession&&l.profession!=="Unknown"?l.profession:l.name||l.id||"Unknown",m=lt(a);Kt[m]=(Kt[m]||0)+1})});const Lo=Object.keys(we).length>0?we:Kt,$o=Object.entries(Lo).map(([e,t])=>({name:e,value:t,color:tn(e)})).sort((e,t)=>t.value-e.value),Oo=B.map((e,t)=>({log:e,originalIndex:t})).sort((e,t)=>nt(e.log.details,e.log)-nt(t.log.details,t.log)).map(({log:e},t)=>{const n=e.details;if(!n)return null;const l=n.players||[],a=l.filter(r=>!r.notInSquad),m=l.filter(r=>r.notInSquad),p=n.targets||[],L=p.filter(r=>!r.isFake),S=a.reduce((r,_)=>{var g,b;return r+(((b=(g=_.dpsAll)==null?void 0:g[0])==null?void 0:b.damage)||0)},0),j=a.reduce((r,_)=>{var g,b;return r+(((b=(g=_.defenses)==null?void 0:g[0])==null?void 0:b.damageTaken)||0)},0),{enemyDeaths:le,enemyDownsDeaths:Z}=Pe(n),D=ve(n),v=nt(n,e),F=Wt(n,e),$={red:0,green:0,blue:0},ue=r=>{const _=Number(r);return Number.isFinite(_)?_:0},ee=r=>{if(!r||typeof r!="object")return;const _=r.teamID??r.teamId??r.team??r.teamColor??r.team_color;if(_!=null)return _;const g=Object.keys(r).find(b=>/^team/i.test(b));return g?r[g]:void 0},Se=(r,_)=>{if(r==null)return null;if(typeof r=="string"){const g=r.toLowerCase();return g.includes("red")?"red":g.includes("green")?"green":g.includes("blue")?"blue":g==="r"?"red":g==="g"?"green":g==="b"?"blue":null}if(typeof r=="number")if(_==="zeroBased"){if(r===0)return"red";if(r===1)return"green";if(r===2)return"blue"}else{if(r===1)return"red";if(r===2)return"green";if(r===3)return"blue"}return null},Te=(r,_)=>{const g={};return r.forEach(b=>{const P=_(b),W=lt(P);W&&(g[W]=(g[W]||0)+1)}),g},ae=Te(a,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)),de=Te(m,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)),Fe=Te(L,r=>(r==null?void 0:r.profession)||(r==null?void 0:r.name)||(r==null?void 0:r.id));if(n.teamCounts&&typeof n.teamCounts=="object"){const r=n.teamCounts;$.red=ue(r.red??r.r??r[0]??r[1]),$.green=ue(r.green??r.g??r[1]??r[2]),$.blue=ue(r.blue??r.b??r[2]??r[3])}else{const r=[];p.forEach(P=>{if(P!=null&&P.isFake)return;const W=ee(P);W!=null&&r.push(W)}),l.forEach(P=>{if(!(P!=null&&P.notInSquad))return;const W=ee(P);W!=null&&r.push(W)}),r.length===0&&l.forEach(P=>{const W=ee(P);W!=null&&r.push(W)});const _=new Set;r.forEach(P=>{typeof P=="number"&&_.add(P)});const g=_.has(0)?"zeroBased":_.has(3)?"oneBased":"zeroBased";if(r.forEach(P=>{const W=Se(P,g);W&&($[W]+=1)}),$.red+$.green+$.blue===0&&r.length>0){const P=new Map;r.forEach(Ne=>{const $e=String(Ne);P.set($e,(P.get($e)||0)+1)});const W=Array.from(P.values()).sort((Ne,$e)=>$e-Ne);$.red=W[0]||0,$.green=W[1]||0,$.blue=W[2]||0}$.red+$.green+$.blue===0&&($.red=Math.max(L.length,l.filter(P=>P==null?void 0:P.notInSquad).length))}return{id:e.filePath||`fight-${t}`,label:e.encounterName||`Fight ${t+1}`,permalink:Bo(n,e),timestamp:v,mapName:F,duration:mo(n.durationMS),isWin:D,squadCount:a.length,allyCount:m.length,enemyCount:L.length,teamCounts:$,alliesDown:a.reduce((r,_)=>{var g,b;return r+(((b=(g=_.defenses)==null?void 0:g[0])==null?void 0:b.downCount)||0)},0),alliesDead:a.reduce((r,_)=>{var g,b;return r+(((b=(g=_.defenses)==null?void 0:g[0])==null?void 0:b.deadCount)||0)},0),alliesRevived:a.reduce((r,_)=>{var g,b;return Number(((b=(g=_.statsAll)==null?void 0:g[0])==null?void 0:b.saved)||0)>0?r+1:r},0),rallies:0,enemyDeaths:le,enemyDowns:Math.max(0,Z-le),totalOutgoingDamage:S,totalIncomingDamage:j,incomingBarrierAbsorbed:a.reduce((r,_)=>{var g,b;return r+(((b=(g=_.defenses)==null?void 0:g[0])==null?void 0:b.damageBarrier)||0)},0),outgoingBarrierAbsorbed:a.reduce((r,_)=>{var P;const g=(P=_.extBarrierStats)==null?void 0:P.outgoingBarrier;if(!Array.isArray(g))return r;let b=0;return g.forEach(W=>{if(Array.isArray(W)){W.forEach(Ne=>{b+=Number((Ne==null?void 0:Ne.barrier)||0)});return}b+=Number((W==null?void 0:W.barrier)||0)}),r+b},0),squadClassCountsFight:ae,allyClassCountsFight:de,enemyClassCounts:Fe}}).filter(Boolean),_o=(e,t)=>{const n=(t==null?void 0:t.skillMap)||{},l=(t==null?void 0:t.buffMap)||{};let a=0,m="";const p=S=>{const j=Number(S);if(!Number.isFinite(j))return String(S||"Unknown Skill");const le=(n==null?void 0:n[`s${j}`])||(n==null?void 0:n[`${j}`]);if(le!=null&&le.name)return String(le.name);const Z=(l==null?void 0:l[`b${j}`])||(l==null?void 0:l[`${j}`]);return Z!=null&&Z.name?String(Z.name):`Skill ${j}`},L=S=>{if(!S||typeof S!="object")return;const j=[Number(S.max),Number(S.maxDamage),Number(S.maxHit),Number(S.totalDamage)>0&&Number(S.connectedHits)>0?Number(S.totalDamage)/Number(S.connectedHits):0].filter(Z=>Number.isFinite(Z)),le=j.length>0?Math.max(...j):0;le>a&&(a=le,m=p(S.id))};return Array.isArray(e==null?void 0:e.totalDamageDist)&&e.totalDamageDist.forEach(S=>{Array.isArray(S)&&S.forEach(j=>L(j))}),Array.isArray(e==null?void 0:e.targetDamageDist)&&e.targetDamageDist.forEach(S=>{Array.isArray(S)&&S.forEach(j=>{Array.isArray(j)&&j.forEach(le=>L(le))})}),{peak:a,skillName:m||"Unknown Skill"}},Ro=(()=>{const e=D=>String(D||"").replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),t=D=>e(D).toLowerCase().split(/[^a-z0-9]+/i).map(v=>v.trim()).filter(Boolean).map(v=>v.length>3&&v.endsWith("s")?v.slice(0,-1):v),n=(D,v)=>{const F=e(D),$=e(v);if(!$)return F;if(!F)return $;const ue=t(F),ee=t($),Se=new Set(ue),Te=new Set(ee),ae=ee.length>0&&ee.every(Fe=>Se.has(Fe)),de=ue.length>0&&ue.every(Fe=>Te.has(Fe));return ae||de?F:`${F} - ${$}`},l=[],a=new Map,m=D=>{const v=ae=>{if(!Array.isArray(ae)||ae.length===0)return[];const de=[];for(let Fe=0;Fe<ae.length;Fe+=1){const r=Number(ae[Fe]||0),_=Fe>0?Number(ae[Fe-1]||0):0;de.push(Math.max(0,r-_))}return de},F=ae=>{if(!Array.isArray(ae))return[];const de=ae.reduce((r,_)=>Math.max(r,Array.isArray(_)?_.length:0),0);if(de<=0)return[];const Fe=new Array(de).fill(0);return ae.forEach(r=>{if(Array.isArray(r))for(let _=0;_<de;_+=1)Fe[_]+=Number(r[_]||0)}),Fe},$=ae=>Array.isArray(ae)?ae.map(de=>Number(de||0)):null,ee=(ae=>{if(!Array.isArray(ae)||ae.length===0)return null;const de=ae[0];if(!Array.isArray(de))return null;if(Array.isArray(de[0])&&Array.isArray(de[0][0]))return F(de);if(Array.isArray(de[0])&&!Array.isArray(de[0][0])){const Fe=ae.map(r=>$(Array.isArray(r)?r[0]:null)).filter(r=>Array.isArray(r)&&r.length>0);if(Fe.length>0)return F(Fe)}return null})(D==null?void 0:D.targetDamage1S),Se=Array.isArray(D==null?void 0:D.damage1S)&&Array.isArray(D.damage1S[0])?D.damage1S[0]:null,Te=ee||(Array.isArray(Se)?Se.map(ae=>Number(ae||0)):[]);return v(Te)},p=(D,v)=>{if(!Array.isArray(D)||D.length===0||v<=0)return 0;let F=0,$=0;for(let ue=0;ue<D.length;ue+=1)F+=Number(D[ue]||0),ue>=v&&(F-=Number(D[ue-v]||0)),ue>=v-1&&F>$&&($=F);return Math.max(0,$)},L=(D,v)=>{if(!Array.isArray(D)||D.length===0||v<=0)return[];const F=[];for(let $=0;$<D.length;$+=v){const ue=Math.min($+v,D.length),ee=D.slice($,ue).reduce((Se,Te)=>Se+Number(Te||0),0);F.push(ee)}return F},S=D=>Array.isArray(D)?D.map(v=>Array.isArray(v)?[Number(v[0]),Number(v[1])]:v&&typeof v=="object"?[Number(v.time),Number(v.value)]:null).filter(v=>!!v&&Number.isFinite(v[0])&&v[0]>=0):[],j=(D,v,F,$,ue)=>{if(!D.length||$<=0)return[];const ee=Math.max($*5e3,ue||0),Se=b=>b.reduce((P,W)=>W>=0&&W<=ee+2e3?P+1:P,0),Te=D.map(b=>Number(b||0)).filter(b=>Number.isFinite(b)&&b>=0);if(!Te.length)return[];const ae=[Te],de=Te.reduce((b,P)=>Math.max(b,P),0),Fe=Te.reduce((b,P)=>Math.min(b,P),Number.POSITIVE_INFINITY);de>ee*20&&ae.push(Te.map(b=>b/1e3)),de<=ee*2&&Fe>=0&&de>0&&de<Math.max(120,$*5+10)&&ae.push(Te.map(b=>b*1e3));let r=Te,_=0,g=-1;return ae.forEach(b=>{const P=b.reduce((Ne,$e)=>Math.min(Ne,$e),Number.POSITIVE_INFINITY),W=new Set([0,...v,...F]);if(Number.isFinite(P)&&ee>0&&P>ee){const Ne=Math.floor(P/ee)*ee;W.add(Ne),W.add(Math.max(0,Ne-ee))}W.forEach(Ne=>{const $e=b.map(Je=>Je-Ne),Ge=Se($e);Ge>g&&(g=Ge,_=Ne,r=b)})}),r.map(b=>b-_).filter(b=>Number.isFinite(b)&&b>=0)},le=(D,v,F,$,ue)=>{const ee=j(D,v,F,$,ue);return Array.from(new Set(ee.map(Se=>Math.floor(Se/5e3)).filter(Se=>Number.isFinite(Se)&&Se>=0&&Se<$)))};B.map(D=>({log:D,ts:nt(D==null?void 0:D.details,D)})).sort((D,v)=>D.ts-v.ts).forEach(({log:D},v)=>{const F=D==null?void 0:D.details;if(!F)return;const $=e(F.fightName||D.fightName||`Fight ${v+1}`),ue=Wt(F,D),ee=n($,String(ue||"")),Se={},Te=Array.isArray(F.players)?F.players:[],ae=Te.flatMap(g=>{const b=g==null?void 0:g.combatReplayData;return Array.isArray(b)?b.map(P=>Number(P==null?void 0:P.start)):[Number(b==null?void 0:b.start)]}).filter(g=>Number.isFinite(g)&&g>=0);Te.forEach(g=>{if(g!=null&&g.notInSquad)return;const b=String((g==null?void 0:g.account)||(g==null?void 0:g.name)||"Unknown"),P=String((g==null?void 0:g.character_name)||(g==null?void 0:g.display_name)||(g==null?void 0:g.name)||""),W=String((g==null?void 0:g.profession)||"Unknown"),Ne=`${b}|${W}`,$e=_o(g,F),Ge=Number($e.peak||0),Je=m(g),ut=Number(p(Je,1)||0),dt=Number(p(Je,5)||0),i=Number(p(Je,30)||0),f=Math.max(0,Math.ceil(Number((F==null?void 0:F.durationMS)||0)/5e3)),M=Math.max(0,Math.ceil(Je.length/5)),R=Math.max(f,M),U=L(Je,5),h=Array.from({length:R},(T,K)=>Number(U[K]||0)),V=(()=>{const T=g==null?void 0:g.combatReplayData;return Array.isArray(T)?T.filter(K=>K&&typeof K=="object"):T&&typeof T=="object"?[T]:[]})(),E=V.map(T=>Number(T==null?void 0:T.start)).filter(T=>Number.isFinite(T)&&T>=0),x=V.flatMap(T=>S(T==null?void 0:T.down).map(([K])=>Number(K||0))),me=V.flatMap(T=>S(T==null?void 0:T.dead).map(([K])=>Number(K||0)));Se[Ne]={hit:Ge,burst1s:ut,burst5s:dt,burst30s:i,skillName:$e.skillName,buckets5s:h,downIndices5s:le(x,E,ae,R,Number((F==null?void 0:F.durationMS)||0)),deathIndices5s:le(me,E,ae,R,Number((F==null?void 0:F.durationMS)||0))};const H=a.get(Ne)||{key:Ne,account:b,displayName:b,characterName:P,profession:W,professionList:[W],logs:0,peakHit:0,peak1s:0,peak5s:0,peak30s:0,peakFightLabel:"",peakSkillName:""};H.logs+=1,H.professionList.includes(W)||H.professionList.push(W),!H.characterName&&P&&(H.characterName=P),Ge>H.peakHit&&(H.peakHit=Ge,H.peakFightLabel=ee,H.peakSkillName=$e.skillName),ut>H.peak1s&&(H.peak1s=ut),dt>H.peak5s&&(H.peak5s=dt),i>H.peak30s&&(H.peak30s=i),a.set(Ne,H)});const de=Object.values(Se).reduce((g,b)=>Math.max(g,Number((b==null?void 0:b.hit)||0)),0),Fe=Object.values(Se).reduce((g,b)=>Math.max(g,Number((b==null?void 0:b.burst1s)||0)),0),r=Object.values(Se).reduce((g,b)=>Math.max(g,Number((b==null?void 0:b.burst5s)||0)),0),_=Object.values(Se).reduce((g,b)=>Math.max(g,Number((b==null?void 0:b.burst30s)||0)),0);l.push({id:D.filePath||D.id||`fight-${v+1}`,shortLabel:`F${v+1}`,fullLabel:ee,timestamp:nt(F,D),values:Se,maxHit:de,max1s:Fe,max5s:r,max30s:_})});const Z=Array.from(a.values()).sort((D,v)=>v.peakHit!==D.peakHit?v.peakHit-D.peakHit:D.displayName.localeCompare(v.displayName));return{fights:l,players:Z}})(),xo=Array.from(Ye.entries()).map(([e,t])=>{const n=Xe.get(e)||{},l=Array.from(t.values()).map(a=>{var le;const m=Array.from(a.professions||[]).filter(Z=>Z&&Z!=="Unknown");let p=a.profession||"Unknown";if(m.length>0){p=m[0];let Z=((le=a.professionTimeMs)==null?void 0:le[p])||0;m.forEach(D=>{var F;const v=((F=a.professionTimeMs)==null?void 0:F[D])||0;v>Z&&(Z=v,p=D)})}const L=a.durationMs||0,S=a.totalMs/1e3,j=L>0?a.totalMs/L:0;return{account:a.account,profession:p,professionList:m,total:S,perSecond:j,duration:L/1e3}}).filter(a=>a.total>0||a.perSecond>0);return{id:e,name:n.name||e,icon:n.icon,rows:l}}).filter(e=>e.rows.length>0),qo=Array.from(Re.values()).map(e=>{const t=Array.from(e.skills.values()).sort((l,a)=>a.damage-l.damage),n=t.reduce((l,a)=>(l[a.id]=a,l),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:t,skillMap:n}}).sort((e,t)=>e.displayName.localeCompare(t.displayName));return{total:I,wins:se,losses:A,avgSquadSize:Co,avgEnemies:ko,squadKDR:Do,enemyKDR:So,totalSquadKills:pe,totalSquadDeaths:X,totalEnemyKills:te,totalEnemyDeaths:Oe,leaderboards:Ie,...wo,outgoingConditionSummary:Object.values(Ee).sort((e,t)=>t.damage-e.damage),incomingConditionSummary:Object.values(He).sort((e,t)=>t.damage-e.damage),outgoingConditionPlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:vo,topIncomingSkills:Eo,playerSkillBreakdowns:qo,topSkillsMetric:N,mapData:Io,timelineData:Uo,boonTables:Po,offensePlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),damageMitigationPlayers:To,damageMitigationMinions:Ao,supportPlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(Ce.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:jt,silver:kn,bronze:Dn,squadClassData:Ho,enemyClassData:$o,fightBreakdown:Oo,spikeDamage:Ro,specialTables:xo,topStatsPerSecond:Qe,topStatsLeaderboardsPerSecond:Ke,avgMvpScore:Sn}})(),qe=(()=>{const ge=new Map,ce=new Map,N=[],I=new Map,se=new Map;B.forEach(Y=>{const Q=Y.details;if(!Q)return;const X=Q.skillMap||{},pe=Q.fightName||"Log",Oe=nt(Q,Y)||Date.now(),te={id:Y.filePath||Y.id||pe,label:pe,timestamp:Oe,skillEntries:{},playerActiveSeconds:{},durationSeconds:Q.durationMS?Q.durationMS/1e3:0};(Q.players||[]).forEach(ve=>{if(ve.notInSquad)return;const Ce=ve.account||ve.name||"Unknown",_e=ve.profession||"Unknown",be=`${Ce}|${_e}`;let ke=ce.get(be);ke||(ke={key:be,account:Ce,displayName:Ce,profession:_e,professionList:[_e],logs:0,totalActiveSeconds:0,skillTotals:{}},ce.set(be,ke)),ke.logs++;const Re=(Array.isArray(ve.activeTimes)?ve.activeTimes[0]:0)/1e3;ke.totalActiveSeconds=(ke.totalActiveSeconds||0)+Re,te.playerActiveSeconds[be]=Re,(ve.rotation||[]).forEach(Ee=>{var Nt,wt,vt;if(!(Ee!=null&&Ee.id))return;const He=((Nt=Ee.skills)==null?void 0:Nt.length)||0;if(He<=0)return;const we=`s${Ee.id}`,Xe=((wt=X[we])==null?void 0:wt.name)||`Skill ${Ee.id}`,Ye=(vt=X[we])==null?void 0:vt.icon;ke.skillTotals[we]=(ke.skillTotals[we]||0)+He,ge.set(we,(ge.get(we)||0)+He),I.set(we,Xe),Ye&&!se.has(we)&&se.set(we,Ye),te.skillEntries[we]||(te.skillEntries[we]={name:Xe,icon:Ye,players:{}}),!te.skillEntries[we].icon&&Ye&&(te.skillEntries[we].icon=Ye),te.skillEntries[we].players[be]=(te.skillEntries[we].players[be]||0)+He})}),N.push(te)});const A=Array.from(ge.entries()).map(([Y,Q])=>({id:Y,name:I.get(Y)||Y,total:Q,icon:se.get(Y)})).sort((Y,Q)=>Q.total-Y.total);return{logRecords:N,players:Array.from(ce.values()),skillOptions:A,resUtilitySkills:[]}})();return{validLogs:B,stats:Le,skillUsageData:qe}};let ze=null,ct=!1,nn=null,on=0,sn=0,$t=null;const an=o=>{if(!o||typeof o!="object")return o;const s=(k,w)=>{const B={};return w.forEach(oe=>{k&&Object.prototype.hasOwnProperty.call(k,oe)&&(B[oe]=k[oe])}),B},c=s(o,["players","targets","durationMS","uploadTime","timeStart","timeStartStd","timeEnd","timeEndStd","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration","player_damage_mitigation","player_minion_damage_mitigation","playerDamageMitigation","playerMinionDamageMitigation"]);return Array.isArray(c.players)&&(c.players=c.players.map(k=>s(k,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","damage1S","targetDamage1S","totalDamageTaken","totalDamageTakenDist","minions","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(c.targets)&&(c.targets=c.targets.map(k=>s(k,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer","totalDamageDist"]))),c},po=o=>{if(!o||typeof o!="object")return o;const s={...o};return o.details?s.details=an(o.details):s.details=an(o),s},rn=()=>{if(!ct||!ze)return;ct=!1,on+=1;const o=$t;$t=null;const s=go(ze);self.postMessage({type:"result",result:s,computeId:on,logCount:ze.logs.length,token:sn,completedAt:Date.now(),flushId:o})},Ot=()=>{nn===null&&(nn=setInterval(()=>{rn()},5e3))};self.onmessage=o=>{var c,k,w,B;const s=o.data;if((s==null?void 0:s.type)==="reset"){ze={logs:[]},typeof s.token=="number"&&(sn=s.token),ct=!0,Ot();return}if((s==null?void 0:s.type)==="settings"){ze={logs:(ze==null?void 0:ze.logs)||[],precomputedStats:(c=s.payload)==null?void 0:c.precomputedStats,mvpWeights:(k=s.payload)==null?void 0:k.mvpWeights,statsViewSettings:(w=s.payload)==null?void 0:w.statsViewSettings,disruptionMethod:(B=s.payload)==null?void 0:B.disruptionMethod},ct=!0,Ot();return}if((s==null?void 0:s.type)==="log"){ze||(ze={logs:[]}),ze.logs.push(po(s.payload)),ct=!0,Ot();return}(s==null?void 0:s.type)==="flush"&&(typeof s.flushId=="number"&&($t=s.flushId),ct=!0,rn())}})();
